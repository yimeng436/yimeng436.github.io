<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>SpringCloud | 异梦的博客</title><meta name="keywords" content="Java"><meta name="author" content="异梦"><meta name="copyright" content="异梦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="SpringCloud">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud">
<meta property="og:url" content="https://yimeng436.github.io/2022/08/21/SpringCloud/SpringCloud/index.html">
<meta property="og:site_name" content="异梦的博客">
<meta property="og:description" content="SpringCloud">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yimeng436.github.io/img/top.png">
<meta property="article:published_time" content="2022-08-20T16:00:00.000Z">
<meta property="article:modified_time" content="2023-03-01T07:38:22.481Z">
<meta property="article:author" content="异梦">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yimeng436.github.io/img/top.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://yimeng436.github.io/2022/08/21/SpringCloud/SpringCloud/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SpringCloud',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-01 15:38:22'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="http://mms2.baidu.com/it/u=665033858,976373917&amp;fm=253&amp;app=138&amp;f=JPEG&amp;fmt=auto&amp;q=75?w=500&amp;h=500" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">46</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/top.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">异梦的博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SpringCloud</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-20T16:00:00.000Z" title="发表于 2022-08-21 00:00:00">2022-08-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-03-01T07:38:22.481Z" title="更新于 2023-03-01 15:38:22">2023-03-01</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="SpringCloud"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><strong><center><font size=7>SpringCloud</font></center></strong></p>
<h1 id="SpringBoot-和SpringCloud-关系"><a href="#SpringBoot-和SpringCloud-关系" class="headerlink" title="SpringBoot 和SpringCloud 关系"></a>SpringBoot 和SpringCloud 关系</h1><ul>
<li>Boot 是用来一个快速开发单个微服务的，实际上就是一个个jar包</li>
<li>Cloud 是在你微服务数量较多时，它将一个个Boot开发的微服务整合起来并加以管理，为各个服务之间提供：配置管理、服务发现、断路器、路由、微代理等服务</li>
<li>Boot可以离开Cloud，Cloud依赖与Boot</li>
</ul>
<h1 id="创建一个父工程，管理子工程的所有配置（2020-12）"><a href="#创建一个父工程，管理子工程的所有配置（2020-12）" class="headerlink" title="创建一个父工程，管理子工程的所有配置（2020.12）"></a>创建一个父工程，管理子工程的所有配置（2020.12）</h1><p>只创建一个普通的maven 工程就行了，导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--用来配置版本号--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring.cloud-version</span>&gt;</span>Hoxton.SR8<span class="tag">&lt;/<span class="name">spring.cloud-version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.16.10<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--为子工程提供必要的依赖，子工程还需要重新引用，不配置版本默认使用父工程的版本--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringCloud--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.cloud-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">        <span class="comment">&lt;!--SpringBoot--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org..projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="子工程1-api"><a href="#子工程1-api" class="headerlink" title="子工程1-api"></a>子工程1-api</h2><p>假设这个子工程只负责管理pojo实体类，所以在xml中只需要引入  lombok就行了。这个就是用了manage特有的识别号。</p>
<p><img src="/../../images/image-20221128184939386.png" alt="image-20221128184939386"></p>
<ul>
<li>只写实体类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span>    <span class="comment">//链式写法，就是在使用 点取访问方法的时候可以一直点下去，比如说一直 .setxxx方法</span></span><br><span class="line"><span class="comment">//分布式中，所有类由于要在网络上传输，所以必须实现一个接口，实现传输时进行序列化</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dept</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long deptno;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String deptname;</span><br><span class="line">    <span class="comment">//用于标记当前这个数据来自于哪个数据库，因为微服务可能出现来自不同数据库的情况</span></span><br><span class="line">    <span class="keyword">private</span> String db_source;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dept</span><span class="params">(String deptname)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.deptname = deptname;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h2 id="子工程2-provider-8001"><a href="#子工程2-provider-8001" class="headerlink" title="子工程2-provider-8001"></a>子工程2-provider-8001</h2><p>一般习惯把工程端口号也写在工程后面，好识别</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">提供者肯定要拿到实体类，所以我们需要把我们上面自己写的服务引入进来</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yhz<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#myabtis</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.yhz.springcloud.pojo</span></span><br><span class="line">  <span class="comment">#注：配置了通配符之后config的不能放在和mapper同一个路径之下，会出现解析xml为空的异常</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mybatis/mapper/*.xml</span>	</span><br><span class="line">  <span class="attr">config-location:</span> <span class="string">classpath:mybatis/mybatis-config.xml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#spring</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">spring-cloud-provider</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/springcloud?useSSL=false&amp;userUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>





<ul>
<li>常规的controller、service、mapper</li>
</ul>
<p><img src="/../../images/image-20221129102559265.png" alt="image-20221129102559265"></p>
<ul>
<li>主启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.yhz.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptProviderr_8001</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DeptProviderr_8001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="子工程3-springcloud-consummer-80"><a href="#子工程3-springcloud-consummer-80" class="headerlink" title="子工程3-springcloud-consummer-80"></a>子工程3-springcloud-consummer-80</h2><p>对于服务消费者，只需要实体类，和web支持</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yhz<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>对于消费者，用户是和前端打交道的，所以我应该只有一个controller层，在controller中通过请求远程的接口服务，所以不应该有service层。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptConsummerController</span> &#123;</span><br><span class="line">    <span class="comment">//首先 ，消费者不应该有Service层，那要如何拿到Service层的接口呢</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//之前在学spring的时候，要获得sqlsession对象的时候，我们通过一个sqlsessionTemplate对象注册在xml中获得</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//同样这里我们在提供者使用Restful风格请求获得数据，</span></span><br><span class="line">    <span class="comment">// 所以在消费者这我们有一个RestTemplate供消费者使用传入对应的url，以及选择请求方式就可以访问到服务提供者的接口</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//看过RestTemplate源码发现，RestTemplate没有被注册到spring中，而springboot中没有applicationContext.xml</span></span><br><span class="line">    <span class="comment">//所以还需要创建一个配置类，将其注册到spring中</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate template;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//由于请求前缀是固定的一般给他写成常量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String prefix= <span class="string">&quot;http://localhost:8001/&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consummer/dept/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Dept <span class="title function_">get</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">int</span> id)</span>&#123;</span><br><span class="line">        <span class="comment">//使用Rest调用，提供什么请求方法名对应的前缀就是什么（getxxx，postxxx）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//第一个参数就是提供者的请求路径,第二个参数就是返回类型的字节码对象</span></span><br><span class="line">        <span class="keyword">return</span> template.getForObject(prefix+<span class="string">&quot;provider/getone/&quot;</span>+id,Dept.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consummer/dept/get/list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Dept&gt; <span class="title function_">getall</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//使用Rest调用，提供什么请求方法名对应的前缀就是什么（getxxx，postxxx）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//第一个参数就是提供者的请求路径,第二个参数就是返回类型的字节码对象</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> template.getForObject(prefix+<span class="string">&quot;provider/list&quot;</span>,List.class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="meta">@RequestMapping(&quot;/consummer/dept/getentity/list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getallbyEntity</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//使用Rest调用，提供什么请求方法名对应的前缀就是什么（getxxx，postxxx）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//第一个参数就是提供者的请求路径,第二个参数就是返回类型的字节码对象</span></span><br><span class="line"></span><br><span class="line">        ResponseEntity&lt;List&gt; forEntity = template.getForEntity(prefix + <span class="string">&quot;provider/list&quot;</span>, List.class);</span><br><span class="line">        <span class="type">HttpStatus</span> <span class="variable">statusCode</span> <span class="operator">=</span> forEntity.getStatusCode();</span><br><span class="line">        <span class="type">List</span> <span class="variable">body</span> <span class="operator">=</span> forEntity.getBody();</span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> forEntity.getHeaders();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;(body:)&quot;</span>+body.toString()+<span class="string">&quot;\n&quot;</span>+</span><br><span class="line">                <span class="string">&quot;(statecode:)&quot;</span>+statusCode.toString()+<span class="string">&quot;\n&quot;</span>+</span><br><span class="line">                <span class="string">&quot;(headers:)&quot;</span>+headers.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consummer/dept/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span> <span class="params">(Dept dept)</span>&#123;</span><br><span class="line">        <span class="comment">//使用Rest调用，提供什么请求方法名对应的前缀就是什么（getxxx，postxxx）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//第一个参数就是提供者的请求路径,第二个参数就是返回类型的字节码对象</span></span><br><span class="line">        <span class="comment">//如果是一个对象/map，还需要将这个对象/map也传到方法里</span></span><br><span class="line">        <span class="keyword">return</span> template.postForObject(prefix+<span class="string">&quot;provider/add&quot;</span>,dept,Boolean.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>请求方式主要有两种，get&#x2F;postForObject和get&#x2F;postForEntity</p>
<ul>
<li><p>getForObject：<br>返回对象为响应体中数据转化成的对象，基本上可以理解为Json</p>
</li>
<li><p>getForEntity：<br>返回对象为ResponseEntity对象，包含了响应中的一些重要信息，比如响应头、响应<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E7%8A%B6%E6%80%81%E7%A0%81&spm=1001.2101.3001.7020">状态码</a>、响应体等，通过对象.getxxx方法获得对应的值</p>
</li>
<li><p>config: 配置RestTemplate</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestTemplateConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>主启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptConsummer_80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(DeptConsummer_80.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="eureka"><a href="#eureka" class="headerlink" title="eureka"></a>eureka</h1><p>上面我我们写完了一个服务提供者和消费者，SpringCloud提供了和zookeeper一样的注册中心的功能，这个就是eureka。</p>
<p>实际上eureka和zookeeper几乎差不多，只不过zookeeper需要手动启动，而eureka我们需要自己首先编写服务的代码。</p>
<h2 id="子模块4-springcloud-eureka-7001"><a href="#子模块4-springcloud-eureka-7001" class="headerlink" title="子模块4-springcloud-eureka-7001"></a>子模块4-springcloud-eureka-7001</h2><ul>
<li>eureka依赖，这里是服务器所以用的是server</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>配置yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#eureka配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span> <span class="comment">#eureka服务端实例名称</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span>   <span class="comment">#表示是否向eureka注册，这里在写服务器所以不需要注册</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span>   <span class="comment">#false表示当前这个配置是注册中心</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">service-url:</span>      <span class="comment">#监控页面，访问这个页面http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/就可以看到服务请求等一些东西</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br></pre></td></tr></table></figure>





<ul>
<li>主启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(exclude= &#123;DataSourceAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span>     <span class="comment">//表示开启Eureka注册主启动类，可以接收别人注册进来</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaServer_7001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(EurekaServer_7001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>访问locoalhost：7001</li>
</ul>
<p><img src="/../../images/image-20221130131143996.png" alt="image-20221130131143996"></p>
<h2 id="将子工程2提供的服务向eureka注册"><a href="#将子工程2提供的服务向eureka注册" class="headerlink" title="将子工程2提供的服务向eureka注册"></a>将子工程2提供的服务向eureka注册</h2><ul>
<li>先导入eureka，我们现在不是写服务器，所以导入的不是 <strong>spring-cloud-starter-eureka-server</strong> 这个依赖，而是<strong>spring-cloud-starter-eureka</strong></li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>配置eureka的服务注册地址</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/</span></span><br></pre></td></tr></table></figure>





<ul>
<li><p>主启动类开启@EnableEurekaClient 注解，服务启动后会自动注册到eureka中，</p>
</li>
<li><p>启动 7001 和 8001，反问7001查看监控界面</p>
</li>
</ul>
<p><img src="/../../images/image-20221130132719877.png" alt="image-20221130132719877"></p>
<p>我们注册的服务会在这里显示。</p>
<p>问题：如果我们在访问过程中，8001停止了，会出现上面。</p>
<ul>
<li><p>几分钟之后，eureka会启动自我保护机制</p>
</li>
<li><p><img src="/../../images/image-20221130133153001.png" alt="image-20221130133153001"></p>
</li>
<li><p>某个时刻微服务不可用了，eureka不会立刻清理，依旧会对微服务的信息进行保存。</p>
</li>
<li><p>eureka在一定时间内没有收到服务的心跳，就会停止该实例默认时90s。但是如果时网络出现异常，微服务和eureka无法正常通信，这时候微服务本身是健康的，所以不应该注销这个服务，eureka这时候就会开启自我保护机制，他会保存服务注册表中的信息，不删除服务注册表的数据，等网络恢复之后eurekaserver也会退出当前自我保护模式。</p>
</li>
<li><p>可以通过<code>eureka.server.enable-self-preservation = false</code> 关闭自我保护机制</p>
</li>
</ul>
<h1 id="eureka-和-zookeeper区别"><a href="#eureka-和-zookeeper区别" class="headerlink" title="eureka 和 zookeeper区别"></a>eureka 和 zookeeper区别</h1><h2 id="CAP原则"><a href="#CAP原则" class="headerlink" title="CAP原则"></a>CAP原则</h2><p>cap原则：指的是在一个分布式系统中，<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E4%B8%80%E8%87%B4%E6%80%A7/9840083?fromModule=lemma_inlink">一致性</a>（Consistency）、<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%8F%AF%E7%94%A8%E6%80%A7/109628?fromModule=lemma_inlink">可用性</a>（Availability）、<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%88%86%E5%8C%BA%E5%AE%B9%E9%94%99%E6%80%A7/23734073?fromModule=lemma_inlink">分区容错性</a>（Partition tolerance）。CAP 原则指的是，这三个<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%A6%81%E7%B4%A0/5261200?fromModule=lemma_inlink">要素</a>最多只能同时实现两点，不可能三者兼顾。</p>
<p>一致性（C）：在<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/4905336?fromModule=lemma_inlink">分布式系统</a>中的所有数据备份，在同一时刻是否同样的值。（等同于所有节点访问同一份最新的数据副本）</p>
<p>可用性（A）：保证每个请求不管成功或者失败都有响应。</p>
<p>分区容忍性（P）：系统中任意信息的丢失或失败不会影响系统的继续运作。 </p>
<p>由于网络硬件肯定会出现延迟丢包等问题，所以分区容错性（P）是我们必须需要实现的。所以我们只能在一致性和可用性之间进行权衡。</p>
<h2 id="eureka-和-zookeeper区别-1"><a href="#eureka-和-zookeeper区别-1" class="headerlink" title="eureka 和 zookeeper区别"></a>eureka 和 zookeeper区别</h2><p>eureka 保证的是 AP；zookeeper保证的是 CP。</p>
<p>当向注册中心查询服务列表时，我们可以容忍注册中心返回的是几分钟以前的注册信息，但不能接受服务直接down掉不可用。也就是说，服务注册功能对可用性的要求要高于一致性。</p>
<ul>
<li>zookeeper ：CP</li>
</ul>
<p>zookeeper会出现这样一种情况，当master节点因为网络故障与其他节点失去联系时，剩余节点会重新进行leader选举。问题在于，选举leader的时间太长，30~120s，且选举期间整个zookeeper集群都是不可用的，这就导致在选举期间注册服务瘫痪。在云部署的环境下，因为网络问题使得zookeeper集群失去master节点是较大概率会发生的事件，虽然服务最终能够恢复，但是漫长的选举时间导致的注册长期不可用是不能容忍的。但是zookeeper保证了一致性，可以让拿到的数据是最新的数据。</p>
<ul>
<li>eureka： AP</li>
</ul>
<p>Eureka各个节点都是平等的，几个节点挂掉不会影响正常节点的工作，剩余的节点依然可以提供注册和查询服务。而Eureka的客户端在向某个Eureka注册时，如果发现连接失败，则会自动切换至其他节点，只要有一台Eureka还在，就能保住注册服务的可用性，只不过查到的信息可能不是最新的，除此之外，Eureka还有一种自我保护机制，如果在15分钟内超过85%的节点都没有正常的心跳，那么Eureka就认为客户端与注册中心出现了网络故障，此时会出现以下几种情况:<br>  1.Eureka不再从注册列表中移除因为长时间没收到心跳而应该过期的服务<br>  2.Eureka仍然能够接受新服务的注册和查询请求，但是不会被同步到其他节点上(即保证当前节点	依然可用)<br>  3.当网络稳定时，当前实例新的注册信息会被同步到其他节点中</p>
<p>&#x3D;&#x3D;因此，eureka可以很好的应对网络故障导致部分节点失去联系的情况，不会像zookeeper那样使整个注册服务瘫痪。&#x3D;&#x3D;</p>
<h1 id="ribbon"><a href="#ribbon" class="headerlink" title="ribbon"></a>ribbon</h1><p>ribbon是 是一套实现客户端负载均衡的工具。</p>
<p>目的就是为了在客户端发起多个访问的时候能过将请求平均分配到多个服务上，从而达到高可用。</p>
<ul>
<li>首先这个是在消费者用户端使用的，所以只需要在用户端导入这个依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-ribbon<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>配置eureka</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">    	<span class="comment">#如果有多个 eureka注册中心，只需要用 逗号隔开</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span>   <span class="comment">#不向eureka注册自己</span></span><br></pre></td></tr></table></figure>





<ul>
<li>由于我们是通过RestTemplate进行发送请求的，所以只要在RestTemplate做负载均衡就行了，只需要加上一个注解，springcloud会帮我们自动完成。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestTemplateConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>主启动类开启eureka</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptConsummer_80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(DeptConsummer_80.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li><p>有个问题，我们controller现在是写死的，通过ip去请求的服务，但是如果我们有多个服务提供者，ip都不相同怎么办？</p>
<ul>
<li>我们在上面eureka注册界面上看到过有一个注册实例的名字</li>
</ul>
<p><img src="/../../images/image-20221130153754514.png" alt="image-20221130153754514"></p>
</li>
</ul>
<p>​		并且如果有多个提供者提供这个服务，那么他们的服务的名字肯定都是相同的，所以我们可以通过，服务名去发送请求。</p>
<p><img src="/../../images/image-20221130153938705.png" alt="image-20221130153938705"></p>
<ul>
<li>结果</li>
</ul>
<p><img src="/../../images/image-20221130153954478.png" alt="image-20221130153954478"></p>
<p> 实际上这里并看不出什么负载均衡的操作。因为我们服务提供者就一个，用户怎么均衡都只能去这里查数据。</p>
<p>现在我们将数据库和服务提供者都复制三份。</p>
<p><img src="/../../images/image-20221130160023743.png" alt="image-20221130160023743"></p>
<ul>
<li><p>可以看到后面就被标记了三个服务提供者，但是是同一个服务名</p>
</li>
<li><p>这时候我们通过 消费者去访问应该会分别查不同的提供者，不同的提供者的 db_source字段不相同</p>
</li>
<li><p>第一次：</p>
<p><img src="/../../images/image-20221130160227551.png" alt="image-20221130160227551"></p>
</li>
<li><p>第二次</p>
</li>
</ul>
<p><img src="/../../images/image-20221130163239812.png" alt="image-20221130163239812"></p>
<ul>
<li>第三次</li>
</ul>
<p><img src="/../../images/image-20221130163254674.png" alt="image-20221130163254674"></p>
<h1 id="Feign"><a href="#Feign" class="headerlink" title="Feign"></a>Feign</h1><p>Feign和ribbon都是一个实现负载均衡的一个工具</p>
<ul>
<li><p>ribbon ：面向服务 用的是服务名去请求的</p>
</li>
<li><p>Feign： 面向接口去访问，实际上是一个对ribbon的封装，通过注解去实现。</p>
</li>
<li><p>首先还是导入Feign的依赖</p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-feign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>Feign 的核心在于通过一个接口去为controller提供服务，controller中直接用@Autired 将这个接口注入</li>
</ul>
<p><img src="/../../images/image-20221130175139646.png" alt="image-20221130175139646"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;SPRING-CLOUD-PROVIDER&quot;)</span>   <span class="comment">//服务名</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeptService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里的映射是提供者的Controller的请求路径</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/provider/add&quot;)</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">addDept</span><span class="params">(Dept dept)</span>;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/provider/list&quot;)</span></span><br><span class="line">    List&lt;Dept&gt; <span class="title function_">getAll</span><span class="params">()</span>;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/provider/getone/&#123;id&#125;&quot;)</span></span><br><span class="line">    Dept <span class="title function_">getone</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">int</span> id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptFeignController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptService service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/feign/dept/add&quot;)</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">addDept</span><span class="params">(Dept dept)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> service.addDept(dept);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/feign/dept/get/list&quot;)</span></span><br><span class="line">    List&lt;Dept&gt; <span class="title function_">getAll</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> service.getAll();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/feign/dept/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    Dept <span class="title function_">getone</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> service.getone(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>主启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients(basePackages = &#123;&quot;com.yhz.springcloud&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptfeignConsummer_80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DeptfeignConsummer_80.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>使用Feign的整个调用流程相当于是 通过Controller的路径调用service的方法，service的方法上中有@RequestMapping注解，里面映射到提供者Controller的请求路径，Service接口外面有配置的@FeignClient(value &#x3D; “SPRING-CLOUD-PROVIDER”)  就是对应的服务名，两个会进行拼接&#x3D;&#x3D;http：&#x2F;&#x2F;value&#x2F;mapping的值&#x3D;&#x3D; ，从而请求到提供者的Controller中的方法</li>
</ul>
<h1 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h1><p>我们在访问一个服务的时候，假设存在一个服务调用链，A–&gt;B–&gt;C–&gt;D，这个时候如果很多用户的请求同时到来，但是我们的服务链出现故障，假设是C出现故障，那么所有请求都会停留在 A和B，随着请求增多，A和B占用的系统资源也越多，最后导致系统奔溃，这个就是<strong>雪崩效应</strong></p>
<p>Hystrix是一个用于处理分布式系统的延迟和容错的开源库，在分布式系统里，许多依赖不可避免的会调用失败，比如超时，异常等，Hystrix能够保证在一个依赖出问题的情况下，不会导致整体服务失败，避免级联故障，以提高分布式系统的弹性。 也被称为熔断器。</p>
<p>“断路器”本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障监控（类似熔断保险丝)，向调用方返回一个服务预期的，可处理的备选响应(FallBack)，而不是长时间的等待或者抛出调用方法无法处理的异常，这样就可以保证了服务调用方的线程不会被长时间，不必要的占用，从而避免了故障在分布式系统中的蔓延，乃至雪崩</p>
<ul>
<li>依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>添加注解，和备选方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;provider/getone/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;hystrix_getonebyid&quot;)</span>  <span class="comment">//如果出现了异常就会去调用这个方法</span></span><br><span class="line"><span class="keyword">public</span> Dept <span class="title function_">getonebyid</span><span class="params">(<span class="meta">@PathVariable</span> (value = <span class="string">&quot;id&quot;</span>)</span> <span class="type">int</span> id)&#123;</span><br><span class="line">    <span class="type">Dept</span> <span class="variable">getone</span> <span class="operator">=</span> deptService.getone(id);</span><br><span class="line">    <span class="keyword">if</span>(getone==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getone;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Dept <span class="title function_">hystrix_getonebyid</span><span class="params">(<span class="meta">@PathVariable</span> (value = <span class="string">&quot;id&quot;</span>)</span> <span class="type">int</span> id)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Dept</span>().setDeptname(<span class="string">&quot;no foud by id&quot;</span>+id).setDeptno((<span class="type">long</span>) id).setDb_source(<span class="string">&quot;no found id&quot;</span>+id+<span class="string">&quot; in mysql&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>主启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.yhz.mapper&quot;)</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span>   <span class="comment">//断路器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptHystrixProviderr_8001</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DeptHystrixProviderr_8001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="Zuul"><a href="#Zuul" class="headerlink" title="Zuul"></a>Zuul</h1><p>Zuul包含了对请求的路由和过滤两个最主要的功能:<br>        其中路由功能负责将外部请求转发到具体的微服务实例上，是实现外部访问统一入口的基础，而过滤器功能则负责对请求的处理过程进行干预，是实现请求校验，服务聚合等功能的基础。Zuul和Eureka进行整合，将Zuul自身注册为Eureka服务治理下的应用，同时从Eureka中获得其他微服务的消息，也即以后的访问微服务都是通过Zuul跳转后获得。<br>注意:</p>
<ul>
<li><p>Zuul服务最终还是会注册进Eureka</p>
</li>
<li><p>提供:代理＋路由＋过滤三大功能!</p>
</li>
</ul>
<p>实际上就是我们现在访问每个服务都是通过直接输入对应的ip：localhost：xxxx这样的形式，但是现在我们不希望用户直接访问我们的这个 ip，而是通过一个统一的路由，这个路由中会包括需要被管理的服务，既然如此那也就说明Zuul提供的路由管理需要被注册到Eureka的注册中心中，才能去发现提供服务。</p>
<ul>
<li>依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>配置：可以都用默认配置</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">spring-cloud-zuul</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#eureka</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/</span></span><br></pre></td></tr></table></figure>



<ul>
<li>主启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(exclude= &#123;DataSourceAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">springcloud_zuul_9001</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(springcloud_zuul_9001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这时候我们肯定是可以同通过 provider 提供的ip进行访问的</p>
<p><img src="/../../images/image-20221205145006663.png" alt="image-20221205145006663"></p>
<p>但是我们现在配置了路由网关，我们不希望把provider 的ip暴露出去，所以我们可以通过zuul的ip+注册的服务名+服务对应的url进行访问</p>
<p><img src="/../../images/image-20221205145125459.png" alt="image-20221205145125459"></p>
<p>但是现在这样的话我们把服务名暴露出去了，这也不是我们希望看到的，所以我们可以通过zuul的一些配置，对ip进行自定义路由。</p>
<ul>
<li>配置</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">mydept.serviceId:</span> <span class="string">spring-cloud-provider</span>    <span class="comment">#服务名</span></span><br><span class="line">    <span class="attr">mydept.path:</span> <span class="string">/springcloud/**</span>    <span class="comment">#替换为这个路径进行访问</span></span><br><span class="line">  <span class="attr">ignored-services:</span> <span class="string">&quot;*&quot;</span>     <span class="comment">#所有以服务名访问都失效</span></span><br></pre></td></tr></table></figure>





<ul>
<li>以服务名访问</li>
</ul>
<p><img src="/../../images/image-20221205145829884.png" alt="image-20221205145829884"></p>
<ul>
<li>用自定义配置的路径 访问</li>
</ul>
<p><img src="/../../images/image-20221205145914807.png" alt="image-20221205145914807"></p>
<p><strong>至此，springcloud netflix 的五大核心组件的  简单应用都已经结束，下面是SpringCloud config的内容，用于管理那么多微服务的配置，以及如何离开本地，访问云端配置。</strong></p>
<h1 id="SpringCloud-Config"><a href="#SpringCloud-Config" class="headerlink" title="SpringCloud Config"></a>SpringCloud Config</h1><p><img src="/../../images/image-20221205150612331.png" alt="image-20221205150612331"></p>
<p>我们的配置可能再本地也可能再云端（默认是git），肯定希望再云端比较理想，所有开发人员都可以进行访问，修改。</p>
<p>Spring Cloud Config 为微服务架构中的微服务提供集中化的外部配置支持，配置服务器为各个不同微服务应用的所有环节提供了一个中心化的外部配置。</p>
<p>Spring Cloud Config 分为服务端和客户端两部分;</p>
<p>​		服务端也称为分布式配置中心，它是一个独立的微服务应用，用来连接配置服务器并为客户端提供获取配置信息，加密，解密信息等访问接口。</p>
<p>​		客户端则是通过指定的配置中心来管理应用资源，以及与业务相关的配置内容，并在启动的时候从配置中心获取和加载配置信息。配置服务器默认采用git来存储配置信息，这样就有助于对环境配置进行版本管理。并且可以通过git客户端工具来方便的管理和访问配置内容。	</p>
<h1 id="Cloud-升级（2022-01）"><a href="#Cloud-升级（2022-01）" class="headerlink" title="Cloud 升级（2022.01）"></a>Cloud 升级（2022.01）</h1><p>随着SpringCloud 的迭代和跟新，好多原本的技术都出现了问题，以及停止跟新或者不推荐使用了，具体跟新不推荐使用的技术如下：</p>
<p><img src="/../../images/image-20230203172011639.png" alt="image-20230203172011639"></p>
<p>以一个实际的项目进行引入，遵循SpringCloud 最基本的流程，并且顺便回顾一下上面的部分内容：</p>
<ul>
<li>父工程下建立 module</li>
<li>当前module引入依赖</li>
<li>写yml文件</li>
<li>修改主启动类</li>
<li>编写业务逻辑</li>
</ul>
<h2 id="服务提供者8001"><a href="#服务提供者8001" class="headerlink" title="服务提供者8001"></a>服务提供者8001</h2><ul>
<li>创建 module</li>
</ul>
<p><img src="/../../images/image-20230204124251111.png" alt="image-20230204124251111"></p>
<ul>
<li>添加依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">version</span>&gt;</span>Hoxton.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--lombk--&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">&lt;!--junit--&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">&lt;!--fastjson依赖--&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">&lt;!--mybatisPlus依赖--&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--mysql数据库驱动--&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     </span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>配置yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/my_blog?characterEncoding=utf-8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">multipart:</span></span><br><span class="line">      <span class="attr">max-file-size:</span> <span class="string">2MB</span></span><br><span class="line">      <span class="attr">max-request-size:</span> <span class="string">5MB</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-8001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment"># 日志</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure>



<ul>
<li>主启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.yhz.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Payment8001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Payment8001.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>业务代码</li>
</ul>
<p><img src="/../../images/image-20230204124410598.png" alt="image-20230204124410598"></p>
<ul>
<li>服务提供者自测</li>
</ul>
<h2 id="服务消费者80"><a href="#服务消费者80" class="headerlink" title="服务消费者80"></a>服务消费者80</h2><p>​	作为消费者我应该只要和前端打交道，所以我肯定不会存在mapper、service这样的包，应该只会有Controller和其他的类似于utills这样的包。那也因此我们在controller也用不到 @Autwride把service注入，我们在上面也提到过，我们会要用restTemplate 来完成service 的工作。</p>
<p>RestTemplate提供了多种便捷访问远程Http服务的方法， 根据服务提供者的http请求类型选用不同的调用服务的方式，</p>
<table>
<thead>
<tr>
<th>provider</th>
<th>consumer</th>
</tr>
</thead>
<tbody><tr>
<td>post请求</td>
<td>restTemplate.postforxxx  (访问provider的controller的url  ， 参数，返回值.class)</td>
</tr>
<tr>
<td>get请求</td>
<td>restTemplate.getforxxx  (访问provider的controller的url    ,  返回值.class)</td>
</tr>
</tbody></table>
<ul>
<li>新建module</li>
</ul>
<p><img src="/../../images/image-20230204133054127.png" alt="image-20230204133054127"></p>
<ul>
<li>配置pom</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-web --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-web  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-devtools --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.projectlombok/lombok --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-test --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>配置yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server</span></span><br><span class="line">	<span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<ul>
<li>主启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderMain80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderMain80.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li><p>业务类</p>
<p><img src="/../../images/image-20230204133238468.png" alt="image-20230204133238468"></p>
<ul>
<li>config</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/consummer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController80</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PROVIDER_URL</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8001&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/payment/create&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">craete</span><span class="params">(<span class="meta">@RequestBody</span> Payment payment)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(PROVIDER_URL + <span class="string">&quot;/payment/create&quot;</span>, payment, ResponseResult.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(PROVIDER_URL + <span class="string">&quot;/payment/&quot;</span> + id, ResponseResult.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</li>
<li><p>测试</p>
</li>
</ul>
<p><img src="/../../images/image-20230204133026538.png" alt="image-20230204133026538"></p>
<h2 id="注册中心"><a href="#注册中心" class="headerlink" title="注册中心"></a>注册中心</h2><p>​	所有微服务架构中都需要一个注册中心，因为当服务量变大之后，消费者和服务提供者的请求越来越复杂，所以需要有一个中间人对服务进行统一的管理和监控。</p>
<h3 id="eureka-1"><a href="#eureka-1" class="headerlink" title="eureka"></a>eureka</h3><p>eureka在上面也说到过，eureka是CS模式的（所以他是两个组件一个是server用于注册服务，另一个是Client 这是需要注册的哪些服务使用的，表示将自己注册给eureka），服务注册服务器管理多个服务提供者，并且监听他们的心跳判断某个微服务是否可用，服务器自己也不是单点的，因为这样可以有效的避免单点故障。</p>
<p><img src="/../../images/image-20230204140754709.png" alt="image-20230204140754709"></p>
<h4 id="server使用"><a href="#server使用" class="headerlink" title="server使用"></a>server使用</h4><p>简单回顾一下 eureka的 使用，依旧是那五步。</p>
<ul>
<li>新建module</li>
</ul>
<p><img src="/../../images/image-20230204142122063.png" alt="image-20230204142122063"></p>
<ul>
<li>pom</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yhz<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-aip-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--这里和之前的eureka有点不一样，这是新版的eureka server--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yhz<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-provider-payment8001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment">#是否向eureka 注册自己</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#表示当前只是注册中心只负责维护服务实例</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">   </span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#eureka 的访问地址,监控中心</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br></pre></td></tr></table></figure>



<ul>
<li>主启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span>     <span class="comment">//开启注册中心</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaServer7001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(EurekaServer7001.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>业务类 没有</li>
</ul>
<h4 id="client-使用"><a href="#client-使用" class="headerlink" title="client 使用"></a>client 使用</h4><ul>
<li><p>client是需要注册的服务用的，所以是已经存在了的，不需要新建module，只需要在需要注册的服务module修改pom、yml和主启动类就行了</p>
</li>
<li><p>在payment-8001 的pom 新增</p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>在payment-8001 的yml 新增</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/</span>	<span class="comment"># eureka注册中心的地址</span></span><br></pre></td></tr></table></figure>



<ul>
<li>在payment-8001 的主启动类 新增  @EnableEurekaClient 表示当前微服务需要加入eureka</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.yhz.mapper&quot;)</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Payment8001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Payment8001.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>测试</li>
</ul>
<p><img src="/../../images/image-20230204144504248.png" alt="image-20230204144504248"></p>
<p>上面对 这一块内容有解释部分的含义。 Applicaiton就是 微服务的名字，和我们在yml中配置的一样。</p>
<p>这样一个简单的单点eureka的注册中心就搭建完了，但是实际中肯定不可能只是单点的注册中心，因为如果只有一个，这台服务器出现故障的话所有服务都找不到了，整个系统就崩了。</p>
<h4 id="eureka集群server使用"><a href="#eureka集群server使用" class="headerlink" title="eureka集群server使用"></a>eureka集群server使用</h4><p>实际上eureka集群可以用一句话进行概括，相互注册，对外暴露整体。即多个注册中心两两之间相互注册，对外暴露一个整体。</p>
<p>先新增一个除了端口号以外完全一样的eureka-server7002</p>
<ul>
<li>修改yml</li>
</ul>
<p><img src="/../../images/image-20230204152223490.png" alt="image-20230204152223490"></p>
<ul>
<li>测试 访问7001 看他是否注册了 7002 ，访问7002 看他是否注册了7001，但是我们没有修改端口映射，所以集群显示的名字都是 localhost，但是和上面单机的相比有明显的区别在DS Replicas上，这一行表示的就是ds的副本。</li>
</ul>
<p><img src="/../../images/image-20230204153133323.png" alt="image-20230204153133323"></p>
<p><img src="/../../images/image-20230204153144262.png" alt="image-20230204153144262"></p>
<p><img src="/../../images/image-20230204153323804.png" alt="image-20230204153323804"></p>
<h4 id="eureka集群client使用"><a href="#eureka集群client使用" class="headerlink" title="eureka集群client使用"></a>eureka集群client使用</h4><p>这个其实只需要修改服务的yml，在单机时候，我们注册服务的时候只要写一个 eureka中心的地址，现在我们就只是把所有的eureka的地址都加上而已。</p>
<p><img src="/../../images/image-20230204153604589.png" alt="image-20230204153604589"></p>
<h4 id="多个微服务提供者，整合Ribbon实现负载均衡"><a href="#多个微服务提供者，整合Ribbon实现负载均衡" class="headerlink" title="多个微服务提供者，整合Ribbon实现负载均衡"></a>多个微服务提供者，整合Ribbon实现负载均衡</h4><p>复制一份8001服务，端口号改为8002，为了能看出效果我们在Controller 返回值之前输出一下 请求到的端口号。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverport;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/create&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">create</span><span class="params">(<span class="meta">@RequestBody</span> Payment payment)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServletRequestAttributes</span> <span class="variable">requestAttributes</span> <span class="operator">=</span> (ServletRequestAttributes)RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> requestAttributes.getResponse();</span><br><span class="line">        response.getOutputStream().println(<span class="string">&quot;server_port:&quot;</span>+serverport);</span><br><span class="line">        <span class="keyword">return</span> paymentService.create(payment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span>  ResponseResult <span class="title function_">getbyid</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServletRequestAttributes</span> <span class="variable">requestAttributes</span> <span class="operator">=</span> (ServletRequestAttributes)RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> requestAttributes.getResponse();</span><br><span class="line">        response.getOutputStream().println(<span class="string">&quot;server_port:&quot;</span>+serverport);</span><br><span class="line">        <span class="keyword">return</span> paymentService.selectById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>自测</li>
</ul>
<p><img src="/../../images/image-20230205105756522.png" alt="image-20230205105756522"></p>
<p>那对于消费者，我们之前是直接写死ip地址的，如今有多个ip都可用，我们肯定不能在消费者的controller上写死，那用什么标识？</p>
<p>当然是我们可以用服务的名称对提供同一个服务的所有ip都用的是同一个名称，所以我们直接用服务名称去访问服务就行了。</p>
<p><img src="/../../images/image-20230205110049961.png" alt="image-20230205110049961"></p>
<p>还需要修改的是，我们现在这个URL肯定不是一个主机名，消费者直接访问肯定是访问不到的，所以我们还需要对服务名进行映射。我们是使用restemplate进行远程RPC访问，我们只需要让resteplate能够识别出服务名就行了，所以在注入容器的时候通过 @LoadBalanced，Ribbon会自动帮我们完成ip映射。</p>
<p><img src="/../../images/image-20230205110409869.png" alt="image-20230205110409869"></p>
<ul>
<li>测试</li>
</ul>
<p><img src="/../../images/image-20230205114529977.png" alt="image-20230205114529977"></p>
<p><img src="/../../images/image-20230205114537712.png" alt="image-20230205114537712"></p>
<h4 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h4><p>我们可以拿到某个微服务的信息包括，端口号、访问的uri、包括的服务等信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/discovery&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">discovery</span><span class="params">()</span>&#123;</span><br><span class="line">    HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; services = discoveryClient.getServices();</span><br><span class="line">    map.put(<span class="string">&quot;service&quot;</span>,services);</span><br><span class="line"></span><br><span class="line">    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;CLOUD-PAYMENT-PROVIDER&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;instances&quot;</span>,instances);</span><br><span class="line">    <span class="keyword">return</span> ResponseResult.okResult(map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>测试，这些都是我们注册的微服务的一些信息，都可以通过getXXX获取，</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;操作成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;instances&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">8001</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;management.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8001&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;jmx.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;56810&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;secure&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://admin:8001&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;instanceId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin:cloud-payment-provider:8001&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;serviceId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CLOUD-PAYMENT-PROVIDER&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;instanceInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;instanceId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin:cloud-payment-provider:8001&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;app&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CLOUD-PAYMENT-PROVIDER&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;appGroupName&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ipAddr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.31.22&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;na&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;homePageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://admin:8001/&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;statusPageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://admin:8001/actuator/info&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;healthCheckUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://admin:8001/actuator/health&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;secureHealthCheckUrl&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;vipAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cloud-payment-provider&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;secureVipAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cloud-payment-provider&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;countryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;dataCenterInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MyOwn&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;hostName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UP&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;overriddenStatus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;leaseInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;renewalIntervalInSecs&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;durationInSecs&quot;</span><span class="punctuation">:</span> <span class="number">90</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;registrationTimestamp&quot;</span><span class="punctuation">:</span> <span class="number">1675569287671</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;lastRenewalTimestamp&quot;</span><span class="punctuation">:</span> <span class="number">1675569557841</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;evictionTimestamp&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;serviceUpTimestamp&quot;</span><span class="punctuation">:</span> <span class="number">1675569287671</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;isCoordinatingDiscoveryServer&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;management.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8001&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;jmx.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;56810&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;lastUpdatedTimestamp&quot;</span><span class="punctuation">:</span> <span class="number">1675569287671</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;lastDirtyTimestamp&quot;</span><span class="punctuation">:</span> <span class="number">1675569287656</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;actionType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ADDED&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;asgName&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;scheme&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">8002</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;management.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8002&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;jmx.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;56888&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;secure&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://admin:8002&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;instanceId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin:cloud-payment-provider:8002&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;serviceId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CLOUD-PAYMENT-PROVIDER&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;instanceInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;instanceId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin:cloud-payment-provider:8002&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;app&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CLOUD-PAYMENT-PROVIDER&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;appGroupName&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ipAddr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.31.22&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;sid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;na&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;homePageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://admin:8002/&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;statusPageUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://admin:8002/actuator/info&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;healthCheckUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://admin:8002/actuator/health&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;secureHealthCheckUrl&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;vipAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cloud-payment-provider&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;secureVipAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cloud-payment-provider&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;countryId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;dataCenterInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;@class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MyOwn&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;hostName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UP&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;overriddenStatus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;leaseInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;renewalIntervalInSecs&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;durationInSecs&quot;</span><span class="punctuation">:</span> <span class="number">90</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;registrationTimestamp&quot;</span><span class="punctuation">:</span> <span class="number">1675569290166</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;lastRenewalTimestamp&quot;</span><span class="punctuation">:</span> <span class="number">1675569560319</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;evictionTimestamp&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;serviceUpTimestamp&quot;</span><span class="punctuation">:</span> <span class="number">1675569290166</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;isCoordinatingDiscoveryServer&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;management.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8002&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;jmx.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;56888&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;lastUpdatedTimestamp&quot;</span><span class="punctuation">:</span> <span class="number">1675569290166</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;lastDirtyTimestamp&quot;</span><span class="punctuation">:</span> <span class="number">1675569290150</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;actionType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ADDED&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;asgName&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;scheme&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;service&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;cloud-payment-provider&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;cloud-payment-privider80&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>





<p><strong>eureka 停更</strong></p>
<p><img src="/../../images/image-20230205124754376.png" alt="image-20230205124754376"></p>
<h3 id="zookeeper"><a href="#zookeeper" class="headerlink" title="zookeeper"></a>zookeeper</h3><p>eureka 停止跟新之后，现在新的注册中心有很多，用zookeeper整合springcloud就是其中一种。</p>
<p>…..</p>
<h3 id="Consul"><a href="#Consul" class="headerlink" title="Consul"></a>Consul</h3><p><img src="/../../images/image-20230205130040734.png" alt="image-20230205130040734"></p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://www.consul.io/downloads.html">https://www.consul.io/downloads.html</a></p>
<p>下载好后只有一个exe文件</p>
<p><img src="/../../images/image-20230205131118695.png" alt="image-20230205131118695"></p>
<p>开发者模式运行</p>
<p>consul agent -dev</p>
<p>默认的端口号是：8500，可以访问consul的web界面</p>
<p><img src="/../../images/image-20230205131204994.png" alt="image-20230205131204994"></p>
<h4 id="provider使用"><a href="#provider使用" class="headerlink" title="provider使用"></a>provider使用</h4><p> 和eureka 使用一样都是那五步。</p>
<ul>
<li>新建module</li>
<li>pom配置</li>
</ul>
<p>把 eureka的 依赖换成 consul的就可以了</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>yml</li>
</ul>
<p>改了一下 eureka的配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8003</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/my_blog?characterEncoding=utf-8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">multipart:</span></span><br><span class="line">      <span class="attr">max-file-size:</span> <span class="string">2MB</span></span><br><span class="line">      <span class="attr">max-request-size:</span> <span class="string">5MB</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-provider</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment"># 日志</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure>



<ul>
<li>主启动类</li>
</ul>
<p>把开启eureka的 注解删掉就行了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.yhz.mapper&quot;)</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Payment8003</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Payment8003.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>测试</li>
</ul>
<p><img src="/../../images/image-20230205135021837.png" alt="image-20230205135021837"></p>
<p><img src="/../../images/image-20230205135029524.png" alt="image-20230205135029524"></p>
<p>有些时候Service ‘cloud-payment-provider’ check可能出现红叉，有可能是没有导入actuator 依赖导致的</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h4 id="consumer使用"><a href="#consumer使用" class="headerlink" title="consumer使用"></a>consumer使用</h4><ul>
<li>pom</li>
</ul>
<p>同样加一个consul的依赖就行了</p>
<ul>
<li>yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>主启动类</li>
</ul>
<p>删掉eureka注解</p>
<ul>
<li>业务类，同样的方式访问注册在consul中的服务</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/consul&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">consul</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(PROVIDER_URL + <span class="string">&quot;/payment/consul&quot;</span>, String.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>测试</li>
</ul>
<p><img src="/../../images/image-20230205141351988.png" alt="image-20230205141351988"></p>
<p><img src="/../../images/image-20230205141405582.png" alt="image-20230205141405582"></p>
<h3 id="三个注册中心的异同"><a href="#三个注册中心的异同" class="headerlink" title="三个注册中心的异同"></a>三个注册中心的异同</h3><p>其实上最主要的还是就是 CAP原则上的区别</p>
<p><img src="/../../images/image-20230205141925677.png" alt="image-20230205141925677"></p>
<p><img src="/../../images/image-20230205142004041.png" alt="image-20230205142004041"></p>
<h2 id="服务调用"><a href="#服务调用" class="headerlink" title="服务调用"></a>服务调用</h2><h3 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h3><p>虽然Ribbon现在也进入停产状态，但是它的优秀目前没有新的技术能够完全替代，大量的 Ribbon+eureka还在使用。</p>
<p>它的主要功能上面也提过主要时用来完成服务调用和负载均衡的，但是Ribbon完成的时进程内的负载均衡，那Nginx也能做负载均衡，他们有什么区别。</p>
<p>Nginx实现的是集中式负载均衡，相当于是一个大门，所有请求都会先到nginx，nginx负责请求转发。</p>
<p>Ribbon是进程内负载均衡，是进入大门之后完成协调的，nginx转发后知道调用哪个接口时，有Ribbon实现的算法选择一个服务器去调用对应的接口，也就是会在注册中心上获取注册信息服务列表之后缓存到本地的JVM，在本地实现RPC远程调用。</p>
<h4 id="LB算法替换"><a href="#LB算法替换" class="headerlink" title="LB算法替换"></a>LB算法替换</h4><p>Ribbon 默认的LB算法是 轮询算法，如果我们要替换实现算法应该怎么替换？可以替换成哪些呢？</p>
<ul>
<li>可替换选项</li>
</ul>
<p><img src="/../../images/image-20230205145317327.png" alt="image-20230205145317327"></p>
<ul>
<li>如何替换</li>
</ul>
<p>官方文档明确给出了警告:<br>这个自定义配置类不能放在@ComponentScan所扫描的当前包下以及子包下，<br>否则我们自定义的这个配置类就会被所有的Ribbon客户端所共享，达不到特殊化定制的目的了。</p>
<p>意思就是切换LB算法，我们的配置不能和 有@ComponentScan 注解的类 放在同一个包或者它的子包下，但是我们的主启动类有@SpringBootApplication，这个注解里面是加了@ComponentScan的，所以意思就是我们不能和主启动类在同一个包下。</p>
<p><img src="/../../images/image-20230205145723353.png" alt="image-20230205145723353"></p>
<p>建立完了之后要被Spring知道，所以要在主启动类上进行配置 只需要一个注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@RibbonClient(name = &quot;CLOUD-PAYMENT-SERVICE&quot;,configuration = ChangeRule.class)</span>  <span class="comment">//name 就是消费者要访问的微服务名称对哪个微服务使用我们自己的算法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderConsulMain80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderConsulMain80.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="轮询的原理"><a href="#轮询的原理" class="headerlink" title="轮询的原理"></a>轮询的原理</h4><p>实际上就是通过我们上面有用到一个DiscoveryClient ，我们可以通过服务名称获得注册这个服务名称的 ip有几个，存在一个List 集合中</p>
<blockquote>
<p>加上当前我们的List 有两个元素 8001，8002</p>
<p>轮询根据每一次的Rest请求和服务器总数（List的size）取余，得到一个index，返回 list中对应的 index</p>
<p>每次重启服务 Rest从1开始重新计数</p>
<p>1 % 2 &#x3D; 1 index &#x3D; 1 list.get(index)    8001</p>
<p>2 % 2 &#x3D; 0 index &#x3D; 0 list.get(index)    8002</p>
<p>…  </p>
</blockquote>
<h3 id="OpenFeign"><a href="#OpenFeign" class="headerlink" title="OpenFeign"></a>OpenFeign</h3><p>Feign 已经可以说是完全被 OpenFeign代替了。</p>
<p>他是一个面向接口的服务调用，只需要自定义一个接口和一个注解，就能够代替 ribbon+resteplate的工作。所以它也是一个用在消费端的</p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><ul>
<li>新建module</li>
<li>pom</li>
</ul>
<p>多了一个 openfeign的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-privider80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/,http://localhost:7002/eureka/</span></span><br></pre></td></tr></table></figure>



<ul>
<li>主启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span>     <span class="comment">//开启Feign支持</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderFeignMain80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderFeignMain80.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>业务类</li>
</ul>
<p><img src="/../../images/image-20230205160239828.png" alt="image-20230205160239828"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/consummer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController80</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span>  ResponseResult <span class="title function_">getbyid</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> paymentService.getbyid(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>消费者请求了 &#x2F;consummer&#x2F;id ，里面会调用Feign中的service层里的接口方法，接口被@FeignClient标识，所以根据@FeignClient中的值找到对应的微服务，在根据接口上的 路径映射@XXXmapping 拼接成对应provider中的url，找到对应的接口进行调用。</p>
<h4 id="超时控制"><a href="#超时控制" class="headerlink" title="超时控制"></a>超时控制</h4><p>openfeign有一个规定等待请求的时间，默认是一秒，如果一个请求默认1s内没有返回那么openfeign就会报错。</p>
<ul>
<li>8001 provider</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/timeout&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">timeout</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;timeout_test&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>80Feign的service</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/payment/timeout&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">timeout</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>



<ul>
<li>80Feign的controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/timeout&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">timeout</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;timeout_test&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>测试</li>
</ul>
<p><img src="/../../images/image-20230206105424556.png" alt="image-20230206105424556"></p>
<ul>
<li>修改</li>
</ul>
<p>需要修改可以在yml文件中对其时间进行修改</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="comment">#建立连接的时间</span></span><br><span class="line">  <span class="attr">Readtimeout:</span> <span class="number">5000</span></span><br><span class="line">  <span class="comment">#建立连接后，从服务器读取数据的时间</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>





<h4 id="日志增强"><a href="#日志增强" class="headerlink" title="日志增强"></a>日志增强</h4><p>Feign提供了日志打印功能，我们可以通过配置来调整日志级别，从而了解Feign中 Http请求的细书说白了就是对Feign接口的调用情况进行监控和输出</p>
<ul>
<li>日志级别</li>
</ul>
<blockquote>
<p>NONE:   默认的，不显示任何日志;<br>BASIC:   仅记录请求方法、URL、响应状态码及执行时间;<br>HEADERS:  除了BASIC中定义的信息之外，还有请求和响应的头信息;<br>FULL:  除了HEADERS中定义的信息之外，还有请求和响应的正文及元数据。</p>
</blockquote>
<ul>
<li>配置日志级别，以配置类的形式讲级别注入spring</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.Level <span class="title function_">feignLoggerLevel</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>





<ul>
<li>配置yml，对哪个类进行使用</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.yhz.service.PaymentService:</span> <span class="string">debug</span>   <span class="comment">#Feign的service的全类名</span></span><br></pre></td></tr></table></figure>





<ul>
<li>测试</li>
</ul>
<p><img src="/../../images/image-20230206111004016.png" alt="image-20230206111004016"></p>
<h4 id="请求拦截"><a href="#请求拦截" class="headerlink" title="请求拦截"></a>请求拦截</h4><p>在服务之间使用feign调用时，有些时候需要携带特定的请求头才能够反问，这个时候就需要使用到请求拦截器，每次使用feign调用时请求就会被拦截下来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignRequestInterceptor</span> <span class="keyword">implements</span> <span class="title class_">RequestInterceptor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate requestTemplate)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求加上请求头，token ：12345</span></span><br><span class="line">        requestTemplate.header(<span class="string">&quot;token&quot;</span>,<span class="string">&quot;12345&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="服务降级、熔断、限流"><a href="#服务降级、熔断、限流" class="headerlink" title="服务降级、熔断、限流"></a>服务降级、熔断、限流</h2><h3 id="Hystrix-1"><a href="#Hystrix-1" class="headerlink" title="Hystrix"></a>Hystrix</h3><p>部分概念在上面已经说过，有几个名词这里在进行解释一下。</p>
<blockquote>
<p>服务降级：某个服务不可用了需要给用户提供一个备用选项，这个选项可以是新的解决方案也可以是友好的提示（服务器忙，请稍候再试，不让客户端等待并立刻返回一个友好提示，fallback）。</p>
<p>​		导致服务降级的原因：程序异常、超时、服务熔断、线程池&#x2F;信号池打满</p>
<p>服务熔断：服务达到最大访问限制后，直接拒绝访问  break，后面自己尝试恢复</p>
<p>服务限流：高并发下，一定时间内只处理固定个数的服务请求 followlimit</p>
</blockquote>
<h4 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h4><ul>
<li>新建module</li>
<li>新增pom</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li><p>配置yml 不变</p>
</li>
<li><p>业务类 ,一个直接访问，一个模拟复杂业务停止三秒后返回</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">Hystrix_ok</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;返回正常&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">Hystrix_error</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">time</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">    TimeUnit.SECONDS.sleep(time);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;返回耗时(秒)&quot;</span>+time;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>用压力测试工具Jmeter，测试20000个线程请求到Hystrix_error 这个接口，会发现Hystrix_ok 这个接口的访问也会变慢。因为底层都是tomcat，tomcat的默认线程池的线程数被打满了，都用于处理Hystrix_error 这个接口的请求，但是这个接口又要停3s，相当于每个线程都要停3s，我再有一个请求来访问Hystrix_ok 由于请求到来的时候没有可用的线程，所以也会出现需要等待的现象。</li>
</ul>
<p>而且现在还只是 provider的自测，还没有加入consummer的请求，如果consumer也是高并发请求，情况只会更糟。</p>
<ul>
<li>新建consumer的module</li>
<li>pom</li>
<li>yml</li>
<li>业务类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient(&quot;cloud-provider-hystrix-payment&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/ok&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">ok</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/notok&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">error</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>测试 对provider的高压20000个请求，在用consumer请求ok变得更卡，理由和上面一样。</li>
</ul>
<h4 id="优化解决"><a href="#优化解决" class="headerlink" title="优化解决"></a>优化解决</h4><ul>
<li><p>超时等待返回友好界面，让用户不再等待</p>
<ul>
<li>8001 自身做服务降级</li>
</ul>
<p>对模拟复杂业务的请求提供一个 fallback，如果超时了就会调用到fallback指定的方法返回友好界面。</p>
<ul>
<li><p>业务类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;Hystrix_error_Handler&quot;,commandProperties = &#123;  //指定调用fallback的条件，第一个参数是这个线程，第二个参数是超过指定的时间调用</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;3000&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">Hystrix_error</span><span class="params">()</span>  &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">time</span> <span class="operator">=</span> <span class="number">3</span>;	<span class="comment">//出现异常同样能够跳转到fallback方法</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(time);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;返回耗时(秒)&quot;</span>+time;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">Hystrix_error_Handler</span><span class="params">()</span>  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;当前访问人数过多，请稍后重试&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span>   <span class="comment">//开启Hystrix</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Payment_Hystrix8001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Payment_Hystrix8001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<p> <img src="/../../images/image-20230206132621540.png" alt="image-20230206132621540"></p>
</li>
<li><p>除了8001自身做降级服务 以外，还可以在消费者端做降级服务，做法和上述一样，主启动类的注解改为@EnableHystrix，并且更常见的是用在消费者上</p>
</li>
</ul>
</li>
<li><p>看似现在解决了一些问题，但是如果每个方法都要配一个对应的服务降级的方法，显然会让代码变得特别臃肿，并且我们的服务降级的方法现在很明显和我们业务逻辑耦合在一起了，不太满足我们对低耦合的要求。</p>
<ul>
<li><p>全局fallback</p>
<p><img src="/../../images/image-20230206141024305.png" alt="image-20230206141024305"></p>
</li>
</ul>
</li>
</ul>
<h4 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h4><p>当达到一定条件时，拒绝请求，后慢慢尝试恢复链路。 有点像保险丝，当家庭用电负载过高时，跳闸，不允许任何使用电，然后减少用电后恢复回去。</p>
<ul>
<li>在上面的 provider 8001的基础上修改，新增一个请求，这个请求可能会出现服务熔断</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//服务熔断</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentCircuitBreaker_fallback&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;circuitBreaker.enabled&quot;,value = &quot;true&quot;),  //是否开启断路器</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;circuitBreaker.requestVolumeThreshold&quot;,value = &quot;10&quot;),   //请求次数，表示在10次访问中，如果满足下面的条件就要熔断</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;circuitBreaker.errorThresholdPercentage&quot;,value = &quot;60&quot;), //失败率达到60后跳闸</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;circuitBreaker.sleepWindowInMilliseconds&quot;,value = &quot;10000&quot;) //跳闸10000ms后尝试放过一个请求，如果成功关闭断路器，还是失败就继续保持断路</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentCircuitBreaker</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (id &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;*****id 不能负数&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">serialNumber</span> <span class="operator">=</span> IdUtil.simpleUUID();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Thread.currentThread().getName()+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;调用成功,流水号：&quot;</span>+serialNumber;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentCircuitBreaker_fallback</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;id 不能负数，请稍候再试,(┬＿┬)/~~     id: &quot;</span> +id;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>



<ul>
<li><p>测试</p>
<ul>
<li><p>大量请求 负数<br><img src="/../../images/image-20230206152628979.png" alt="image-20230206152628979"></p>
</li>
<li><p>再请求正数<br> <img src="/../../images/image-20230206152705745.png" alt="image-20230206152705745"></p>
</li>
<li><p>过一段时间再请求</p>
<p><img src="/../../images/image-20230206152722672.png" alt="image-20230206152722672"></p>
</li>
</ul>
</li>
</ul>
<h2 id="服务网关"><a href="#服务网关" class="headerlink" title="服务网关"></a>服务网关</h2><p>zuul停止跟新，zuul2迟迟未到，Gateway 代替他们。</p>
<p>zuul2 还没稳定，zuul1是非Reator模式的，所以自然Gateway作为使用了 spring5、spring boot2.0和Project Reator等新技术的网关，更受大家欢迎。</p>
<p>Spring Cloud Gateway 使用的Webflux中的reactor-netty响应式编程组件，底层使用了Netty通讯框架。因此它在高并发和非阻塞式的通信中非常有优势。</p>
<h3 id="Gateway和zuul对比"><a href="#Gateway和zuul对比" class="headerlink" title="Gateway和zuul对比"></a>Gateway和zuul对比</h3><p>在SpringCloud Finchley（也就是F版，现在是H版）正式版之前，Spring Cloud推荐的网关是Netflix提供的Zuul:</p>
<ul>
<li><p>Zuul 1.x，是一个基于阻塞I&#x2F;O的API Gateway</p>
</li>
<li><p>Zuul 1.x基于Servlet 2.5使用阻塞架构它不支持任何长连接(如 WebSocket)Zuul的设计模式和Nginx较像，每次V&#x2F;О操作工作线程中选择一个执行，请求线程被阻塞到工作线程完成，但是差别是Nginx用C++实现ZuulJava 实现，而JVM本身，次加载较慢的情况，使得Zuul的性能相对较差。</p>
</li>
<li><p>Zuul 2.x理念更先进，想基于Netty非阻塞和支持长连接，但SpringCloud目前还没有整合。Zul 2x的性能较Zuul 1.x有较。在性能方面，根据官方提供的基准测试,Spring Cloud Gateway的RPS(每秒请求数）是Zuul的1.6倍。</p>
</li>
<li><p>Spring Cloud Gateway建立在Spring5、Project Reactor和Spring Boot 2之上，使用非阻塞APl。</p>
</li>
<li><p>Spring Cloud Gateway还支持WebSocket，并且与Spring紧密集成拥有更好的开发体验</p>
</li>
</ul>
<h3 id="Gateway三大核心概念"><a href="#Gateway三大核心概念" class="headerlink" title="Gateway三大核心概念"></a>Gateway三大核心概念</h3><p>Route(路由)：根据URI和断言唯一标识一个路由地址，如果断言为true则匹配该路由</p>
<p>Predicate(断言)：可以匹配HTTP请求中的所有内容（例如请求头或请求参数），如果请求与断言相匹配则进行路由</p>
<p>Filter(过滤)：可以在请求被路由前或者之后对请求进行修改。</p>
<h3 id="Route"><a href="#Route" class="headerlink" title="Route"></a>Route</h3><ul>
<li>依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>yml，gateway也是一个微服务所以也需要配置到注册中心</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#eureka 的访问地址,监控中心</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/</span></span><br></pre></td></tr></table></figure>



<ul>
<li><p>业务类：无</p>
</li>
<li><p>主启动类 不变</p>
</li>
<li><p>对一些服务配置路由网关</p>
<ul>
<li>对provider-8001中的两个方法配置路由网关，由于之前的路由在这里不好演示，所以新增了两个方法</li>
</ul>
<p><img src="/../../images/image-20230215201339505.png" alt="image-20230215201339505"></p>
</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_roth</span>   <span class="comment">#路由的id 没有特别要求，只要求唯一</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:8001</span>    <span class="comment">#提供服务的地址</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/gateway/get/**</span>    <span class="comment"># 和 uri会进行拼接，**：是通配符表示什么都可以，前面只要满足是/payment/gateway/get/ 都走这个路由</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_roth2</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:8001</span>    <span class="comment">#提供服务的地址</span></span><br><span class="line">            <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/gateway/**</span></span><br></pre></td></tr></table></figure>



<p>配置完成之后，我们后续的访问就可以不暴露自己微服务的端口号8001进行访问了，直接使用统一端口号9527一样能够访问。</p>
<p>注：启动gateway服务可能会出现以下问题</p>
<p><img src="/../../images/image-20230215211653610.png" alt="image-20230215211653610"></p>
<p>这是因为gateway中已经包含了 web的依赖，不需要再进行引入，需要删掉对web的依赖</p>
<ul>
<li>测试<ul>
<li>8001<br><img src="/../../images/image-20230215203656511.png" alt="image-20230215203656511"></li>
<li>9527<br><img src="/../../images/image-20230215203702181.png" alt="image-20230215203702181"></li>
</ul>
</li>
</ul>
<p>​		上面我们是直接将 uri写死的，只会去找8001这个端口，但是和我们之前有提到过的这就相当于是单机版的，非常不可取，如果多个端口号要怎么路由？ 当然还是用微服务名称进行动态路由就行了。并且我们之前是专门有用Ribbon来做负载均衡，现在网关也需要做负载均衡。</p>
<p>​		gateway配置动态路由非常的简单，同样在yml中配置就可以了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: cloud-gateway</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      discovery:</span><br><span class="line">        locator:</span><br><span class="line">          enabled: <span class="literal">true</span>   #开启注册中心动态路由功能</span><br><span class="line"></span><br><span class="line">      routes:</span><br><span class="line">        - id: payment_roth   #路由的id 没有特别要求，只要求唯一</span><br><span class="line">          #uri: http:<span class="comment">//localhost:8001    #提供服务的地址</span></span><br><span class="line">          uri: lb:<span class="comment">//CLOUD-PAYMENT-PROVIDER		#lb表示要进行负载均衡</span></span><br><span class="line">          predicates:</span><br><span class="line">            - Path=/payment/gateway/get<span class="comment">/**    # 和 uri会进行拼接，**：是通配符表示什么都可以，前面只要满足是/payment/gateway/get/ 都走这个路由</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        - id: payment_roth2</span></span><br><span class="line"><span class="comment">          #uri: http://localhost:8001    #提供服务的地址</span></span><br><span class="line"><span class="comment">          uri: lb://CLOUD-PAYMENT-PROVIDER</span></span><br><span class="line"><span class="comment">          predicates:</span></span><br><span class="line"><span class="comment">            - Path=/payment/gateway/**</span></span><br></pre></td></tr></table></figure>



<ul>
<li>测试</li>
</ul>
<p><img src="/../../images/image-20230215211459517.png" alt="image-20230215211459517"></p>
<p><img src="/../../images/image-20230215211508737.png" alt="image-20230215211508737"></p>
<p> 成功访问且做到了负载均衡</p>
<h3 id="Predicate"><a href="#Predicate" class="headerlink" title="Predicate"></a>Predicate</h3><p>在启动 gateway的时候我们在控制台会看到 一些和Predicate有关的东西</p>
<p><img src="/../../images/image-20230216111708051.png" alt="image-20230216111708051"></p>
<p>我们刚刚只配置了一个Path，那就相当于这里所有都是可以配置的。</p>
<ul>
<li>After： 官方给的例子表示会匹配指定日期之后的路由。只有在指定的时间之后的路由才会匹配</li>
</ul>
<p><img src="/../../images/image-20230216112052079.png" alt="image-20230216112052079"></p>
<p>但是后面的时间串怎么获得的？ Jdk8之后开始有了一个新的类用于获得上面那种格式的时间。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ZonedDateTime</span> <span class="variable">zbj</span> <span class="operator">=</span> ZonedDateTime.now();	<span class="comment">//2022-02-16T12:18:36.174+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>



<ul>
<li><p>Before和Between使用和After一样</p>
</li>
<li><p>Cookie：要求携带Cookie，可以指定携带什么形式的Cookie</p>
</li>
</ul>
<p><img src="/../../images/image-20230216122251961.png" alt="image-20230216122251961"></p>
<p>接收两个参数，是一个k-v键值对，第一个参数是Key，第二个参数是一个正则表达式。</p>
<ul>
<li><p>Head 和Cookie类似，要求带有请求头，接收的也是两个参数 K-V键值对的形式，第一个参数是请求头中要包含的Key，第二个是一个正则表达式的Value</p>
</li>
<li><p>Method：指定哪些请求</p>
</li>
</ul>
<p><img src="/../../images/image-20230216122927157.png" alt="image-20230216122927157"></p>
<ul>
<li>Host：请求的主机的格式，例子中的表示 有  xxx.somehost.org或者xxx.anotherhost.org 都可以访问。</li>
</ul>
<p><img src="/../../images/image-20230216123041992.png" alt="image-20230216123041992"></p>
<ul>
<li>Qurry：访问时携带的参数，可以一个也可以多个都是正则表达式</li>
</ul>
<p><img src="/../../images/image-20230216123309989.png" alt="image-20230216123309989"></p>
<p>Predicate可以配置很多，只有Predicates里面的内容全部匹配成功才能够访问。</p>
<h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><p>包括两种：单一的和全局的，单一的一共有30多种，全局的有10几种。但是使用起来其实和Predicate是类似的。</p>
<p>比如：</p>
<ul>
<li>要求包含请求头</li>
</ul>
<p><img src="/../../images/image-20230216123756702.png" alt="image-20230216123756702"></p>
<ul>
<li>要求包含请求参数</li>
</ul>
<p><img src="/../../images/image-20230216123832532.png" alt="image-20230216123832532"></p>
<p>比较重要的是自定义过滤器。</p>
<p>官方给了一个例子：</p>
<p><img src="/../../images/image-20230216124058396.png" alt="image-20230216124058396"></p>
<p>说明我们要自定义全局过滤器需要实现这两个接口，然后将我们的过滤器注入Spring。</p>
<p>假设需要请求携带username这个参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange:里面包含了很多可用的东西，封装了HttptRequest、Response等</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chain</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> exchange.getRequest().getQueryParams().getFirst(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(username==<span class="literal">null</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;未登录&quot;</span>);</span><br><span class="line">            <span class="comment">//不允许通过</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//继续往下执行</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这个过滤器的优先级</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>不携带</li>
</ul>
<p><img src="/../../images/image-20230216125139034.png" alt="image-20230216125139034"></p>
<ul>
<li>携带</li>
</ul>
<p><img src="/../../images/image-20230216125148410.png" alt="image-20230216125148410"></p>
<h2 id="服务配置中心"><a href="#服务配置中心" class="headerlink" title="服务配置中心"></a>服务配置中心</h2><p>为什么要使用配置中心？</p>
<p>随着服务的增加，我们每增加一个服务必不可少的就是增加一个yml文件，那如果服务注册中心突然要发生改变，那么所有的yml配置文件都需要手动进行改变，太麻烦，不够灵活。所以希望能够有一个总的配置管理中心，能够一次配置处处生效。</p>
<p>是什么？</p>
<p>SpringCloud Config为微服务架构中的微服务提供集中化的外部配置支持，配置服务器为各个不同微服务应用的所有环境提供了一个中心化的外部配置。也就是会将所有配置文件中共有的部分都抽取出来，要使用直接在配置中心中读取。</p>
<p><img src="/../../images/image-20230216130412724.png" alt="image-20230216130412724"></p>
<p>服务端：管理共有的配置，放在GitHUb这样的平台上。</p>
<p>客户端：从服务端获取配置。</p>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><ul>
<li>依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3344</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-config-center</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/yimeng436/test.git</span>	<span class="comment">#github仓库地址</span></span><br><span class="line">          <span class="attr">search-paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">          <span class="attr">default-label:</span> <span class="string">main</span>			<span class="comment">#哪个分支</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br></pre></td></tr></table></figure>



<ul>
<li>主启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span>		<span class="comment">//开启configserver</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Config_Center3344</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Config_Center3344.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>测试</li>
</ul>
<p><img src="/../../images/image-20230216135234607.png" alt="image-20230216135234607"></p>
<p>可以访问仓库中的配置文件。访问形式有几种不同的</p>
<ul>
<li>在yml文件前后都可以加上指定的分支</li>
<li>不加分支默认找master</li>
</ul>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>从服务端读取里面的配置。</p>
<ul>
<li>依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>yml</li>
</ul>
<p>这里的yml有点区别和之前学的，这里我们会先创建一个bootstrap.yml</p>
<p>什么是bootstrap.yml？</p>
<p>applicaiton.yml是用户级的资源配置项；bootstrap.yml是系统级的，优先级更加高。</p>
<p>Spring Cloud会创建一个“BootstrapContext”，作为Spring应用的 Application Context的父上下文。初始化的时候，‘BootstrapContext负责从<strong>外部</strong>源加载配置属性并解析配置。这两个上下文共享一个从外部获取的环境。</p>
<ul>
<li>bootstrap.yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3355</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-client</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:3344</span>    <span class="comment">#服务端的地址</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config</span>  <span class="comment">#配置文件名称</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span>  <span class="comment">#配置文件后缀   将上面的拼接，http://localhost:3344/config-dev.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br></pre></td></tr></table></figure>





<ul>
<li>主启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Config_Clinent3355</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Config_Clinent3355.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>业务类：我们从配置中心读取到了github上的 配置文件，会注入bootstrap.yml中，那我们只要能够拿到对应的值就行了</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/get/info&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getInfo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>测试</li>
</ul>
<p><img src="/../../images/image-20230216145449918.png" alt="image-20230216145449918"></p>
<p>随之而来的问题：现在我们在客户端能够正常读取到github上的配置，但是如果现在我修改了github上的内容，那么很显然我现在的配置不可能能够生效，要生效所有客户端服务就要重启，那这样看来好像并没有特别好用。</p>
<p><strong>解决：</strong></p>
<p>首先要确保引入了actuator这个依赖，因为需要使用到里面的健康监控等功能</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>yml新增配置</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新增暴露监控端口</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>业务类加上自动刷新注解@RefreshScope</li>
</ul>
<p><img src="/../../images/image-20230216150453509.png" alt="image-20230216150453509"></p>
<ul>
<li>跟新之后要求跟新人员给 3355发送一个post请求，提醒3355客户端配置发送变动</li>
</ul>
<p>可以用 postman，也可以用cm的  curl就行发送</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST &quot;http://localhost:3355/actuator/refresh&quot;</span><br></pre></td></tr></table></figure>





<p>但是这样做也存在比较大的问题：如果有很多微服务，每一个都需要发送一次刷新岂不是也很麻烦，所以这一块的内容会被后面的bus代替。</p>
<h2 id="消息总线"><a href="#消息总线" class="headerlink" title="消息总线"></a>消息总线</h2><p>由于Config极限也只能够手动刷新，所以需要Bus配合Config就行消息的传递实现自动刷新的目的。</p>
<p>Spring Cloud Bus是用来将分布式系统的节点与轻量级消息系统链接起来的框架，它整合了Java的事件处理机制和消息中间件的功能。Spring Clud Bus目前支持RabbitMQ和Kafka。</p>
<p>自动刷星有两种实现形式，但是都是让客户端都去订阅同一个MQ，从里面获取。</p>
<p>一种是：先传递给一个客户端，这个客户端再传递给别的客户端</p>
<p>另一种是：直接传递给控制中心，控制中心直接通知全部的客户端。显然 这种的实现比较合理。</p>
<h3 id="配置中心服务端改进"><a href="#配置中心服务端改进" class="headerlink" title="配置中心服务端改进"></a>配置中心服务端改进</h3><p>在服务端我们要使用到bus的RabbitMQ的支持，所以还是先导入它的依赖</p>
<ul>
<li>依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>yml新增 rabbitMQ的配置，以及刷新点</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rabbitmq:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#bus刷新配置的端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;bus-refresh&#x27;</span></span><br></pre></td></tr></table></figure>





<h3 id="配置中心客户端改进"><a href="#配置中心客户端改进" class="headerlink" title="配置中心客户端改进"></a>配置中心客户端改进</h3><ul>
<li>依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>yml增加 RabbitMQ</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rabbitmq:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">guest</span></span><br></pre></td></tr></table></figure>



<ul>
<li>测试：github上更新之后只需要向 配置中心服务端 发送一个 post请求刷新就行了。其他所有客户端都可以收到刷新的结果</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST &quot;http://localhost:3344/actuator/bus-refresh&quot;</span><br></pre></td></tr></table></figure>





<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>在启动工程的时候，SpringCloud会帮我们把引入了依赖的模块都去订阅一个SpringCloudBus的交换机，这个交换机的类型是主题交换机，有几个模块引入了依赖就会有几个队列和这个交换机绑定</p>
<p><img src="/../../images/image-20230216163437022.png" alt="image-20230216163437022"></p>
<p>可以看到Routing key 都是#，所以这个交换机也相当于是一个广播类型的（fanout）交换机，会将消息发送给所有的队列，所以发送一次post请求给 服务端，也相当于发送给了所有的客户端。</p>
<p>如果现在我只希望通知其中的某些客户端，可以根据下面的公式进行发送</p>
<p>curl -X POST “<a target="_blank" rel="noopener" href="http://localhost:3344/actuator/bus-refresh/%7Bdestination%7D&quot;">http://localhost:3344/actuator/bus-refresh/{destination}&quot;</a></p>
<p>{destination}：就是 服务名：端口号 </p>
<p>如：curl -X POST “<a target="_blank" rel="noopener" href="http://localhost:3344/actuator/bus-refresh/config-client:3355">http://localhost:3344/actuator/bus-refresh/config-client:3355</a></p>
<h2 id="Cloud-Stream"><a href="#Cloud-Stream" class="headerlink" title="Cloud Stream"></a>Cloud Stream</h2><p>​		由于现在的系统可能不仅仅包括前后端，后端除了处理逻辑以外可能还需要保存一些数据，提供给大数据平台分析。所以后端到大数据平台又会出现一个消息传输的过程。那么整个系统可能就会存在两套消息传输的中间件。</p>
<p>​		那么这两套中间件可能会出现不同就比如，后端自己使用的是 RabbitMQ，大数据平台使用的是kafka，那就可能会出现技术不同导致，切换、维护、开发带来较大的困难。</p>
<p>​		这种情况和之前我们数据库出现的问题一样，有那么多数据库，驱动和操作都不相同如果都需要掌握那是相当费时的。所以后来出现了JDBC，为我们屏蔽了底层数据库的实现细节。所以我们现在也希望有一门技术能够为我们屏蔽掉MQ的实现细节，能够方便的切换，这就是Cloud Stream。</p>
<h3 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h3><p>Spring Cloud Stream 是一个框架，用于构建与共享消息传递系统连接的高度可扩展的事件驱动微服务。</p>
<p>应用程序中就是通过<strong>消息的生产者</strong>或者<strong>消费者</strong>来和Spring Cloud Stream中 的binder对象进行交互，通过配置来binding，然后binder就会和消息中间件交互。</p>
<p>在SpringBoot中，SpringBoot应用要直接和消息中间件进行交互，所以要满足不同中间件的规定。到了SpringCloud使用Cloud Stream之后，我们的中间层就变成了Cloud Stream的Bind，实现了应用程序和中间件细节的隔离。</p>
<p><img src="/../../images/image-20230216210723208.png" alt="image-20230216210723208"></p>
<p>把这个架构图再细化展开就是Cloud Stream的一些核心部分：</p>
<p><img src="/../../images/image-20230216211043428.png" alt="image-20230216211043428"></p>
<ul>
<li>Binder：连接中间件，屏蔽差异</li>
<li>Channel：实现消息存储转发的媒介，通过对Channel进行配置</li>
<li>Source、Sink：生产者和消费者发出和接收</li>
</ul>
<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><ul>
<li><p>消息生产者</p>
<ul>
<li><p>依赖，这一用的是rabbitmq，如果是kafka就把后缀改为kafka就行了</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>yml</p>
</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8801</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-message-provider</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span>          <span class="comment">#创建一个binder</span></span><br><span class="line">        <span class="attr">defaultRabbits:</span>     <span class="comment">#起一个名字用于和后面的就行绑定</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span>    <span class="comment">#消息中间件的类型</span></span><br><span class="line">          <span class="attr">enviroment:</span>     <span class="comment">#rabbitmq的相关配置</span></span><br><span class="line">            <span class="attr">spring:</span></span><br><span class="line">              <span class="attr">rabbitmq:</span></span><br><span class="line">                <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">                <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">      <span class="attr">bindings:</span></span><br><span class="line">        <span class="attr">outputs:</span>  <span class="comment">#生产者，发送消息的</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">myexchange</span>     <span class="comment">#发送到哪个交换机</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">application/json</span>    <span class="comment">#发送的内容的类型和格式</span></span><br><span class="line">          <span class="attr">binder:</span> <span class="string">defaultRabbits</span>        <span class="comment">#绑定哪个binder</span></span><br></pre></td></tr></table></figure>

<ul>
<li>主启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageProvider8801</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(MessageProvider8801.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>业务类，这里的业务类和我们之前的有点区别，我们现在的业务是什么？对于生产者来说是发送消息，在之前的我们所说的各种业务逻辑都是去操作数据库，让service去调用dao什么的。但是现在我们们变成了去操作Binder对象，去操作底层的MQ，因此我们的一些注解也要发生改变</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yhz.service.Imp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.yhz.service.MessageService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.annotation.EnableBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.messaging.Source;</span><br><span class="line"><span class="keyword">import</span> org.springframework.integration.support.MessageBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.MessageChannel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 现在这里就不是用<span class="doctag">@Service</span>注解了</span></span><br><span class="line"><span class="comment"> * 我们已经不是在操作数据库了，我们现在操作的是消息中间件</span></span><br><span class="line"><span class="comment"> * 要用到的是 Source、Channel、Binder 那一套、</span></span><br><span class="line"><span class="comment"> * 我们是消息发送者，要将这个类和Sourse进行绑定</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableBinding(Source.class)</span>    <span class="comment">//Source是cloud.stream.messageing下的</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">MessageService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MessageChannel output;  <span class="comment">//消息发送者的管道</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">send</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">serid</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">//调用send方法要求将发送的消息封装成Message对象，所以还需要对要发送的消息进行封装</span></span><br><span class="line">        <span class="comment">//MessageBuilder 是org.springframework.integration.support.MessageBuilder;这个包下的</span></span><br><span class="line">        Message&lt;String&gt; message = MessageBuilder.withPayload(serid).build();</span><br><span class="line"></span><br><span class="line">        output.send(message);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;发送&quot;</span>+serid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageSendController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageService messageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/send&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">send</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> messageService.send();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




</li>
<li><p>消息消费者</p>
<ul>
<li>依赖 ：和生产者一样</li>
<li>yml：只需要改变output改成input</li>
</ul>
</li>
</ul>
<p><img src="/../../images/image-20230216230201360.png" alt="image-20230216230201360"></p>
<ul>
<li><ul>
<li>业务类：消费者本质—监听器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yhz.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.annotation.EnableBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.annotation.StreamListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.stream.messaging.Sink;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 和SpringBoot项目一样，消费者实际上就是一个监听器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableBinding(Sink.class)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageReceiveListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@StreamListener(Sink.INPUT)</span></span><br><span class="line">    <span class="comment">//Message :import org.springframework.messaging.Message;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">input</span><span class="params">(Message&lt;String&gt; message)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> message.getPayload();</span><br><span class="line">        log.info(<span class="string">&quot;消费者1号端口号：&quot;</span>+port+<span class="string">&quot;收到消息：&quot;</span>+payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>测试，生产者发送之后</p>
</li>
</ul>
<p><img src="/../../images/image-20230216230302250.png" alt="image-20230216230302250"></p>
<p>在MQ的web上也能看到我们定义的exchange，以及队列</p>
<p><img src="/../../images/image-20230216230458619.png" alt="image-20230216230458619"></p>
<p>上述是一个消费者的情况，如果有两个消费者，这样的形式就会存在一些问题，所有消费者都会收到生产者的消息，导致消息重复消费。</p>
<p><img src="/../../images/image-20230217095419012.png" alt="image-20230217095419012"></p>
<p><img src="/../../images/image-20230217095427386.png" alt="image-20230217095427386"></p>
<p>这是因为RabbitMQ中对于消费者 还有一个组的概念，对于同一个组的消费者他们是竞争关系，同一个消息只会被同一个组内的成员消费一次，而不同组之间就可以重复消费。在没有配置的情况下，一个消费者就会是一个组，这也是重复消费的主要原因。</p>
<p><img src="/../../images/image-20230217095737650.png" alt="image-20230217095737650"></p>
<p>配置也非常简单，我们先改变系统默认分配的组名，再考虑如何将他们分到同一个组。</p>
<ul>
<li>给消费者分配组，只需要在yml中增加一个组的配置即可</li>
</ul>
<p><img src="/../../images/image-20230217100258006.png" alt="image-20230217100258006"></p>
<p>可以在RabbitMQ的管理界面看到，我们的配置组名生效了。</p>
<p><img src="/../../images/image-20230217100421293.png" alt="image-20230217100421293"></p>
<p>要将他们的分到同一个组也就非常简单了，只要他们的group相同就行了。</p>
<p><img src="/../../images/image-20230217101021795.png" alt="image-20230217101021795"></p>
<p>这个group的配置还有一个重要的作用，如果不配置group，每次MQ默认分配的队列名都是不同的，如果中间消费者宕机了，生产者还在继续发生，下次消费者启动的时候它的队列名就又是不同的了，在宕机期间生产者发送的消息就全部丢失了。所以配置group非常重要。</p>
<h2 id="Sleuth"><a href="#Sleuth" class="headerlink" title="Sleuth"></a>Sleuth</h2><p>​		随着我们的微服务逐渐增多，服务调用的链路也越来越长，为了即时发现链路中哪个环节出现了问题，所以需要有一个链路监控的技术。这就是Sleuth提供的。Sleuth负载链路的跟踪和整理，再配合zipkin提供可视化界面。</p>
<p>​	下载zipkin：<a target="_blank" rel="noopener" href="https://repo1.maven.org/maven2/io/zipkin/java/zipkin-server/2.12.9/">Central Repository: io&#x2F;zipkin&#x2F;java&#x2F;zipkin-server&#x2F;2.12.9 (maven.org)</a></p>
<p>下载下来是一个jar 包，直接用java -jar运行。</p>
<p><img src="/../../images/image-20230217102737160.png" alt="image-20230217102737160"></p>
<p>localhost：9411</p>
<p><img src="/../../images/image-20230217102841682.png" alt="image-20230217102841682"></p>
<p>使用也非常简单在需要的地方引入对应的依赖，修改一些yml文件就可以了</p>
<ul>
<li>依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>yml</li>
</ul>
<p><img src="/../../images/image-20230217103803641.png" alt="image-20230217103803641"></p>
<p>在8001和80加入做一个测试，order会调用payment的服务。</p>
<p><img src="/../../images/image-20230217104252105.png" alt="image-20230217104252105"></p>
<p>可以看到记录了请求路径，谁调用的谁</p>
<p><img src="/../../images/image-20230217104320345.png" alt="image-20230217104320345"></p>
<h1 id="Spring-Cloud-Alibaba"><a href="#Spring-Cloud-Alibaba" class="headerlink" title="Spring Cloud Alibaba"></a>Spring Cloud Alibaba</h1><p>在一开始那张图上就可以看到，好多技术都可以用Nacos,来代替这个Nacos就是Spring Cloud Alibaba的技术。其实实际上不仅仅是这些，整个之前的Spring Cloud Netfix都可以被Spring Cloud Alibaba代替。</p>
<p><img src="/../../images/image-20230217105304702.png" alt="image-20230217105304702"></p>
<p>官网：<a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md">https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md</a></p>
<p>主要提供功能：</p>
<p><img src="/../../images/image-20230217105557262.png" alt="image-20230217105557262"></p>
<h2 id="Nacos-服务注册和配置中心"><a href="#Nacos-服务注册和配置中心" class="headerlink" title="Nacos 服务注册和配置中心"></a>Nacos 服务注册和配置中心</h2><p>从名字就能够看出来这个是用于替换，eureka、zookeeper、Consul和Config、Bus的。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/">nacos</a></p>
<p>启动</p>
<p><img src="/../../images/image-20230217111030430.png" alt="image-20230217111030430"></p>
<p>访问：<a target="_blank" rel="noopener" href="http://localhost:8848/nacos">http://localhost:8848/nacos</a></p>
<p><img src="/../../images/image-20230217111048885.png" alt="image-20230217111048885"></p>
<h3 id="Nacos注册中心"><a href="#Nacos注册中心" class="headerlink" title="Nacos注册中心"></a>Nacos注册中心</h3><h4 id="提供者"><a href="#提供者" class="headerlink" title="提供者"></a>提供者</h4><ul>
<li>父工程引入Spring Cloud Alibaba的依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>子工程引入 Nacos-discovery的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacos-discovery--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>yml配置</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-payment-provider-9001</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>主启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NacosPaymentProvider9001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(NacosPaymentProvider9001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>测试</li>
</ul>
<p><img src="/../../images/image-20230217131513209.png" alt="image-20230217131513209"></p>
<p>Nacos天生自带负载均衡，为了验证，在建立一个provider，两个都是取同一个微服务名字。以便于后面验证</p>
<p><img src="/../../images/image-20230217132540570.png" alt="image-20230217132540570"></p>
<h4 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h4><ul>
<li>依赖：不变</li>
<li>yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">90</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-payment-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service-url:</span>		<span class="comment">#用于后面的注入，可以不配</span></span><br><span class="line">  <span class="attr">nacos-user-service:</span> <span class="string">http://nacos-payment-provider</span></span><br></pre></td></tr></table></figure>



<ul>
<li>业务类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerClient loadBalancerClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;service-url.nacos-user-service&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String PROVIDER_URL;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(PROVIDER_URL+<span class="string">&quot;/hello&quot;</span>, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>config</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NacosConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span>		<span class="comment">//由于nacos自带负载均衡 集成了Ribbon所以@LoadBalanced一定要带，不然会出现							UnknowHostException</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>测试</li>
</ul>
<p><img src="/../../images/image-20230217140626836.png" alt="image-20230217140626836"></p>
<p><img src="/../../images/image-20230217140633621.png" alt="image-20230217140633621"></p>
<ul>
<li>也可以集成OpenFeign使用</li>
</ul>
<p><img src="/../../images/image-20230217141732125.png" alt="image-20230217141732125"></p>
<p>Nacos优点：</p>
<ul>
<li>使用简单</li>
<li>自带Ribbon</li>
<li>集成各种技术</li>
<li>支持CP和AP的切换</li>
</ul>
<h3 id="Nacos配置中心"><a href="#Nacos配置中心" class="headerlink" title="Nacos配置中心"></a>Nacos配置中心</h3><p>之前我们使用Spring Cloud 提供的配置管理实现了对配置文件的统一管理，还是用了Bus实现了一次通知修改全员都能够收到修改信号的功能。</p>
<p>同样为了解耦，Nacos将这些功能都集成到一起了，只需要一个Nacos就能够完成。</p>
<ul>
<li>依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li><p>yml，和Config一样有两个yml，一个是从控制中心获取的bootstrap，另一个是自己的application</p>
<ul>
<li><p>bootstrap</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3388</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yml</span>     <span class="comment">#要读取的文件类型</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>application</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span>   <span class="comment">#表示开发环境，还可以是 test、prod，会和bootstrap从控制中心获取的文件就行拼接</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>controller</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span>       <span class="comment">//自动跟新</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/info&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getInfo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>之前我们需要在Github上写配置文件，但是现在我们可以直接在nacos上配置，nacos会帮我们管理。但是配置需要符合一些规则。</p>
<ul>
<li>配置管理的界面</li>
</ul>
<p><img src="/../../images/image-20230217153337454.png" alt="image-20230217153337454"></p>
<ul>
<li><p>配置规则</p>
<ul>
<li>Data Id</li>
</ul>
<p><img src="/../../images/image-20230217153433637.png" alt="image-20230217153433637"></p>
</li>
</ul>
<p>这些东西也对应了我们刚刚bootstrap 和 application中的配置。所以我们在Nacos上配置的Id就应该是配置文件中那些值的组合。需要注意的是Nacos对于 yml和yaml的支持只能是yaml。</p>
<p>然后就去新增我们的配置文件：</p>
<p><img src="/../../images/image-20230217154513224.png" alt="image-20230217154513224"></p>
<p>启动我们的3388</p>
<p><img src="/../../images/image-20230217154944190.png" alt="image-20230217154944190"></p>
<p>并且Nacos自己就是动态刷新的，一更新我们的客户端就会跟新。</p>
<h2 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h2><p>上面那些功能只不过是Nacos能够替代 eureka + config+ bus的一些功能，Nacos还有别的更强大的功能。</p>
<p>开发中会存在多环境，多服务的问题，所以Nacos就提供了一个类似于Java package名和类名的类似的一个命名空间。</p>
<p>命名空间由Namespace+Group+Data ID设计构建出来的。namespace区分部署环境，Group和Data ID逻辑上区分两个目标对象。</p>
<p><img src="/../../images/image-20230217155641906.png" alt="image-20230217155641906"></p>
<p>Namespace就是用于区分部署环境的：开发、测试、生产，不同的NameSpace之间是隔离的。</p>
<p>Group可以将不同的微服务划分到不同的组里面去，类似于Cloud Stream里的Group</p>
<p>Serivice就是微服务，一个Service可以有多个Cluster 集群环境。</p>
<ul>
<li>Data ID</li>
</ul>
<p>就是在我们的application.yml中的spring.profiles.active 对应，这里配置什么环境，就读取在naocs中的什么环境。</p>
<ul>
<li>Group</li>
</ul>
<p>不同组下面可以有相同名字的配置文件，开发中用于区分不同的开发组使用同名的配置。在bootstrap中设置</p>
<p><img src="/../../images/image-20230218111234870.png" alt="image-20230218111234870"></p>
<ul>
<li>namespace</li>
</ul>
<p>可以新建命名空间，</p>
<p><img src="/../../images/image-20230218111808689.png" alt="image-20230218111808689"></p>
<p><img src="/../../images/image-20230218111845605.png" alt="image-20230218111845605"></p>
<p>要选择使用这个命名空间只需要在bootstrap中指定命名空间的id即可</p>
<p><img src="/../../images/image-20230218111933341.png" alt="image-20230218111933341"></p>
<h2 id="Nacos集群和持久化配置"><a href="#Nacos集群和持久化配置" class="headerlink" title="Nacos集群和持久化配置"></a>Nacos集群和持久化配置</h2><p>​		我们之前的eureka，我们自己可以配置多台eureka注册中心，但是现在我们的nacos自带注册中心，但是目前来说我们好像只知道有一个8848这么一个注册中心，但实际中肯定不可能只有一台服务器作为注册中心，不然出现单点故障时，系统就直接崩溃了，所以我们还要对Nacos的集群进行配置。</p>
<p>​		持久化配置指的是针对有些重要的信息我们不希望Nacos重启之后丢失，希望一直保存在Nacos中。并且官方提出的是最好是要配置到数据库中。</p>
<p>官方集群部署说明：<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html">https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html</a></p>
<p><img src="/../../images/image-20230218113223013.png" alt="image-20230218113223013"></p>
<p>除了上面的部分之外，还需要用到数据库，将重要数据存放到数据库中，所以一个完整的Nacos集群应该是这样的流程。</p>
<p><img src="/../../images/image-20230218113350514.png" alt="image-20230218113350514"></p>
<p>使用到mysql数据库还有一个原因是在于，对于Nacos它自带了一个嵌入式的数据库实现，所以如果在集群配置时，会带有三份自己的数据库，所以可能会出现数据不一致的问题，所以Nacos采用集中式存储的方式来解决这个不一致的问题。这样数据始终就只有一份，数据一直都是一致的。目前只支持Mysql。</p>
<h3 id="持久化配置"><a href="#持久化配置" class="headerlink" title="持久化配置"></a>持久化配置</h3><p>Nacos自带的数据库是derby，我们现在要将这个自带的数据库数据存入mysql。</p>
<p>在nacos的安装目录下可以看到两个sql脚本。</p>
<p><img src="/../../images/image-20230218114036565.png" alt="image-20230218114036565"></p>
<p>把nacos-mysql.sql脚本在自己的mysql数据库中执行，就能够创建出支持mysql的所有的数据库和表名等。</p>
<p>根据官网指示找到对应文件  applicaiton.properties，进行修改</p>
<p><img src="/../../images/image-20230218114500780.png" alt="image-20230218114500780"></p>
<h3 id="集群配置"><a href="#集群配置" class="headerlink" title="集群配置"></a>集群配置</h3><p>现在linux下安装好 nacos，由于nacos集群配置需要3个以上，所以我们要启动三个以上的nacos，但是一台linux下，都是用startup.sh命令的话就无法区分出不同的nacos，所以我们需要修改startup指令，携带上一个参数p表示指定不同的端口号。</p>
<p>由于Centos7下不支持mysql，这里只是复制，没有实践。</p>
<p>在linux下同样有sql脚本</p>
<p><img src="/../../images/image-20230218135538958.png" alt="image-20230218135538958"></p>
<p>将这个脚本在linux里的mysql运行得到结果和Windows下运行的表结构是一样的。</p>
<p>然后修改application.properties</p>
<p><img src="/../../images/image-20230218135643247.png" alt="image-20230218135643247"></p>
<p>修改的内容也和Windows一样。</p>
<p>集群的配置要修改cluster.conf文件</p>
<p><img src="/../../images/image-20230218135920601.png" alt="image-20230218135920601"></p>
<p>一开始默认是.example 这是修改的例子，我们拷贝这个文件命名问 cluster.conf</p>
<p>里面配置的内容就是  ip  +  端口号，这里的ip是网卡的ip 不是 127.0.0.1，通过hostname -I查看</p>
<p><img src="/../../images/image-20230218141140882.png" alt="image-20230218141140882"></p>
<p>编辑cluster.conf</p>
<p><img src="/../../images/image-20230218141303078.png" alt="image-20230218141303078"></p>
<p>上面是 官方给的例子，下面是我们要配置的集群。</p>
<p>修改nacos下的bin 的startup.sh，传递一个参数p去指定开启我们cluster.conf中哪个端口。修改前先拷贝一份</p>
<p><img src="/../../images/image-20230218141558029.png" alt="image-20230218141558029"></p>
<p>根据下面的这个来修改</p>
<p><img src="/../../images/image-20230218141828991.png" alt="image-20230218141828991"></p>
<p>这是出厂自带可用参数，我们要定义我们自己的参数 -P，就可以直接红框处添加</p>
<p><img src="/../../images/image-20230218141914776.png" alt="image-20230218141914776"></p>
<p><img src="/../../images/image-20230218142413162.png" alt="image-20230218142413162"></p>
<p>在最后面加上取得这个port</p>
<p><img src="/../../images/image-20230218142358129.png" alt="image-20230218142358129"></p>
<p>修改完成之后我们要去配置Nginx，去代理我们的这三台集群。</p>
<p><img src="/../../images/image-20230218143328126.png" alt="image-20230218143328126"></p>
<p>然后开启nginx，和三台集群，如果能够通过 <a target="_blank" rel="noopener" href="http://localhost:1111/">http://localhost:1111</a> 访问到我们的nacos集群表示配置成功。</p>
<p>启动 nacos</p>
<p><img src="/../../images/image-20230218145002957.png" alt="image-20230218145002957"></p>
<p>启动 nginx</p>
<p><img src="/../../images/image-20230218150308689.png" alt="image-20230218150308689"></p>
<p>在我们的浏览器输入 linux ip + nginx监听的端口号能够访问到nacos 就算配置成功</p>
<p><img src="/../../images/image-20230220173804987.png" alt="image-20230220173804987"></p>
<p>将我们的服务配置给Linux中的nacos集群 就只需要把我们之前配置的 server -addr内容改成我们linux下的ip和nginx监听的端口就行了。</p>
<p><img src="/../../images/image-20230220174259304.png" alt="image-20230220174259304"></p>
<h2 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h2><p>Sentinel 是面向分布式、多语言异构化服务架构的流量治理组件，主要以流量为切入点，从流量路由、流量控制、流量整形、熔断降级、系统自适应过载保护、热点流量防护等多个维度来帮助开发者保障微服务的稳定性。</p>
<p>Sentinel 和 之前的Hystrix都是做流量控制的有什么区别呢？</p>
<p>Hystrix 通过<a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix/wiki/How-it-Works#benefits-of-thread-pools">线程池</a>的方式，来对依赖(在我们的概念中对应资源)进行了隔离。这样做的好处是资源和资源之间做到了最彻底的隔离。缺点是除了增加了线程切换的成本，还需要预先给各个资源做线程池大小的分配。</p>
<p>Sentinel 对这个问题采取了两种手段:</p>
<ul>
<li>通过并发线程数进行限制</li>
</ul>
<p>和资源池隔离的方法不同，Sentinel 通过限制资源并发线程的数量，来减少不稳定资源对其它资源的影响。这样不但没有线程切换的损耗，也不需要您预先分配线程池的大小。当某个资源出现不稳定的情况下，例如响应时间变长，对资源的直接影响就是会造成线程数的逐步堆积。当线程数在特定资源上堆积到一定的数量之后，对该资源的新请求就会被拒绝。堆积的线程完成任务后才开始继续接收请求。</p>
<ul>
<li>通过响应时间对资源进行降级</li>
</ul>
<p>除了对并发线程数进行控制以外，Sentinel 还可以通过响应时间来快速降级不稳定的资源。当依赖的资源出现响应时间过长后，所有对该资源的访问都会被直接拒绝，直到过了指定的时间窗口之后才重新恢复。</p>
<p>相比于Hystrix他提供了更加简易的操作以及可以直接操作的web界面。</p>
<p>下载：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">https://github.com/alibaba/Sentinel/releases</a></p>
<p>下载下来是一个jar包，只需要直接执行即可。但是有一个要求就是 8080端口不能被占用。</p>
<p><img src="/../../images/image-20230221095113421.png" alt="image-20230221095113421"></p>
<p>访问8080</p>
<p><img src="/../../images/image-20230221095329899.png" alt="image-20230221095329899"></p>
<p>用户名密码都是 sentinel</p>
<p><img src="/../../images/image-20230221113158617.png" alt="image-20230221113158617"></p>
<h3 id="使用-2"><a href="#使用-2" class="headerlink" title="使用"></a>使用</h3><ul>
<li>依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--sentinel的持久化依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8401</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-sentinel-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span>   <span class="comment">#sentinel的地址</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span>    <span class="comment">#默认的端口，如果被占用就会自己+1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>



<ul>
<li><p>主启动类和业务类都不变</p>
</li>
<li><p>启动 nacos，sentinel和8401工程</p>
</li>
</ul>
<p>直接访问 8080，发现什么都没有</p>
<p><img src="/../../images/image-20230222093508747.png" alt="image-20230222093508747"></p>
<p>这是因为sentinel使用了懒加载机制，需要执行一次请求才会被sentinel监控到，</p>
<p><img src="/../../images/image-20230222093614833.png" alt="image-20230222093614833"></p>
<h3 id="簇点控制界面"><a href="#簇点控制界面" class="headerlink" title="簇点控制界面"></a>簇点控制界面</h3><p>这个界面可以看到我们访问了哪些服务，可以对这些服务进行后面的一系列操作。</p>
<p><img src="/../../images/image-20230222093804197.png" alt="image-20230222093804197"></p>
<h3 id="流控规则"><a href="#流控规则" class="headerlink" title="流控规则"></a>流控规则</h3><p>流控规则有两个入口可以直接从流控规则界面上进行添加，也可以在簇点控制界面对某个簇点增加流控。</p>
<p>这个界面里可以增加对流量控制的规则。</p>
<p><img src="/../../images/image-20230222093954412.png" alt="image-20230222093954412"></p>
<p><img src="/../../images/image-20230222094320561.png" alt="image-20230222094320561"></p>
<p><img src="/../../images/image-20230222094338970.png" alt="image-20230222094338970"></p>
<ul>
<li>QPS直接失败：</li>
</ul>
<p><img src="/../../images/image-20230222094741307.png" alt="image-20230222094741307"></p>
<p>这样对于 &#x2F;testA这个请求如果每秒超过了一个访问就会直接在前端报错。</p>
<p>慢慢点：</p>
<p><img src="/../../images/image-20230222094907783.png" alt="image-20230222094907783"></p>
<p>快速访问：</p>
<p><img src="/../../images/image-20230222094926715.png" alt="image-20230222094926715"></p>
<p>后续当QPS降下来了会自动恢复。<strong>但是这个是默认的返回值，我们是否可以自定义或者和Hystrix一样有一个fallbcak方法？</strong></p>
<ul>
<li>线程数直接失败</li>
</ul>
<p><img src="/../../images/image-20230222095615979.png" alt="image-20230222095615979"></p>
<p>在线程数这个流控界面中，发现没有让你选择是直接失败还是 Warm up 还是排队等待的选项。因为线程超过了阈值直接就失败。</p>
<p>在访问testA时候增加延迟，在延迟过程中后续的访问都是会被直接失败的。</p>
<p><img src="/../../images/image-20230222100225712.png" alt="image-20230222100225712"></p>
<ul>
<li>关联快速失败</li>
</ul>
<p><img src="/../../images/image-20230222100523995.png" alt="image-20230222100523995"></p>
<p>关联可以用一个比较简单的例子来解释就是：假设支付服务关联了下订单的服务，当支付服务达到我们的限流阈值的时候，下订单的服务就会被限流。</p>
<p>上面图上的配置就是，当testB请求的QPS达到1的时候testA请求就会被先流直接失败。</p>
<p>用postman模拟并发反问testB</p>
<ul>
<li><ul>
<li>新建一个conllection</li>
</ul>
</li>
</ul>
<p><img src="/../../images/image-20230222101113808.png" alt="image-20230222101113808"></p>
<ul>
<li><ul>
<li>把我们的请求报错到collection中</li>
</ul>
</li>
</ul>
<p><img src="/../../images/image-20230222101216507.png" alt="image-20230222101216507"></p>
<ul>
<li><ul>
<li>运行conllection</li>
</ul>
</li>
</ul>
<p><img src="/../../images/image-20230222101354697.png" alt="image-20230222101354697"></p>
<p><img src="/../../images/image-20230222101407663.png" alt="image-20230222101407663"></p>
<ul>
<li><ul>
<li>选择需要运行的请求，并且配置启用的线程数量和延迟时间。</li>
</ul>
</li>
</ul>
<p><img src="/../../images/image-20230222101543208.png" alt="image-20230222101543208"></p>
<ul>
<li><ul>
<li>测试，发现testB再发送请求的时候，testA被限流了。</li>
</ul>
</li>
</ul>
<p><img src="/../../images/image-20230222101710705.png" alt="image-20230222101710705"></p>
<ul>
<li>warm up</li>
</ul>
<p><img src="/../../images/image-20230222102846753.png" alt="image-20230222102846753"></p>
<p>warm up是为了防止出现某个请求平常访问量都很低，但是突然访问量剧增的情况。</p>
<p>所以warm up模式中有一个 预热时长和冷加载因子，冷加载因子默认是3，作用是当我们设定了最大阈值为 max的情况下，突然访问量飙升，warm up模式不会突然的允许访问量上升，会先允许 max &#x2F; 3个数的访问通过，然后在我们设置了 预热时长时间内，慢慢的增加到我们设定的最大阈值。</p>
<ul>
<li>排队等待</li>
</ul>
<p>排队等待模式是为了处理间隔高并发的请求，让高并发的请求不会直接报错放回，而是会再间隔的时间中依次执行。</p>
<p><img src="/../../images/image-20230222104106272.png" alt="image-20230222104106272"></p>
<p>如果排队等待时间超过了指定的超时时间才会报错提示，否则就是按照指定的QPS处理请求。</p>
<p><img src="/../../images/image-20230222104402485.png" alt="image-20230222104402485"></p>
<p><img src="/../../images/image-20230222104351416.png" alt="image-20230222104351416"></p>
<p>对于每个请求都会在QPS为1的时间内被处理。</p>
<h3 id="降级规则"><a href="#降级规则" class="headerlink" title="降级规则"></a>降级规则</h3><p><img src="/../../images/image-20230222104557212.png" alt="image-20230222104557212"></p>
<p>在sentinel中的降级指的就是熔断降级，后续是可以自己恢复的。下面是参数的一些设置规则。</p>
<p><img src="/../../images/image-20230222104750055.png" alt="image-20230222104750055"></p>
<p>相比于Hystrix的断路器，sentinel没有断路器半开的状态，也就是系统不会自己尝试放一部分的请求通过，如果正常访问则慢慢恢复。sentinel中只要过了时间窗口请求都能够通过，再出现问题就再断开。</p>
<ul>
<li>RT</li>
</ul>
<p>RT的流程图很简单，就和下面这张图一样：</p>
<p><img src="/../../images/image-20230222105142497.png" alt="image-20230222105142497"></p>
<ul>
<li>测试代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/testD&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testD</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="number">1</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">    log.info(<span class="string">&quot;testD 测试RT&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;------testD&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230222105646094.png" alt="image-20230222105646094"></p>
<p>对于testD请求要求响应时间是200ms，如果没有完成系统就自动熔断，1s的时间窗口后重新启动。</p>
<p>postman发送并发请求的过程中，我们再在浏览器中无法访问，postman发送完成之后又恢复。</p>
<ul>
<li>异常比例</li>
</ul>
<p><img src="/../../images/image-20230222110858124.png" alt="image-20230222110858124"></p>
<p>我们需要自己指定异常的比例，当请求数大于5，且请求异常的比例(0%-100%)达到我们指定的比例的时候就会进行熔断，在再指定窗口期内恢复。</p>
<p><img src="/../../images/image-20230222111330127.png" alt="image-20230222111330127"></p>
<p>当QPS达到5，且异常比例为0.2的时候才会进入熔断，1s之后恢复。注意如果1s之后恢复之后慢慢的再发送请求，让QPS达不到5这个时候是不会走熔断的，并且此时如果出现了异常，前端就是直接把异常信息进行返回的。</p>
<ul>
<li>异常数</li>
</ul>
<p><img src="/../../images/image-20230222111846881.png" alt="image-20230222111846881"></p>
<p>会统计一分钟之内的异常的个数，因为是分钟级别的，所以如果时间窗口小于60s的话，时间窗口结束还可能处于熔断状态，所以这个模式下一定要求时间窗口大于60s。</p>
<p><img src="/../../images/image-20230222112220533.png" alt="image-20230222112220533"></p>
<p>这种模式下，出现异常的前异常数次的请求一定是会返回错误界面的，所以如果为了系统更友好需要加上error界面。</p>
<h3 id="热点规则"><a href="#热点规则" class="headerlink" title="热点规则"></a>热点规则</h3><p>可以对某个请求，如果包含了某个参数就对这个请求进行限制。</p>
<h4 id="SentinelResource引入"><a href="#SentinelResource引入" class="headerlink" title="@SentinelResource引入"></a>@SentinelResource引入</h4><p>假设我们的一个请求有两个参数，现在要对一个参数进行热点限制。并且返回一句话：当前访问人数过多。</p>
<p>在Hystrix中我们可能会想到用一个fallback方法去指定在熔断后的对于服务请求的处理方法，在Sentinel中也有类似的注解@SentinelResource。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/testD&quot;)</span></span><br><span class="line"><span class="comment">//value是降级方法的唯一标识可以任意,但一般是Mapping中的值不加 /  ，</span></span><br><span class="line"><span class="comment">//blockHandler是对应的降级方法的方法名，不配置的话会到默认的errorpage界面，不友好</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;testD&quot;,blockHandler = &quot;testD_Handler&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testD</span><span class="params">(<span class="meta">@RequestParam(value = &quot;p1&quot;,required = false)</span> String p1,</span></span><br><span class="line"><span class="params">                    <span class="meta">@RequestParam(value = &quot;p2&quot;,required = false)</span> String p2)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//try &#123; TimeUnit.SECONDS.sleep(1); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125;</span></span><br><span class="line">    log.info(<span class="string">&quot;testD 测试RT&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;------testD&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testD_Handler</span><span class="params">(String p1,String p2,BlockException e)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;当前访问人数过多&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>配置</li>
</ul>
<p><img src="/../../images/image-20230222145723717.png" alt="image-20230222145723717"></p>
<ul>
<li>快速访问</li>
</ul>
<p><img src="/../../images/image-20230222145742591.png" alt="image-20230222145742591"></p>
<h4 id="参数例外项"><a href="#参数例外项" class="headerlink" title="参数例外项"></a>参数例外项</h4><p>热点配置界面中还有一些高级配置，以便于满足某些特殊情况的处理。比如上面的例子是对p1这个参数无论什么情况都是限制的，但是如果我想如果p1 是某些特殊的值的时候不限流，就需要用到这个参数例外项进行配置。</p>
<p><img src="/../../images/image-20230222150209461.png" alt="image-20230222150209461"></p>
<p>只支持一下几种类型</p>
<p><img src="/../../images/image-20230222151034647.png" alt="image-20230222151034647"></p>
<p><img src="/../../images/image-20230222151128442.png" alt="image-20230222151128442"></p>
<p>注：这个配置只会对于流量控制时起效，如果运行时出现异常，该出现errorpage 还是会出现erroropage的。</p>
<h3 id="SentinelResource"><a href="#SentinelResource" class="headerlink" title="@SentinelResource"></a>@SentinelResource</h3><p>上面引入部分也说了这个注解类似与HystrixCommand注解。官网有一个对于Sentinel规则配置实现的源码模板。</p>
<p><img src="/../../images/image-20230222153204453.png" alt="image-20230222153204453"></p>
<p>也就是说我们在Sentinel所有配置的规则都会对应源码中某个类的这么一块try catch代码，try就是我们对于资源或者请求路径设定的规则，如果不满足就会出现BlockException，默认的对于Block Exception的处理就是会返回一个  Blocked by Sentinel (flow limiting)。 </p>
<p>上面引入部分也实现了对于Blocked by Sentinel (flow limiting)的自定义修改。这里要细说的是，除了上面的对于参数的监控，我们在@SentinelResource 中指定的 value参数的值，就是会将这个值注入到Sentinel管理中心进行管理作为一个可监控的资源，让它和其他请求路径一样能够完成所有的监控规则。</p>
<p><img src="/../../images/image-20230222153841406.png" alt="image-20230222153841406"></p>
<p>实际上@SentinelResource 更多用在Service层的方法上，这里是为了方便测试用在了Controller层上，用在Service层上就是对于方法的保护，为这个方法会在Sentinel中创建一个资源，</p>
<p>用在Controller上我的理解是对于Controller中的方法，创建了两个资源名一个是Mapping指定的资源名，一个是SentinelResource指定的资源名，但是都是保护的同一个方法，我们对SentinelResource指定的资源名进行控制才能够实现自定义的返回界面，因为Mapping指定的资源名没办法指定异常处理方法，不满足我们自己的配置的时候，抛出BlockException 只会被默认的处理类捕获，返回Blocked by Sentinel (flow limiting)。</p>
<p>现在面临一下几个问题，这些问题在Hystrix同样出现过：</p>
<ul>
<li>处理方法和业务逻辑耦合</li>
<li>每个方法配置一个处理方法代码泰国臃肿</li>
<li>重启服务流量规则丢失</li>
</ul>
<h4 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h4><p>单独定义一个Handler类，里面都是专门由于自定义处理blockhandler的方法。</p>
<ul>
<li>Handler</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">handler1</span><span class="params">(BlockException e)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;全局处理方法 handler1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">handler2</span><span class="params">(BlockException e)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;全局处理方法 handler2&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>Controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/testE&quot;)</span></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * blockHandlerClass：指定处理方法对应的类</span></span><br><span class="line"><span class="comment"> * blockHandler：处理方法类中的具体那个方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;testE&quot;,</span></span><br><span class="line"><span class="meta">        blockHandlerClass = CustomerHandler.class,</span></span><br><span class="line"><span class="meta">        blockHandler = &quot;handler1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testE</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testE.........&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230222161127313.png" alt="image-20230222161127313"></p>
<h4 id="整合Ribbon、Openfeign"><a href="#整合Ribbon、Openfeign" class="headerlink" title="整合Ribbon、Openfeign"></a>整合Ribbon、Openfeign</h4><p>创建两个provider和一个consummer，consummer给Sentinel管理。</p>
<ul>
<li>provider controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Long, Payment&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        hashMap.put(<span class="number">1L</span>,<span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">1L</span>,<span class="string">&quot;28a8c1e3bc2742d8848569891fb42181&quot;</span>));</span><br><span class="line">        hashMap.put(<span class="number">2L</span>,<span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">2L</span>,<span class="string">&quot;bba8c1e3bc2742d8848569891ac32182&quot;</span>));</span><br><span class="line">        hashMap.put(<span class="number">3L</span>,<span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">3L</span>,<span class="string">&quot;6ua8c1e3bc2742d8848569891xt92183&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/paymentSQL/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult&lt;Payment&gt; <span class="title function_">paymentSQL</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;</span><br><span class="line">        <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> hashMap.get(id);</span><br><span class="line">        ResponseResult&lt;Payment&gt; result = <span class="keyword">new</span> <span class="title class_">ResponseResult</span>(<span class="number">200</span>,<span class="string">&quot;from mysql,serverPort:  &quot;</span>+serverPort,payment);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>consummer controller先不进行任何配置</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;fallback&quot;)</span> <span class="comment">//没有配置</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult&lt;Payment&gt; <span class="title function_">fallback</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">    ResponseResult&lt;Payment&gt; result = restTemplate.getForObject(SERVICE_URL + <span class="string">&quot;/paymentSQL/&quot;</span>+id, ResponseResult.class,id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (id == <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span> (<span class="string">&quot;IllegalArgumentException,非法参数异常....&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (result.getData() == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span> (<span class="string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<ul>
<li>sentinel 控制台</li>
</ul>
<p><img src="/../../images/image-20230222172253208.png" alt="image-20230222172253208"></p>
<p>按照上面的代码和我们之前的知识，如果我们传递的参数是1、2、3肯定能够正常访问，但是如果是我们才provider的map里面没有的东西肯定会报错。</p>
<ul>
<li>正常</li>
</ul>
<p><img src="/../../images/image-20230222172846137.png" alt="image-20230222172846137"></p>
<ul>
<li>错误</li>
</ul>
<p><img src="/../../images/image-20230222172902590.png" alt="image-20230222172902590"></p>
<p>出现错误的时候这样返回是一个非常不友好的界面。我们之前学过的配置异常处理又只能处理sentinel中配置管理不满足条件走我们的自定义处理逻辑，Java运行时异常无法处理，那该怎么办呢？</p>
<h5 id="fallbcak参数"><a href="#fallbcak参数" class="headerlink" title="fallbcak参数"></a><font size=5>fallbcak参数</font></h5><p>SentinelResource的blockHandler参数会处理配置管理不满足条件抛出的BlockException，对应的fallback参数可以处理java运行时出现的异常，用法和blockHandler几乎一样。这个fallback参数和 HystrixCommand中的fallback是一样的实现的都是服务降级。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="comment">//@SentinelResource(value = &quot;fallback&quot;) //没有配置</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;fallback&quot;,fallback = &quot;handlerFallback&quot;)</span> <span class="comment">//fallback只负责业务异常</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult&lt;Payment&gt; <span class="title function_">fallback</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">    ResponseResult&lt;Payment&gt; result = restTemplate.getForObject(SERVICE_URL + <span class="string">&quot;/paymentSQL/&quot;</span>+id, ResponseResult.class,id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (id == <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span> (<span class="string">&quot;IllegalArgumentException,非法参数异常....&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (result.getData() == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span> (<span class="string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//fallback</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">handlerFallback</span><span class="params">(<span class="meta">@PathVariable</span>  Long id,Throwable e)</span> &#123;</span><br><span class="line">    <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Payment</span>(id,<span class="string">&quot;null&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseResult</span>(<span class="number">444</span>,<span class="string">&quot;兜底异常handlerFallback,exception内容  &quot;</span>+e.getMessage(),payment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>测试</li>
</ul>
<p><img src="/../../images/image-20230222173657941.png" alt="image-20230222173657941"></p>
<p><strong><font size=5>fallback 和 blockHandler都配置</font></strong></p>
<p>上面介绍的 fallback捕获java运行时异常，而blockHandler会管理控制台配置异常，那如果同时配置这两个会发生什么？是异常冲突还是 各自管理自己的？</p>
<p>只出现一种异常的时候 @SentinelResource 会自己管理各自的异常，但是异常发生冲突时，blockHandler会主要接管异常捕获和处理。</p>
<p>当需要对某一个异常进行忽略时，可以采用exceptionsToIgnore 参数进行配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;fallback&quot;,fallback = &quot;handlerFallback&quot;,blockHandler = &quot;blockHandler&quot;,</span></span><br><span class="line"><span class="meta">exceptionsToIgnore = &#123;IllegalArgumentException.class&#125;)</span>	<span class="comment">//不会被handlerFallback处理</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult&lt;Payment&gt; <span class="title function_">fallback</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">    ResponseResult&lt;Payment&gt; result = restTemplate.getForObject(SERVICE_URL + <span class="string">&quot;/paymentSQL/&quot;</span>+id, ResponseResult.class,id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (id == <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span> (<span class="string">&quot;IllegalArgumentException,非法参数异常....&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (result.getData() == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span> (<span class="string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//fallback</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">handlerFallback</span><span class="params">(<span class="meta">@PathVariable</span>  Long id,Throwable e)</span> &#123;</span><br><span class="line">    <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Payment</span>(id,<span class="string">&quot;null&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseResult</span>(<span class="number">444</span>,<span class="string">&quot;兜底异常handlerFallback,exception内容  &quot;</span>+e.getMessage(),payment);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//blockHandler</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">blockHandler</span><span class="params">(<span class="meta">@PathVariable</span>  Long id, BlockException blockException)</span> &#123;</span><br><span class="line">    <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Payment</span>(id,<span class="string">&quot;null&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseResult</span>(<span class="number">445</span>,<span class="string">&quot;blockHandler-sentinel限流,无此流水: blockException  &quot;</span>+blockException.getMessage(),payment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<p>对feign的整合也很简单，和上面整合nacos一样，只是要开启sentinel对feign的支持</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">84</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-order-sentinel-openfeign-consummer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">nacos-user-service:</span> <span class="string">http://nacos-payment-provider</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sentinel 对 feign支持</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<ul>
<li>service</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;nacos-payment-sentinel-provider&quot;,fallback= PaymentFallbackService.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/paymentSQL/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult&lt;Payment&gt; <span class="title function_">paymentSQL</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>fallbcak</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentFallbackService</span> <span class="keyword">implements</span> <span class="title class_">PaymentService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> ResponseResult&lt;Payment&gt; <span class="title function_">paymentSQL</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseResult</span>&lt;Payment&gt;(<span class="number">444</span>,<span class="string">&quot;服务降级处理&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230223142232640.png" alt="image-20230223142232640"></p>
<h3 id="持久化规则"><a href="#持久化规则" class="headerlink" title="持久化规则"></a>持久化规则</h3><p>上面我们也提到过，服务重启会导致sentinel的流控规则丢失，那需要如何使得这些规则不丢失？</p>
<p>首先我们需要一个持久化媒介，可以文件、可以数据库，但是更建议使用nacos进行保存。</p>
<p>拿8401做为例子</p>
<p><img src="/../../images/image-20230223142849922.png" alt="image-20230223142849922"></p>
<ul>
<li>依赖，将sentinel持久化到nacos</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8401</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-sentinel-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span>   <span class="comment">#sentinel的地址</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span>    <span class="comment">#默认的端口，如果被占用就会自己+1</span></span><br><span class="line">      <span class="attr">datasource:</span>		<span class="comment">#新增配置</span></span><br><span class="line">        <span class="attr">ds1:</span>			<span class="comment">#数据源1</span></span><br><span class="line">          <span class="attr">nacos:</span></span><br><span class="line">            <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">            <span class="attr">dataId:</span> <span class="string">cloud-sentinel-service</span>	<span class="comment">#需要持久化的服务名称</span></span><br><span class="line">            <span class="attr">groupId:</span> <span class="string">DEFAULT_GROUP</span>			<span class="comment">#需要持久化的服务分组</span></span><br><span class="line">            <span class="attr">data-type:</span> <span class="string">json</span>					<span class="comment">#再nacos中以上面数据格式进行保存</span></span><br><span class="line">            <span class="attr">rule-type:</span> <span class="string">flow</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>到nacos配置列表中新建配置</li>
</ul>
<p><img src="/../../images/image-20230223143640374.png" alt="image-20230223143640374"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">         <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/testE&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;limitApp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span>   <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span>   <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;controlBehavior&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">         <span class="attr">&quot;clusterMode&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span>    </span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">resource:资源名称</span></span><br><span class="line"><span class="comment">limitApp：默认即可</span></span><br><span class="line"><span class="comment">grade:阈值类型，0表示线程数，1表示QPS</span></span><br><span class="line"><span class="comment">count：阈值</span></span><br><span class="line"><span class="comment">stategy:流控模式，0表示直接、1表示关联、2表示链路</span></span><br><span class="line"><span class="comment">controlbehavior：流控效果，0表示快速失败、1表示warm up、2表示排队等待</span></span><br><span class="line"><span class="comment">clustermode：是否启用集群</span></span><br><span class="line"><span class="comment">**/</span></span><br></pre></td></tr></table></figure>



<ul>
<li>启动8401的时候在流控规则界面就有对饮的规则配置</li>
</ul>
<p><img src="/../../images/image-20230223144346962.png" alt="image-20230223144346962"></p>
<h2 id="Seata"><a href="#Seata" class="headerlink" title="Seata"></a>Seata</h2><p>对于分布式数据库一定会涉及到的就是分库分表的问题，在加上现在的微服务分模块的开发，可能一个模块对应一个数据库，但是这个模块会调用到别的模块，别的模块又要使用到自己对应的数据库。</p>
<p>在这样复杂场景数据的一致性都只能在本地完成，无法保证全局的数据一致，所以对于事物的控制是非常重要的，但是现在又是跨数据库的调用所以导致事务的控制也变得十分复杂。所以Cloud Alibaba推出了 Seata。</p>
<p>什么是seata？</p>
<blockquote>
<p>Seata是一款开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事务服务 </p>
</blockquote>
<p>官网：<a target="_blank" rel="noopener" href="http://seata.io/zh-cn/">http://seata.io/zh-cn/</a></p>
<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>分布式事务处理过程的-ID+三组件模型</p>
<ul>
<li><p>Transaction ID XID：全局唯一的事务ID，将某次事务涉及到的数据库都由这个id标识，只要出现异常，开启回滚就由这个id去找所有包含这个id的数据库。</p>
</li>
<li><p>三组件模型</p>
<ul>
<li>Transaction Coordinator(TC) ：事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚;</li>
<li>Transaction  Manager(TM) ：控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议;</li>
<li>Resource Manager(RM) ：控制分支事务，负责分支注册，状态汇报，并接收事务协调器的指令，驱动分支（本地）事务的提交和回滚；</li>
</ul>
</li>
</ul>
<p>官方流程图</p>
<p><img src="/../../images/image-20230223151449068.png" alt="image-20230223151449068"></p>
<ul>
<li><p>1、TM向TC申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的XID;</p>
</li>
<li><p>2、XID在微服务调用链路的上下文中传播;</p>
</li>
<li><p>3、RM向TC注册分支事务，将其纳入XID对应全局事务的管辖;</p>
</li>
<li><p>4、TM向TC发起针对XID的全局提交或回滚决议;</p>
</li>
<li><p>5、TC调度XID下管辖的全部分支事务完成提交或回滚请求。</p>
</li>
</ul>
<h3 id="使用-3"><a href="#使用-3" class="headerlink" title="使用"></a>使用</h3><p>seata做了比较大的跟新，配置文件从原来的conf变成了  yml，所以这里会尽可能记录两种配置方式。</p>
<ul>
<li><p>conf文件</p>
<ul>
<li><p>file.conf<br><img src="/../../images/image-20230223161353735.png" alt="image-20230223161353735"></p>
</li>
<li><p>register.conf</p>
</li>
</ul>
<p><img src="/../../images/image-20230223163523339.png" alt="image-20230223163523339"></p>
</li>
<li><p>yml文件</p>
<ul>
<li><p>配置中心<br><img src="/../../images/image-20230223162506551.png" alt="image-20230223162506551"></p>
</li>
<li><p>注册中心<br><img src="/../../images/image-20230223162708278.png" alt="image-20230223162708278"></p>
</li>
<li><p>存储</p>
</li>
</ul>
</li>
</ul>
<p><img src="/../../images/image-20230223162953330.png" alt="image-20230223162953330"></p>
<p>根据上面的一些配置我们知道我们需要建立seata数据库和几张表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- the table to store GlobalSession data</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `global_table`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `global_table` (</span><br><span class="line">  `xid` <span class="type">varchar</span>(<span class="number">128</span>)  <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">  `transaction_id` <span class="type">bigint</span>,</span><br><span class="line">  `status` tinyint <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">  `application_id` <span class="type">varchar</span>(<span class="number">32</span>),</span><br><span class="line">  `transaction_service_group` <span class="type">varchar</span>(<span class="number">32</span>),</span><br><span class="line">  `transaction_name` <span class="type">varchar</span>(<span class="number">128</span>),</span><br><span class="line">  `timeout` <span class="type">int</span>,</span><br><span class="line">  `begin_time` <span class="type">bigint</span>,</span><br><span class="line">  `application_data` <span class="type">varchar</span>(<span class="number">2000</span>),</span><br><span class="line">  `gmt_create` datetime,</span><br><span class="line">  `gmt_modified` datetime,</span><br><span class="line">  <span class="keyword">primary</span> key (`xid`),</span><br><span class="line">  key `idx_gmt_modified_status` (`gmt_modified`, `status`),</span><br><span class="line">  key `idx_transaction_id` (`transaction_id`)</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line"><span class="comment">-- the table to store BranchSession data</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `branch_table`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `branch_table` (</span><br><span class="line">  `branch_id` <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">  `xid` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">  `transaction_id` <span class="type">bigint</span> ,</span><br><span class="line">  `resource_group_id` <span class="type">varchar</span>(<span class="number">32</span>),</span><br><span class="line">  `resource_id` <span class="type">varchar</span>(<span class="number">256</span>) ,</span><br><span class="line">  `lock_key` <span class="type">varchar</span>(<span class="number">128</span>) ,</span><br><span class="line">  `branch_type` <span class="type">varchar</span>(<span class="number">8</span>) ,</span><br><span class="line">  `status` tinyint,</span><br><span class="line">  `client_id` <span class="type">varchar</span>(<span class="number">64</span>),</span><br><span class="line">  `application_data` <span class="type">varchar</span>(<span class="number">2000</span>),</span><br><span class="line">  `gmt_create` datetime,</span><br><span class="line">  `gmt_modified` datetime,</span><br><span class="line">  <span class="keyword">primary</span> key (`branch_id`),</span><br><span class="line">  key `idx_xid` (`xid`)</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line"><span class="comment">-- the table to store lock data</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> `lock_table`;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> `lock_table` (</span><br><span class="line">  `row_key` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">  `xid` <span class="type">varchar</span>(<span class="number">96</span>),</span><br><span class="line">  `transaction_id` long ,</span><br><span class="line">  `branch_id` long,</span><br><span class="line">  `resource_id` <span class="type">varchar</span>(<span class="number">256</span>) ,</span><br><span class="line">  `table_name` <span class="type">varchar</span>(<span class="number">32</span>) ,</span><br><span class="line">  `pk` <span class="type">varchar</span>(<span class="number">36</span>) ,</span><br><span class="line">  `gmt_create` datetime ,</span><br><span class="line">  `gmt_modified` datetime,</span><br><span class="line">  <span class="keyword">primary</span> key(`row_key`)</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p><img src="/../../images/image-20230223163733294.png" alt="image-20230223163733294"></p>
<ul>
<li><p>启动nacos再启动seata</p>
<ul>
<li>conf版本启动</li>
</ul>
<p><img src="/../../images/image-20230223164037852.png" alt="image-20230223164037852"></p>
</li>
</ul>
<p>在conf文件中，我们能够看到seata的端口号是8091，在nacos中可以看到注册进了一个端口为8091的服务</p>
<p><img src="/../../images/image-20230223164231903.png" alt="image-20230223164231903"></p>
<ul>
<li><ul>
<li>yml版本启动</li>
</ul>
<p><img src="/../../images/image-20230223164607652.png" alt="image-20230223164607652"></p>
</li>
</ul>
<p><img src="/../../images/image-20230223164626814.png" alt="image-20230223164626814"></p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>我们完成官网给的一个支付的案例。</p>
<p><img src="/../../images/image-20230223165108430.png" alt="image-20230223165108430"></p>
<p>按照官网的例子，我们只需要在我们的业务类上加上一个@GloableTranscational 就能够完成所有之前复杂的分析。</p>
<p>WTF 这么简单？？？？？？？？？？？？？？？？？？</p>
<p>但是实现这个注解的逻辑异常的复杂。</p>
<blockquote>
<p>案例说明：</p>
<p>这里我们会创建三个服务，一个订单服务，一个库存服务，一个账户服务。</p>
<p>当用户下单时，会在订单服务中创建一个订单，然后通过远程调用库存服务来扣减下单商品的库存,再通过远程调用账户服务来扣减用户账户里面的余额，最后在订单服务中修改订单状态为已完成。</p>
<p>该操作跨越三个数据库，有两次远程调用，很明显会有分布式事务问题。</p>
</blockquote>
<h4 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a><strong><font size=5>准备环境</font></strong></h4><ul>
<li>建库建表准备</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE seata_order；</span><br><span class="line"> </span><br><span class="line"><span class="keyword">CREATE</span> DATABASE seata_storage；</span><br><span class="line"> </span><br><span class="line"><span class="keyword">CREATE</span> DATABASE seata_account；</span><br></pre></td></tr></table></figure>



<p>order下建立订单表，stroage下建立库存表，account下建立账户表</p>
<ul>
<li>order</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_order(</span><br><span class="line">    `id` <span class="type">BIGINT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    `user_id` <span class="type">BIGINT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">    `product_id` <span class="type">BIGINT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;产品id&#x27;</span>,</span><br><span class="line">    `count` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;数量&#x27;</span>,</span><br><span class="line">    `money` <span class="type">DECIMAL</span>(<span class="number">11</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;金额&#x27;</span>,</span><br><span class="line">    `status` <span class="type">INT</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单状态：0：创建中; 1：已完结&#x27;</span></span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">7</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_order;</span><br></pre></td></tr></table></figure>

<ul>
<li>storage</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_storage(</span><br><span class="line">    `id` <span class="type">BIGINT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    `product_id` <span class="type">BIGINT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;产品id&#x27;</span>,</span><br><span class="line">    `total` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;总库存&#x27;</span>,</span><br><span class="line">    `used` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;已用库存&#x27;</span>,</span><br><span class="line">    `residue` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;剩余库存&#x27;</span></span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">2</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> seata_storage.t_storage(`id`,`product_id`,`total`,`used`,`residue`)</span><br><span class="line"><span class="keyword">VALUES</span>(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;100&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;100&#x27;</span>);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_storage;</span><br></pre></td></tr></table></figure>



<ul>
<li>account</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_account(</span><br><span class="line">    `id` <span class="type">BIGINT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> KEY COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">    `user_id` <span class="type">BIGINT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">    `total` <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;总额度&#x27;</span>,</span><br><span class="line">    `used` <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;已用余额&#x27;</span>,</span><br><span class="line">    `residue` <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;剩余可用额度&#x27;</span></span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">2</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> seata_account.t_account(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;user_id&#x27;</span>,<span class="string">&#x27;total&#x27;</span>,<span class="string">&#x27;used&#x27;</span>,<span class="string">&#x27;residue&#x27;</span>) <span class="keyword">VALUES</span>(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1000&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;1000&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_account;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>在每个数据库下都要配一个回滚日志，需要按照官网的来配置</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> `undo_log`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `undo_log` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `branch_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `xid` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `context` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `rollback_info` longblob <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_status` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_created` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `ext` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`,`branch_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>



<ul>
<li>准备结果</li>
</ul>
<p><img src="/../../images/image-20230223171426204.png" alt="image-20230223171426204"></p>
<h4 id="模块编写"><a href="#模块编写" class="headerlink" title="模块编写"></a><strong><font size=6>模块编写</font></strong></h4><p>案例的逻辑 ：下订单—&gt;减库存—–&gt;扣余额—–&gt;修改订单状态</p>
<h5 id="Order-2001"><a href="#Order-2001" class="headerlink" title="Order-2001"></a><strong><font size=6>Order-2001</font></strong></h5><ul>
<li>pom</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yhz<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-aip-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>Hoxton.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--lombk--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--junit--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--nacos-discovery--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--sentinel的持久化依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--seata--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--feign--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">2001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/seata_order?characterEncoding=utf-8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">multipart:</span></span><br><span class="line">      <span class="attr">max-file-size:</span> <span class="string">2MB</span></span><br><span class="line">      <span class="attr">max-request-size:</span> <span class="string">5MB</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">seata-order-provider</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">alibaba:</span></span><br><span class="line">      <span class="attr">seata:</span></span><br><span class="line">        <span class="attr">tx-service-group:</span> <span class="string">&quot;fsp_tx_group&quot;</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">feign:</span></span><br><span class="line">      <span class="attr">hystrix:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment"># 日志</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImp</span></span><br></pre></td></tr></table></figure>



<p>需要有另外两个配置文件，file.conf 和  registry.conf 否则会出现以下错误</p>
<p><img src="/../../images/image-20230228114523792.png" alt="image-20230228114523792"></p>
<p>这两个配置文件也就是用于告诉Java，seata的一些配置信息</p>
<ul>
<li>file.conf</li>
</ul>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">transport &#123;</span><br><span class="line">  <span class="params">#</span> tcp udt unix-domain-socket</span><br><span class="line">  type = &quot;TCP&quot;</span><br><span class="line">  <span class="params">#</span>NIO NATIVE</span><br><span class="line">  server = &quot;NIO&quot;</span><br><span class="line">  <span class="params">#</span>enable heartbeat</span><br><span class="line">  heartbeat = true</span><br><span class="line">  <span class="params">#</span>thread factory for netty</span><br><span class="line">  thread-factory &#123;</span><br><span class="line">    boss-thread-prefix = &quot;NettyBoss&quot;</span><br><span class="line">    worker-thread-prefix = &quot;NettyServerNIOWorker&quot;</span><br><span class="line">    server-executor-thread-prefix = &quot;NettyServerBizHandler&quot;</span><br><span class="line">    share-boss-worker = false</span><br><span class="line">    client-selector-thread-prefix = &quot;NettyClientSelector&quot;</span><br><span class="line">    client-selector-thread-size = 1</span><br><span class="line">    client-worker-thread-prefix = &quot;NettyClientWorkerThread&quot;</span><br><span class="line">    <span class="params">#</span> netty boss thread size,will not be used for UDT</span><br><span class="line">    boss-thread-size = 1</span><br><span class="line">    <span class="params">#</span>auto default pin or 8</span><br><span class="line">    worker-thread-size = 8</span><br><span class="line">  &#125;</span><br><span class="line">  shutdown &#123;</span><br><span class="line">    <span class="params">#</span> when destroy server, wait seconds</span><br><span class="line">    wait = 3</span><br><span class="line">  &#125;</span><br><span class="line">  serialization = &quot;seata&quot;</span><br><span class="line">  compressor = &quot;none&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">service &#123;</span><br><span class="line"></span><br><span class="line">  vgroup<span class="built_in">_</span>mapping.fsp<span class="built_in">_</span>tx<span class="built_in">_</span>group = &quot;default&quot;</span><br><span class="line"></span><br><span class="line">  default.grouplist = &quot;127.0.0.1:8091&quot;</span><br><span class="line">  enableDegrade = false</span><br><span class="line">  disable = false</span><br><span class="line">  max.commit.retry.timeout = &quot;-1&quot;</span><br><span class="line">  max.rollback.retry.timeout = &quot;-1&quot;</span><br><span class="line">  disableGlobalTransaction = false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client &#123;</span><br><span class="line">  async.commit.buffer.limit = 10000</span><br><span class="line">  lock &#123;</span><br><span class="line">    retry.internal = 10</span><br><span class="line">    retry.times = 30</span><br><span class="line">  &#125;</span><br><span class="line">  report.retry.count = 5</span><br><span class="line">  tm.commit.retry.count = 1</span><br><span class="line">  tm.rollback.retry.count = 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="params">##</span> transaction log store</span><br><span class="line">store &#123;</span><br><span class="line">  <span class="params">##</span> store mode: file、db</span><br><span class="line">  mode = &quot;db&quot;</span><br><span class="line"></span><br><span class="line">  <span class="params">##</span> file store</span><br><span class="line">  file &#123;</span><br><span class="line">    dir = &quot;sessionStore&quot;</span><br><span class="line"></span><br><span class="line">    <span class="params">#</span> branch session size , if exceeded first try compress lockkey, still exceeded throws exceptions</span><br><span class="line">    max-branch-session-size = 16384</span><br><span class="line">    <span class="params">#</span> globe session size , if exceeded throws exceptions</span><br><span class="line">    max-global-session-size = 512</span><br><span class="line">    <span class="params">#</span> file buffer size , if exceeded allocate new buffer</span><br><span class="line">    file-write-buffer-cache-size = 16384</span><br><span class="line">    <span class="params">#</span> when recover batch read size</span><br><span class="line">    session.reload.read<span class="built_in">_</span>size = 100</span><br><span class="line">    <span class="params">#</span> async, sync</span><br><span class="line">    flush-disk-mode = async</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="params">##</span> database store</span><br><span class="line">  db &#123;</span><br><span class="line">    <span class="params">##</span> the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp) etc.</span><br><span class="line">    datasource = &quot;dbcp&quot;</span><br><span class="line">    <span class="params">##</span> mysql/oracle/h2/oceanbase etc.</span><br><span class="line">    db-type = &quot;mysql&quot;</span><br><span class="line">    driver-class-name = &quot;com.mysql.jdbc.Driver&quot;</span><br><span class="line">    url = &quot;jdbc:mysql://127.0.0.1:3306/seata&quot;</span><br><span class="line">    user = &quot;root&quot;</span><br><span class="line">    password = &quot;123456&quot;</span><br><span class="line">    min-conn = 1</span><br><span class="line">    max-conn = 3</span><br><span class="line">    global.table = &quot;global<span class="built_in">_</span>table&quot;</span><br><span class="line">    branch.table = &quot;branch<span class="built_in">_</span>table&quot;</span><br><span class="line">    lock-table = &quot;lock<span class="built_in">_</span>table&quot;</span><br><span class="line">    query-limit = 100</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">lock &#123;</span><br><span class="line">  <span class="params">##</span> the lock store mode: local、remote</span><br><span class="line">  mode = &quot;remote&quot;</span><br><span class="line"></span><br><span class="line">  local &#123;</span><br><span class="line">    <span class="params">##</span> store locks in user&#x27;s database</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  remote &#123;</span><br><span class="line">    <span class="params">##</span> store locks in the seata&#x27;s server</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">recovery &#123;</span><br><span class="line">  <span class="params">#</span>schedule committing retry period in milliseconds</span><br><span class="line">  committing-retry-period = 1000</span><br><span class="line">  <span class="params">#</span>schedule asyn committing retry period in milliseconds</span><br><span class="line">  asyn-committing-retry-period = 1000</span><br><span class="line">  <span class="params">#</span>schedule rollbacking retry period in milliseconds</span><br><span class="line">  rollbacking-retry-period = 1000</span><br><span class="line">  <span class="params">#</span>schedule timeout retry period in milliseconds</span><br><span class="line">  timeout-retry-period = 1000</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">transaction &#123;</span><br><span class="line">  undo.data.validation = true</span><br><span class="line">  undo.log.serialization = &quot;jackson&quot;</span><br><span class="line">  undo.log.save.days = 7</span><br><span class="line">  <span class="params">#</span>schedule delete expired undo<span class="built_in">_</span>log in milliseconds</span><br><span class="line">  undo.log.delete.period = 86400000</span><br><span class="line">  undo.log.table = &quot;undo<span class="built_in">_</span>log&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="params">##</span> metrics settings</span><br><span class="line">metrics &#123;</span><br><span class="line">  enabled = false</span><br><span class="line">  registry-type = &quot;compact&quot;</span><br><span class="line">  <span class="params">#</span> multi exporters use comma divided</span><br><span class="line">  exporter-list = &quot;prometheus&quot;</span><br><span class="line">  exporter-prometheus-port = 9898</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">support &#123;</span><br><span class="line">  <span class="params">##</span> spring</span><br><span class="line">  spring &#123;</span><br><span class="line">    <span class="params">#</span> auto proxy the DataSource bean</span><br><span class="line">    datasource.autoproxy = false</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>registry.conf</li>
</ul>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">registry &#123;</span><br><span class="line">  <span class="params">#</span> file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span><br><span class="line">  type = &quot;nacos&quot;</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr = &quot;localhost:8848&quot;</span><br><span class="line">    namespace = &quot;&quot;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  eureka &#123;</span><br><span class="line">    serviceUrl = &quot;http://localhost:8761/eureka&quot;</span><br><span class="line">    application = &quot;default&quot;</span><br><span class="line">    weight = &quot;1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  redis &#123;</span><br><span class="line">    serverAddr = &quot;localhost:6379&quot;</span><br><span class="line">    db = &quot;0&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  zk &#123;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:2181&quot;</span><br><span class="line">    session.timeout = 6000</span><br><span class="line">    connect.timeout = 2000</span><br><span class="line">  &#125;</span><br><span class="line">  consul &#123;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:8500&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  etcd3 &#123;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    serverAddr = &quot;http://localhost:2379&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  sofa &#123;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:9603&quot;</span><br><span class="line">    application = &quot;default&quot;</span><br><span class="line">    region = &quot;DEFAULT<span class="built_in">_</span>ZONE&quot;</span><br><span class="line">    datacenter = &quot;DefaultDataCenter&quot;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    group = &quot;SEATA<span class="built_in">_</span>GROUP&quot;</span><br><span class="line">    addressWaitTime = &quot;3000&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    name = &quot;file.conf&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">config &#123;</span><br><span class="line">  <span class="params">#</span> file、nacos 、apollo、zk、consul、etcd3</span><br><span class="line">  type = &quot;file&quot;</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr = &quot;localhost&quot;</span><br><span class="line">    namespace = &quot;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  consul &#123;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:8500&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  apollo &#123;</span><br><span class="line">    app.id = &quot;seata-server&quot;</span><br><span class="line">    apollo.meta = &quot;http://192.168.1.204:8801&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  zk &#123;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:2181&quot;</span><br><span class="line">    session.timeout = 6000</span><br><span class="line">    connect.timeout = 2000</span><br><span class="line">  &#125;</span><br><span class="line">  etcd3 &#123;</span><br><span class="line">    serverAddr = &quot;http://localhost:2379&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    name = &quot;file.conf&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>主启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeataOrderService2001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SeataOrderService2001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li><p>业务类<br><img src="/../../images/image-20230228114829681.png" alt="image-20230228114829681"></p>
</li>
<li><p>这里的业务类需要有服务之间的调用，所以还需要用到openfeign，去指定调用其他服务的哪些接口</p>
<ul>
<li>OrderService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;Order&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">creataOrder</span><span class="params">(Order order)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateOrder</span><span class="params">(Long userId,Integer status)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>StorageService，openfeign调用storage微服务</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;seata-storage-service&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StorageService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/storage/decrease&quot;)</span></span><br><span class="line">    ResponseResult <span class="title function_">decrease</span><span class="params">(<span class="meta">@RequestParam(&quot;productId&quot;)</span> Long productId,<span class="meta">@RequestParam(&quot;count&quot;)</span> Integer count)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>AccountSerivceopenfeign调用account微服务</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;seata-account-service&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/account/decrease&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">decreaseaccount</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> Long userId, <span class="meta">@RequestParam(&quot;money&quot;)</span>BigDecimal money)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>OrderServiceImpl</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;orderService&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;OrderMapper, Order&gt; <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StorageService storageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountService accountService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">creataOrder</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;-----------&gt;开始新建订单&quot;</span>);</span><br><span class="line">        <span class="comment">//新建订单</span></span><br><span class="line">        order.setStatus(<span class="number">0</span>);</span><br><span class="line">        save(order);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//扣减库存</span></span><br><span class="line">        log.info(<span class="string">&quot;--------&gt;订单微服务调用库存微服务，做库存扣减&quot;</span>);</span><br><span class="line">        storageService.decrease(order.getProductId(),order.getCount());</span><br><span class="line">        log.info(<span class="string">&quot;--------&gt;订单微服务调用库存微服务，做库存扣减完成&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//扣减余额</span></span><br><span class="line">        log.info(<span class="string">&quot;--------&gt;订单微服务调用账户微服务，做余额扣减&quot;</span>);</span><br><span class="line">        accountService.decreaseaccount(order.getUserId(),order.getMoney());</span><br><span class="line">        log.info(<span class="string">&quot;--------&gt;订单微服务调用库存微服务，做余额扣减完成&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//修改订单状态</span></span><br><span class="line">        log.info(<span class="string">&quot;-----------&gt;开始修改订单状态&quot;</span>);</span><br><span class="line">        updateOrder(order.getUserId(),<span class="number">1</span>);</span><br><span class="line">        log.info(<span class="string">&quot;-----------&gt;结束修改订单状态&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateOrder</span><span class="params">(Long userId, Integer status)</span> &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;Order&gt; orderLambdaQueryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;Order&gt;();</span><br><span class="line">        orderLambdaQueryWrapper.eq(Order::getUserId,userId);</span><br><span class="line">        orderLambdaQueryWrapper.eq(Order::getStatus,<span class="number">0</span>);</span><br><span class="line">        <span class="type">Order</span> <span class="variable">one</span> <span class="operator">=</span> getOne(orderLambdaQueryWrapper);</span><br><span class="line">        one.setStatus(status);</span><br><span class="line">        updateById(one);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="Storage-2002"><a href="#Storage-2002" class="headerlink" title="Storage-2002"></a><strong><font size=6>Storage-2002</font></strong></h5><p>和Order的配置几乎一样，实现Order指定的接口和Controller</p>
<ul>
<li>StorageServiceImpl</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;storageService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StorageServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;StorageMapper, Storage&gt; <span class="keyword">implements</span> <span class="title class_">StorageService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">decrease</span><span class="params">(Long produceId, Integer account)</span> &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;Storage&gt; storageLambdaQueryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;Storage&gt;();</span><br><span class="line">        storageLambdaQueryWrapper.eq(Storage::getProductId,produceId);</span><br><span class="line">        <span class="type">Storage</span> <span class="variable">one</span> <span class="operator">=</span> getOne(storageLambdaQueryWrapper);</span><br><span class="line">        one.setUsed(one.getUsed()+account);</span><br><span class="line">        one.setResidue(one.getResidue()-account);</span><br><span class="line">        updateById(one);</span><br><span class="line">        <span class="keyword">return</span> ResponseResult.okResult(one);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Account-2001"><a href="#Account-2001" class="headerlink" title="Account-2001"></a><strong><font size=6>Account-2001</font></strong></h5><p>和Order的配置几乎一样，实现Order指定的接口和Controller</p>
<ul>
<li>AccountImpl</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;accountService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;AccountMapper, Account&gt; <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">decreaseaccount</span><span class="params">(Long userId, BigDecimal money)</span> &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;Account&gt; accountLambdaQueryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;Account&gt;();</span><br><span class="line">        accountLambdaQueryWrapper.eq(Account::getUserId,userId);</span><br><span class="line">        <span class="type">Account</span> <span class="variable">one</span> <span class="operator">=</span> getOne(accountLambdaQueryWrapper);</span><br><span class="line">        one.setUsed(one.getUsed().add(money));</span><br><span class="line">        one.setResidue(one.getResidue().subtract(money));</span><br><span class="line">        updateById(one);</span><br><span class="line">        <span class="keyword">return</span> ResponseResult.okResult(one);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a><strong><font size=6>测试</font></strong></h5><p>出现了很多不同的错误</p>
<p>1、首先是 每个项目老是需要在 project struceter中修改 language level，直接在父工程上指定 版本</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>2、微服务之间的调用出现空值</p>
<p><img src="/../../images/image-20230228120214348.png" alt="image-20230228120214348"></p>
<p>原因是我在Order微服务中，使用openfeign去调用StorageService的微服务的接口时，指定了@RequestParam的名称，但是在StorageController 里没有指定，而且参数名还不一样。</p>
<p><img src="/../../images/image-20230228120417346.png" alt="image-20230228120417346"></p>
<p><img src="/../../images/image-20230228120430331.png" alt="image-20230228120430331"></p>
<p>3、某个微服务中出现异常，和上面的类似</p>
<p><img src="/../../images/image-20230228120841914.png" alt="image-20230228120841914"></p>
<p>会指定到 StorageService中的decrease方法出现了异常，只需要去调试对饮的实现方法就行</p>
<p>正常执行，</p>
<p><img src="/../../images/image-20230228123822371.png" alt="image-20230228123822371"></p>
<ul>
<li>order表</li>
</ul>
<p><img src="/../../images/image-20230228140716992.png" alt="image-20230228140716992"></p>
<ul>
<li>storage 表</li>
</ul>
<p><img src="/../../images/image-20230228123910993.png" alt="image-20230228123910993"></p>
<ul>
<li>account 表</li>
</ul>
<p><img src="/../../images/image-20230228123924441.png" alt="image-20230228123924441"></p>
<p>可以看到，上面出现了那么多异常，但是有些逻辑是正常执行的，导致了数据库数据不一致，这也是我们一开始需要解决的问题。</p>
<p>上面一开始介绍也说了只需要一个 @GloableTransational就能够解决这些问题。这个注解加在业务逻辑的入口。</p>
<p><img src="/../../images/image-20230228140856735.png" alt="image-20230228140856735"></p>
<p><img src="/../../images/image-20230228141111455.png" alt="image-20230228141111455"></p>
<p><img src="/../../images/image-20230228141216449.png" alt="image-20230228141216449"></p>
<h3 id="原理简介"><a href="#原理简介" class="headerlink" title="原理简介"></a>原理简介</h3><p>再回到上面对于Seata几个基本概念的解释</p>
<p><img src="/../../images/image-20230228150437734.png" alt="image-20230228150437734"></p>
<p>现在可以具体的将这几个概念归结为如下意思：</p>
<ul>
<li>TC： Seata 服务器，全局管理我们的事务</li>
<li>TM：需要有事务控制的业务函数的入口，也就是加了@GloableTranstional的方法</li>
<li>RM：每个参与事务的数据库，</li>
</ul>
<p>同样满足分布式数据库业务的两段提交协议：</p>
<ul>
<li><p>第一阶段、业务执行时，seata会拦截要执行的sql语句，并且对sql语句执行前的数据库状态进行拦截，生成执行前快照，并且保存到每一个数据库中的undo_log中，执行完成后又会保存执行后的数据库状态，并且生成行锁。</p>
</li>
<li><p>第二阶段、由于第一阶段已经执行了业务sql语句，数据库可能已经发生跟新，也有可能出现失败</p>
<ul>
<li>如果顺利执行提交，那么seata只需要将上面保存的快照数据和行锁删掉就行了</li>
<li>如果不成功seata会根据拦截到的业务sql，执行对应的逆向sql语句，还原为执行前的状态，删除前后快照，和行锁。</li>
</ul>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://yimeng436.github.io">异梦</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://yimeng436.github.io/2022/08/21/SpringCloud/SpringCloud/">https://yimeng436.github.io/2022/08/21/SpringCloud/SpringCloud/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yimeng436.github.io" target="_blank">异梦的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a></div><div class="post_share"><div class="social-share" data-image="/img/top.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/08/21/SpringSecurity/SpringSecurity/"><img class="prev-cover" src="/img/top.png" onerror="onerror=null;src='/img/cover.png'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">SpringSecurity</div></div></a></div><div class="next-post pull-right"><a href="/2022/08/20/MybatisPlus/MybatisPlus/"><img class="next-cover" src="/img/top.png" onerror="onerror=null;src='/img/cover.png'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MybatisPlus</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/01/04/%E5%A4%9A%E6%80%81%E4%BE%8B%E9%A2%98/%E5%A4%9A%E6%80%81%E4%BE%8B%E9%A2%98/" title="多态例题"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-04</div><div class="title">多态例题</div></div></a></div><div><a href="/2022/06/06/%E8%87%AA%E5%8A%A8%E6%8B%86%E8%A3%85%E7%AE%B1/%E8%87%AA%E5%8A%A8%E6%8B%86%E8%A3%85%E7%AE%B1/" title="自动拆装箱"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-06</div><div class="title">自动拆装箱</div></div></a></div><div><a href="/2022/06/15/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="多线程"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-15</div><div class="title">多线程</div></div></a></div><div><a href="/2022/06/30/JavaWeb/JavaWeb/" title="JavaWeb"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-30</div><div class="title">JavaWeb</div></div></a></div><div><a href="/2022/07/25/Mybatis/Mybatis/" title="Mybatis"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-25</div><div class="title">Mybatis</div></div></a></div><div><a href="/2022/07/26/%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%8F%8D%E5%B0%84/%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%8F%8D%E5%B0%84/" title="注解和反射"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-26</div><div class="title">注解和反射</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="http://mms2.baidu.com/it/u=665033858,976373917&amp;fm=253&amp;app=138&amp;f=JPEG&amp;fmt=auto&amp;q=75?w=500&amp;h=500" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">异梦</div><div class="author-info__description">欢迎访问</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">46</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/yimeng436" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2441844062@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringBoot-%E5%92%8CSpringCloud-%E5%85%B3%E7%B3%BB"><span class="toc-number">1.</span> <span class="toc-text">SpringBoot 和SpringCloud 关系</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%88%B6%E5%B7%A5%E7%A8%8B%EF%BC%8C%E7%AE%A1%E7%90%86%E5%AD%90%E5%B7%A5%E7%A8%8B%E7%9A%84%E6%89%80%E6%9C%89%E9%85%8D%E7%BD%AE%EF%BC%882020-12%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">创建一个父工程，管理子工程的所有配置（2020.12）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%90%E5%B7%A5%E7%A8%8B1-api"><span class="toc-number">2.1.</span> <span class="toc-text">子工程1-api</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%90%E5%B7%A5%E7%A8%8B2-provider-8001"><span class="toc-number">2.2.</span> <span class="toc-text">子工程2-provider-8001</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%90%E5%B7%A5%E7%A8%8B3-springcloud-consummer-80"><span class="toc-number">2.3.</span> <span class="toc-text">子工程3-springcloud-consummer-80</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#eureka"><span class="toc-number">3.</span> <span class="toc-text">eureka</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%90%E6%A8%A1%E5%9D%974-springcloud-eureka-7001"><span class="toc-number">3.1.</span> <span class="toc-text">子模块4-springcloud-eureka-7001</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86%E5%AD%90%E5%B7%A5%E7%A8%8B2%E6%8F%90%E4%BE%9B%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%90%91eureka%E6%B3%A8%E5%86%8C"><span class="toc-number">3.2.</span> <span class="toc-text">将子工程2提供的服务向eureka注册</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#eureka-%E5%92%8C-zookeeper%E5%8C%BA%E5%88%AB"><span class="toc-number">4.</span> <span class="toc-text">eureka 和 zookeeper区别</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CAP%E5%8E%9F%E5%88%99"><span class="toc-number">4.1.</span> <span class="toc-text">CAP原则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eureka-%E5%92%8C-zookeeper%E5%8C%BA%E5%88%AB-1"><span class="toc-number">4.2.</span> <span class="toc-text">eureka 和 zookeeper区别</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ribbon"><span class="toc-number">5.</span> <span class="toc-text">ribbon</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Feign"><span class="toc-number">6.</span> <span class="toc-text">Feign</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hystrix"><span class="toc-number">7.</span> <span class="toc-text">Hystrix</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Zuul"><span class="toc-number">8.</span> <span class="toc-text">Zuul</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringCloud-Config"><span class="toc-number">9.</span> <span class="toc-text">SpringCloud Config</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Cloud-%E5%8D%87%E7%BA%A7%EF%BC%882022-01%EF%BC%89"><span class="toc-number">10.</span> <span class="toc-text">Cloud 升级（2022.01）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%858001"><span class="toc-number">10.1.</span> <span class="toc-text">服务提供者8001</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%8580"><span class="toc-number">10.2.</span> <span class="toc-text">服务消费者80</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">10.3.</span> <span class="toc-text">注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#eureka-1"><span class="toc-number">10.3.1.</span> <span class="toc-text">eureka</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#server%E4%BD%BF%E7%94%A8"><span class="toc-number">10.3.1.1.</span> <span class="toc-text">server使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#client-%E4%BD%BF%E7%94%A8"><span class="toc-number">10.3.1.2.</span> <span class="toc-text">client 使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#eureka%E9%9B%86%E7%BE%A4server%E4%BD%BF%E7%94%A8"><span class="toc-number">10.3.1.3.</span> <span class="toc-text">eureka集群server使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#eureka%E9%9B%86%E7%BE%A4client%E4%BD%BF%E7%94%A8"><span class="toc-number">10.3.1.4.</span> <span class="toc-text">eureka集群client使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E4%B8%AA%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%EF%BC%8C%E6%95%B4%E5%90%88Ribbon%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">10.3.1.5.</span> <span class="toc-text">多个微服务提供者，整合Ribbon实现负载均衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">10.3.1.6.</span> <span class="toc-text">服务发现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zookeeper"><span class="toc-number">10.3.2.</span> <span class="toc-text">zookeeper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Consul"><span class="toc-number">10.3.3.</span> <span class="toc-text">Consul</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#provider%E4%BD%BF%E7%94%A8"><span class="toc-number">10.3.3.1.</span> <span class="toc-text">provider使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#consumer%E4%BD%BF%E7%94%A8"><span class="toc-number">10.3.3.2.</span> <span class="toc-text">consumer使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E4%B8%AA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E7%9A%84%E5%BC%82%E5%90%8C"><span class="toc-number">10.3.4.</span> <span class="toc-text">三个注册中心的异同</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="toc-number">10.4.</span> <span class="toc-text">服务调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ribbon"><span class="toc-number">10.4.1.</span> <span class="toc-text">Ribbon</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LB%E7%AE%97%E6%B3%95%E6%9B%BF%E6%8D%A2"><span class="toc-number">10.4.1.1.</span> <span class="toc-text">LB算法替换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AE%E8%AF%A2%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">10.4.1.2.</span> <span class="toc-text">轮询的原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenFeign"><span class="toc-number">10.4.2.</span> <span class="toc-text">OpenFeign</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">10.4.2.1.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6"><span class="toc-number">10.4.2.2.</span> <span class="toc-text">超时控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%A2%9E%E5%BC%BA"><span class="toc-number">10.4.2.3.</span> <span class="toc-text">日志增强</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%8B%A6%E6%88%AA"><span class="toc-number">10.4.2.4.</span> <span class="toc-text">请求拦截</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E3%80%81%E7%86%94%E6%96%AD%E3%80%81%E9%99%90%E6%B5%81"><span class="toc-number">10.5.</span> <span class="toc-text">服务降级、熔断、限流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hystrix-1"><span class="toc-number">10.5.1.</span> <span class="toc-text">Hystrix</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="toc-number">10.5.1.1.</span> <span class="toc-text">服务降级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E8%A7%A3%E5%86%B3"><span class="toc-number">10.5.1.2.</span> <span class="toc-text">优化解决</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="toc-number">10.5.1.3.</span> <span class="toc-text">服务熔断</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3"><span class="toc-number">10.6.</span> <span class="toc-text">服务网关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Gateway%E5%92%8Czuul%E5%AF%B9%E6%AF%94"><span class="toc-number">10.6.1.</span> <span class="toc-text">Gateway和zuul对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gateway%E4%B8%89%E5%A4%A7%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">10.6.2.</span> <span class="toc-text">Gateway三大核心概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Route"><span class="toc-number">10.6.3.</span> <span class="toc-text">Route</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Predicate"><span class="toc-number">10.6.4.</span> <span class="toc-text">Predicate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filter"><span class="toc-number">10.6.5.</span> <span class="toc-text">Filter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">10.7.</span> <span class="toc-text">服务配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">10.7.1.</span> <span class="toc-text">服务端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">10.7.2.</span> <span class="toc-text">客户端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF"><span class="toc-number">10.8.</span> <span class="toc-text">消息总线</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%94%B9%E8%BF%9B"><span class="toc-number">10.8.1.</span> <span class="toc-text">配置中心服务端改进</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%94%B9%E8%BF%9B"><span class="toc-number">10.8.2.</span> <span class="toc-text">配置中心客户端改进</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">10.8.3.</span> <span class="toc-text">原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cloud-Stream"><span class="toc-number">10.9.</span> <span class="toc-text">Cloud Stream</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">10.9.1.</span> <span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-1"><span class="toc-number">10.9.2.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sleuth"><span class="toc-number">10.10.</span> <span class="toc-text">Sleuth</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-Cloud-Alibaba"><span class="toc-number">11.</span> <span class="toc-text">Spring Cloud Alibaba</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">11.1.</span> <span class="toc-text">Nacos 服务注册和配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">11.1.1.</span> <span class="toc-text">Nacos注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BE%9B%E8%80%85"><span class="toc-number">11.1.1.1.</span> <span class="toc-text">提供者</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">11.1.1.2.</span> <span class="toc-text">消费者</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">11.1.2.</span> <span class="toc-text">Nacos配置中心</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">11.2.</span> <span class="toc-text">命名空间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos%E9%9B%86%E7%BE%A4%E5%92%8C%E6%8C%81%E4%B9%85%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-number">11.3.</span> <span class="toc-text">Nacos集群和持久化配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-number">11.3.1.</span> <span class="toc-text">持久化配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">11.3.2.</span> <span class="toc-text">集群配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel"><span class="toc-number">11.4.</span> <span class="toc-text">Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-2"><span class="toc-number">11.4.1.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B0%87%E7%82%B9%E6%8E%A7%E5%88%B6%E7%95%8C%E9%9D%A2"><span class="toc-number">11.4.2.</span> <span class="toc-text">簇点控制界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="toc-number">11.4.3.</span> <span class="toc-text">流控规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%8D%E7%BA%A7%E8%A7%84%E5%88%99"><span class="toc-number">11.4.4.</span> <span class="toc-text">降级规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99"><span class="toc-number">11.4.5.</span> <span class="toc-text">热点规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SentinelResource%E5%BC%95%E5%85%A5"><span class="toc-number">11.4.5.1.</span> <span class="toc-text">@SentinelResource引入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E4%BE%8B%E5%A4%96%E9%A1%B9"><span class="toc-number">11.4.5.2.</span> <span class="toc-text">参数例外项</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SentinelResource"><span class="toc-number">11.4.6.</span> <span class="toc-text">@SentinelResource</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="toc-number">11.4.6.1.</span> <span class="toc-text">解决方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E5%90%88Ribbon%E3%80%81Openfeign"><span class="toc-number">11.4.6.2.</span> <span class="toc-text">整合Ribbon、Openfeign</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#fallbcak%E5%8F%82%E6%95%B0"><span class="toc-number">11.4.6.2.1.</span> <span class="toc-text">fallbcak参数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E8%A7%84%E5%88%99"><span class="toc-number">11.4.7.</span> <span class="toc-text">持久化规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Seata"><span class="toc-number">11.5.</span> <span class="toc-text">Seata</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">11.5.1.</span> <span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-3"><span class="toc-number">11.5.2.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">11.5.3.</span> <span class="toc-text">例子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="toc-number">11.5.3.1.</span> <span class="toc-text">准备环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E7%BC%96%E5%86%99"><span class="toc-number">11.5.3.2.</span> <span class="toc-text">模块编写</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Order-2001"><span class="toc-number">11.5.3.2.1.</span> <span class="toc-text">Order-2001</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Storage-2002"><span class="toc-number">11.5.3.2.2.</span> <span class="toc-text">Storage-2002</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Account-2001"><span class="toc-number">11.5.3.2.3.</span> <span class="toc-text">Account-2001</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">11.5.3.2.4.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E7%AE%80%E4%BB%8B"><span class="toc-number">11.5.4.</span> <span class="toc-text">原理简介</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/10/14/Paper-FSAF/Paper-FSAF/" title="FSAF论文"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="FSAF论文"/></a><div class="content"><a class="title" href="/2022/10/14/Paper-FSAF/Paper-FSAF/" title="FSAF论文">FSAF论文</a><time datetime="2022-10-13T16:00:00.000Z" title="发表于 2022-10-14 00:00:00">2022-10-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/25/Paper-Faster-RCNN/Paper-Faster-RCNN/" title="Faster-RCNN论文"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="Faster-RCNN论文"/></a><div class="content"><a class="title" href="/2022/08/25/Paper-Faster-RCNN/Paper-Faster-RCNN/" title="Faster-RCNN论文">Faster-RCNN论文</a><time datetime="2022-08-24T16:00:00.000Z" title="发表于 2022-08-25 00:00:00">2022-08-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/25/Netty/Netty/" title="Netty"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="Netty"/></a><div class="content"><a class="title" href="/2022/08/25/Netty/Netty/" title="Netty">Netty</a><time datetime="2022-08-24T16:00:00.000Z" title="发表于 2022-08-25 00:00:00">2022-08-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/23/Nginx/nginx/" title="Nginx"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="Nginx"/></a><div class="content"><a class="title" href="/2022/08/23/Nginx/nginx/" title="Nginx">Nginx</a><time datetime="2022-08-22T16:00:00.000Z" title="发表于 2022-08-23 00:00:00">2022-08-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/22/Redis/Redis/" title="Redis"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="Redis"/></a><div class="content"><a class="title" href="/2022/08/22/Redis/Redis/" title="Redis">Redis</a><time datetime="2022-08-21T16:00:00.000Z" title="发表于 2022-08-22 00:00:00">2022-08-22</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 异梦</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>
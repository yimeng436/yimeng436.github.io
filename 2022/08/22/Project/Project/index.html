<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Project | 异梦的博客</title><meta name="keywords" content="Java"><meta name="author" content="异梦"><meta name="copyright" content="异梦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Project">
<meta property="og:type" content="article">
<meta property="og:title" content="Project">
<meta property="og:url" content="https://yimeng436.github.io/2022/08/22/Project/Project/index.html">
<meta property="og:site_name" content="异梦的博客">
<meta property="og:description" content="Project">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yimeng436.github.io/img/top.png">
<meta property="article:published_time" content="2022-08-21T16:00:00.000Z">
<meta property="article:modified_time" content="2023-12-16T01:34:22.101Z">
<meta property="article:author" content="异梦">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yimeng436.github.io/img/top.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://yimeng436.github.io/2022/08/22/Project/Project/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Project',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-12-16 09:34:22'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="http://mms2.baidu.com/it/u=665033858,976373917&amp;fm=253&amp;app=138&amp;f=JPEG&amp;fmt=auto&amp;q=75?w=500&amp;h=500" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">62</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/top.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">异梦的博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Project</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-21T16:00:00.000Z" title="发表于 2022-08-22 00:00:00">2022-08-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-12-16T01:34:22.101Z" title="更新于 2023-12-16 09:34:22">2023-12-16</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Project"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="project-mall"><a href="#project-mall" class="headerlink" title="project-mall"></a><strong><font size=7>project-mall</font></strong></h1><h1 id="业务图"><a href="#业务图" class="headerlink" title="业务图"></a>业务图</h1><p><img src="/../../images/image-20230309154130529.png" alt="image-20230309154130529"></p>
<p>这是一个B2C的一个模式， business 2 customer。主要包含以下几个模块：</p>
<p>1、后台管理系统</p>
<p>2、搜索</p>
<p>3、商品详情</p>
<p>4、购物车</p>
<p>5、单点登录</p>
<p>6、用户下单</p>
<p>7、结算支付</p>
<p>8、支付服务</p>
<p>9、商品秒杀</p>
<p>10、项目部署</p>
<p><strong><font size=5>所需的依赖：</font></strong></p>
<ul>
<li>mysql</li>
<li>rabbitmq</li>
<li>redis</li>
<li>elsaticsearch+kibana+logstash</li>
<li>nacos</li>
<li>sentinel</li>
<li>zipkin</li>
<li>minio</li>
</ul>
<h1 id="项目的整体架构"><a href="#项目的整体架构" class="headerlink" title="项目的整体架构"></a>项目的整体架构</h1><p>从整体结构上看，整个项目的父工程 mall-parent，父工程下的子工程分为通用模块，业务模块，实体类模块。</p>
<p>为了防止引入不必要的依赖，对每个模块在进行细分。</p>
<ul>
<li>通用模块：common，本来应该是所有服务都需要依赖的，大概对其划分成以下几部分<ul>
<li>common-util，工具类模块，让这部分被所有服务依赖，作为基础依赖</li>
<li>redis-util，只有有需要使用到redis的部分才需要引入</li>
<li>service-util，业务类才需要引入</li>
<li>xxx-util，其他</li>
</ul>
</li>
<li>业务模块：service，每个不同的业务在这个模块下在进行细分<ul>
<li>购物车</li>
<li>支付</li>
<li>……..</li>
</ul>
</li>
<li>实体类模块，model</li>
</ul>
<h1 id="mall-parent-整体架构搭建"><a href="#mall-parent-整体架构搭建" class="headerlink" title="mall-parent(整体架构搭建)"></a>mall-parent(整体架构搭建)</h1><ul>
<li>pom.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yhz<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mall-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--定义jar包的版本号--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cloud.version</span>&gt;</span>Hoxton.SR8<span class="tag">&lt;/<span class="name">cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">alibaba.version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">alibaba.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">gmall.version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">gmall.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mybatis-plus.version</span>&gt;</span>3.4.1<span class="tag">&lt;/<span class="name">mybatis-plus.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>5.1.46<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">swagger.version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">swagger.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.18.10<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fastjson.version</span>&gt;</span>1.2.29<span class="tag">&lt;/<span class="name">fastjson.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redisson.version</span>&gt;</span>3.15.3<span class="tag">&lt;/<span class="name">redisson.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pool2.version</span>&gt;</span>2.6.0<span class="tag">&lt;/<span class="name">pool2.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">httpclient.version</span>&gt;</span>4.5.13<span class="tag">&lt;/<span class="name">httpclient.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--配置dependencyManagement锁定依赖的版本 并不是实际的依赖。--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;alibaba.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--mybatis-plus 持久层--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--swagger--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;swagger.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--swagger ui--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;swagger.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;fastjson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- redisson 分布式锁--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;redisson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- spring2.X集成redis所需common-pool2--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;pool2.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;httpclient.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="common"><a href="#common" class="headerlink" title="common"></a>common</h2><ul>
<li>pom.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided <span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--lombok用来简化实体类：需要安装lombok插件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--swagger--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--用来转换json使用 &#123;JavaObject - json | json - JavaObject&#125;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 服务调用feign --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided <span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h3 id="common-utils"><a href="#common-utils" class="headerlink" title="common-utils"></a>common-utils</h3><ul>
<li>pom.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>这个模块下定义了全局异常、统一请求格式、http请求状态码枚举类。授权、日期、ip、http请求、加密的工具类。</p>
<p><img src="/../../images/image-20230310142909579.png" alt="image-20230310142909579"></p>
<h3 id="service-utils"><a href="#service-utils" class="headerlink" title="service-utils"></a>service-utils</h3><ul>
<li>pom.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- redis --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- spring2.X集成redis所需common-pool2--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- redisson 分布式锁--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--mybatis-plus--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>





<p>这个模块下定义了，redis、MP、Swagger、Redisson的配置。以及redis的常量和全局异常拦截处理的handler。cache那个包下面的先不管他，后面会自己实现。</p>
<p><img src="/../../images/image-20230310144029101.png" alt="image-20230310144029101"></p>
<h2 id="model"><a href="#model" class="headerlink" title="model"></a>model</h2><ul>
<li>pom.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--mybatis-plus--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided <span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--swagger--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided <span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided <span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided <span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>





<p>这个模块中主要定义了各种的实体类，有一个比较特殊的设计就是将每个实体类都有的字段提到了一个父类，baseentity：包括id、date、逻辑删除。</p>
<p><img src="/../../images/image-20230310144716548.png" alt="image-20230310144716548"></p>
<h2 id="service"><a href="#service" class="headerlink" title="service"></a>service</h2><ul>
<li>pom.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--依赖服务的工具类--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yhz<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>service-utils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--数据载体--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yhz<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>model<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--web 需要启动项目--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--mybatis-plus--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--mysql--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 服务注册 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 服务配置--&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 服务调用feign --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 流量控制 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--开发者工具--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--链路追踪--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>这个模块就是我们后面主要要完成的部分。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p><img src="/../../images/image-20230310145453317.png" alt="image-20230310145453317"></p>
<p>拿到这么一张总体需要实现的业务图，从哪里开始？</p>
<p>一般来说我们会选择，从后台管理部分开始。先保证了整个项目的数据可以被正常的操作，然后再去完成别的部分的实现。</p>
<p>然后就会跟着箭头指向，依次实现：商品详情(其实也可以先实现首页，因为一般都会按照箭头的起始功能进行开发)、首页(包括搜索)、购物车(包括登录)、支付</p>
<h2 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h2><p>明确了先要从后台管理部分开始，那么后台管理部分最首先的就是需要构建对应的数据库，除去各种类型商品对应表以外，对于一个商城的系统，我们以京东为例，还需要有怎么样的设计。我们在首页可以看到对商品基本信息的分类，</p>
<p><img src="/../../images/image-20230310150058033.png" alt="image-20230310150058033"></p>
<p>这是一个三级分类的数据显示，那么需要这么设计对应的数据库呢？</p>
<p>我们在RuoYi系统中也碰到过类似的设计，比如说，用户管理这个部分下面包括了用户的curd以及数据的导出。这个做法是在单表中增加一个 parent_id，通过单表自连查询。</p>
<p>我们在这里可以参考类似的思想，每个分类都构建一张表，子分类会有一个parent_id引用父分类的id。</p>
<p>那么这个分类的表的设计就可以设计成这样。</p>
<p><img src="/../../images/image-20230310151645725.png" alt="image-20230310151645725"></p>
<h2 id="平台属性"><a href="#平台属性" class="headerlink" title="平台属性"></a>平台属性</h2><p>同样有类似功能的是，可以在搜索商品时我们对商品进行过滤的平台属性。</p>
<p><img src="/../../images/image-20230310151301882.png" alt="image-20230310151301882"></p>
<p>这是一个二级分类的界面，搜索时可以通过选择某些属性进行条件筛选。并且这个平台属性和我们上面的三级分类也是有关系的，对应的分类只会显示出有关系的可以过滤的属性。上面叫做分类的话这一部分我们就称之为分层吧。</p>
<p>我们需要根据三个分类表去确定到一个分层的表，才能拿到在某个具体类别下的可以参与过滤的属性，而这个属性又是一个二级分层的，所以又可以和上面的实现一样，增加一个关联父层的id字段属性，那么这几张表的结构就变成下面这种形：</p>
<p><img src="/../../images/image-20230310151929945.png" alt="image-20230310151929945"></p>
<h2 id="销售属性"><a href="#销售属性" class="headerlink" title="销售属性"></a>销售属性</h2><p>我们在每个商品的详细页面中，同样会需要选择商品的各种属性，如下</p>
<p><img src="/../../images/image-20230310153222325.png" alt="image-20230310153222325"></p>
<p>这个界面还会出现对于选择不同的属性，可能会出现价格和商品名称的改变，所以这个选择不同的属性是会跳转到同类型商品下的 “兄弟” 商品的。</p>
<p>所以每个商品都有一个对应的一个大类别的名称，根据不同的属性选择具体的商品，这个大类别叫做spu。而通过具体的属性确定下来的商品就叫做sku。</p>
<p>比如，iphone12 这个大类就是一个sku，而iphone 12 白色 256G  5000元，就是一个sku。</p>
<p>spu是一组可复用，易检索的信息集合，sku &#x3D; spu+销售属性。</p>
<p>spu的构建就可以是所有sku公共属性，id，介绍，评论</p>
<p>sku的构建就是每个具体商品的特殊属性，价格、商品名</p>
<h1 id="后台管理的开发-商品的各种操作-：service-product"><a href="#后台管理的开发-商品的各种操作-：service-product" class="headerlink" title="后台管理的开发(商品的各种操作)：service-product"></a>后台管理的开发(商品的各种操作)：service-product</h1><p>启动docker服务，查看以下镜像的状态。</p>
<p><img src="/../../images/image-20230310160545624.png" alt="image-20230310160545624"></p>
<p>我们先要连接到这里的数据库，然后创建对应的表。</p>
<p><img src="/../../images/image-20230310160611264.png" alt="image-20230310160611264"></p>
<p><img src="/../../images/image-20230310160638541.png" alt="image-20230310160638541"></p>
<p>创建表：</p>
<p><img src="/../../images/image-20230310162151500.png" alt="image-20230310162151500"></p>
<p>这个表可以分成两个部分来看</p>
<p>上面那一部分就是前面讲的平台属性和基本检索信息的内容，后面一部分就是  spu和sku。</p>
<ul>
<li>第一部分：</li>
</ul>
<blockquote>
<p>base_category1、2、3 ：就是基本的检索信息，</p>
<p>base_attr_info：保存了根据具体的层级能够显示的基本搜索条件(手机的内存、颜色…) ，同时也可以用于sku属性的检索</p>
<p> base_attr_value：根据层级和可以确定base_attr_info中的id在这里查找出具体的检索项(8G、16G…)   ，同时也可以作为sku属性具体内容的检索</p>
<p>base_category_trademark：根据第三级的分类id保存的商标的id</p>
<p>base_trademark：品牌id对应的品牌名</p>
</blockquote>
<ul>
<li>第二部分</li>
</ul>
<blockquote>
<p>spu_info：保存了 一个大类 的基本属性(id、名称、对这类商品的评论…..：1、华为p50、很好…..)，根据三级分类的id来确定某一类商品，类似于一个分类表。</p>
<p>spu_poster和spu_image：保存了sku id对应的要展示的图片等内容</p>
<p>spu_sale_attr：spu_id对应的可以检索的内容名称(颜色、版本、容量大小)，这些名称是通过base_sale_attr_id在base_sale_attr表中获取的</p>
<p>spu_sale_attr_value：根据spu的id 和 base_sale_attr_id确定spu_sale_attr的检索名对应检索的具体内容(白色、旗舰版、8G…..)，</p>
<p>sku_info：存储了具体的某个商品的sku_id、价格、名称</p>
<p>sku_img：sku_id对应的显示图片的内容</p>
<p>sku_sale_attr_value：sku_id对应的在spu_sale_attr_value保存商品的销售属性</p>
</blockquote>
<ul>
<li><p>yml</p>
<ul>
<li>bootstrap</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service-product</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.73</span><span class="number">.129</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.73</span><span class="number">.129</span><span class="string">:8848</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br></pre></td></tr></table></figure>

<ul>
<li>application</li>
</ul>
</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>



<p>配置中心中还有对应的基础配置，</p>
<p><img src="/../../images/image-20230315164718910.png" alt="image-20230315164718910"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8206</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*Mapper.xml</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.73.129:3306/mall_product</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.73</span><span class="number">.129</span></span><br><span class="line">    <span class="attr">password:</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://192.168.73.129:9411</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.73</span><span class="number">.129</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br></pre></td></tr></table></figure>





<ul>
<li>启动类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.yhz.gmall&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceProductApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ServiceProductApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>业务类</li>
</ul>
<p>……………</p>
<h2 id="遇到的部分问题，以及知识点回顾"><a href="#遇到的部分问题，以及知识点回顾" class="headerlink" title="遇到的部分问题，以及知识点回顾"></a>遇到的部分问题，以及知识点回顾</h2><h3 id="复杂sql的结果集映射问题"><a href="#复杂sql的结果集映射问题" class="headerlink" title="复杂sql的结果集映射问题"></a>复杂sql的结果集映射问题</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	id:映射的名称全局唯一</span></span><br><span class="line"><span class="comment">	type：查询结果映射为哪一个实体类</span></span><br><span class="line"><span class="comment">	&lt;id&gt;: 将查询结果的字段名和实体类的属性名进行映射</span></span><br><span class="line"><span class="comment">	&lt;collection&gt; 对集合的映射 </span></span><br><span class="line"><span class="comment">		property：实体类的属性名</span></span><br><span class="line"><span class="comment">		ofType：实体类属性名的类型</span></span><br><span class="line"><span class="comment">			&lt;id&gt; 和上面的一样</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;BaseAttrInfoMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.yhz.gmall.model.product.BaseAttrInfo&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;attr_info_id&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;attr_name&quot;</span> <span class="attr">property</span>=<span class="string">&quot;attrName&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;category_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;categoryId&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;category_level&quot;</span> <span class="attr">property</span>=<span class="string">&quot;categoryLevel&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;attrValueList&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;com.yhz.gmall.model.product.BaseAttrValue&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;attr_value_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;value_name&quot;</span> <span class="attr">property</span>=<span class="string">&quot;valueName&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;attr_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;attrId&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h3 id="事务处理"><a href="#事务处理" class="headerlink" title="事务处理"></a>事务处理</h3><blockquote>
<p>@Transactional：只会对RuntimeExcetion进行回滚，要增加回滚的级别需要用rollbackFor进行指定</p>
<p>@Transactional(rollbackFor &#x3D; Exception.class)</p>
</blockquote>
<h3 id="网关配置"><a href="#网关配置" class="headerlink" title="网关配置"></a>网关配置</h3><p>前端都是统一的，localhost+&#x2F;url，但是后端有很多不同的服务，所以提供的端口也不同，所以需要有一个能够转换的东西，nginx和gateways都可以。</p>
<p>单独创建一个网关的服务，为不同的服务配上路由，主要就是 routes、predicates这两个东西</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.73</span><span class="number">.129</span><span class="string">:8848</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.73</span><span class="number">.129</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span>    <span class="comment">#开启动态路由，并且和注册中心的服务id进行绑定，可以通过服务id进行访问</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-product</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-product</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">Path=/*/product/**</span></span><br></pre></td></tr></table></figure>





<h3 id="跨域"><a href="#跨域" class="headerlink" title="跨域"></a>跨域</h3><p>网关配置完了之后理论上前后端是可以进行调用了，但是还会有一个跨域的问题。控制台上可以看到对应的错误消息：</p>
<p><img src="/../../images/image-20230317135330429.png" alt="image-20230317135330429"></p>
<p>当前是XMLHttpRequest ，这个就是要给ajax请求，从8888到80出现了跨域的问题，也就是端口不一致。</p>
<p>跨域本身是一种浏览器的自我保护机制，为了防止非法网站读取用户在别的网站上的cookie信息，从而模拟用户进入别的网站窃取个人隐私。</p>
<p>ip、端口、域名、协议不同都会出现跨域问题。</p>
<p>我们现在的前后端分离的开发模式，前端是一个端口，请求的后端肯定是不同的端口号，所以一定会出现跨域问题，</p>
<p>如何解决？</p>
<ul>
<li><p>nginx，前端的请求都由nginx进行反向代理找到后端的接口，缺点需要频繁修改配置文件</p>
</li>
<li><p>cors：跨域资源共享，只需要配置允许某个跨域请求就可以了，缺点会先进行一次预检，浪费一次请求，用于判断是否允许当前访问。配置方式如下：</p>
<ul>
<li><p>局部配置，在需要允许跨域的controller加上@CrossOrigin注解，post请求好像无法实现</p>
</li>
<li><p>全局配置：我所有的请求都需要过gateway，所以我们需要在gateway里进行配置</p>
<ul>
<li><p>注入bean实现<br><img src="/../../images/image-20230317144118549.png" alt="image-20230317144118549"></p>
</li>
<li><p>实现WebMvcConfigurer，重写addCorsMappings方法实现</p>
</li>
</ul>
<p><img src="/../../images/image-20230317144219083.png" alt="image-20230317144219083"></p>
</li>
</ul>
</li>
</ul>
<h3 id="bootstrap和application"><a href="#bootstrap和application" class="headerlink" title="bootstrap和application"></a>bootstrap和application</h3><p>bootstrap是父容器创建的，而这两个配置文件的特点是，父容器的配置不会被子容器覆盖，所以我们在bootstrap一般配置引导性的配置，如配置中心的地址。</p>
<h3 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h3><p>mybatis-plus实现分页只需要创建一个page对象，指定页数也大小。 调用page方法，传入page对象和条件构造器就行了。</p>
<p>Page对象包括的内容：</p>
<p><img src="/../../images/image-20230317161410377.png" alt="image-20230317161410377"></p>
<p>对于单表查询，Mapper提供了更简单的分页查询的方式，selectPage方法，同样传递page对象和条件构造器。会返回一个page对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> IPage&lt;SpuInfo&gt; <span class="title function_">getSpuInfo</span><span class="params">(Page&lt;SpuInfo&gt; pageInfo, Long category3Id)</span> &#123;</span><br><span class="line">    LambdaQueryWrapper&lt;SpuInfo&gt; spuInfoqw= <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    spuInfoqw.eq(SpuInfo::getCategory3Id,category3Id);</span><br><span class="line">    <span class="keyword">return</span> supManagerMapper.selectPage(pageInfo, spuInfoqw);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="Minio"><a href="#Minio" class="headerlink" title="Minio"></a>Minio</h3><p>这是这个项目中新用到的技术，就是用于存储图片、视频等对象数据的对象存储服务。有点类似于在Blog项目中使用到的七牛云 OOS。</p>
<p>Minio有一个纠错码机制，使得数据安全性很高，并且可恢复性也很高。还提供可视化界面。</p>
<p>默认的用户名密码是，admin  admin123456</p>
<p><img src="/../../images/image-20230318125928270.png" alt="image-20230318125928270"></p>
<p>需要存储东西，所以有一个“桶”的概念，需要创建一个桶来存储数据。</p>
<p><img src="/../../images/image-20230318130149631.png" alt="image-20230318130149631"> </p>
<p>进入桶之后，就可以直接在这里上传数据</p>
<p><img src="/../../images/image-20230318130237801.png" alt="image-20230318130237801"></p>
<p><img src="/../../images/image-20230318130319255.png" alt="image-20230318130319255"></p>
<p>可以通过用我们的虚拟机的ip替换它的ip，就能够访问到具体的数据。</p>
<p><img src="/../../images/image-20230318130607873.png" alt="image-20230318130607873"></p>
<p><strong><font size=5>Java 操作Minio</font></strong></p>
<p>依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>Controller:</p>
<p>和七牛云使用类似，我们要上传文件，需要用到MultipartFile 对象，当时blog项目里上传的是图片用的也是这个对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;minio.endpointUrl&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String endpointUrl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;minio.accessKey&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String accessKey;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;minio.secreKey&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String secreKey;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;minio.bucketName&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String bucketName;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(&quot;/fileUpload&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">fileUpload</span><span class="params">(<span class="meta">@RequestBody</span> MultipartFile file)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">//创建Minio对象</span></span><br><span class="line">        <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span> MinioClient.builder()</span><br><span class="line">                <span class="comment">// 去哪里找minio服务器，就是我们的虚拟机加端口号，在配置文件中读取</span></span><br><span class="line">                .endpoint(endpointUrl)</span><br><span class="line">                .credentials(accessKey, secreKey)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断指定的桶是否存在</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">found</span> <span class="operator">=</span></span><br><span class="line">                minioClient.bucketExists(BucketExistsArgs.builder().bucket(bucketName).build());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">            <span class="comment">// 如果不存在指定的桶，创建.</span></span><br><span class="line">            minioClient.makeBucket(MakeBucketArgs.builder().bucket(bucketName).build());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Bucket &#x27;gmall&#x27; already exists.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//防止重名覆盖</span></span><br><span class="line">        String fileName=System.currentTimeMillis()+ UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/***</span></span><br><span class="line"><span class="comment">         * 现在参数是文件流的形式，所以要用流的形式传输。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        minioClient.putObject(</span><br><span class="line">                PutObjectArgs.builder().bucket(bucketName).object(fileName).stream(</span><br><span class="line">                        <span class="comment">//传递上传文件的输入流，和大小</span></span><br><span class="line">                        file.getInputStream(), file.getSize(), -<span class="number">1</span>)</span><br><span class="line">                        <span class="comment">//设置上传文件的类型</span></span><br><span class="line">                        .contentType(file.getContentType())</span><br><span class="line">                        .build());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//拼接文件路径</span></span><br><span class="line">       url  = endpointUrl+<span class="string">&quot;/&quot;</span>+bucketName+<span class="string">&quot;/&quot;</span>+fileName;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建的bucket默认是私有的，需要手动设置成public。</p>
<p><img src="/../../images/image-20230318141805298.png" alt="image-20230318141805298"></p>
<h3 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h3><p>​	现在我们做的是一个商城的项目，我们可能需要支持搜索这个功能，那我每次发送搜索请求都是直接打到数据库上的嘛？</p>
<p>​	显然在并发量大的情况下不可能这样实现，我们会借助ElasticSearch做全局搜索，搜索请求都是由ES完成。</p>
<p>​	但是在商城项目中，我们商品的状态是会不断发生改变的。我们通过ES搜索出来的结果肯定都是能够被检索的状态(上架的商品)，那后续可能我们也会对商品的状态就行修改，我们后台可能只需要修改一个mysql的字段就能够完成。那我们要如何通知ES，改变ES中的商品的状态？</p>
<ul>
<li>Openfeign，修改mysql和修改ES肯定是两个不同的服务，所以我们很自然的想到可以通过Openfeign远程调用完成。但是这样的修改肯定不能够保证两次修改都能够必然正确完成，而且再服务之间相互调用时，我们自然也就增加了服务之间的耦合性。所以这种方式可以实现但是不够完美。</li>
<li>利用消息队列完成解耦，我们可以在mysql修改完之后，给消息队列发送一个消息，ES端有一个监听器会监听这个交换机，然后完成商品状态的改变。这样是最好的实现方式。</li>
</ul>
<h1 id="商品详情页：service-item-拿数据-，web-all-数据渲染"><a href="#商品详情页：service-item-拿数据-，web-all-数据渲染" class="headerlink" title="商品详情页：service-item(拿数据)，web-all(数据渲染)"></a>商品详情页：service-item(拿数据)，web-all(数据渲染)</h1><p><img src="/../../images/image-20230319100508757.png" alt="image-20230319100508757"></p>
<p>根据京东的商品详情页可以看到我们要完成一下几部分查询：</p>
<ul>
<li>sku基本信息+图片+海报</li>
<li>sku销售属性+每个销售属性选定后的价格(为了安全性考虑，价格不能够放缓存)</li>
<li>sku对应spu的规格参数</li>
</ul>
<p>很显然这里涉及到了两个不同微服务直接的调用，所以我们要用到openfeign来实现。当前整个请求的流程：</p>
<p><img src="/../../images/image-20230319101445729.png" alt="image-20230319101445729"></p>
<p>web-all：专门用于做数据渲染，里面存放的都是模板页面，然后去找service-item获取数据。</p>
<p>service-item自己没有连接数据库，所以要去service-product获取数据，因为数据是不会改变的，但是前端界面会改变，可能包括web、移动端等，但是我们始终只要从service-item来获取数据就可以了。然后我们对查询的数据就行规范性整合提供给web-all，避免了不同的页面需要不同形式的数据格式，每次从service-product获取完之后单独整合。也可以当作是一个解耦的过程，让service-product模块只负责查找数据。</p>
<p>service-product提供给service-item的数据就不需要经过Result做封装了，因为service-item需要自己单独封装数据。</p>
<p>所以现在要完成的就是：</p>
<ul>
<li>service-product提供能够查询上面那些数据的接口</li>
<li>service-item使用feign调用这些接口并且完成封装</li>
</ul>
<h2 id="遇到的部分问题，以及知识点回顾-1"><a href="#遇到的部分问题，以及知识点回顾-1" class="headerlink" title="遇到的部分问题，以及知识点回顾"></a>遇到的部分问题，以及知识点回顾</h2><h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><p>在频繁使用的连表查询的过程中可以，为其创建对应的视图，从而加快查询效率。</p>
<p>service-item里面有一个根据 三级分类id查找 一级和二级分类id和名称的接口，我们就可以为这个连表查询创建对应的视图。</p>
<ul>
<li>不创建视图的查询：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> bc3.`id`,bc3.`name`,bc2.`id`,bc2.`name`,bc1.`id`,bc1.`name` <span class="keyword">FROM</span> base_category3 bc3</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> base_category2 bc2 <span class="keyword">ON</span> bc2.`id` <span class="operator">=</span> bc3.`category2_id`</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> base_category1 bc1 <span class="keyword">ON</span> bc2.`category1_id` <span class="operator">=</span> bc1.`id`</span><br><span class="line"><span class="keyword">WHERE</span> bc3.`id` <span class="operator">=</span> <span class="number">61</span></span><br></pre></td></tr></table></figure>



<ul>
<li>创建视图：去掉查询条件，为每个连表结果创建统一视图</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#创建视图</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> category_view <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> bc3.`id` bc3id ,bc3.`name` bc3name,bc2.`id` bc2id, bc2.`name` bc2name,bc1.`id` bc1id,bc1.`name` bc1name </span><br><span class="line"><span class="keyword">FROM</span> base_category3 bc3</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> base_category2 bc2 <span class="keyword">ON</span> bc2.`id` <span class="operator">=</span> bc3.`category2_id`</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> base_category1 bc1 <span class="keyword">ON</span> bc2.`category1_id` <span class="operator">=</span> bc1.`id`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查询视图</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> category_view <span class="keyword">WHERE</span> bc3id <span class="operator">=</span> <span class="number">61</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/../../images/image-20230319113220730.png" alt="image-20230319113220730"></p>
<h3 id="商品详情中，sku切换的实现"><a href="#商品详情中，sku切换的实现" class="headerlink" title="商品详情中，sku切换的实现"></a>商品详情中，sku切换的实现</h3><p>我们在选择具体商品时，需要根据不同的销售属性的组合切换不同的sku，根据不同的销售属性的组合我们可以得到不同的sku。以京东为例：不同的销售属性的组合，实际上就是对应一个不同的请求，这个请求的参数就是具体的sku。</p>
<p><img src="/../../images/image-20230319143345255.png" alt="image-20230319143345255"></p>
<p>所以我们需要根据spuid查找数据库构建一个，这个spu下，sku和所有销售属性不同组合的关系映射表。</p>
<p><img src="/../../images/image-20230319143706747.png" alt="image-20230319143706747"></p>
<table>
<thead>
<tr>
<th align="center">销售属性</th>
<th align="center">skuid</th>
</tr>
</thead>
<tbody><tr>
<td align="center">3717  |  3718</td>
<td align="center">17</td>
</tr>
<tr>
<td align="center">3716 | 3718</td>
<td align="center">18</td>
</tr>
<tr>
<td align="center">……..</td>
<td align="center">…..</td>
</tr>
</tbody></table>
<p>也就是要维护一个类似于上面这样的映射关系表格。</p>
<p>首先我们需要根据spu查询这张表，这个比较简单。然后我们需要不出现重复的skuid，distinct去重是对于一整个数据的而不是对于一个字段的，所以也不能用。还有什么能够起到对一个字段去重？ 答案是分组，我们对skuid分组自然就不会出现相同的skuid了。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> sku_id <span class="keyword">FROM</span> sku_sale_attr_value ssav</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> sku_id</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/image-20230319144420630.png" alt="image-20230319144420630"></p>
<p>那怎么取别的值？有一个mysql提供的函数 GROUP_CONCAT(要连接字段，要排序的字段，分隔符)：</p>
<p>这个函数会将由 group by产生的在同一个分组里面的值 用指定的分割符分隔开。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">GROUP_CONCAT(ssav.`sale_attr_value_id` SEPARATOR <span class="string">&#x27;|&#x27;</span>) value_ids,</span><br><span class="line">sku_id</span><br><span class="line"><span class="keyword">FROM</span> sku_sale_attr_value ssav</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> sku_id</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/image-20230319145129201.png" alt="image-20230319145129201"></p>
<p>看样子我们好像是完成了，但是这个查询拼接字符串时，如果出现 3718|3717 的情况会不会映射到17呢？ 显然是不会的，到时候返回前端操作只是一个字符串匹配的过程。所以我们在返回前必须要保证拼接字段的顺序，这也是为什么group_concate函数还会提供一个排序的字段。</p>
<p>我们希望按照销售属性的id进行排序，保证颜色会在前，但是问题又来了我sku_sale_attr_value这张表没有销售属性id，所以我们还需要拼接一张有销售属性id的表，并且这张表要能够和sku_sale_attr_value这张表进行关联。</p>
<ul>
<li>base_sale_attr，确实有自己的id但是没法和我们的sku_sale_attr_value进行关联</li>
</ul>
<p><img src="/../../images/image-20230319145636403.png" alt="image-20230319145636403"></p>
<ul>
<li>spu_sale_attr：同样有 base_sale_attr_id，但是没法和sku_sale_attr_value关联</li>
</ul>
<p><img src="/../../images/image-20230319145752936.png" alt="image-20230319145752936"></p>
<ul>
<li>spu_sale_attr_value：有base_sale_attr_id，并且可以用id和sku_sale_attr_value表中的销售属性值id进行关联</li>
</ul>
<p><img src="/../../images/image-20230319145856557.png" alt="image-20230319145856557"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">GROUP_CONCAT(ssav.`sale_attr_value_id` <span class="keyword">ORDER</span> <span class="keyword">BY</span> spsav.`base_sale_attr_id` SEPARATOR <span class="string">&#x27;|&#x27;</span>) value_ids,</span><br><span class="line">sku_id</span><br><span class="line"><span class="keyword">FROM</span> sku_sale_attr_value ssav</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> spu_sale_attr_value spsav <span class="keyword">ON</span> ssav.`sale_attr_value_id` <span class="operator">=</span> spsav.`id`</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> sku_id</span><br></pre></td></tr></table></figure>





<h3 id="Openfeign"><a href="#Openfeign" class="headerlink" title="Openfeign"></a>Openfeign</h3><p>​	我们之前使用feign，就是在需要使用远程调用的服务里创建一个Service接口，通过@Feigncient(“服务名”)，和路径找到对应的服务，再在这个服务的Controller中注入这个接口使用。</p>
<p>​	但是随着越来越多的服务可能要使用到远程调用，并且在同一个服务里既有远程调用的service接口，又有自己的service接口难免有些混乱。所以我们可以再加一层，用一个单独的模块去管理远程调用，需要使用远程调用的服务只需要依赖这个模块就能够使用。</p>
<p><img src="/../../images/image-20230319164954606.png" alt="image-20230319164954606"></p>
<p>feign-client是一个父工程，每个子工程就是需要对外暴露被远程调用的接口。</p>
<ul>
<li>feign-product-client子工程暴露，service-product的远程调用接口，这里的@PathVariable注解必须要加上属性</li>
</ul>
<p><img src="/../../images/image-20230319172309760.png" alt="image-20230319172309760"></p>
<ul>
<li><p>service-item模块调用feign-product-client模块，只要将feign-product-client中的service接口注入就可以使用里面的方法。</p>
</li>
<li><p>service-item写完之后也需要在feign下面创建一个暴露自己的方法的模块，因为我们要通过feign调用service-item拿到数据放到web-all模块里面做渲染。所以下面就是要实现web-all模块</p>
</li>
</ul>
<h3 id="web-all"><a href="#web-all" class="headerlink" title="web-all"></a>web-all</h3><p>这个模块里面我们返回的都是模板页面，所以我们在controller中的注解不能够使用rescontroller注解，因为这是直接将结果返回响应体，只要用Controller注解就行了。</p>
<p><img src="/../../images/image-20230319182625482.png" alt="image-20230319182625482"></p>
<p>拿到数据后，我们要通过Model对象去设置数据，</p>
<p><img src="/../../images/image-20230319184312765.png" alt="image-20230319184312765"></p>
<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><p>高频反问优化，我们一个商品详情页会伴随着大量的数据库反问，其他界面可能也是如此，所以我们需要引入缓存来优化查询时间。最常用的就是redis。</p>
<p>要使用到缓存无法避免的就是：穿透、雪崩、击穿的问题。我们在实际中如何解决这些问题？</p>
<p>先稍微回顾以下redis的使用：</p>
<ul>
<li>依赖</li>
<li>配置类：设置序列化规则</li>
<li><font color = red>定义key常量</font> ，这是因为我们在真实开发中一般都会按照一定规则去设置redis的key，而不会随便设置防止导致key重复覆盖</li>
<li>一般还会自己封装一个redis的工具类</li>
</ul>
<p><strong><font size=5>搭建一个简单的案例</font></strong></p>
<p>我们现在在redis中存入一个  num:0  ，我们现在要让每次有请求过来都对这个数据加一。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">num</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;num&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isEmpty(num))&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;num&quot;</span>,<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> Integer.parseInt(num);</span><br><span class="line">    value++;</span><br><span class="line">    stringRedisTemplate.opsForValue().set(<span class="string">&quot;num&quot;</span>,value+<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>请求测试也没什么问题。</p>
<p><img src="/../../images/image-20230320091920958.png" alt="image-20230320091920958"></p>
<p>使用 ab压测工具，安装 </p>
<p>yum install -y httpd-tools</p>
<p>指令：</p>
<p>ab -n 请求数 -c 并发数 url。</p>
<p>这里的url由于我们是在虚拟机下运行这个指令，虚拟机和windows机是通过网卡通信的，网卡的ip可以在vmnet8这个网卡上看到。</p>
<p><img src="/../../images/image-20230320093946782.png" alt="image-20230320093946782"></p>
<ul>
<li>并发测试，5000个请求，并发数是100，按道理redis中的结果应该变成了 5000+</li>
</ul>
<p><img src="/../../images/image-20230320094220195.png" alt="image-20230320094220195"></p>
<ul>
<li>结果</li>
</ul>
<p><img src="/../../images/image-20230320095531879.png" alt="image-20230320095531879"></p>
<p>显然在高并发情况下，redis的访问是不隔离的。解决：最简单的实现对方法加锁，</p>
<p><img src="/../../images/image-20230320095737243.png" alt="image-20230320095737243">  </p>
<ul>
<li>测试</li>
</ul>
<p><img src="/../../images/image-20230320095907881.png" alt="image-20230320095907881"></p>
<p><img src="/../../images/image-20230320095927567.png" alt="image-20230320095927567"></p>
<p>可以看到结果确实是对了，但是效率实在太低了。先抛开效率问题不谈，我们先关系一个问题，这样的实现方式只是单机下是正常的，我们现在都是在搞分布式，都是集群式的，我们还没有确定集群下是否能够正确执行。</p>
<p>我们拷贝三个相同的环境，取不同的端口号 8206  8216 8226。</p>
<p><img src="/../../images/image-20230320101247065.png" alt="image-20230320101247065"></p>
<p>创建号环境后，我们还要启动网关，因为我们这次的请求不知道会请求哪个端口，所以不需要携带端口(去找80)，让网关帮我们去找具体的服务。</p>
<ul>
<li>测试</li>
</ul>
<p><img src="/../../images/image-20230320101454475.png" alt="image-20230320101454475"></p>
<p>可以看到启用集群速度变快了，但是结果会不会出问题呢？我们刚刚的结果是5124，现在预期的结果应该得是 10124才符合我们的预期，或者说本地锁在分布式任务中也能够起效。</p>
<p><img src="/../../images/image-20230320101733440.png" alt="image-20230320101733440"></p>
<p>但是从结果上来看，本地锁并没有生效。为什么加了锁还是出现了安全问题呢？</p>
<p>首先无论是 lock还是syschronized都是有使用范围的，他们都只会对自己本身这个进程内有效。</p>
<p>假设现在有三个进程到来，线程A进入8206准备修改redis，还没修改完成线程B到来，进入了8216同样准备修改redis，但是A还没有修改完成B进入的又不是8206这个进程，所以syschronized管不到线程B它同样会进到redis读取旧数据并且修改旧数据。第三个线程也是如此。</p>
<p>所以要解决这个问题，就是需要有一个锁能够跨进程的。这就是分布式锁。分布式锁可以由多种实现形式：</p>
<ul>
<li>基于数据库</li>
<li>基于缓存</li>
<li>基于zookeeper</li>
</ul>
<p>比较常用的是基于缓存的，如redis。</p>
<h3 id="redis实现分布式锁"><a href="#redis实现分布式锁" class="headerlink" title="redis实现分布式锁"></a>redis实现分布式锁</h3><p>redis实现分布式锁的核心思想就是 “占坑”，</p>
<ul>
<li>实现思路：利用setnx指令，setnx是set if not exists的缩写，这个指令当key不存在时才会设置并且返回1，否则返回0。redis利用setnx实现分布式锁的流程：</li>
</ul>
<p><img src="/../../images/image-20230320154310497.png" alt="image-20230320154310497"></p>
<ul>
<li>实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//判断是否加锁成功</span></span><br><span class="line">	<span class="keyword">if</span>(stringRedisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>,<span class="string">&quot;1&quot;</span>))&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">num</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;num&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(num))&#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(<span class="string">&quot;num&quot;</span>,<span class="string">&quot;0&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> Integer.parseInt(num);</span><br><span class="line">        value++;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;num&quot;</span>,value+<span class="string">&quot;&quot;</span>);</span><br><span class="line">        stringRedisTemplate.delete(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            <span class="comment">//自旋</span></span><br><span class="line">            testlock();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>测试先将数据清0</li>
</ul>
<p><img src="/../../images/image-20230320160317330.png" alt="image-20230320160317330"></p>
<p>可以看到能够实现线程安全，但是随之而来的效率就是更慢。除此之外这种方式还会出现一个问题，就是如果在执行过程中，有一个线程获取到了锁，但是又出现了异常，导致锁无法释放，所有线程都会一直自旋，导致瘫痪。解决方法就是我们可以给key设置一个过期时间。以下两种方式都可以</p>
<p><img src="/../../images/image-20230320161031940.png" alt="image-20230320161031940"></p>
<p>但是设置过期时间还会带来一个问题就是，业务执行的时间超过了过期时间，导致上一个业务还没有释放锁，锁就已经过期了，当下一个线程再拿到锁执行时，上一个线程结束释放锁时，释放的就是下面的线程的锁了，导致整个结果都是很混乱的。解决这个问题也很简单，出现这个问题的原因是因为我们全局都用同一个名字去表示锁，我们只需要对每个不同的线程设置不一样的锁标识即可。</p>
<p><img src="/../../images/image-20230320165912788.png" alt="image-20230320165912788"></p>
<p>但是这样实际上也不能保证一定能够不出现误删除的情况，因为可能在A线程进入判断准备删除之前，过期了，并且B线程也到达，设置了锁，再切换到A线程时，A线程又会对B线程上的锁进行删除。出现这种情况的主要原因还是判断和删除不是原子性操作的问题。</p>
<p>要解决这个问题官网给出了可以用，lua脚本代替del完成删除。lua脚本会根据传递的uuid和获取key对应的value的值进行判断，只有相等的时候才会进行删除。</p>
<p><img src="/../../images/image-20230320171131025.png" alt="image-20230320171131025"></p>
<h3 id="redisson实现分布式锁"><a href="#redisson实现分布式锁" class="headerlink" title="redisson实现分布式锁"></a>redisson实现分布式锁</h3><p>redisson：是在redis的基础上实现的Java驻内存的数据网格，他提供了一系列分布式的Java常用对象和许多分布式服务。</p>
<p>内存数据网格就是指将数据存在内存并且放在多个服务器上。</p>
<ul>
<li>依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.15.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>配置</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(&quot;spring.redis&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String host; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String addresses;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">timeout</span> <span class="operator">=</span> <span class="number">3000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">connectionPoolSize</span> <span class="operator">=</span> <span class="number">64</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> connectionMinimumIdleSize=<span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">pingConnectionInterval</span> <span class="operator">=</span> <span class="number">60000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">ADDRESS_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;redis://&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自动装配</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    RedissonClient <span class="title function_">redissonSingle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//创建配置对象</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(host))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;host is  empty&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置对应的值</span></span><br><span class="line">        <span class="type">SingleServerConfig</span> <span class="variable">serverConfig</span> <span class="operator">=</span> config.useSingleServer()</span><br><span class="line">                <span class="comment">//redis://127.0.0.1:7181</span></span><br><span class="line">                .setAddress(ADDRESS_PREFIX + <span class="built_in">this</span>.host + <span class="string">&quot;:&quot;</span> + <span class="built_in">this</span>.port)</span><br><span class="line">                .setTimeout(<span class="built_in">this</span>.timeout)</span><br><span class="line">                .setPingConnectionInterval(pingConnectionInterval)</span><br><span class="line">                .setConnectionPoolSize(<span class="built_in">this</span>.connectionPoolSize)</span><br><span class="line">                .setConnectionMinimumIdleSize(<span class="built_in">this</span>.connectionMinimumIdleSize)</span><br><span class="line">                ;</span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.isEmpty(<span class="built_in">this</span>.password)) &#123;</span><br><span class="line">            serverConfig.setPassword(<span class="built_in">this</span>.password);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// RedissonClient redisson = Redisson.create(config);</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testlock</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">lock_name</span> <span class="operator">=</span> <span class="string">&quot;test:&quot;</span>+<span class="number">123</span>+<span class="string">&quot;:info&quot;</span>;</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(lock_name);</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="type">String</span> <span class="variable">num</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;num&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isEmpty(num))&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;num&quot;</span>,<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> Integer.parseInt(num);</span><br><span class="line">    value++;</span><br><span class="line">    stringRedisTemplate.opsForValue().set(<span class="string">&quot;num&quot;</span>,value+<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>使用起来也很简单，甚至redisson都不需要自旋，它会帮我们完成自旋操作。只需要对key上锁和删除锁就行了。但是redisson提供的自旋速度可能比较慢，我们还是可以显示的去自旋的。</p>
<p><img src="/../../images/image-20230321085751574.png" alt="image-20230321085751574"></p>
<p>对于redisson的加锁同样会遇到锁无法释放导致的死锁问题，redisson同样也可以使用加入锁的过期时间。</p>
<p>加入过期时间也会遇到误删的问题，reidsson给出了自己的解决方式，他有一个提供监控的“看门狗”，它的作用就是在业务执行未完成的之前，不会对锁进行释放，会延迟默认的 30s，如果还没有完成继续延迟。这个默认时间可以通过Config.lockWatchdogTimeOut 来设置。</p>
<h3 id="redis对sku商品详情页的优化"><a href="#redis对sku商品详情页的优化" class="headerlink" title="redis对sku商品详情页的优化"></a>redis对sku商品详情页的优化</h3><p>这是现在 的sku查找语句，我们都是从mysql中获取的，现在就要对这个进行优化。</p>
<p><img src="/../../images/image-20230321092644577.png" alt="image-20230321092644577"></p>
<p>把这个方法抽取出来单独表示从数据库查询数据的操作。</p>
<ul>
<li>优化</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SkuInfo <span class="title function_">getSkuInfo</span><span class="params">(Long skuid)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getSkuInfoRedis(skuid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> SkuInfo <span class="title function_">getSkuInfoDB</span><span class="params">(Long skuid)</span>&#123;</span><br><span class="line">    <span class="type">SkuInfo</span> <span class="variable">res</span> <span class="operator">=</span> skuInfoMapper.selectById(skuid);</span><br><span class="line">    res.setSkuImageList(skuImageMapper.selectList(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;SkuImage&gt;().eq(SkuImage::getSkuId,skuid)));</span><br><span class="line">    res.setSkuAttrValueList(skuAttrValueMapper.selectList(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;SkuAttrValue&gt;().eq(SkuAttrValue::getSkuId,skuid)));</span><br><span class="line">    res.setSkuSaleAttrValueList(skuSaleAttrValueMapper.selectList(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;SkuSaleAttrValue&gt;().eq(SkuSaleAttrValue::getSkuId,skuid)));</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****</span></span><br><span class="line"><span class="comment"> * 实际要实现的优化代码</span></span><br><span class="line"><span class="comment"> * 从缓存中获取数据，现在这边解决的是高并发下防止缓存穿透</span></span><br><span class="line"><span class="comment"> * 大量查找缓存中不存在的数据，直接落到mysql上</span></span><br><span class="line"><span class="comment"> * 所以这里加上分布式锁，只让一个线程进到mysql里查找，后续都可以从redis中拿到</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> skuid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 实现步骤：</span></span><br><span class="line"><span class="comment"> *    从缓存拿skuinfo数据</span></span><br><span class="line"><span class="comment"> *       判断有没有</span></span><br><span class="line"><span class="comment"> *         有：直接返回</span></span><br><span class="line"><span class="comment"> *         没有：定义锁的key，加锁</span></span><br><span class="line"><span class="comment"> *            成功：去数据库查找，如果有数据返回写回redis，没数据也要写null回redis</span></span><br><span class="line"><span class="comment"> *            失败：睡眠自旋</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> SkuInfo <span class="title function_">getSkuInfoRedis</span><span class="params">(Long skuid)</span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">//定义skukey</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">skukey</span> <span class="operator">=</span> RedisConst.SKUKEY_PREFIX+skuid+RedisConst.SKUKEY_SUFFIX;</span><br><span class="line">        <span class="comment">//从redis中获取值</span></span><br><span class="line">        <span class="type">SkuInfo</span> <span class="variable">skuInfo</span> <span class="operator">=</span> (SkuInfo)redisTemplate.opsForValue().get(skukey);</span><br><span class="line">        <span class="comment">//判断redis里有没有</span></span><br><span class="line">        <span class="keyword">if</span>(Objects.isNull(skuInfo))&#123;</span><br><span class="line">            <span class="comment">//定义锁的key</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">lock_key</span> <span class="operator">=</span> RedisConst.SKUKEY_PREFIX+skuid+RedisConst.SKULOCK_SUFFIX;</span><br><span class="line">            <span class="type">String</span> <span class="variable">uuuid</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//尝试获取锁</span></span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(lock_key,uuuid,RedisConst.SKULOCK_EXPIRE_PX2, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(flag)&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//获取成功</span></span><br><span class="line">                <span class="comment">//从数据中查数据</span></span><br><span class="line">                skuInfo = getSkuInfoDB(skuid);</span><br><span class="line">                <span class="comment">//判断数据库里有没有数据</span></span><br><span class="line">                <span class="keyword">if</span>(!Objects.isNull(skuInfo))&#123;</span><br><span class="line">                    <span class="comment">//有写入redis</span></span><br><span class="line">                    redisTemplate.opsForValue().set(skukey,skuInfo,RedisConst.SKUKEY_TIMEOUT,TimeUnit.SECONDS);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="comment">//没有也要把空值写入redis，防止穿透，大量不存在的数据一直访问mysql</span></span><br><span class="line">                    redisTemplate.opsForValue().set(skukey,skuInfo,RedisConst.SKUKEY_TEMPORARY_TIMEOUT,TimeUnit.SECONDS);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//解锁</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">ruuid</span> <span class="operator">=</span> (String)redisTemplate.opsForValue().get(lock_key);</span><br><span class="line">                <span class="keyword">if</span>(ruuid.equals(uuuid))&#123;</span><br><span class="line">                    redisTemplate.delete(lock_key);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> skuInfo;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//获取失败</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                <span class="keyword">return</span> getSkuInfoRedis(skuid);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> skuInfo;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//防止上面的操作出现异常</span></span><br><span class="line">    <span class="keyword">return</span> getSkuInfoDB(skuid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="redisson对sku商品详情页的优化"><a href="#redisson对sku商品详情页的优化" class="headerlink" title="redisson对sku商品详情页的优化"></a>redisson对sku商品详情页的优化</h3><p>原理和redis差不多只是用redisson实现而已</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SkuInfo <span class="title function_">getSkuInfo</span><span class="params">(Long skuid)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//优化前，直接从数据库查询</span></span><br><span class="line">    <span class="comment">//return  getSkuInfoDB(skuid);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用redis实现优化</span></span><br><span class="line">    <span class="comment">//return getSkuInfoRedis(skuid);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用redisson进行优化</span></span><br><span class="line">    <span class="keyword">return</span> getSkuInfoRedisson(skuid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> SkuInfo <span class="title function_">getSkuInfoRedisson</span><span class="params">(Long skuid)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sku_name</span> <span class="operator">=</span> RedisConst.SKUKEY_PREFIX+skuid+RedisConst.SKUKEY_SUFFIX;</span><br><span class="line">        <span class="type">SkuInfo</span> <span class="variable">skuInfo</span> <span class="operator">=</span> (SkuInfo)redisTemplate.opsForValue().get(sku_name);</span><br><span class="line">        <span class="keyword">if</span>(Objects.isNull(skuInfo))&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sku_lock</span> <span class="operator">=</span> RedisConst.SKUKEY_PREFIX+skuid+RedisConst.SKULOCK_SUFFIX;</span><br><span class="line">            <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(sku_lock);</span><br><span class="line">            lock.lock(RedisConst.SKULOCK_EXPIRE_PX2,TimeUnit.SECONDS);</span><br><span class="line">            skuInfo = getSkuInfoDB(skuid);</span><br><span class="line">            <span class="keyword">if</span> (Objects.isNull(skuInfo))&#123;</span><br><span class="line">                redisTemplate.opsForValue().set(sku_name,skuInfo,RedisConst.SKUKEY_TEMPORARY_TIMEOUT,TimeUnit.SECONDS);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                redisTemplate.opsForValue().set(sku_name,skuInfo,RedisConst.SKUKEY_TIMEOUT,TimeUnit.SECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">            lock.unlock();</span><br><span class="line">            <span class="keyword">return</span> skuInfo;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> skuInfo;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getSkuInfoDB(skuid);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> SkuInfo <span class="title function_">getSkuInfoDB</span><span class="params">(Long skuid)</span>&#123;</span><br><span class="line">    <span class="type">SkuInfo</span> <span class="variable">res</span> <span class="operator">=</span> skuInfoMapper.selectById(skuid);</span><br><span class="line">    <span class="keyword">if</span>(Objects.nonNull(res))&#123;</span><br><span class="line">        res.setSkuImageList(skuImageMapper.selectList(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;SkuImage&gt;().eq(SkuImage::getSkuId,skuid)));</span><br><span class="line">        res.setSkuAttrValueList(skuAttrValueMapper.selectList(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;SkuAttrValue&gt;().eq(SkuAttrValue::getSkuId,skuid)));</span><br><span class="line">        res.setSkuSaleAttrValueList(skuSaleAttrValueMapper.selectList(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;SkuSaleAttrValue&gt;().eq(SkuSaleAttrValue::getSkuId,skuid)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="AOP代码优化"><a href="#AOP代码优化" class="headerlink" title="AOP代码优化"></a>AOP代码优化</h3><p>上面两种实现是对代码的逻辑进行优化，但是我们会发现，这些操作都和业务关系不大，甚至代码量远超了业务代码，对业务如入侵性极大。并且如果有 涉及到缓存的都需要侵入这么大量的非业务代码会导致代码大量冗余。所以我们可以使用AOP来完成解耦。</p>
<p>回顾一下AOP 原理：动态代理，实现动态代理的两种形式：JDK，CGLIB</p>
<ul>
<li>JDK特点：接口，要实现别代理类的接口，要求被代理的类有一个接口否则不能代理。</li>
<li>CGLIB：继承</li>
</ul>
<p>基本做法就是定义一个注解，然后编写切片类实现。并且我们这里的切片类主要提取的都应该是公共的代码，才能减少耦合和冗余，所以我们还需要分析我们现有的代码哪里是公共的部分。</p>
<ul>
<li>注解初定义：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Inherited</span>      <span class="comment">//表示继承，被这个注解修饰的子类是否能够享受到这个注解的效果</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyGmallCache &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>但是我们要实现分布式锁，我们不是还得查缓存吗，所以我们还需要通过定义一个属性去获取查询的key。但是我们的key又是按照规范去定义的，都是 xxx：id：info&#x2F;lock，所以我们只需要传递前面的前缀即可。</p>
<ul>
<li>完整定义</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Inherited</span>      <span class="comment">//表示继承，被这个注解修饰的子类是否能够享受到这个注解的效果</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyGmallCache &#123;</span><br><span class="line">    String <span class="title function_">prefix</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>分析公共部分</li>
</ul>
<p>分布式锁的公共部分还是比较好分析的，基本都是公共的，业务代码就只是查询数据库的部分。所以我们可以把，查缓存，分布式锁，解锁都放到切面类中。被增强的方法中就只保留查询数据库的业务逻辑。</p>
<ul>
<li>优化，被增强的方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MyGmallCache(prefix = &quot;sku&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SkuInfo <span class="title function_">getSkuInfo</span><span class="params">(Long skuid)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//优化前，直接从数据库查询</span></span><br><span class="line">    <span class="comment">//return  getSkuInfoDB(skuid);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用redis实现优化</span></span><br><span class="line">    <span class="comment">//return getSkuInfoRedis(skuid);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用redisson进行优化</span></span><br><span class="line">    <span class="comment">//return getSkuInfoRedisson(skuid);</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//使用AOP 优化</span></span><br><span class="line">    <span class="keyword">return</span>  getSkuInfoDB(skuid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>Aop切面类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//切点表达式</span></span><br><span class="line"><span class="meta">@Pointcut(&quot;@annotation(com.yhz.gmall.common.cache.MyGmallCache)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pt</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Around(&quot;pt()&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">Mylock</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">//获得方法描述对象，里面包括各种和方法有关的数据，method对象等</span></span><br><span class="line">    <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature)joinPoint.getSignature();</span><br><span class="line">    <span class="comment">//获得method对象</span></span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> signature.getMethod();</span><br><span class="line">    <span class="comment">//获取加载这个方法上的注解，需要指定具体的注解的字节码对象</span></span><br><span class="line">    <span class="type">MyGmallCache</span> <span class="variable">annotation</span> <span class="operator">=</span> method.getAnnotation(MyGmallCache.class);</span><br><span class="line">    <span class="comment">//获取我们定义的注解的 属性值</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> annotation.prefix();</span><br><span class="line">    <span class="comment">//获取请求参数</span></span><br><span class="line">    Object[] args = joinPoint.getArgs();</span><br><span class="line">    <span class="comment">//转成 用于拼接的key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> Arrays.asList(args).toString();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//拼接成key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">redis_key</span> <span class="operator">=</span> prefix +key+ RedisConst.SKUKEY_SUFFIX;</span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 这里需要注意下，因为我们要做到通用</span></span><br><span class="line"><span class="comment">     * 这里获取的类型肯定只能是object接收，但是我们怎么将object转为我们想要的类型呢</span></span><br><span class="line"><span class="comment">     * 做法是 Object  强转   String 因为我们在存入redis的时候就是转成Json字符串进行存储的</span></span><br><span class="line"><span class="comment">     * String用Json工具转为指定类型，类型可以通过Method对象获取方法的返回类型</span></span><br><span class="line"><span class="comment">     * 将从redis获取数据单独封装成一个方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> getData(redis_key,signature);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//没有从redis拿到数据，开启分布式锁</span></span><br><span class="line">        <span class="keyword">if</span>(Objects.isNull(object))&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">lock_key</span> <span class="operator">=</span> prefix+key+RedisConst.SKULOCK_SUFFIX;</span><br><span class="line">            <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(lock_key);</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="comment">//执行被增强方法，查询数据库</span></span><br><span class="line">            object = joinPoint.proceed(args);</span><br><span class="line">            <span class="comment">//数据库没有拿到数据</span></span><br><span class="line">            <span class="keyword">if</span>(Objects.isNull(object))&#123;</span><br><span class="line">                redisTemplate.opsForValue().set(redis_key,JSON.toJSONString(object),RedisConst.SKUKEY_TEMPORARY_TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                redisTemplate.opsForValue().set(redis_key,JSON.toJSONString(object),RedisConst.SKUKEY_TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> object;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> object;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Throwable e)&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> redis_key     redis对应的key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> signature     可以获取被增强方法的返回值类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Object <span class="title function_">getData</span><span class="params">(String redis_key, MethodSignature signature)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> (String) redisTemplate.opsForValue().get(redis_key);</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.hasText(res))&#123;</span><br><span class="line">        <span class="comment">//从redis获取到了数据，直接返回</span></span><br><span class="line">        <span class="comment">//获取返回值类型</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">returnType</span> <span class="operator">=</span> signature.getReturnType();</span><br><span class="line">        <span class="keyword">return</span> JSON.parseObject(res,returnType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//没有从redis获取到数据返回空</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>在写通用AOP时，很容易出现类型转换异常，因为涉及到好多Object和其他类型的转换。回顾一下Java中类型转换的规则：</p>
<ul>
<li>向上类型转换(自动类型转换)：能够直接进行，子类转父类，不会报错。</li>
<li>向下类型转换(强制类型转换)：需要显示的转换为需要的类型。并且强制类型转换也是有前提的，只有经过向上转型的对象，才能够向下转型，否则会报类型转换错误。例子如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> (String)o;		<span class="comment">//类型转换错误</span></span><br><span class="line">System.out.println(s);</span><br><span class="line"></span><br><span class="line"><span class="comment">//正确应该这样写</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>();</span><br><span class="line"><span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> (String)o;</span><br><span class="line">System.out.println(s);</span><br></pre></td></tr></table></figure>





<h3 id="布隆过滤器"><a href="#布隆过滤器" class="headerlink" title="布隆过滤器"></a>布隆过滤器</h3><p>布隆过滤器是一个解决缓存穿透的一个方法，我们也知道，如果有人使用大量的不存在的请求，去请求我们的数据，这些请求在redis都不会命中，直接打到mysql，导致mysql挂了。</p>
<p>对于一般的请求，我们可以对这个不存在的数据也加上缓存，后面下次再来我们可以直接在redis中拿到。但是如果发请求的数据是一个随机数，每次的key都不同，这样同样会导致请求绕过redis，全都到达mysql，压爆mysql。为了解决这种问题，所以就发明了布隆过滤器。</p>
<p>布隆过滤器，是一个很长的二进制数据集合。他的作用是可以判断出一个元素是否在一个集合中，他的优点是：查询效率都比一般的算法好，但是缺点就是可能会出现一些误判率并且删除困难。</p>
<p>我们要使用布隆过滤器首先需要将数据库中的数据告诉布隆过滤器，并且每次插入数据时候都需要告诉布隆过滤。向其中插入数据会经过以下步骤：</p>
<ul>
<li>计算出插入数据的hash值，并且可以使用多个计算hash值的hash公式。假设是k个</li>
<li>然后会根据得到的k个值，将布隆过滤底层的二进制数据的k个值对应的下标都设置为1.</li>
</ul>
<p>查找的步骤也是类似：</p>
<ul>
<li>计算带查找的数据的k个hash</li>
<li>查找二进制集合中k个hash值的下标是否为1，之后全都为1布隆过滤器才会认为数据库中能够拿到对应的结果会放行。但是由于使用hash可能会出现hash冲突，所以有可能将没有值的数据也放行。但是已经能够屏蔽掉大量的无效请求了。并且在删除数据库时，是否对这个值在布隆过滤器中下标映射进行删除不好判断，这也是删除困难问题。</li>
</ul>
<p>并且在使用时，我们只需要指定要存储的数据量以及我们可以忍受的错误率，就会自动帮我们计算出hash函数的个数k。</p>
<p><strong><font size=5>使用</font></strong></p>
<p>Redisson中有对布隆过滤器的支持。</p>
<p>我们上面说到使用也就两步：初始化数据、在插入数据时候告知布隆过滤。</p>
<p>那么现在就是我们怎么初始化数据，什么时候初始化？</p>
<p>在博客项目中，我们有有实现一个浏览量的功能，在项目启动的时候就将数据库中的部分数据写入redis。当时是通过实现CommandLineRunner接口来实现的。我们这里也差不多是类似的要求，所以同样可以这样来操作。这个接口会在IOC 容器创建好后执行里面的方法。</p>
<p><img src="/../../images/image-20230324154459386.png" alt="image-20230324154459386"></p>
<ul>
<li>初始化</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BloomFilterRunner</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SkuManagerService skuManagerServicel;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//获取布隆过滤器</span></span><br><span class="line">        RBloomFilter&lt;Object&gt; bloomFilter = redissonClient.getBloomFilter(RedisConst.SKU_BLOOM_FILTER);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化过滤器大小和误判率,假设我们这个过滤器是用于拦截对sku的请求的，所以容量就是预计有多少个sku</span></span><br><span class="line">        bloomFilter.tryInit(<span class="number">10000</span>,<span class="number">0.001</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//将数据库的sku放入过滤器，假设通过id来拦截请求，所以我们插入布隆过滤的key就是 skuiid</span></span><br><span class="line">        List&lt;SkuAttrValue&gt; list = skuManagerServicel.list();</span><br><span class="line">        list.stream().map((l-&gt;&#123;</span><br><span class="line">            <span class="keyword">return</span> l.getSkuId();</span><br><span class="line">        &#125;)).forEach((li-&gt;&#123;</span><br><span class="line">            bloomFilter.add(li);</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>保存时候还需要添加到布隆过滤器中：</li>
</ul>
<p><img src="/../../images/image-20230324161240731.png" alt="image-20230324161240731"></p>
<ul>
<li>判断，我们先回一下我们整个sku商品详情页的流程，用户发起请求之后会通过网关，到web-all渲染界面，web-all会通过feign调用item-service，item-service用于整合数据，item-service会通过feign调用product-service查询数据库。上面我们对查询数据库进行了优化，加上了缓存也就是在product-service中进行了优化。现在我们的布隆过滤是加在缓存之前的一个判断，所以我们可以把判断步骤放到item-service中。</li>
</ul>
<p><img src="/../../images/image-20230324161637339.png" alt="image-20230324161637339"></p>
<ul>
<li>删除时：可以不对布隆过滤器进行删除，以防误删。也可以在一定时间内定时清空布隆过滤器，然后把存在的重新写入布隆过滤器中。</li>
</ul>
<h3 id="异步编排"><a href="#异步编排" class="headerlink" title="异步编排"></a>异步编排</h3><p>我们回头看一下商品详情的业务逻辑，一共会有七次的查询：</p>
<p><img src="/../../images/image-20230324183547534.png" alt="image-20230324183547534"></p>
<p>为了能够提高系统的效率，我们希望能够将互不依赖的一些查询能够并行执行，这就需要用到异步编排。</p>
<p>在Jdk1.8之后新增了一个CompleteableFuture，它提供了更加强大的uture的功能。Future是Jdk1.5出现的，使用Future开启一个异步任务的时候，需要通过get()去获取异步任务的结果，但是get()方法本身会使得程序阻塞(如果异步任务未执行成功)，这反而可能会导致程序执行时间变慢。</p>
<p>CompleteableFuture的引入结合了函数式编程，他开启一个任务之后不会对程序进行阻塞如果执行完成自己会调用回调函数进行处理执行的结果。	 </p>
<p><img src="/../../images/image-20230324184525920.png" alt="image-20230324184525920"></p>
<p><strong><font size=5>使用</font></strong></p>
<ul>
<li><p>如何创建一个异步对象：CompletableFuture提供了四个创建异步对象的方法：</p>
<p><img src="/../../images/image-20230324185931926.png" alt="image-20230324185931926"></p>
<ul>
<li>runAsync：有两个参数和一个参数的，Runabel就是一个异步任务，Executor是一个线程池。没有返回值，指的是异步对象有没有返回值。这个有没有返回值，指的是创建的异步对象通过get方法能不能获取到值，和异步任务没关系。</li>
<li>supplyAsync：有返回值。</li>
</ul>
</li>
<li><p>回调函数，当CompletableFuture的计算结果完成，或者抛出异常时，可以指定特定的行为，主要就是以下几个方法：</p>
<p><img src="/../../images/image-20230324190818920.png" alt="image-20230324190818920"></p>
<ul>
<li>whenComplete：处理正常和异常的结果，开启线程处理完成返回后继续使用当前线程执行主线程的后续的代码</li>
<li>whenCompleteAsync：开启线程处理完成返回后，可能不再使用当前执行线程执行主线程的后续的代码，而是丢到线程池中重新选择一个线程继续执行</li>
<li>excetionally：只能处理异常结果</li>
</ul>
</li>
</ul>
<p><strong><font size=5>小案例</font></strong></p>
<ul>
<li><strong>创建异步对象</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    <span class="comment">//创建一个没有返回值的异步对象</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; future = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;没有返回结果的异步对象&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    System.out.println(future.get());<span class="comment">//没有返回值的异步对象所以返回为空</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个有返回值的异步对象</span></span><br><span class="line">    CompletableFuture&lt;String&gt; future1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;创建一个有返回值的异步对象&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;有返回值&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    System.out.println(future1.get());  <span class="comment">//有返回值可以获取得到，结果就是lamba表达式的返回值 &quot;有返回值&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<ul>
<li><strong>回调函数</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    <span class="comment">//创建一个没有返回值的异步对象</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; future = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">    &#125;).whenComplete(<span class="keyword">new</span> <span class="title class_">BiConsumer</span>&lt;Void, Throwable&gt;() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/***</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> aVoid      异步对象执行后的返回值</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> throwable  如果出现异常，异常的结果</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(Void aVoid, Throwable throwable)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;whenComplete:&quot;</span>+aVoid);</span><br><span class="line">            System.out.println(<span class="string">&quot;whenComplete:&quot;</span>+throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个有返回值的异步对象</span></span><br><span class="line">    CompletableFuture&lt;String&gt; future1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">int</span> a= <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;有返回值&quot;</span>;</span><br><span class="line">    &#125;).exceptionally(<span class="keyword">new</span> <span class="title class_">Function</span>&lt;Throwable, String&gt;() &#123;</span><br><span class="line">        <span class="comment">/***</span></span><br><span class="line"><span class="comment">             * 只处理异常</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> throwable</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">apply</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;exceptionally:&quot;</span>+throwable);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;exceptionally&quot;</span>+throwable;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230324193756758.png" alt="image-20230324193756758"></p>
<ul>
<li><p>**<font size=4>串行、并行化方法</font>**。</p>
<p><img src="/../../images/image-20230325195143927.png" alt="image-20230325195143927"></p>
<ul>
<li>thenApply：有返回值的，当线程执行完成之后执行参数中的任务，依赖其他线程执行的结果</li>
<li>thenAccetp：区别就是没有返回值的</li>
<li>thenRun：无返回值，不依赖其他线程的结果，只要调用线程执行完成就执行参数中的任务。</li>
<li>带有Async异步执行，就是可能会换另一个线程调用同步操作。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 案例要求是先执行A，等A执行完之后可以执行B和C，B需要睡眠2s</span></span><br><span class="line"><span class="comment">     * 如果正常从上往下写就是输出 A、B、C，但是B和C并没有依赖C为什么要等B 2s</span></span><br><span class="line"><span class="comment">     * 所以需要使用异步操作来完成</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//开启一个异步任务A</span></span><br><span class="line">    CompletableFuture&lt;String&gt; futureA = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;我是A&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;404&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当A执行完之后执行B</span></span><br><span class="line">    futureA.thenAcceptAsync(<span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(String s)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;我是B&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当A执行完之后执行C</span></span><br><span class="line">    futureA.thenAcceptAsync(<span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(String s)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;我是C&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//没有使用线程池</span></span><br><span class="line">    <span class="comment">// 让主线程休眠防止主线程比其他线程提前结束</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




</li>
<li><ul>
<li>A和C是先被打印的</li>
</ul>
</li>
</ul>
<p><img src="/../../images/image-20230325201249310.png" alt="image-20230325201249310"></p>
<ul>
<li><ul>
<li>B最后才被打印</li>
</ul>
</li>
</ul>
<p><img src="/../../images/image-20230325201312965.png" alt="image-20230325201312965"></p>
<ul>
<li>多任务组合</li>
</ul>
<p>有些时候我们可能会要求有多个任务完成后才执行某个任务，或者在多个任务其中一个完成后就可以执行某个操作。此时分别可以使用 <strong>allOf</strong>和<strong>anyOf</strong>两个方法来实现</p>
<h3 id="利用异步编排优化商品详情页"><a href="#利用异步编排优化商品详情页" class="headerlink" title="利用异步编排优化商品详情页"></a>利用异步编排优化商品详情页</h3><p>上面我们也说到了商品详情页有其次数据库查询，并且许多操作都是可以并行执行的。所以我们需要使用异步技术对其进行优化。</p>
<p><img src="/../../images/image-20230325204616627.png" alt="image-20230325204616627"></p>
<p>会发现下面这四个查询会和第一个查询skuinfo有依赖关系，所以可以对其进行异步操作进行优化，创建查询skuinfo的异步任务。这里我们还会需要一个线程池，因为如果使用默认的话他就是简单的创建单个线程。</p>
<ul>
<li>config：配置线程池对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * ThreadPoolExecutor:</span></span><br><span class="line"><span class="comment">     *      核心线程数</span></span><br><span class="line"><span class="comment">     *      最大线程数</span></span><br><span class="line"><span class="comment">     *      空闲存活时间</span></span><br><span class="line"><span class="comment">     *      时间单位</span></span><br><span class="line"><span class="comment">     *      阻塞队列</span></span><br><span class="line"><span class="comment">     *      还有两个默认参数：</span></span><br><span class="line"><span class="comment">     *          线程池满的拒绝策略</span></span><br><span class="line"><span class="comment">     *          线程工程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolExecutor <span class="title function_">threadPoolExecutor</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">50</span>,</span><br><span class="line">                <span class="number">100</span>,</span><br><span class="line">                <span class="number">60</span>,</span><br><span class="line">                TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">10000</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>异步优化代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MyGmallCache(prefix = &quot;sku_item&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map <span class="title function_">getItem</span><span class="params">(Long skuid)</span> &#123;</span><br><span class="line"></span><br><span class="line">    HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    RBloomFilter&lt;Object&gt; bloomFilter = redissonClient.getBloomFilter(RedisConst.SKU_BLOOM_FILTER);</span><br><span class="line">    <span class="comment">//如果过滤器中不存在直接返回。</span></span><br><span class="line">    <span class="keyword">if</span>(!bloomFilter.contains(skuid))&#123;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建获取skuinfo的异步任务对象</span></span><br><span class="line">    CompletableFuture&lt;SkuInfo&gt; skuInfoCompletableFuture = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;SkuInfo&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> SkuInfo <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">SkuInfo</span> <span class="variable">skuInfo</span> <span class="operator">=</span> productClientService.getSkuInfo(skuid);</span><br><span class="line">            map.put(<span class="string">&quot;skuInfo&quot;</span>,skuInfo);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> skuInfo;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取三级分类,不需要返回值，所以使用thenAcceptAsync</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; categoryViewfuture = skuInfoCompletableFuture.thenAcceptAsync(<span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;SkuInfo&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(SkuInfo skuInfo)</span> &#123;</span><br><span class="line">            <span class="type">BaseCategoryView</span> <span class="variable">categoryView</span> <span class="operator">=</span> productClientService.getCategoryView(skuInfo.getCategory3Id());</span><br><span class="line">            map.put(<span class="string">&quot;categoryView&quot;</span>, categoryView);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取销售属性和选中状态,同样不需要返回值</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; spuSaleAttrListfuture = skuInfoCompletableFuture.thenAcceptAsync(<span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;SkuInfo&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(SkuInfo skuInfo)</span> &#123;</span><br><span class="line">            List&lt;SpuSaleAttr&gt; spuSaleAttrListCheckBySku = productClientService.getSpuSaleAttrListCheckBySku(skuid, skuInfo.getSpuId());</span><br><span class="line">            map.put(<span class="string">&quot;spuSaleAttrList&quot;</span>, spuSaleAttrListCheckBySku);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取商品切换数据，也不需要返回值</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; valuesSkuJsonfuture = skuInfoCompletableFuture.thenAcceptAsync(<span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;SkuInfo&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(SkuInfo skuInfo)</span> &#123;</span><br><span class="line">            <span class="type">Map</span> <span class="variable">skuValueldsMap</span> <span class="operator">=</span> productClientService.getSkuValueldsMap(skuInfo.getSpuId());</span><br><span class="line">            map.put(<span class="string">&quot;valuesSkuJson&quot;</span>, JSON.toJSONString(skuValueldsMap));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取海报，不需要返回值</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; spuPosterListfuture = skuInfoCompletableFuture.thenAcceptAsync(<span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;SkuInfo&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(SkuInfo skuInfo)</span> &#123;</span><br><span class="line">            List&lt;SpuPoster&gt; spuPosterBySpuld = productClientService.findSpuPosterBySpuld(skuInfo.getSpuId());</span><br><span class="line">            map.put(<span class="string">&quot;spuPosterList&quot;</span>, spuPosterBySpuld);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取平台属性，不依赖skuinfo的查询，直接开启一个异步任务</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; skuAttrListfuture = CompletableFuture.runAsync(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            List&lt;BaseAttrInfo&gt; attrList = productClientService.getAttrList(skuid);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//处理符合要求 List  Obj  key attrName   key attrValue</span></span><br><span class="line">            List&lt;Map&lt;String, String&gt;&gt; spuAttrList = attrList.stream().map(baseAttrInfo -&gt; &#123;</span><br><span class="line">                Map&lt;String, String&gt; tem_map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                tem_map.put(<span class="string">&quot;attrName&quot;</span>, baseAttrInfo.getAttrName());</span><br><span class="line">                tem_map.put(<span class="string">&quot;attrValue&quot;</span>, baseAttrInfo.getAttrValueList().get(<span class="number">0</span>).getValueName());</span><br><span class="line">                <span class="keyword">return</span> tem_map;</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">            map.put(<span class="string">&quot;skuAttrList&quot;</span>, spuAttrList);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取实时价格,也不需要依赖skuinfo查询</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; SkuPricefuture = CompletableFuture.runAsync(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">BigDecimal</span> <span class="variable">skuPrice</span> <span class="operator">=</span> productClientService.getSkuPrice(skuid);</span><br><span class="line">            map.put(<span class="string">&quot;price&quot;</span>, skuPrice);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//多任务组合，需要等待所有任务完成才算完成</span></span><br><span class="line">    CompletableFuture.allOf(SkuPricefuture,</span><br><span class="line">                        skuAttrListfuture,</span><br><span class="line">                        spuPosterListfuture,</span><br><span class="line">                        valuesSkuJsonfuture,</span><br><span class="line">                        spuSaleAttrListfuture,</span><br><span class="line">                        categoryViewfuture,</span><br><span class="line">                        skuInfoCompletableFuture).join();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="商城首页"><a href="#商城首页" class="headerlink" title="商城首页"></a>商城首页</h1><p>​	上面我们完成了商品详情页的开发，从构建到优化。下面我们就需要来完成商城首页的开发，首页主要就是会展示一些广告页面、搜索框、三级分类的显示等功能。</p>
<p>​	同样相比于商品详情页，这也是一个需要承载超高并发的一个页面，所以我们也需要一步步对其进行优化。</p>
<p>​	我们先来看看整个的流程：</p>
<p>​	<img src="/../../images/image-20230325221840653.png" alt="image-20230325221840653"></p>
<p>​	发起请求后，先经过网关，网关分配到对应的服务，web-all需要负责渲染数据，数据还需要从能够查询数据库的地方拿。本来我们应该从另一个中间服务来获取数据提供给web-all的，但是为了方便我们就还是从service-product中直接拿数据了。</p>
<p>​	</p>
<p>​	思考一下优化的步骤：</p>
<ul>
<li>是否需要缓存：需要</li>
<li>显示使用的模板的显示方式：<ul>
<li>页面渲染：就是和我们商品详情页中实现的方式一样，先拿到数据，然后将数据渲染到页面上</li>
<li>页面生成：进一步优化，连渲染都不要，直接给我一个固定的html页面，我把数据填上去，因为页面中很多都是静态数据，我们很显然可以使用nginx实现静态分离，搭建一个静态服务器，把静态数据直接放到服务器中，毕竟单机的nginx能够达到的并发量就达到2w-5w</li>
</ul>
</li>
</ul>
<h2 id="遇到的部分问题，以及知识点回顾-2"><a href="#遇到的部分问题，以及知识点回顾-2" class="headerlink" title="遇到的部分问题，以及知识点回顾"></a>遇到的部分问题，以及知识点回顾</h2><h3 id="查询三级分类：Json封装、去重、数据渲染"><a href="#查询三级分类：Json封装、去重、数据渲染" class="headerlink" title="查询三级分类：Json封装、去重、数据渲染"></a>查询三级分类：Json封装、去重、数据渲染</h3><p>我们查询三级分类会需要以下一个较为复杂的json字符串</p>
<p><img src="/../../images/image-20230325225054210.png" alt="image-20230325225054210"></p>
<p>首先分析：外面对应于Java肯定是一个List&lt; T &gt; 问题就在于里面这个T怎么封装, 通常可以通过Java对象 但是这样可能会比较麻烦,  我们使用Map代替。Map提供的api又有限，所以我们还可以通过JSONObject来代替map，因为其底层本身也是一个map。</p>
<p>此外，我们希望得到是一个类似于树状的结构，但是我们查询的时候肯定查的是我们之前创建过的一个类别的视图：</p>
<p><img src="/../../images/image-20230326122734804.png" alt="image-20230326122734804"></p>
<p>但是我们会发现这里面一级分类有大量的重复数据，我们需要对他进行去重，可能我们还是会想到和通过Distinct来实现，但是这个函数只能够对一个字段进行去重，并且后面的数据也会被删掉。我们还可能会想到通过Group By天然去重，但是分组之后我们获取其他字段就变得很麻烦。所以我们可以考虑通过查询所有的结果后，在Java中对结果进行去重。</p>
<p>我们这里会查询出一个List集合，对于集合我们去重可以通过Stream流中的一个分组函数 groupingby方法对结果去重。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过category1Id进行分组，返回的就是一个树状的结构</span></span><br><span class="line">Map&lt;Long, List&lt;BaseCategoryView&gt;&gt; category1Map =</span><br><span class="line">        baseCategoryViewList.stream().collect(Collectors.groupingBy(BaseCategoryView::getCategory1Id));</span><br></pre></td></tr></table></figure>



<p>这个map 就是以 category1Id 为 key，value 就是一条条category1Id等于key的查询结果。就是一个类似于树状的结构。</p>
<p>后面的结构以此类推，根据二级和三级id分类，将数据存入 JSONObject里。封装好数据之后就还是一样的流程，通过feign暴露远程调用接口，在web-all模块的controller中调用。</p>
<ul>
<li>数据渲染实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductClientService productClientService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&#123;&quot;/&quot;,&quot;/index.html&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getBaseCategoryList</span><span class="params">(Model model)</span>&#123;</span><br><span class="line">        <span class="type">Result</span> <span class="variable">baseCategoryList</span> <span class="operator">=</span> productClientService.getBaseCategoryList();</span><br><span class="line"></span><br><span class="line">        model.addAttribute(<span class="string">&quot;list&quot;</span>,baseCategoryList.getData());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index/index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li><p>动静分离实现，这种方式主要也是因为index中比较多的数据不是实时变动的，相对较为稳定，我们可以通过请求自己生成了一次页面后将其放到 nginx中管理，通过nginx完成反向代理找到静态页面。</p>
<ul>
<li>生成请求</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/createhtml&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">createIndexHtml</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Result</span> <span class="variable">baseCategoryList</span> <span class="operator">=</span> productClientService.getBaseCategoryList();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 需要三个参数：</span></span><br><span class="line"><span class="comment">     *  1、模板的位置</span></span><br><span class="line"><span class="comment">     *  2、数据  Icontext类型 所以还需要要创建要给Icontext对象，但是这是一个接口所以要创建对应的实现类 Context</span></span><br><span class="line"><span class="comment">     *  3、输出到文件的流</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建Context对象</span></span><br><span class="line">    <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Context</span>();</span><br><span class="line">    context.setVariable(<span class="string">&quot;list&quot;</span>,baseCategoryList.getData());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建流对象</span></span><br><span class="line">    <span class="type">FileWriter</span> <span class="variable">fw</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fw = <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;D:\\Java_projiect\\Java_mall\\mall-parent\\web\\staticindex\\index.html&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    templateEngine.process(<span class="string">&quot;index/index.html&quot;</span>,</span><br><span class="line">                            context,</span><br><span class="line">                            fw);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>把css文件放到生成的html下</li>
</ul>
<p><img src="/../../images/image-20230326213919172.png" alt="image-20230326213919172"></p>
<ul>
<li>运行html文件可以打开</li>
</ul>
</li>
<li><p>将整个文件放到nginx的html下，创建一个staticindex文件夹存放，并且配置监听端口，和请求location</p>
</li>
</ul>
<p><img src="/../../images/image-20230327085750073.png" alt="image-20230327085750073"></p>
<p>nginx会监听 8888这个端口，请求过来时，会去html下的staticindex找index.html:</p>
<p><img src="/../../images/image-20230327085842900.png" alt="image-20230327085842900"></p>
<h3 id="搜索、ES简单使用"><a href="#搜索、ES简单使用" class="headerlink" title="搜索、ES简单使用"></a>搜索、ES简单使用</h3><p>对于搜索框使用的频率应该是最高的，如果我们使用上面分布式锁+缓存这一套会出现什么问题？</p>
<p>搜索肯定是通过模糊查询得到的， like %xxx%，我们知道使用模糊查询一般会引起索引失效，这就会每个查询都是顺序查找，效率极低根本不可能实现大量的高并发。这也是为什么我们在搜索的时候需要使用到 ElasticSearch的原因。</p>
<p>Es：全文搜索的引擎，可以很好的实现实时查询。因为它会对存入ES的所有字都添加索引(默认)，也可以对部分数据声明不需要索引。除此之外Es还有一个很重要的特点，那就是倒排索引。</p>
<p>和倒排索引相对的就是正排索引，我们先从正派索引来开始了解：</p>
<ul>
<li>正排索引：</li>
</ul>
<p>ES中存储一条条数据的东西的名称叫做 文档(doc)，java中叫对象，mysql叫记录。对于正排索引来说，他会根据一个个文档中的内容的词进行分词，并且为每一个词都加上索引，比如一个文档是 华为手机，另一个是苹果手机。对于正排索引来说，可能就会在文档1中为每个关键词创建对应的索引：</p>
<blockquote>
<p>文档1：0 华  1为   2 手机</p>
<p> 文档2：0 苹 1 果  2 苹果 3 手机。</p>
</blockquote>
<p>那么我去查询手机时，就会一条条配对，查找每一个文档判断文档中是否包含手机的索引，如果有就将这个文档进行返回。</p>
<p>这种方式，其实效率和mysql直接查询没什么太大的区别，都是顺序查询效率都非常的低。</p>
<ul>
<li>倒排索引：</li>
</ul>
<p>和上面的那种建立方式不同，对于倒排索引，他构建的索引的方式是根据关键字为每个包含这个关键字的文档进行索引。比如：</p>
<blockquote>
<p> 华：文档1 ；</p>
<p>为 ：文档1 ；</p>
<p>手机：文档1、文档2；</p>
<p>苹果：文档2。</p>
</blockquote>
<p>当我们查询手机时，会匹配关键词然后将包含这个关键字的所有文档都进行返回。</p>
<p>这种做法的好处是，我可以一次性将所有包含对应关键词的文档都返回，效率高。</p>
<p><strong><font size=5>使用</font></strong></p>
<p>Es的使用主要分为两个部分，索引和检索。索引就是我们要将数据库中的数据放入到Es中，并创建对应的索引。</p>
<p>检索就是从Es中查询结果。</p>
<ul>
<li>索引：和创建数据库很像</li>
</ul>
<blockquote>
<p>​					数据库						Es</p>
<p>1、		创建数据库			创建索引库</p>
<p>2、		创建表					创建Mapping</p>
<p>3、		添加数据				添加数据</p>
<p>工具：   mybatis-plus		ElasticTemplate、ElasticRepository</p>
</blockquote>
<p>数据库的一条条记录到 Java 中被称为实体类，es也有自己的名称它里面存的是json被称作document，他映射到Java中被称为 也需要有一个实体类接收，这里是Goods。</p>
<p>所以我们要使用es的时候，需要将实体类转为Goods 存入es。</p>
<p><img src="/../../images/image-20230327170402660.png" alt="image-20230327170402660"></p>
<p>分词其实不需要我们去考虑，我们在配置环境的时候下载过对应的中文分词器，ik_analyzer。可以在kibana中测试看一下：</p>
<p>测试工具： kibana的端口为5601</p>
<p><img src="/../../images/image-20230327095015745.png" alt="image-20230327095015745"></p>
<ul>
<li>默认分词器，按照空格分开</li>
</ul>
<p><img src="/../../images/image-20230327095316628.png" alt="image-20230327095316628"></p>
<ul>
<li><p>ik_analyzer</p>
<ul>
<li>粗粒度分词</li>
</ul>
<p><img src="/../../images/image-20230327095642945.png" alt="image-20230327095642945"></p>
<ul>
<li>细粒度分词</li>
</ul>
<p><img src="/../../images/image-20230327095725623.png" alt="image-20230327095725623"></p>
</li>
</ul>
<p>我们在存入Es时，还需要考虑数据之间的关系，就比如属性和属性值之间的关系，Es不会主动记录这些关系，需要根据nested类来实现。</p>
<ul>
<li>创建普通索引</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#创建索引</span><br><span class="line">POST myindex/_doc/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fans&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;first&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jhon&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;last&quot;</span><span class="punctuation">:</span> <span class="string">&quot;simth&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;first&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Alice&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;last&quot;</span><span class="punctuation">:</span> <span class="string">&quot;White&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">#查询索引</span><br><span class="line">Get _cat/indices?v</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230327101702271.png" alt="image-20230327101702271"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询数据</span></span><br><span class="line">get myindex/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>   </span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>		<span class="comment">//查询要求，必须满足下面两条规则</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;users.first&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jhon&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;users.last&quot;</span><span class="punctuation">:</span> <span class="string">&quot;simth&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查出了一条数据：</p>
<p><img src="/../../images/image-20230327102540108.png" alt="image-20230327102540108"></p>
<p>但是普通存储是有问题的，我们现在查找的是first&#x3D;jhon，last&#x3D;simth肯定是能出现结果的，但是如果我查找first&#x3D;jhon，last&#x3D;White，同样也也会出现结果</p>
<p><img src="/../../images/image-20230327102708191.png" alt="image-20230327102708191"></p>
<p>这是因为我们在使用普通存储时候它默认会存储成这样的效果：</p>
<blockquote>
<p>users:</p>
<p>​	first:  jhon、Alice</p>
<p>​	last：  simth、White</p>
</blockquote>
<p>这也就使得怎么组合都能够查出结果，失去了存入数据时候的关系了。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get myindex/_mapping		<span class="comment">//查询映射关系</span></span><br></pre></td></tr></table></figure>

<p><img src="/../../images/image-20230327102939441.png" alt="image-20230327102939441"></p>
<p>要想保留之间的关系，就需要用到nested。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">DELETE myindex</span><br><span class="line"></span><br><span class="line">#声明存储类型为nested</span><br><span class="line">put myindex</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nested&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//查询映射关系看一下和上面的区别</span></span><br><span class="line">get myindex/_mapping</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230327104045460.png" alt="image-20230327104045460"></p>
<p>重新将数据传进去</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#创建索引</span><br><span class="line">POST myindex/_doc/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fans&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;first&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jhon&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;last&quot;</span><span class="punctuation">:</span> <span class="string">&quot;simth&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;first&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Alice&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;last&quot;</span><span class="punctuation">:</span> <span class="string">&quot;White&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>





<p>重新在查询结果，就找不到了<br><img src="/../../images/image-20230327104430205.png" alt="image-20230327104430205"></p>
<h3 id="全文检索"><a href="#全文检索" class="headerlink" title="全文检索"></a>全文检索</h3><p>上面我们了解到，我们要建立一个索引库提供给搜索框使用，提示系统效率，避免访问mysql。所以现在整个搜索的流程就是下面这样的：</p>
<p><img src="/../../images/image-20230327164339704.png" alt="image-20230327164339704"></p>
<p>​		检索流程相对比较简单。我们在做后台管理系统的时候，我们在实现商品上下架的时候，留了一个坑，就是因为我们数据都是从Es库中拿到的，我们怎么保证我们后台上架后能够同步到Es中，也就是Es新增索引的这么一个过程。当时说我们会发送一个消息给MQ，MQ会帮我们处理，这一部分主要会在使用MQ的时候详细实现，这里只操作ES实现上下架。所以整个增加检索的流程就变成了下面这样：(下架也是同样的道理 )</p>
<p><img src="/../../images/image-20230327164945019.png" alt="image-20230327164945019"></p>
<p><strong><font size=5>service-list服务</font></strong></p>
<ul>
<li>依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yhz<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-product-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>bootstrap</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service-list</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.73</span><span class="number">.129</span><span class="string">:8848</span></span><br><span class="line">        <span class="attr">shared-configs:</span> <span class="string">common.yaml</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.73</span><span class="number">.129</span><span class="string">:8848</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>



<ul>
<li>nacos.config：</li>
</ul>
<p><img src="/../../images/image-20230327165914851.png" alt="image-20230327165914851"></p>
<ul>
<li>Goods实体类，存入和接收Es中的一个类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***、</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Document</span>：</span></span><br><span class="line"><span class="comment"> *      indexName：索引库名称</span></span><br><span class="line"><span class="comment"> *      shards：分片，集群情况下使用，</span></span><br><span class="line"><span class="comment"> *      replicas：副本，也是集群下使用，表示对于一个数据存储几分</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Document(indexName = &quot;goods&quot; , shards = 3,replicas = 2)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Goods</span> &#123;</span><br><span class="line">    <span class="comment">// 商品Id skuId作为文档的Id，是唯一的</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword, index = false)</span>     <span class="comment">//声明字段，文档中的字段名称，可以指定类型Keyword和Text都表示字符串</span></span><br><span class="line">    <span class="keyword">private</span> String defaultImg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  es 中能分词的字段，这个字段数据类型必须是 text！keyword 不分词！analyzer：指定分词器</span></span><br><span class="line">    <span class="comment">// 里面还有一个属性值没有体现出来，searchAnalyzer：这个是搜索时候使用的分词器</span></span><br><span class="line">    <span class="comment">// 区分索引和搜索时的分词器是因为可能 在索引时候希望尽可能的细一点，搜索的时候没必要那么细</span></span><br><span class="line">    <span class="comment">// 除了这个字段其他都不需要分词</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Double)</span></span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  @Field(type = FieldType.Date)   6.8.1</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Date,format = DateFormat.custom,pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime; <span class="comment">// 新品</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Long)</span></span><br><span class="line">    <span class="keyword">private</span> Long tmId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword)</span></span><br><span class="line">    <span class="keyword">private</span> String tmName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword)</span></span><br><span class="line">    <span class="keyword">private</span> String tmLogoUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Long)</span></span><br><span class="line">    <span class="keyword">private</span> Long category1Id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword)</span></span><br><span class="line">    <span class="keyword">private</span> String category1Name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Long)</span></span><br><span class="line">    <span class="keyword">private</span> Long category2Id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword)</span></span><br><span class="line">    <span class="keyword">private</span> String category2Name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Long)</span></span><br><span class="line">    <span class="keyword">private</span> Long category3Id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword)</span></span><br><span class="line">    <span class="keyword">private</span> String category3Name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  商品的热度！ 我们将商品被用户点查看的次数越多，则说明热度就越高！</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Long)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Long</span> <span class="variable">hotScore</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 平台属性集合对象</span></span><br><span class="line">    <span class="comment">// Nested 支持嵌套查询</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Nested)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SearchAttr&gt; attrs;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>先创建Es的索引库和mapping映射结构</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ElasticsearchRestTemplate elasticsearchRestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 创建索引库，建立mapping对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/createIndex&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">createIndex</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//创建索引库</span></span><br><span class="line">    elasticsearchRestTemplate.createIndex(Goods.class);</span><br><span class="line">    <span class="comment">//创建mapping</span></span><br><span class="line">    elasticsearchRestTemplate.putMapping(Goods.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>查询是否创建goods索引库成功</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get _cat/indices?v</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/image-20230327174512901.png" alt="image-20230327174512901"></p>
<ul>
<li>查询索引库结构</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">get goods/_mapping</span><br></pre></td></tr></table></figure>



<p>主要是看那个nested的索引</p>
<p><img src="/../../images/image-20230327174550602.png" alt="image-20230327174550602"></p>
<p>增加索引实际上就是通过上架功能来实现的，我们可以通过先实现上架功能来代替全部一起放到Es中。</p>
<p>既然是上架，我们也实现了通过skuid修改数据库中的is_sale字段，所以我们上架新增索引也是通过skuid来查找各种需要的值，然后存入Es。那需要那些值，我们可以通过对Goods进行分析得到：</p>
<p><img src="/../../images/image-20230327180134732.png" alt="image-20230327180134732"></p>
<p>我们可以通过skuid查到 skuinfo，封装红色部分的数据，然后skuinfo中有tmId就可以封装蓝色部分的数据，skuinfo中还有category3Id，就可以查找紫色部分的数据，平台属性同样可以通过skuinfo中的skuAttrValueList</p>
<p>拿到平台属性封装绿色部分。</p>
<p>并且好多我们其实已经实现了，红色部分、紫色部分和绿色部分。我们在feign中已经提供了对应的接口了，可以直接使用。所以我们只需要再实现根据品牌Id获取品牌数据，这个也很简单我们跳过，直接到上架的功能的实现。</p>
<p>由于这次要操作的是Es，而不是数据库。所以我们包的命名会有些区别，操作数据的包我们叫mapper，操作Es的称为repository，需要继承ElasticsearchRepository，提供很多操作的方法。</p>
<p><strong><font size=5>上架实现</font></strong></p>
<ul>
<li>repository</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> *  类似于数据库的mapper在es中称为Repository</span></span><br><span class="line"><span class="comment"> *  需要继承ElasticsearchRepository可提供很多Crud的方法</span></span><br><span class="line"><span class="comment"> *  两个泛型分别表示：</span></span><br><span class="line"><span class="comment"> *      1、查询结果返回什么类型</span></span><br><span class="line"><span class="comment"> *      2、结果唯一标识的Id的类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ESrepository</span> <span class="keyword">extends</span> <span class="title class_">ElasticsearchRepository</span>&lt;Goods,Long&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>serivce</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">upperGoods</span><span class="params">(Long skuid)</span> &#123;</span><br><span class="line">    <span class="comment">//查询数据</span></span><br><span class="line">    <span class="type">SkuInfo</span> <span class="variable">skuInfo</span> <span class="operator">=</span> productClientService.getSkuInfo(skuid);</span><br><span class="line">    <span class="type">BaseTrademark</span> <span class="variable">trademark</span> <span class="operator">=</span> productClientService.getTrademark(skuInfo.getTmId());</span><br><span class="line">    <span class="type">BaseCategoryView</span> <span class="variable">categoryView</span> <span class="operator">=</span> productClientService.getCategoryView(skuInfo.getCategory3Id());</span><br><span class="line">    List&lt;BaseAttrInfo&gt; attrList = productClientService.getAttrList(skuid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将数据封装到Goods里</span></span><br><span class="line">    <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Goods</span>();</span><br><span class="line">    <span class="comment">//封装Sku数据</span></span><br><span class="line">    goods.setId(skuid);</span><br><span class="line">    goods.setDefaultImg(skuInfo.getSkuDefaultImg());</span><br><span class="line">    goods.setTitle(skuInfo.getSkuName());</span><br><span class="line">    goods.setPrice(productClientService.getSkuPrice(skuid).doubleValue());<span class="comment">//要实时获取价格</span></span><br><span class="line">    goods.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    goods.setTmId(skuInfo.getTmId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装商品品牌信息</span></span><br><span class="line">    goods.setTmName(trademark.getTmName());</span><br><span class="line">    goods.setTmLogoUrl(trademark.getLogoUrl());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装分类信息</span></span><br><span class="line">    goods.setCategory1Id(categoryView.getCategory1Id());</span><br><span class="line">    goods.setCategory2Id(categoryView.getCategory2Id());</span><br><span class="line">    goods.setCategory3Id(categoryView.getCategory3Id());</span><br><span class="line">    goods.setCategory1Name(categoryView.getCategory1Name());</span><br><span class="line">    goods.setCategory2Name(categoryView.getCategory2Name());</span><br><span class="line">    goods.setCategory3Name(categoryView.getCategory3Name());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装平台属性信息</span></span><br><span class="line">    ArrayList&lt;SearchAttr&gt; searchAttrs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    attrList.stream().forEach((attr)-&gt;&#123;</span><br><span class="line">        <span class="type">SearchAttr</span> <span class="variable">searchAttr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchAttr</span>();</span><br><span class="line"></span><br><span class="line">        searchAttr.setAttrId(attr.getId());</span><br><span class="line">        searchAttr.setAttrName(attr.getAttrName());</span><br><span class="line">        searchAttr.setAttrValue(attr.getAttrValueList().get(<span class="number">0</span>).getValueName());</span><br><span class="line">        searchAttrs.add(searchAttr);</span><br><span class="line">    &#125;);</span><br><span class="line">    goods.setAttrs(searchAttrs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加到Es</span></span><br><span class="line">    eSrepository.save(goods);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>测试时，一直在查找skuinfo时候出现空指针异常，最后发现他连feign都是空的，所以找到主启动类发现没有扫描到feign的包</li>
</ul>
<p><img src="/../../images/image-20230328095332329.png" alt="image-20230328095332329"></p>
<ul>
<li>测试通过后，去kibana中查看</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">post goods/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230328095426611.png" alt="image-20230328095426611"></p>
<p><strong><font size=5>下架实现</font></strong></p>
<p>直接使用skuid就能够直接通过ESrepository进行删除，因为这里的skuid就是Goods的id。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lowerGoods</span><span class="params">(Long skuid)</span> &#123;</span><br><span class="line">    eSrepository.deleteById(skuid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<p><strong><font size=5>查询</font></strong></p>
<p>上面实现的实际上是一个索引的过程，我们在首页还要完成查询的功能。直接用搜索框查询被称为匹配查询，而使用三级分类的标签则被称为过滤查询。可以通过品牌、一二三级分类、平台属性来实现过滤查询。查询所有手机的品牌，或者说把所有被查到的手机的品牌聚合到一起，聚合查询。 </p>
<p>这些查询都是在ES上完成的，所以我们还需要编写Es专门的查询语句dsl。</p>
<ul>
<li>匹配查询：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询小米手机</span></span><br><span class="line">post goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: <span class="string">&quot;小米手机&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面这样的查询会对 小米手机进行分词，分成小米和手机</span></span><br><span class="line"><span class="comment"># 包含小米和手机的都会被查出来，不符合要求</span></span><br><span class="line"><span class="comment"># 所以我们要将将分词之后的关系设置为 and 而不是or</span></span><br><span class="line"><span class="comment">#########################################</span></span><br><span class="line"></span><br><span class="line">post goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;小米手机&quot;</span>,</span><br><span class="line">        <span class="string">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################</span></span><br><span class="line"><span class="comment">#高亮显示，只有在匹配查询的时候可以指定</span></span><br><span class="line"><span class="comment"># highlight 开启高亮显示</span></span><br><span class="line"><span class="comment"># fields指定匹配词在哪个字段</span></span><br><span class="line"><span class="comment"># pre_tags 匹配到的字段加上前缀，这里只能用 []，不能用&#123;&#125;</span></span><br><span class="line"><span class="comment"># post_tags 匹配到的字段加上后缀，这里只能用 []，不能用&#123;&#125;</span></span><br><span class="line">POST goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: <span class="string">&quot;小米&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;pre_tags&quot;</span>: [<span class="string">&quot;&lt;span style-color:red&gt;&quot;</span>],</span><br><span class="line">    <span class="string">&quot;post_tags&quot;</span>: [<span class="string">&quot;&lt;/span&gt;&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><img src="/../../images/image-20230329104646017.png" alt="image-20230329104646017"></p>
<ul>
<li>过滤查询：</li>
</ul>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询手机分类，实际上传递的就是分类的id</span></span><br><span class="line"><span class="comment"># bool 条件查询</span></span><br><span class="line"><span class="comment"># term：对查询不分词</span></span><br><span class="line">post goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>:[</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;term&quot;</span>:&#123;</span><br><span class="line">              <span class="string">&quot;category3Id&quot;</span>:<span class="number">61</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">##########################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#还有一个就是对于nested类型的查询</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bool条件查询</span></span><br><span class="line"><span class="comment"># must 必须满足里面的条件</span></span><br><span class="line"><span class="comment"># nested 声明是对nested类型的查询</span></span><br><span class="line"><span class="comment"># path 具体的nested的属性</span></span><br><span class="line"><span class="comment"># match 实际的查询条件，条件名需要用path的值去获取</span></span><br><span class="line">post goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;nested&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;attrs&quot;</span>,</span><br><span class="line">            <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;attrs.attrValue&quot;</span>: <span class="string">&quot;8G&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#############################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分页查询加排序</span></span><br><span class="line"><span class="comment"># from 查出来的结果从第几个开始显示：(当前页-1)*size</span></span><br><span class="line"><span class="comment"># size：每页显示多少个</span></span><br><span class="line"><span class="comment"># sort 需要排序</span></span><br><span class="line"><span class="comment"># price指定的根据哪个字段进行排序</span></span><br><span class="line"><span class="comment"># order：降序还是升序</span></span><br><span class="line">post goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;from&quot;</span>:<span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;price&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;order&quot;</span>:<span class="string">&quot;desc&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>聚合查询</li>
</ul>
<p><img src="/../../images/image-20230329094441157.png" alt="image-20230329094441157"></p>
<ul>
<li>聚合里面还需要在根据另一个属性聚合，一个aggs下只能有一个aggs。但是aggs可以一直嵌套</li>
</ul>
<p><img src="/../../images/image-20230329102001622.png" alt="image-20230329102001622"></p>
<ul>
<li>子集合中多字段聚合，一个aggs下可以创建多个聚合命名</li>
</ul>
<p><img src="/../../images/image-20230329102344057.png" alt="image-20230329102344057"></p>
<ul>
<li>nested子集合中多字段聚合，其实就是多申明一个nested域而已。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//现根据id聚合起来</span></span><br><span class="line"><span class="comment">//每个id下面又根据value和name聚合起来</span></span><br><span class="line"></span><br><span class="line">POST goods/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;attrsAggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attrs&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;attrIdAggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attrs.attrId&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attrNameAggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attrs.attrName&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attrValueAggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attrs.attrValue&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>结果过滤，有些时候我们查出来不要那么多的结果，只要去几个字段就可以了</li>
</ul>
<p><img src="/../../images/image-20230329104953006.png" alt="image-20230329104953006"></p>
<h3 id="检索条件和响应封装"><a href="#检索条件和响应封装" class="headerlink" title="检索条件和响应封装"></a>检索条件和响应封装</h3><p>由于，我们的搜索可能会加上很多的条件，为了避免在请求参数里写很多的变量直接定义了一个通用的检索对象。</p>
<ul>
<li>检索条件对象</li>
</ul>
<p><img src="/../../images/image-20230329110549116.png" alt="image-20230329110549116"></p>
<ul>
<li>响应数据对象</li>
</ul>
<p><img src="/../../images/image-20230329111018913.png" alt="image-20230329111018913"></p>
<p><strong><font size=5>dsl查询</font></strong></p>
<p>我们之前使用ElasticsearchRepository作为查询Es的工具，但是这个类里面只有简单的一些查询api，对于较为复杂的查询我们需要使用一个新的对象，也是Es官方为我们提供的一个客户端高级对象<strong>RestHighLevelClient。</strong></p>
<ul>
<li>通过search方法去查询，他需要一个SearchRequest对象，所以我们还需要封装一个SearchRequest对象</li>
</ul>
<p><img src="/../../images/image-20230329113207840.png" alt="image-20230329113207840"></p>
<ul>
<li>SearchRequest对象通过source方法可以添加搜索条件，所以还需要构造一个条件构造对象</li>
</ul>
<p><img src="/../../images/image-20230329113426209.png" alt="image-20230329113426209"></p>
<ul>
<li>条件构造对象通过query 增加搜索条件，需要一个条件构造器，通过QueryBuilders添加条件</li>
</ul>
<p><img src="/../../images/image-20230329113906321.png" alt="image-20230329113906321"></p>
<ul>
<li>一次es查询的基本流程</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//封装SearchRequest请求对象</span></span><br><span class="line"><span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//条件构造对象</span></span><br><span class="line"><span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加搜索条件</span></span><br><span class="line">searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加条件到请求对象</span></span><br><span class="line">searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line"><span class="comment">//search方法需要一个SearchRequest请求对象</span></span><br><span class="line"><span class="type">SearchResponse</span> <span class="variable">search</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br></pre></td></tr></table></figure>



<p>那么我们自己的逻辑就是：</p>
<blockquote>
<p>封装Es查询对象—&gt;Es查询—-&gt;解析查询结果，封装成返回对象。</p>
</blockquote>
<p><img src="/../../images/image-20230329135306770.png" alt="image-20230329135306770"></p>
<ul>
<li><p><strong><font size=4.5 color=red>封装Es查询对象</font></strong></p>
<ul>
<li>query部分</li>
</ul>
<p><img src="/../../images/image-20230329150355267.png" alt="image-20230329150355267"></p>
<ul>
<li>分页，指定查找结果中从哪个结果开始和每页的条数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> (searchParam.getPageNo()-<span class="number">1</span>)*searchParam.getPageSize();</span><br><span class="line">searchSourceBuilder.from(start).size(searchParam.getPageSize());</span><br></pre></td></tr></table></figure>



<ul>
<li>排序</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//排序,排序字段的存储格式，1:desc/2:desc</span></span><br><span class="line"><span class="comment">// 1表示hotScore 2表示priceString order = searchParam.getOrder();</span></span><br><span class="line"><span class="keyword">if</span>(!StringUtils.isEmpty(order))&#123;</span><br><span class="line">    String[] split = order.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(split!=<span class="literal">null</span>&amp;&amp;split.length==<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">switch</span> (split[<span class="number">0</span>])&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;1&quot;</span>:</span><br><span class="line">                searchSourceBuilder.sort(<span class="string">&quot;hotScore&quot;</span>, SortOrder.DESC);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;2&quot;</span>:</span><br><span class="line">                searchSourceBuilder.sort(<span class="string">&quot;price&quot;</span>, SortOrder.DESC);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        searchSourceBuilder.sort(<span class="string">&quot;hotScore&quot;</span>, SortOrder.DESC);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>聚合</li>
</ul>
<p><img src="/../../images/image-20230329171920823.png" alt="image-20230329171920823"></p>
<ul>
<li>高亮，需要设置三个参数，字段、前缀、后缀</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HighlightBuilder</span> <span class="variable">highlightBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>();</span><br><span class="line">highlightBuilder.field(<span class="string">&quot;title&quot;</span>);</span><br><span class="line">highlightBuilder.preTags(<span class="string">&quot;&lt;span style-color:red&gt;&quot;</span>);</span><br><span class="line">highlightBuilder.postTags(<span class="string">&quot;&lt;/span&gt;&quot;</span>);</span><br><span class="line">searchSourceBuilder.highlighter(highlightBuilder);</span><br></pre></td></tr></table></figure>



<ul>
<li>结果过滤，第一个参数表示要包含哪些显示，第二个参数表示不包含哪些参数显示</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String[] index = &#123;<span class="string">&quot;id&quot;</span>,</span><br><span class="line">                <span class="string">&quot;defaultImg&quot;</span>,</span><br><span class="line">                <span class="string">&quot;title&quot;</span>,</span><br><span class="line">                <span class="string">&quot;price&quot;</span>&#125;;</span><br><span class="line">searchSourceBuilder.fetchSource(index,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>





<ul>
<li>dsl查询语句</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(searchSourceBuilder.toString()); <span class="comment">//可以拿到dsl表达式</span></span><br></pre></td></tr></table></figure>

<p>拿到结果后可以到kibana中查找</p>
<p><img src="/../../images/image-20230329172847250.png" alt="image-20230329172847250"></p>
<ul>
<li>结果</li>
</ul>
<p><img src="/../../images/image-20230329174231049.png" alt="image-20230329174231049"></p>
<p>拿到上面的结果，我们还要将这个结果转为Java实体类。也就是SearchResponseVo：</p>
<p><img src="/../../images/image-20230329174340653.png" alt="image-20230329174340653"></p>
<ul>
<li>这里实际上就是对着查询结果一个个拆，很麻烦但是不难</li>
</ul>
<p><img src="/../../images/image-20230329183952837.png" alt="image-20230329183952837"></p>
<p>其他的结构也是一直调用Api去拆数据，这里不过多赘述。</p>
<h3 id="热度排名"><a href="#热度排名" class="headerlink" title="热度排名"></a>热度排名</h3><p>​		我们希望我们反问首页，或者查询某个关键字的时候显示的商品是以热度排名的，而热度是每个sku被点击一次对应的热点得分就会加一，虽然Es能够很好的帮我们实现全文检索了，但是我们还是要避免大量的请求都直接放到Es上，所以我们还需要经过缓存的介入，一段时间内是修改缓存中的热点得分，同一个数据的查询也是通过缓存返回的。</p>
<p><img src="/../../images/image-20230328101952108.png" alt="image-20230328101952108"></p>
<p>这里存入缓存用的方式和之前只对String类型操作有点不一样，虽然直接操作String也可以。</p>
<p>因为我们想 这里的加一操作有这么一个感觉，hotscore是redis中的key，这个key下面可以存放不同的对象对应的值：</p>
<blockquote>
<p>hotscore:</p>
<p>​	skuid: 21   1</p>
<p>​	skuid:22    2</p>
<p>​	…</p>
</blockquote>
<p>所以这使用到了数据类型是zset，它能够提供根据一个key为不同的成员分组，每个成员又还有不同的key - value的对应关系。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">incrHotScore</span><span class="params">(Long skuid)</span> &#123;</span><br><span class="line">    <span class="comment">//在redis中增加数据</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">hotKey</span> <span class="operator">=</span> <span class="string">&quot;hotScore&quot;</span>;</span><br><span class="line">    <span class="type">Double</span> <span class="variable">hotscore</span> <span class="operator">=</span> redisTemplate.opsForZSet().incrementScore(hotKey, <span class="string">&quot;skuid:&quot;</span> + skuid, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果加到整10则重新写入es中</span></span><br><span class="line">    <span class="keyword">if</span>(hotscore%<span class="number">10</span>==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//通过id查找es数据</span></span><br><span class="line">        Optional&lt;Goods&gt; res = eSrepository.findById(skuid);</span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> res.get();</span><br><span class="line">        <span class="comment">//通过redis增加得到的数据是一个dobule类型的数据，这里的参数是Long类型</span></span><br><span class="line">        <span class="comment">//通过Math的四舍五入的函数可以将double --&gt;  long类型</span></span><br><span class="line">        goods.setHotScore(Math.round(hotscore));</span><br><span class="line">        <span class="comment">//覆盖</span></span><br><span class="line">        eSrepository.save(goods);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>请求同一个sku多次</li>
</ul>
<p><img src="/../../images/image-20230328113253838.png" alt="image-20230328113253838"></p>
<ul>
<li>es里面会存放整数的hotscore</li>
</ul>
<p><img src="/../../images/image-20230328113318385.png" alt="image-20230328113318385"></p>
<h1 id="单点登录"><a href="#单点登录" class="headerlink" title="单点登录"></a>单点登录</h1><p>以前单机登录非常简单，登陆后把登录对象存入session中。每次访问需要登录的页面的时候去session中查看是否有session。</p>
<p>分布式架构之后，由于session是属于web服务器的，每个服务都有自己的端口所以每个服务的session也就是不共享的，所以没办法从session中获得以登录对象。流程图如下：</p>
<p><img src="/../../images/image-20230401104605067.png" alt="image-20230401104605067"></p>
<p>虽然我们上面说session不能共享，但是这个不能共享指的是不能够直接从另一个web服务器中拿到session，但是我们可以通过认证中心拿到不同服务器之间相同的登录对象，实现不同服务器之间存储相同的session，实现session共享。 所以我们只需要在其中一个模块中登录过了就能够拿到登录的数据，不需要多次登录，所以就被称为单点登录。</p>
<p>实现起来也比较简单，都是通过token来实现验证，登录从数据库匹配到结果后，把部分消息存到redis，再将前端需要的数据返回回去。</p>
<p><img src="/../../images/image-20230402092627012.png" alt="image-20230402092627012"></p>
<p>登陆完成之后，后续对不同的请求可能需要验证是否登录，所以需要实现一个过滤器，拦截请求判断是否登录。</p>
<p>过滤器实现GlobalFilter接口，重写里面的方法注入容器即可。这里的内容也大部分比较简单，但也有些新的内容。</p>
<ul>
<li>通过response向浏览器输出内容</li>
</ul>
<p>在过滤器中，通过ServerWebExchange 拿到的response对象不是 Http的原生对象，没有Writer那些方法。</p>
<p>这里的response是ServerHttpResponse对象，通过writeWith方法进行输出。构造他的参数比较麻烦：</p>
<blockquote>
<p>1、response.writeWith() 返回Mono<Void>类型，需要一个Publisher<T>对象</p>
<p>2、Mono.just(DataBuffer)就是将参数转成Pubilsher对象，但是参数需要是DataBuffer对象</p>
<p>3、response.bufferFactory()可以获得一个buffer工厂对象，可以通过wrap方法的DataBuffer对象</p>
<p>4、wrap方法需要一个字节流数据，就是我们要输出的数据</p>
<p>5、所以最终就是将我们要输出的数据转成 byte[]，传给wrap方法构造DataBuffer对象，传给Mono.just方法构造Publisher对象，用response.writeWith()进行输出</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Mono&lt;Void&gt; <span class="title function_">out</span><span class="params">(ServerHttpResponse response, ResultCodeEnum permission)</span> &#123;</span><br><span class="line"></span><br><span class="line">    Result&lt;Object&gt; build = Result.build(<span class="literal">null</span>, permission);</span><br><span class="line"></span><br><span class="line">    <span class="type">byte</span>[] bytes = JSONObject.toJSONString(build).getBytes();</span><br><span class="line"></span><br><span class="line">    <span class="type">DataBuffer</span> <span class="variable">wrap</span> <span class="operator">=</span> response.bufferFactory().wrap(bytes);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理中文乱码</span></span><br><span class="line">    response.getHeaders().add(<span class="string">&quot;Content-Type&quot;</span>,<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response.writeWith(Mono.just(wrap));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>经过网关转发时，怎么在请求头中插入参数</li>
</ul>
<p>同样这里拿到的也不是原生对象，所以加起来比较麻烦。出现这个需求是因为，我们在后续登录之后可能会比较频繁的获取userId，如果每次都是通过redis获取就会很麻烦，不如在过滤器中直接将他存到请求头中，后面直接获取。</p>
<p>这里不能通过request.getHeaders().add(“userId”,userId.toString());方法增加，因为这里的request是ServerHttpRequest类型的，获得的headers是只允许读的对象，增加会出现UnsupportOperteException。而是通过以下方式来完成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.mutate().header(<span class="string">&quot;userId&quot;</span>,userId.toString()).build();</span><br><span class="line"><span class="keyword">return</span> chain.filter(exchange.mutate().request(request).build());</span><br></pre></td></tr></table></figure>





<h1 id="订单模块"><a href="#订单模块" class="headerlink" title="订单模块"></a>订单模块</h1><p>​	订单模块的开始表示也会涉及到钱，涉及到钱一般都是比较核心的部分。所以这里的业务逻辑可能会比较繁琐。</p>
<p>​	订单是通过结算按钮生成的，所以一开始需要完成的就是结算按钮后的逻辑处理。点击结算后会发送一个html请求，和上面一样都会被网关拦截，然后找到web-all找到对应的页面。所以我们只需要考虑是否需要 携带数据即可。</p>
<p>​	通过对页面的分析，我们发现需要携带以下数据：1、用户地址；2、流水号；3、选中的商品清单。</p>
<p><img src="/../../images/image-20230402213529964.png" alt="image-20230402213529964"></p>
<h2 id="遇到的部分问题，以及知识点回顾-3"><a href="#遇到的部分问题，以及知识点回顾-3" class="headerlink" title="遇到的部分问题，以及知识点回顾"></a>遇到的部分问题，以及知识点回顾</h2><h3 id="LinkedHashMap-转实体类"><a href="#LinkedHashMap-转实体类" class="headerlink" title="LinkedHashMap 转实体类"></a>LinkedHashMap 转实体类</h3><p>这个问题出现在，经过feign调用后，原来接口获取的数据类型是 List&lt; T &gt;类型，但是到使用feign调用后结果都变成了 以T的属性名做key，值为value的List&lt; LinkedHashMap &gt;类型。</p>
<p>出现这个问题主要原因是因为RPC底层还是由http请求实现的，涉及到http请求数据传输就会涉及到数据序列化和反序列化。所以主要原因还是服务提供者反序列化没有处理好。</p>
<p>但是我没找到在服务提供方哪里出错了，只能在拿到数据后对LinkedHashMap做处理，通过ObjectMapper对类型进行转化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"><span class="type">T</span> <span class="variable">data</span> <span class="operator">=</span> objectMapper.convertValue(mapdata, T.class);</span><br></pre></td></tr></table></figure>





<h3 id="Feign调用请求头丢失"><a href="#Feign调用请求头丢失" class="headerlink" title="Feign调用请求头丢失"></a>Feign调用请求头丢失</h3><p>在订单模块中，我们之前为了方便获取userId，设置了一个全局过滤器，如果已经登录的用户，会在请求头上加上一个userId请求头。也就是过了网关到达web-all准备进行feign调用的时候，请求头中的数据是还存在的，但是经过feign调用后可能会出现请求头丢失的情况，也就是我们无法从请求头中获取userId信息。</p>
<p>解决：我们需要自定义一个拦截器，实现RequestInterceptor接口，在发送一个http请求的时候就会被这个拦截器拦截下来，执行public void apply(RequestTemplate requestTemplate)方法。</p>
<p>这个方法的参数是将会向后传递的请求模板对象，断点可以看到这里面没有请求头内容，所以我们要通过原生的httprequest对象，将我们后面需要用到的请求头塞到RequestTemplate 中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate requestTemplate)</span>&#123;</span><br><span class="line">    <span class="comment">//  微服务远程调用使用feign ，feign 传递数据的时候，没有。</span></span><br><span class="line">    <span class="type">ServletRequestAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">    <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> attributes.getRequest();</span><br><span class="line">    <span class="comment">//  添加header 数据</span></span><br><span class="line">    requestTemplate.header(<span class="string">&quot;userTempId&quot;</span>, request.getHeader(<span class="string">&quot;userTempId&quot;</span>));</span><br><span class="line">    requestTemplate.header(<span class="string">&quot;userId&quot;</span>, request.getHeader(<span class="string">&quot;userId&quot;</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="防止重复提交订单"><a href="#防止重复提交订单" class="headerlink" title="防止重复提交订单"></a>防止重复提交订单</h3><p>​	为了防止用户生成订单后回退到去结算页面，多次提交同一个订单，我们需要再生成订单时，携带一个流水号。并且生成了流水号还需要再去支付的时候携带这个流水号，并向redis中保存一份流水号。支付时只有redis中的流水号和当前请求携带的流水号相同才允许支付，否则就会报错重复提交订单。</p>
<h3 id="不同项目之间的调用"><a href="#不同项目之间的调用" class="headerlink" title="不同项目之间的调用"></a>不同项目之间的调用</h3><p>在实际开发中，一个系统可能有伴随其他好几个系统的融合，不同之间的系统可能互相都只知道对方的接口，因此在项目中要使用这些接口就不能够用feign来完成了，只能用http请求来实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:9001/hasStock?skuId=&quot;</span>+skuId+<span class="string">&quot;&amp;num=&quot;</span>+skuNum;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> HttpClientUtil.doGet(url);</span><br></pre></td></tr></table></figure>







<h1 id="其他遇到的问题以及知识点回顾"><a href="#其他遇到的问题以及知识点回顾" class="headerlink" title="其他遇到的问题以及知识点回顾"></a>其他遇到的问题以及知识点回顾</h1><h2 id="操作redis的hash"><a href="#操作redis的hash" class="headerlink" title="操作redis的hash"></a>操作redis的hash</h2><p>我们很容易想到可以直接通过以下代码来操作redis里的hash数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redisTemplate.opsForHash().put(k,hk,hv);</span><br><span class="line">redisTemplate.opsForHash().get(k, hk);</span><br><span class="line">。。。。</span><br></pre></td></tr></table></figure>



<p>除此之外，redisTemplate还提供了更为简便的操作redis的hash数据的方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BoundHashOperations&lt;Object,Object,Object&gt; boundHashOperations = redisTemplate.boundHashOps(redis_key);</span><br></pre></td></tr></table></figure>

<p>这种方式我们相当于只要传递第一级的key，然后可以把这个对象当作map使用，并且他还提供了更丰富的api。</p>
<h2 id="商品上下架、订单自动取消、分布式事务"><a href="#商品上下架、订单自动取消、分布式事务" class="headerlink" title="商品上下架、订单自动取消、分布式事务"></a>商品上下架、订单自动取消、分布式事务</h2><p>商品上下架是我们之前就一直在提到的问题，后台操作了数据库怎么让Es能够知道。之前也提出过解决方案：</p>
<blockquote>
<p>1、操作数据库之后顺便操作Es</p>
<p>2、Es服务提供结构共后台使用</p>
<p>这些方法都违背了服务之间相互独立的原则，使得服务之间相互耦合</p>
</blockquote>
<p>订单自动取消指的是，我们下了一个订单之后，经过2小时候会自动取消如何实现。</p>
<blockquote>
<p>后台启动一个定时器，两个消失后自动执行定时器任务。</p>
<p>这种方式是可行的，但是会占用一定的系统开销</p>
</blockquote>
<p>分布式事务，现在可能实现分布式事务已经不需要像我们这样麻烦了，但是还是可以通过这种方式来实现。</p>
<p>这种方式就是消息队列，上述的三个问题都能够被消息队列很好的解决。</p>
<p>一使用到消息队列，最需要关心和解决的问题就是如何保证消息不丢失？</p>
<p>要解决消息丢失我们先回顾以下什么时候会出现消息丢失：</p>
<blockquote>
<p>1、生产者将消息发送给交换机时，消息会丢失</p>
<p>2、交换机收到消息之后，还没有被消费宕机，导致消息丢失</p>
<p>3、交换机将消息发送给消费者的过程中，出现消息丢失</p>
</blockquote>
<p>有哪些方式去防止出现消息丢失：</p>
<blockquote>
<p>1、开启事务模式</p>
<p>2、消息持久化到磁盘</p>
<p>3、开启消息确认模式</p>
<p>其中1会导致接收消息的效率大大降低，所以一般不会使用，而2、3两种方式一般都是同时启用的。</p>
</blockquote>
<ul>
<li>消息持久化，为了让MQ重启的时候消息不出现丢失，可以将交换机、队列在声明时候就设为持久的，且不自动删除的。</li>
</ul>
<blockquote>
<p>durable&#x3D;true  ;  autoDelete&#x3D;false</p>
<p>还需要设置 deliveryMode&#x3D;2</p>
<p>这就是让消息持久化和确认机制一同工作，消息持久化到磁盘后还会发送一个ack，防止交换机接收到消息就发送ack，但是在持久化过程中宕机，导致生产者误以为消息能够不丢失。</p>
</blockquote>
<ul>
<li>发送确认</li>
</ul>
<blockquote>
<p>一般我们都是要求需要开发者进行手动确认，因为有时可能会出现消息被消费者接收到了，但是消费者执行出现了异常，导致消息没有被正常消费，但是生产者不知道，不会将消息重发。</p>
</blockquote>
<h3 id="使用、封装"><a href="#使用、封装" class="headerlink" title="使用、封装"></a>使用、封装</h3><p>RabbitMq基本配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rabbitmq:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.73</span><span class="number">.129</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">  <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span>  <span class="comment">#交换机的确认</span></span><br><span class="line">  <span class="attr">publisher-returns:</span> <span class="literal">true</span>			<span class="comment">#队列的确认 </span></span><br><span class="line">  <span class="attr">listener:</span></span><br><span class="line">    <span class="attr">simple:</span></span><br><span class="line">      <span class="attr">acknowledge-mode:</span> <span class="string">manual</span> <span class="comment">#默认情况下消息消费者是自动确认消息的，如果要手动确认消息则需要修改确认模式为manual</span></span><br><span class="line">      <span class="attr">prefetch:</span> <span class="number">1</span> <span class="comment"># 消费者每次从队列获取的消息数量。此属性当不设置时为：轮询分发，设置为1为：公平分发</span></span><br></pre></td></tr></table></figure>





<p>为了方便使用，我们可以定义一个通用的消息发送模板，后面设需要发送消息直接调用这个方法，把交换机、routingkey和要发送的消息传给这个方法就可以了。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String exchange,String routingkey,Object mess)</span>&#123;</span><br><span class="line"></span><br><span class="line">        rabbitTemplate.convertAndSend(exchange,routingkey,mess);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>除此之外，我们要保证消息无论是到交换机还是队列中都要能够返回一个应答，所以还要实现RabbitTemplate中的两个内部接口。RabbitTemplate.ReturnCallback   ； RabbitTemplate.ConfirmCallback</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//内部接口 需要注入</span></span><br><span class="line">    rabbitTemplate.setReturnCallback(<span class="built_in">this</span>);</span><br><span class="line">    rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> correlationData      封装了消息的对象，里面有id和Message对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ack        应答</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cause     错误的原因</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ack)&#123;</span><br><span class="line">        <span class="comment">//正确接收</span></span><br><span class="line">        log.info(<span class="string">&quot;发送消息成功&quot;</span>+ JSON.toJSONString(correlationData));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;发送消息失败，原因&quot;</span>+cause+JSON.toJSONString(correlationData));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 确认消息是否正确到达队列</span></span><br><span class="line"><span class="comment"> * 到达不执行</span></span><br><span class="line"><span class="comment"> * 没到执行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> replycode        应答码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> replytext         描述信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> echange           交换机</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> queue             路由</span></span><br><span class="line"><span class="comment"> *         交换机+路由用于重发</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(Message message, <span class="type">int</span> replycode, String replytext, String echange, String queue)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消息内容：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    System.out.println(<span class="string">&quot;应答码：&quot;</span>+replycode);</span><br><span class="line">    System.out.println(<span class="string">&quot;描述：&quot;</span>+replytext);</span><br><span class="line">    System.out.println(<span class="string">&quot;使用的交换机：&quot;</span>+echange);</span><br><span class="line">    System.out.println(<span class="string">&quot;路由信息：&quot;</span>+queue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>测试消息无法发送到队列，信息会被打印。既然这些信息都可以被获取到，所以我们就能够在方法里设置消息发送失败重发的机制。</p>
<p><img src="/../../images/image-20230404095308736.png" alt="image-20230404095308736"></p>
<p>重试发送的实现方式有很多，这里采用和redis结合实现的形式。</p>
<blockquote>
<p>首先会有一个封装消息的实体类</p>
<p>生产者生产消息之后会对消息进行封装，并存入redis</p>
<p>如果消息没有达到交换机，调用confirm回调函数，就可以在里面从redis中获取消息重新发送</p>
<p>如果没有达到队列也是类似的实现。</p>
</blockquote>
<ul>
<li>实体类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * CorrelationData 里面就有消息的id和Message对象</span></span><br><span class="line"><span class="comment"> * 我们只需要增加自己想要的属性就能够对其进行拓展</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCorrelationData</span> <span class="keyword">extends</span> <span class="title class_">CorrelationData</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  消息主体</span></span><br><span class="line">    <span class="keyword">private</span> Object message;</span><br><span class="line">    <span class="comment">//  交换机</span></span><br><span class="line">    <span class="keyword">private</span> String exchange;</span><br><span class="line">    <span class="comment">//  路由键</span></span><br><span class="line">    <span class="keyword">private</span> String routingKey;</span><br><span class="line">    <span class="comment">//  重试次数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">retryCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//  消息类型  是否是延迟消息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isDelay</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//  延迟时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">delayTime</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li><p>消息保存到redis，应该什么时候进行保存？每个生产者都对其保存一次吗？那要么就是出现大量的冗余代码，要么就是同一个方法被大量调用同样出现冗余。我们之前不是封装了发送的方法吗，我们可以在发送方法中对消息进行保存，只要谁调用了发送方法自然就会保存消息。</p>
<ul>
<li><p>修改发送方法</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String exchange,String routingkey,Object mess)</span>&#123;</span><br><span class="line">        <span class="type">MyCorrelationData</span> <span class="variable">myCorrelationData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyCorrelationData</span>();</span><br><span class="line">        myCorrelationData.setId(UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>,<span class="string">&quot;&quot;</span>));</span><br><span class="line">        myCorrelationData.setExchange(exchange);</span><br><span class="line">        myCorrelationData.setRoutingKey(routingkey);</span><br><span class="line">        myCorrelationData.setMessage(mess);</span><br><span class="line"></span><br><span class="line">        redisTemplate.opsForValue().set(myCorrelationData.getId(), JSON.toJSONString(myCorrelationData));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//用这个重载形式是因为需要 在confirm回调函数中能够拿到Id，从redis中获取要重发的消息</span></span><br><span class="line">        <span class="comment">//confirm有一个参数就会接收CorelationData对象</span></span><br><span class="line">        rabbitTemplate.convertAndSend(exchange,routingkey,mess,myCorrelationData);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改confirm方法</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> correlationData      封装了消息的对象，里面有id和Message对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ack        应答</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cause     错误的原因</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ack)&#123;</span><br><span class="line">        <span class="comment">//正确接收</span></span><br><span class="line">        log.info(<span class="string">&quot;发送消息成功&quot;</span>+ JSON.toJSONString(correlationData));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;发送消息失败，原因&quot;</span>+cause+JSON.toJSONString(correlationData));</span><br><span class="line">        retry(correlationData.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">retry</span><span class="params">(String id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span>(String) redisTemplate.opsForValue().get(id);</span><br><span class="line">    <span class="type">MyCorrelationData</span> <span class="variable">myCorrelationData</span> <span class="operator">=</span> JSON.parseObject(res, MyCorrelationData.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(myCorrelationData.getRetryCount()&gt;<span class="number">3</span>)&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;重试次数过多&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        myCorrelationData.setRetryCount(myCorrelationData.getRetryCount()+<span class="number">1</span>);</span><br><span class="line">        redisTemplate.opsForValue().set(myCorrelationData.getId(),JSON.toJSONString(myCorrelationData));</span><br><span class="line"></span><br><span class="line">        rabbitTemplate.convertAndSend(myCorrelationData.getExchange(),</span><br><span class="line">                                      myCorrelationData.getRoutingKey(),</span><br><span class="line">                                      myCorrelationData.getMessage(),</span><br><span class="line">                                      myCorrelationData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改returnedMessage</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 确认消息是否正确到达队列</span></span><br><span class="line"><span class="comment"> * 到达不执行</span></span><br><span class="line"><span class="comment"> * 没到执行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> replycode        应答码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> replytext         描述信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> echange           交换机</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> queue             路由</span></span><br><span class="line"><span class="comment"> *         交换机+路由用于重发</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(Message message, <span class="type">int</span> replycode, String replytext, String echange, String queue)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消息内容：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    System.out.println(<span class="string">&quot;应答码：&quot;</span>+replycode);</span><br><span class="line">    System.out.println(<span class="string">&quot;描述：&quot;</span>+replytext);</span><br><span class="line">    System.out.println(<span class="string">&quot;使用的交换机：&quot;</span>+echange);</span><br><span class="line">    System.out.println(<span class="string">&quot;路由信息：&quot;</span>+queue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取消息唯一Id的固定写法</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">messageId</span> <span class="operator">=</span> (String) message.getMessageProperties().getHeaders().get(<span class="string">&quot;spring_returned_message_correlation&quot;</span>);</span><br><span class="line"></span><br><span class="line">    retry(messageId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="上下架完善"><a href="#上下架完善" class="headerlink" title="上下架完善"></a>上下架完善</h3><p>上下架功能我们到这里提到了好多次，这里是做最终的实现，通过MQ来完成响应到Es服务中。</p>
<ul>
<li>serivce-product，我们在修改完数据库后发送一条消息给消息队列</li>
</ul>
<p><img src="/../../images/image-20230404143318610.png" alt="image-20230404143318610"></p>
<ul>
<li>serivce-list，在service-list服务中开启两个监听器，分别监听两个队列，当队列有消息时候就会取出skuId，然后执行对Es的增加和删除操作。</li>
</ul>
<p><img src="/../../images/image-20230404143413609.png" alt="image-20230404143413609"></p>
<h3 id="订单取消"><a href="#订单取消" class="headerlink" title="订单取消"></a>订单取消</h3><p>我们需要对两小时内未支付的订单进行取消，所以需要用到Mq中的延迟队列。</p>
<p>实现Mq延迟队列的方式主要有两种：</p>
<blockquote>
<p>1、基于死信队列</p>
<p>2、基于延迟插件</p>
</blockquote>
<p>​		死信队列就是无法被消费的消息就会进入死信队列，在我们这个业务要求中我们只需要将订单发送的消息设置它的ttl为2h，让它交换机发送给一个没有消费者监听的队列，并且配置好死信路由，就能够在两小时后将这个消息发送到死信队列，并且让消费者监听这个死信队列。</p>
<ul>
<li>基于死信</li>
</ul>
<p>上面演示过用注解实现绑定，这里回忆一下使用配置类完成绑定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLetterMqConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">exchange_dead</span> <span class="operator">=</span> <span class="string">&quot;exchange.dead&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">routing_dead_1</span> <span class="operator">=</span> <span class="string">&quot;routing.dead.1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">routing_dead_2</span> <span class="operator">=</span> <span class="string">&quot;routing.dead.2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queue_dead_1</span> <span class="operator">=</span> <span class="string">&quot;queue.dead.1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queue_dead_2</span> <span class="operator">=</span> <span class="string">&quot;queue.dead.2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">exchange</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(exchange_dead,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">deadQueu1</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//设置超时</span></span><br><span class="line">        Map&lt;String,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//设置超时</span></span><br><span class="line">        map.put(<span class="string">&quot;x-message-ttl &quot;</span>,<span class="number">1000</span>*<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置死信路由</span></span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>,exchange_dead);</span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>,routing_dead_2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(queue_dead_1).withArguments(map).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">deadQueu2</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(queue_dead_2,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding1</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(deadQueu1()).to(exchange()).with(routing_dead_1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding2</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(deadQueu2()).to(exchange()).with(routing_dead_2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/sendDeadLetter&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendDeadLetter</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">SimpleDateFormat</span> <span class="variable">simpleDateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd yy:MM:ss&quot;</span>);</span><br><span class="line">    System.out.println(simpleDateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">    mqService.sendMessage(DeadLetterMqConfig.exchange_dead,DeadLetterMqConfig.routing_dead_1,<span class="string">&quot;hahahahahha&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = DeadLetterMqConfig.queue_dead_2)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getMessage</span><span class="params">(String msg, Message message, Channel channel)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//时间格式化</span></span><br><span class="line">    SimpleDateFormat simpleDateFormat=<span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd  HH:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;消息接收的时间：\t&quot;</span>+simpleDateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;消息的内容&quot;</span>+msg);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<ul>
<li>基于延迟插件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayMqConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">exchange_delay</span> <span class="operator">=</span> <span class="string">&quot;exchange.delay&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">routing_delay</span> <span class="operator">=</span> <span class="string">&quot;routing.delay&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queue_delay</span> <span class="operator">=</span> <span class="string">&quot;queue.delay&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queuedelay</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(queue_delay,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomExchange <span class="title function_">customExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">&quot;x-delayed-type&quot;</span>,<span class="string">&quot;direct&quot;</span>); <span class="comment">//  延迟类型</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/***</span></span><br><span class="line"><span class="comment">         * 1、交换机名字</span></span><br><span class="line"><span class="comment">         * 2、交换机的类型</span></span><br><span class="line"><span class="comment">         * 3、是否持久化</span></span><br><span class="line"><span class="comment">         * 4、是否自动删除</span></span><br><span class="line"><span class="comment">         * 5、额外参数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(exchange_delay,<span class="string">&quot;x-delayed-message&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queuedelay()).to(customExchange()).with(routing_delay).noargs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>生产者，使用插件后不能用我们自己写的封装的方法，因为我们需要多设置一个参数，要用RabbitMq提供的Template才完成</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/sendDelayLetter&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendDelayLetter</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">SimpleDateFormat</span> <span class="variable">simpleDateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd yy:MM:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line">    rabbitTemplate.convertAndSend(DelayMqConfig.exchange_delay, DelayMqConfig.routing_delay, <span class="string">&quot;lalalalala&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">MessagePostProcessor</span>() &#123;</span><br><span class="line">            <span class="comment">//使用插件必须实现这个方法，因为消息会被这个方法拦截，如果不返回消息就不会过</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> Message <span class="title function_">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException &#123;</span><br><span class="line">                    <span class="comment">//设置延迟 时间</span></span><br><span class="line">                    message.getMessageProperties().setDelay(<span class="number">10</span>*<span class="number">1000</span>);</span><br><span class="line">                    System.out.println(simpleDateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">                    <span class="keyword">return</span> message;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>消费者就和上面都是一样的</li>
</ul>
<p>如果实现了 RabbitTemplate.ReturnCallback接口的话，可能会报错，因为我们设置了延迟到达队列，而这个接口中的方法对于没有到达队列的消息会重试，所以可能会拿不到message对象。</p>
<p>为了方便使用，我们将延迟插件的消息发送同样也进行封装。</p>
<p>在Mqservice中增加一个延迟插件的sendMessage方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String exchange, String routingkey, Object mess, <span class="type">int</span> delaytime)</span>&#123;</span><br><span class="line">    <span class="type">MyCorrelationData</span> <span class="variable">myCorrelationData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyCorrelationData</span>();</span><br><span class="line">    myCorrelationData.setId(UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>,<span class="string">&quot;&quot;</span>));</span><br><span class="line">    myCorrelationData.setExchange(exchange);</span><br><span class="line">    myCorrelationData.setRoutingKey(routingkey);</span><br><span class="line">    myCorrelationData.setMessage(mess);</span><br><span class="line">    myCorrelationData.setDelay(<span class="literal">true</span>);</span><br><span class="line">    myCorrelationData.setDelayTime(<span class="number">1000</span>*delaytime);</span><br><span class="line"></span><br><span class="line">    redisTemplate.opsForValue().set(myCorrelationData.getId(), JSON.toJSONString(myCorrelationData));</span><br><span class="line"></span><br><span class="line">    rabbitTemplate.convertAndSend(exchange,routingkey,mess,message -&gt; &#123;</span><br><span class="line">        message.getMessageProperties().setDelay(<span class="number">1000</span>*delaytime);</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;,myCorrelationData);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>重试方法改造：需要加上判断是否是延迟队列</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">retry</span><span class="params">(String id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span>(String) redisTemplate.opsForValue().get(id);</span><br><span class="line">    <span class="type">MyCorrelationData</span> <span class="variable">myCorrelationData</span> <span class="operator">=</span> JSON.parseObject(res, MyCorrelationData.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(myCorrelationData.getRetryCount()&gt;<span class="number">3</span>)&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;重试次数过多&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        myCorrelationData.setRetryCount(myCorrelationData.getRetryCount()+<span class="number">1</span>);</span><br><span class="line">        redisTemplate.opsForValue().set(myCorrelationData.getId(),JSON.toJSONString(myCorrelationData));</span><br><span class="line">        <span class="comment">//判断是否延迟</span></span><br><span class="line">        <span class="keyword">if</span> (myCorrelationData.isDelay()) &#123;</span><br><span class="line">            rabbitTemplate.convertAndSend(myCorrelationData.getExchange(),</span><br><span class="line">                    myCorrelationData.getRoutingKey(),</span><br><span class="line">                    myCorrelationData.getMessage(),</span><br><span class="line">                    message -&gt; &#123;</span><br><span class="line">                        message.getMessageProperties().setDelay(<span class="number">1000</span>*myCorrelationData.getDelayTime());</span><br><span class="line">                        <span class="keyword">return</span> message;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    myCorrelationData);</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            rabbitTemplate.convertAndSend(myCorrelationData.getExchange(),</span><br><span class="line">                    myCorrelationData.getRoutingKey(),</span><br><span class="line">                    myCorrelationData.getMessage(),</span><br><span class="line">                    myCorrelationData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>​		增加了重试机制之后，我们还需要新增加考虑的一个点，那就是当消费者把消息消费之后，如果返回ack出现问题，导致生产者以为没有收到消息，在重新发送了一个消息如何保证这个消息不被重复消费。这就是消费者需要关系的幂等性问题。</p>
<p>​		实现思路：</p>
<blockquote>
<p>​		要实现幂等性，我们一般都是通过一个标记，这个标记要保证第一次的时候可以使用，第二次到来的时候就无法使用。</p>
<p>​		这个要求是否很想我们当时实现分布式锁的要求，分布式锁是为了保证多个进程改到达同步代码块时，只允许一个进程进入，我们通过使用redis 的setnx指令，只有第一次到达的进程能够设置成功，后续的都无法设置成功，不成功就需要在同步代码块外等待。</p>
<p>​		这里实现幂等性同样可以使用这种方式，让第一次消费的消息使用redis的setnx指令，后续的消息无法执行setnx指令。</p>
</blockquote>
<ul>
<li>消费者改造</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = DelayMqConfig.queue_delay)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getMessageByDelay</span><span class="params">(String msg, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">redis_key</span> <span class="operator">=</span> <span class="string">&quot;message:&quot;</span>+msg;</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">result</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(redis_key, <span class="string">&quot;0&quot;</span>, <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置成功返回true表示第一次准备消费消息，失败返回false表示可能已经被消费</span></span><br><span class="line">    <span class="keyword">if</span>(!result)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> (String)redisTemplate.opsForValue().get(redis_key);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//表示已经被消费直接返回应答消息</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;1&quot;</span>.equals(status))&#123;</span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//设置了redis但是没有被正常消费</span></span><br><span class="line">            SimpleDateFormat simpleDateFormat=<span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd  HH:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;消费者消息接收的时间：\t&quot;</span>+simpleDateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;消费者接收消息的内容&quot;</span>+msg);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//跟新redis中的状态，表示消息已经被消费</span></span><br><span class="line">            redisTemplate.opsForValue().set(redis_key,<span class="string">&quot;1&quot;</span>,<span class="number">10</span>,TimeUnit.MINUTES);</span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//第一次到达消费消息</span></span><br><span class="line">        SimpleDateFormat simpleDateFormat=<span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd  HH:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;消费者消息接收的时间：\t&quot;</span>+simpleDateFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;消费者接收消息的内容&quot;</span>+msg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//跟新redis中的状态，表示消息已经被消费，set语句是可以生效的，setnxy</span></span><br><span class="line">        redisTemplate.opsForValue().set(redis_key,<span class="string">&quot;1&quot;</span>,<span class="number">10</span>,TimeUnit.MINUTES);</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h2 id="对接支付宝"><a href="#对接支付宝" class="headerlink" title="对接支付宝"></a>对接支付宝</h2><p>要去申请，需要营业执照有点麻烦，这里使用他们提供的一个已经注册的账号。下面是一些配置：</p>
<p>账号的公私密钥，还有APPID。</p>
<p><img src="/../../images/image-20230405083645674.png" alt="image-20230405083645674"></p>
<ul>
<li>支付宝的依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sdk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>alipay-sdk-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.8.73.ALL<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>





<p>我们现在希望通过点击支付宝支付，能够让支付宝给我们返回一个扫码支付的界面，这个要请求到这个界面需要，满足支付宝请求的要求，我们要做好参数封装提交给支付宝。</p>
<p>请求入口：</p>
<p><img src="/../../images/image-20230405091650827.png" alt="image-20230405091650827"></p>
<p>我们可以将支付宝需要配置的APPID、公钥、私钥等信息从配置文件读到 Config文件里，并且创建AliPay对象注入容器，后面就可以直接使用 Alipay对象。</p>
<p>参数都是从配置文件中读取过来的，这里还涉及到一个知识点，在配置类中静态的变量如何从yml中读取到？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//静态数据读取赋值</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String notify_payment_url;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;notify_payment_url&#125;&quot;)</span>		<span class="comment">//会设置参数中，然后再通过赋值的方式完成</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNotify_payment_url</span><span class="params">(String notify_payment_url)</span>&#123;</span><br><span class="line"></span><br><span class="line">    AlipayConfig.notify_payment_url =notify_payment_url;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> AlipayClient <span class="title function_">alipayClient</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(alipay_url,app_id,app_private_key,format,charset,alipay_public_key,sign_type);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> alipayClient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>创建好支付对象之后，我们后面直接使用里面的方法就能够完成对接支付宝</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alipayClient.pageExecute()	<span class="comment">//要一个请求对象</span></span><br></pre></td></tr></table></figure>





<p>设置请求对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AlipayTradePagePayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradePagePayRequest</span>(); <span class="comment">//创建API对应的request</span></span><br><span class="line"><span class="comment">//设置同步回调地址</span></span><br><span class="line">alipayRequest.setReturnUrl(AlipayConfig.return_payment_url);</span><br><span class="line"><span class="comment">//异步回调地址</span></span><br><span class="line">alipayRequest.setNotifyUrl(AlipayConfig.notify_payment_url); <span class="comment">//在公共参数中设置回跳和通知地址</span></span><br><span class="line"><span class="comment">//设置请求参数</span></span><br><span class="line"><span class="type">JSONObject</span> <span class="variable">bizContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">bizContent.put(<span class="string">&quot;out_trade_no&quot;</span>, orderInfo.getOutTradeNo());</span><br><span class="line">bizContent.put(<span class="string">&quot;total_amount&quot;</span>, <span class="number">0.01</span>);       <span class="comment">//这里就是扫码需要支付的金额，这里做测试写死0.01</span></span><br><span class="line">bizContent.put(<span class="string">&quot;subject&quot;</span>, <span class="string">&quot;测试商品&quot;</span>);</span><br><span class="line"><span class="comment">//设置超时时间--相对时间</span></span><br><span class="line"><span class="comment">//        bizContent.put(&quot;timeout_express&quot;, &quot;10m&quot;);</span></span><br><span class="line"><span class="comment">//          设置超时时间--绝对时间</span></span><br><span class="line"><span class="comment">//获取十分后的时间 yyyy-MM-dd HH:mm:ss</span></span><br><span class="line"><span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line"><span class="comment">//加上十分钟</span></span><br><span class="line">calendar.add(Calendar.MINUTE,<span class="number">10</span>);</span><br><span class="line"><span class="comment">//获取时间</span></span><br><span class="line"><span class="type">String</span> <span class="variable">format</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(calendar.getTime());</span><br><span class="line"></span><br><span class="line">bizContent.put(<span class="string">&quot;time_expire&quot;</span>, format);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bizContent.put(<span class="string">&quot;product_code&quot;</span>, <span class="string">&quot;FAST_INSTANT_TRADE_PAY&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">alipayRequest.setBizContent(bizContent.toJSONString()); <span class="comment">//填充业务参数</span></span><br></pre></td></tr></table></figure>



<p>主要是两个回调函数地址，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置同步回调地址</span></span><br><span class="line">alipayRequest.setReturnUrl(AlipayConfig.return_payment_url);</span><br><span class="line"><span class="comment">//异步回调地址</span></span><br><span class="line">alipayRequest.setNotifyUrl(AlipayConfig.notify_payment_url); <span class="comment">//在公共参数中设置回跳和通知地址</span></span><br></pre></td></tr></table></figure>

<p><img src="/../../images/image-20230405110713475.png" alt="image-20230405110713475"></p>
<ul>
<li>同步回调函数</li>
</ul>
<p>这个主要是给用户看的，支付完钱之后跳转回自己的网站执行后续操作的。</p>
<p>设置了这个请求之后，支付宝会帮我们发起这个请求。也就是会发起</p>
<p><a target="_blank" rel="noopener" href="http://api.gmall.com/api/payment/alipay/callback/return%E8%BF%99%E4%B8%AA%E8%AF%B7%E6%B1%82%EF%BC%8C%E6%89%80%E4%BB%A5%E6%88%91%E4%BB%AC%E8%BF%98%E8%A6%81%E5%AE%9A%E4%B9%89%E8%BF%99%E4%B8%AA%E8%AF%B7%E6%B1%82%E4%B8%8D%E7%84%B6%E6%89%BE%E4%B8%8D%E5%88%B0%E3%80%82%E8%BF%99%E4%B8%AA%E8%AF%B7%E6%B1%82%E5%AE%9E%E9%99%85%E4%B8%8A%E4%B8%BB%E8%A6%81%E6%98%AF%E8%A6%81%E5%AE%8C%E6%88%90%E9%87%8D%E5%AE%9A%E5%90%91%EF%BC%8C%E5%8F%91%E8%B5%B7%E8%AF%B7%E6%B1%82%E5%90%8E%EF%BC%8C%E7%BB%8F%E8%BF%87%E7%BD%91%E5%85%B3%E6%89%BE%E5%88%B0service-payment%E9%87%8C%E7%9A%84%EF%BC%9Aalipay/callback/return">http://api.gmall.com/api/payment/alipay/callback/return这个请求，所以我们还要定义这个请求不然找不到。这个请求实际上主要是要完成重定向，发起请求后，经过网关找到service-payment里的：alipay/callback/return</a></p>
<p>这个请求将请求重定向至success.html。</p>
<p>这里是要重定向页面，所以返回的字符串应该被解析成路径，所以不能够加上@ResponseBody注解，或者@ResController注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/callback/return&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">callback</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:&quot;</span>+ AlipayConfig.return_order_url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>支付宝发起   &#x2F;callback&#x2F;return请求后，被我们重定向至  <a target="_blank" rel="noopener" href="http://payment.gmall.com/pay/success.html%EF%BC%8C%E5%90%8C%E6%A0%B7%E4%BC%9A%E5%85%88%E7%BB%8F%E8%BF%87%E7%BD%91%E5%85%B3%EF%BC%8C%E6%97%A2%E7%84%B6%E4%BC%9A%E7%BB%8F%E8%BF%87%E7%BD%91%E5%85%B3%EF%BC%8C%E9%82%A3%E5%B0%B1%E4%BC%9A%E8%A2%AB%E5%8F%91%E9%80%81%E5%88%B0web-all%EF%BC%8Cweb-all%E5%AF%B9%E8%AF%B7%E6%B1%82%E7%9A%84html%E9%A1%B5%E9%9D%A2%E5%81%9A%E8%B7%B3%E8%BD%AC%E6%89%BE%E5%88%B0%E5%85%B7%E4%BD%93%E7%9A%84html%E9%A1%B5%E9%9D%A2%E3%80%82">http://payment.gmall.com/pay/success.html，同样会先经过网关，既然会经过网关，那就会被发送到web-all，web-all对请求的html页面做跳转找到具体的html页面。</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/pay/success.html&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">success</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;payment/success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>支付：</p>
<p><img src="/../../images/image-20230405114005054.png" alt="image-20230405114005054"></p>
<p>跳转：</p>
<p><img src="/../../images/image-20230405114139320.png" alt="image-20230405114139320"></p>
<ul>
<li>异步回调</li>
</ul>
<p>主要是涉及到金钱，为了保证安全，防止在支付完成之后用户关闭了浏览器或者浏览器卡死导致没有执行同步回调，导致没有修改到订单的状态。所以需要加上一个异步回调，异步回调会一直在后台尝试直到成功。并且异步回调会携带一个Map参数里面会携带一些用于校验的信息。</p>
<h2 id="秒杀服务"><a href="#秒杀服务" class="headerlink" title="秒杀服务"></a>秒杀服务</h2><p>可想而知，秒杀要承受的并发量肯定是远远大于前面任何一个业务的，所以我们仅仅对要参与秒杀的数据存入redis这样的远程缓存可能已经不太能够满足我们的要求了。</p>
<p>所以在处理这样 的超高并发的场景一般我们都会在redis前面再加一层， 本地缓存存储一个用于管理秒杀商品数据的Map，用户一参与秒杀就先进入判断Map中的商品状态，如果状态表示已售空就会直接放回连redis都不会进。</p>
<p>既然使用到本地缓存，如果在集群情况下部署的话，本地缓存的内容如何与其他服务器进行同步呢？</p>
<p>秒杀数据该如何导入redis？什么时候导入？</p>
<h3 id="数据预热"><a href="#数据预热" class="headerlink" title="数据预热"></a>数据预热</h3><p>假设是每天都会有一个秒杀活动，每天凌晨一点会开启此活动，要怎么实现这样的要求呢？</p>
<p>我们会有一个定时任务服务，在每隔十秒的时候就会发送一条消息给消息队列，秒杀服务会监听这个队列，一旦收到消息就会将要导入的数据读入redis进行预热。</p>
<ul>
<li>定时任务</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableScheduling</span>       <span class="comment">//开启定时任务注解</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScheduledTask</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MqService mqService;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cron表达式：</span></span><br><span class="line"><span class="comment">     *      秒 分 时 日 月 星期 年</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/10 * * * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">task</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;发消息&quot;</span>);</span><br><span class="line">        mqService.sendMessage(MqConstant.EXCHANGE_DIRECT_TASK,MqConstant.ROUTING_TASK_1,<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>秒杀服务监听器</li>
</ul>
<p>这里监听器除了要把数据写入redis以外还要考虑写入redis的条件，比如说要怎么样才能获取当天的商品？</p>
<p>怎么防止超卖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> SeckillGoodsService seckillGoodsService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(MqConstant.EXCHANGE_DIRECT_TASK),</span></span><br><span class="line"><span class="meta">        value = @Queue(value = MqConstant.QUEUE_TASK_1,durable = &quot;true&quot;,autoDelete = &quot;false&quot;),</span></span><br><span class="line"><span class="meta">        key = &#123;MqConstant.ROUTING_TASK_1&#125;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//要添加条件，是不是当天的活动，</span></span><br><span class="line">    <span class="comment">// 思路：查询开始时间字段格式化为 年月日，和new Date也格式化为年月日对比</span></span><br><span class="line">    QueryWrapper&lt;SeckillGoods&gt; seckillGoodsqw = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    seckillGoodsqw.eq(<span class="string">&quot;date_format(start_time,&#x27;%Y-%m-%d&#x27;)&quot;</span>, DateUtil.formatDate(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加条件状态为1</span></span><br><span class="line">    seckillGoodsqw.eq(<span class="string">&quot;status&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//库存大于0</span></span><br><span class="line">    seckillGoodsqw.ge(<span class="string">&quot;stock_count&quot;</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    List&lt;SeckillGoods&gt; list = seckillGoodsService.list(seckillGoodsqw);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断是否为空</span></span><br><span class="line">    <span class="keyword">if</span>(!CollectionUtils.isEmpty(list))&#123;</span><br><span class="line">        <span class="keyword">for</span> (SeckillGoods seckillGoods : list) &#123;</span><br><span class="line">            <span class="comment">//插入前判断数据是否以已经存在</span></span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">aBoolean</span> <span class="operator">=</span> redisTemplate.boundHashOps(RedisConst.SECKILL_GOODS).hasKey(seckillGoods.getSkuId().toString());</span><br><span class="line">            <span class="keyword">if</span>(aBoolean)&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            redisTemplate.opsForHash().put(RedisConst.SECKILL_GOODS,seckillGoods.getSkuId().toString(),seckillGoods);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//防止超卖，这个的实现使用到了redis的list数据类型，以及redis操作的原子性</span></span><br><span class="line">            <span class="comment">//有多少个商品，我们就往list里面存入几个同样的Id，每次枪就会取走一个知道list为空</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">stockCount</span> <span class="operator">=</span> seckillGoods.getStockCount();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">Integer</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; stockCount; i++) &#123;</span><br><span class="line">                <span class="comment">//key：seckill:stock:skuId</span></span><br><span class="line">                redisTemplate.opsForList().leftPush(RedisConst.SECKILL_STOCK_PREFIX+seckillGoods.getSkuId().toString(),seckillGoods.getSkuId().toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>上面只是实现了redis数据的导入，我们之前还说了要有一个本地内存来存放一个map，来表示商品的状态让每个商品先过内存，提高并发量。但是问题就是如果是集群环境，怎么保证内存能够同步呢？</p>
<p>很容易想到使用mq的广播，faout交换机。但是我们回忆一下mq的广播是如何实现的：</p>
<blockquote>
<p>faout交换机，也就是mq 的发布订阅模式，一条消息到达交换机后，他会将消息转发给所有绑定了这个交换机的队列，也就是我是会有多个队列的，再让每个消费者去监听这些不同的队列，从而让每个消费者都拿到同一个数据。</p>
<p>看似可行，但是问题就出在这是有多个队列才能实现的，如果是集群部署，集群中运行的都是同一套代码，所以不同的端口好监听的应该是同一个队列，队列的消息又只能被一个消费者消费，这就还是无法达到我们的目的。</p>
</blockquote>
<p>那既然mq无法实现，还有什么类似的中间件能够完成这个功能。其实同样是发布订阅模式，redis中也有一个发布订阅模式，redis中的发布订阅模式只有一个管道的概念，只要是订阅了这个管道的订阅者都能够拿到这个消息，是不是就正好能够满足我们的要求。</p>
<p>redis的发布订阅模式，命令很简单就是 发送发通过 publish channel message，将message发送到channel中，订阅者通过 subscript channel 就能够订阅这个管道，就能够收到message。但是在Java中要如何配置。</p>
<p>需要配置主题的监听器，监听器需要有适配器参数，适配器需要有能够处理消息的处理器，所以一共要配置三个东西。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisChannelConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     *注册主题订阅的监听器</span></span><br><span class="line"><span class="comment">     * 参数：</span></span><br><span class="line"><span class="comment">     *  1、适配器</span></span><br><span class="line"><span class="comment">     *  2、连接工程</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisMessageListenerContainer <span class="title function_">container</span><span class="params">(MessageListenerAdapter messageListenerAdapter,</span></span><br><span class="line"><span class="params">                                                   RedisConnectionFactory factory)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">RedisMessageListenerContainer</span> <span class="variable">container</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisMessageListenerContainer</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置适配器</span></span><br><span class="line">        container.addMessageListener(messageListenerAdapter,<span class="keyword">new</span> <span class="title class_">PatternTopic</span>(<span class="string">&quot;seckillPush&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//连接工厂</span></span><br><span class="line">        container.setConnectionFactory(factory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建适配器对象，注入spring</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageListenerAdapter <span class="title function_">adapter</span><span class="params">(MessageReceiver messageReceiver)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//参数：</span></span><br><span class="line">        <span class="comment">//  1、处理消息的处理器</span></span><br><span class="line">        <span class="comment">//  2、处理消息的处理器的处理方法名，后面通过反射调用，</span></span><br><span class="line">        <span class="comment">//生产者发送消息就会被处理器的 方法拦截并处理</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MessageListenerAdapter</span>(messageReceiver,<span class="string">&quot;messagereceive&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置进template中，这里要用redistemplate的子类来创建，因为redistemplate本身没有设置的方法</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> StringRedisTemplate <span class="title function_">stringRedisTemplate</span><span class="params">(RedisConnectionFactory factory)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringRedisTemplate</span>(factory);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>消息处理器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageReceiver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">messagereceive</span><span class="params">(String message)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这里拿到的message的格式是：  &quot;&quot;message&quot;&quot;,有两个双引号，需要对其进行处理</span></span><br><span class="line">        System.out.println(message);</span><br><span class="line"></span><br><span class="line">        message = message.replaceAll(<span class="string">&quot;\&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        String[] split = message.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(split!=<span class="literal">null</span>&amp;&amp;split.length==<span class="number">2</span>)&#123;</span><br><span class="line">            CacheHelper.put(split[<span class="number">0</span>],split[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CacheHelper里面封装了一个ConcurrentHashMap，保证线程安全。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://yimeng436.github.io">异梦</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://yimeng436.github.io/2022/08/22/Project/Project/">https://yimeng436.github.io/2022/08/22/Project/Project/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yimeng436.github.io" target="_blank">异梦的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a></div><div class="post_share"><div class="social-share" data-image="/img/top.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/08/22/Redis/Redis/"><img class="prev-cover" src="/img/top.png" onerror="onerror=null;src='/img/cover.png'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Redis</div></div></a></div><div class="next-post pull-right"><a href="/2022/08/22/Project-UserCenter/Project-UserCenter/"><img class="next-cover" src="/img/top.png" onerror="onerror=null;src='/img/cover.png'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Project</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/01/04/%E5%A4%9A%E6%80%81%E4%BE%8B%E9%A2%98/%E5%A4%9A%E6%80%81%E4%BE%8B%E9%A2%98/" title="多态例题"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-04</div><div class="title">多态例题</div></div></a></div><div><a href="/2022/06/06/%E8%87%AA%E5%8A%A8%E6%8B%86%E8%A3%85%E7%AE%B1/%E8%87%AA%E5%8A%A8%E6%8B%86%E8%A3%85%E7%AE%B1/" title="自动拆装箱"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-06</div><div class="title">自动拆装箱</div></div></a></div><div><a href="/2022/06/15/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="多线程"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-15</div><div class="title">多线程</div></div></a></div><div><a href="/2022/06/30/JavaWeb/JavaWeb/" title="JavaWeb"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-30</div><div class="title">JavaWeb</div></div></a></div><div><a href="/2022/07/25/Mybatis/Mybatis/" title="Mybatis"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-25</div><div class="title">Mybatis</div></div></a></div><div><a href="/2022/07/26/%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%8F%8D%E5%B0%84/%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%8F%8D%E5%B0%84/" title="注解和反射"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-26</div><div class="title">注解和反射</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="http://mms2.baidu.com/it/u=665033858,976373917&amp;fm=253&amp;app=138&amp;f=JPEG&amp;fmt=auto&amp;q=75?w=500&amp;h=500" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">异梦</div><div class="author-info__description">欢迎访问</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">62</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/yimeng436" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2441844062@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#project-mall"><span class="toc-number">1.</span> <span class="toc-text">project-mall</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%9B%BE"><span class="toc-number">2.</span> <span class="toc-text">业务图</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">项目的整体架构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mall-parent-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E6%90%AD%E5%BB%BA"><span class="toc-number">4.</span> <span class="toc-text">mall-parent(整体架构搭建)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#common"><span class="toc-number">4.1.</span> <span class="toc-text">common</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#common-utils"><span class="toc-number">4.1.1.</span> <span class="toc-text">common-utils</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#service-utils"><span class="toc-number">4.1.2.</span> <span class="toc-text">service-utils</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#model"><span class="toc-number">4.2.</span> <span class="toc-text">model</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#service"><span class="toc-number">4.3.</span> <span class="toc-text">service</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-number">5.1.</span> <span class="toc-text">基本信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B3%E5%8F%B0%E5%B1%9E%E6%80%A7"><span class="toc-number">5.2.</span> <span class="toc-text">平台属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%80%E5%94%AE%E5%B1%9E%E6%80%A7"><span class="toc-number">5.3.</span> <span class="toc-text">销售属性</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E7%9A%84%E5%BC%80%E5%8F%91-%E5%95%86%E5%93%81%E7%9A%84%E5%90%84%E7%A7%8D%E6%93%8D%E4%BD%9C-%EF%BC%9Aservice-product"><span class="toc-number">6.</span> <span class="toc-text">后台管理的开发(商品的各种操作)：service-product</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%83%A8%E5%88%86%E9%97%AE%E9%A2%98%EF%BC%8C%E4%BB%A5%E5%8F%8A%E7%9F%A5%E8%AF%86%E7%82%B9%E5%9B%9E%E9%A1%BE"><span class="toc-number">6.1.</span> <span class="toc-text">遇到的部分问题，以及知识点回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82sql%E7%9A%84%E7%BB%93%E6%9E%9C%E9%9B%86%E6%98%A0%E5%B0%84%E9%97%AE%E9%A2%98"><span class="toc-number">6.1.1.</span> <span class="toc-text">复杂sql的结果集映射问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86"><span class="toc-number">6.1.2.</span> <span class="toc-text">事务处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="toc-number">6.1.3.</span> <span class="toc-text">网关配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F"><span class="toc-number">6.1.4.</span> <span class="toc-text">跨域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bootstrap%E5%92%8Capplication"><span class="toc-number">6.1.5.</span> <span class="toc-text">bootstrap和application</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%A1%B5"><span class="toc-number">6.1.6.</span> <span class="toc-text">分页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Minio"><span class="toc-number">6.1.7.</span> <span class="toc-text">Minio</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2"><span class="toc-number">6.1.8.</span> <span class="toc-text">搜索</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5%EF%BC%9Aservice-item-%E6%8B%BF%E6%95%B0%E6%8D%AE-%EF%BC%8Cweb-all-%E6%95%B0%E6%8D%AE%E6%B8%B2%E6%9F%93"><span class="toc-number">7.</span> <span class="toc-text">商品详情页：service-item(拿数据)，web-all(数据渲染)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%83%A8%E5%88%86%E9%97%AE%E9%A2%98%EF%BC%8C%E4%BB%A5%E5%8F%8A%E7%9F%A5%E8%AF%86%E7%82%B9%E5%9B%9E%E9%A1%BE-1"><span class="toc-number">7.1.</span> <span class="toc-text">遇到的部分问题，以及知识点回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE"><span class="toc-number">7.1.1.</span> <span class="toc-text">视图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E4%B8%AD%EF%BC%8Csku%E5%88%87%E6%8D%A2%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.1.2.</span> <span class="toc-text">商品详情中，sku切换的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Openfeign"><span class="toc-number">7.1.3.</span> <span class="toc-text">Openfeign</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#web-all"><span class="toc-number">7.1.4.</span> <span class="toc-text">web-all</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96"><span class="toc-number">7.1.5.</span> <span class="toc-text">优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">7.1.6.</span> <span class="toc-text">redis实现分布式锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redisson%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">7.1.7.</span> <span class="toc-text">redisson实现分布式锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E5%AF%B9sku%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-number">7.1.8.</span> <span class="toc-text">redis对sku商品详情页的优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redisson%E5%AF%B9sku%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-number">7.1.9.</span> <span class="toc-text">redisson对sku商品详情页的优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AOP%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96"><span class="toc-number">7.1.10.</span> <span class="toc-text">AOP代码优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">7.1.11.</span> <span class="toc-text">布隆过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E7%BC%96%E6%8E%92"><span class="toc-number">7.1.12.</span> <span class="toc-text">异步编排</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%BC%82%E6%AD%A5%E7%BC%96%E6%8E%92%E4%BC%98%E5%8C%96%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5"><span class="toc-number">7.1.13.</span> <span class="toc-text">利用异步编排优化商品详情页</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%95%86%E5%9F%8E%E9%A6%96%E9%A1%B5"><span class="toc-number">8.</span> <span class="toc-text">商城首页</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%83%A8%E5%88%86%E9%97%AE%E9%A2%98%EF%BC%8C%E4%BB%A5%E5%8F%8A%E7%9F%A5%E8%AF%86%E7%82%B9%E5%9B%9E%E9%A1%BE-2"><span class="toc-number">8.1.</span> <span class="toc-text">遇到的部分问题，以及知识点回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB%EF%BC%9AJson%E5%B0%81%E8%A3%85%E3%80%81%E5%8E%BB%E9%87%8D%E3%80%81%E6%95%B0%E6%8D%AE%E6%B8%B2%E6%9F%93"><span class="toc-number">8.1.1.</span> <span class="toc-text">查询三级分类：Json封装、去重、数据渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E3%80%81ES%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-number">8.1.2.</span> <span class="toc-text">搜索、ES简单使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="toc-number">8.1.3.</span> <span class="toc-text">全文检索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2%E6%9D%A1%E4%BB%B6%E5%92%8C%E5%93%8D%E5%BA%94%E5%B0%81%E8%A3%85"><span class="toc-number">8.1.4.</span> <span class="toc-text">检索条件和响应封装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E5%BA%A6%E6%8E%92%E5%90%8D"><span class="toc-number">8.1.5.</span> <span class="toc-text">热度排名</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95"><span class="toc-number">9.</span> <span class="toc-text">单点登录</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97"><span class="toc-number">10.</span> <span class="toc-text">订单模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%83%A8%E5%88%86%E9%97%AE%E9%A2%98%EF%BC%8C%E4%BB%A5%E5%8F%8A%E7%9F%A5%E8%AF%86%E7%82%B9%E5%9B%9E%E9%A1%BE-3"><span class="toc-number">10.1.</span> <span class="toc-text">遇到的部分问题，以及知识点回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LinkedHashMap-%E8%BD%AC%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="toc-number">10.1.1.</span> <span class="toc-text">LinkedHashMap 转实体类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Feign%E8%B0%83%E7%94%A8%E8%AF%B7%E6%B1%82%E5%A4%B4%E4%B8%A2%E5%A4%B1"><span class="toc-number">10.1.2.</span> <span class="toc-text">Feign调用请求头丢失</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E6%AD%A2%E9%87%8D%E5%A4%8D%E6%8F%90%E4%BA%A4%E8%AE%A2%E5%8D%95"><span class="toc-number">10.1.3.</span> <span class="toc-text">防止重复提交订单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E9%A1%B9%E7%9B%AE%E4%B9%8B%E9%97%B4%E7%9A%84%E8%B0%83%E7%94%A8"><span class="toc-number">10.1.4.</span> <span class="toc-text">不同项目之间的调用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E7%9F%A5%E8%AF%86%E7%82%B9%E5%9B%9E%E9%A1%BE"><span class="toc-number">11.</span> <span class="toc-text">其他遇到的问题以及知识点回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%93%8D%E4%BD%9Credis%E7%9A%84hash"><span class="toc-number">11.1.</span> <span class="toc-text">操作redis的hash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%95%86%E5%93%81%E4%B8%8A%E4%B8%8B%E6%9E%B6%E3%80%81%E8%AE%A2%E5%8D%95%E8%87%AA%E5%8A%A8%E5%8F%96%E6%B6%88%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">11.2.</span> <span class="toc-text">商品上下架、订单自动取消、分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E3%80%81%E5%B0%81%E8%A3%85"><span class="toc-number">11.2.1.</span> <span class="toc-text">使用、封装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%B8%8B%E6%9E%B6%E5%AE%8C%E5%96%84"><span class="toc-number">11.2.2.</span> <span class="toc-text">上下架完善</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E5%8F%96%E6%B6%88"><span class="toc-number">11.2.3.</span> <span class="toc-text">订单取消</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E6%8E%A5%E6%94%AF%E4%BB%98%E5%AE%9D"><span class="toc-number">11.3.</span> <span class="toc-text">对接支付宝</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%92%E6%9D%80%E6%9C%8D%E5%8A%A1"><span class="toc-number">11.4.</span> <span class="toc-text">秒杀服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%A2%84%E7%83%AD"><span class="toc-number">11.4.1.</span> <span class="toc-text">数据预热</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/08/19/MySQL%E5%8E%9F%E7%90%86%E9%83%A8%E5%88%86/MySQL%E5%8E%9F%E7%90%86%E9%83%A8%E5%88%86/" title="MySQL原理"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="MySQL原理"/></a><div class="content"><a class="title" href="/2023/08/19/MySQL%E5%8E%9F%E7%90%86%E9%83%A8%E5%88%86/MySQL%E5%8E%9F%E7%90%86%E9%83%A8%E5%88%86/" title="MySQL原理">MySQL原理</a><time datetime="2023-08-18T16:00:00.000Z" title="发表于 2023-08-19 00:00:00">2023-08-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/19/%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/" title="算法笔记"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="算法笔记"/></a><div class="content"><a class="title" href="/2023/08/19/%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/" title="算法笔记">算法笔记</a><time datetime="2023-08-18T16:00:00.000Z" title="发表于 2023-08-19 00:00:00">2023-08-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/06/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86/" title="前端知识"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="前端知识"/></a><div class="content"><a class="title" href="/2023/06/06/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86/" title="前端知识">前端知识</a><time datetime="2023-06-05T16:00:00.000Z" title="发表于 2023-06-06 00:00:00">2023-06-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/14/Paper-FSAF/Paper-FSAF/" title="FSAF论文"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="FSAF论文"/></a><div class="content"><a class="title" href="/2022/10/14/Paper-FSAF/Paper-FSAF/" title="FSAF论文">FSAF论文</a><time datetime="2022-10-13T16:00:00.000Z" title="发表于 2022-10-14 00:00:00">2022-10-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/25/Paper-Faster-RCNN/Paper-Faster-RCNN/" title="Faster-RCNN论文"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="Faster-RCNN论文"/></a><div class="content"><a class="title" href="/2022/08/25/Paper-Faster-RCNN/Paper-Faster-RCNN/" title="Faster-RCNN论文">Faster-RCNN论文</a><time datetime="2022-08-24T16:00:00.000Z" title="发表于 2022-08-25 00:00:00">2022-08-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 异梦</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>
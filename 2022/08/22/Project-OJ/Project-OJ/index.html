<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Project | 异梦的博客</title><meta name="keywords" content="Go"><meta name="author" content="异梦"><meta name="copyright" content="异梦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="OJ">
<meta property="og:type" content="article">
<meta property="og:title" content="Project">
<meta property="og:url" content="https://yimeng436.github.io/2022/08/22/Project-OJ/Project-OJ/index.html">
<meta property="og:site_name" content="异梦的博客">
<meta property="og:description" content="OJ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yimeng436.github.io/img/top.png">
<meta property="article:published_time" content="2022-08-21T16:00:00.000Z">
<meta property="article:modified_time" content="2023-09-30T06:47:24.257Z">
<meta property="article:author" content="异梦">
<meta property="article:tag" content="Go">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yimeng436.github.io/img/top.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://yimeng436.github.io/2022/08/22/Project-OJ/Project-OJ/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Project',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-30 14:47:24'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="http://mms2.baidu.com/it/u=665033858,976373917&amp;fm=253&amp;app=138&amp;f=JPEG&amp;fmt=auto&amp;q=75?w=500&amp;h=500" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">62</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/top.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">异梦的博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Project</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-21T16:00:00.000Z" title="发表于 2022-08-22 00:00:00">2022-08-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-30T06:47:24.257Z" title="更新于 2023-09-30 14:47:24">2023-09-30</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Project"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><strong><center><font size=7>OJ 系统</font></center></strong></p>
<h1 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h1><p>1、题目预览</p>
<p>2、在线做题，在线提交</p>
<h2 id="核心实现"><a href="#核心实现" class="headerlink" title="核心实现"></a>核心实现</h2><p>1、权限校验</p>
<p>2、代码沙箱：将用户代码和服务器隔离，防止用户代码藏毒。或者 指令侵害服务器。</p>
<p>3、判题规则</p>
<p>4、任务调度：服务器资源有限，需要让用户有顺序的判题。</p>
<h2 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h2><ul>
<li>普通测评：</li>
</ul>
<p>管理员设置题目的输入和输出用例，判题机执行用户的代码，将用户的结果和标准答案对比是否一致。上面只是测评的概念，普通测评更倾向于有强一致性的答案，比如说标准答案是1用户答案就只能是1这样的。这样的测评我们就只需要去比对用例文件就能够实现</p>
<ul>
<li>特殊测评（SPJ）</li>
</ul>
<p>特殊测评和普通测评的区别就在于，特殊测评的结果可能是不固定的，比如说这题的答案只要是 大于1就能够算对，那用户的结果就有无穷种。这种的测评我们就不好只去比对用例文件来实现了。这种需要专门根据这道题目设计一个特判程序。这个特判程序需要接收的数据有：用户 输入、用户输出、标准输出，特判程序根据这些值来判断结果是否正确。</p>
<h2 id="核心业务流程"><a href="#核心业务流程" class="headerlink" title="核心业务流程"></a>核心业务流程</h2><ul>
<li>时序图</li>
</ul>
<p><img src="/../../images/image-20230824195249295.png" alt="image-20230824195249295"></p>
<p>判题服务和沙箱是必须要解耦的。</p>
<p>沙箱只负责编译运行得到结果</p>
<p>判题才负责对比结果。判题模块还需要处理各种出错的问题。</p>
<h1 id="前端初始化"><a href="#前端初始化" class="headerlink" title="前端初始化"></a>前端初始化</h1><p>使用的是Vue、项目初始化使用的是VueCli、组件库使用的是arco design这是字节开源的一个对标ant design的组件库；</p>
<p>这里做一个简单通用前端的模板</p>
<p>安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add --dev @arco-design/web-vue</span><br></pre></td></tr></table></figure>



<p>完整引入</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">ArcoVue</span> <span class="keyword">from</span> <span class="string">&quot;@arco-design/web-vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@arco-design/web-vue/dist/arco.css&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>);</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title class_">ArcoVue</span>);</span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>);</span><br></pre></td></tr></table></figure>





<ul>
<li><p>抽象基本布局  pass</p>
</li>
<li><p>导航栏，组件库里面是写死的，我们想把他协程和路由绑定的那种是动态的。</p>
</li>
</ul>
<p>把路由的数组从路由文件里面抽离出来，因为别的地方也要用到这个数组。</p>
<p><img src="/../../images/image-20230824211133084.png" alt="image-20230824211133084"></p>
<p>在导航组件中用for循环来遍历这个数组代替这里写死的 菜单项</p>
<p><img src="/../../images/image-20230824211222398.png" alt="image-20230824211222398"></p>
<p>v-for 动态填充</p>
<p><img src="/../../images/image-20230824221749777.png" alt="image-20230824221749777"></p>
<p>还需要配合 menu组件的菜单项单机时间点击菜单项的时候跳转到对应的路由。</p>
<p><img src="/../../images/image-20230824221913940.png" alt="image-20230824221913940"></p>
<p>选中后，还需要做一个被选中项的高亮显示。</p>
<p><img src="/../../images/image-20230824222835537.png" alt="image-20230824222835537"></p>
<p>menu组件有一个绑定选定状态的属性，根据这个属性高亮哪一个菜单项。</p>
<p>router组件提供了两个路由跳转前后的路由守卫函数，里面可以做一些操作。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// to  from 分别是跳转前后的路径的响应式对象</span></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to,<span class="keyword">from</span>,next</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//next 可以控制是否跳转或者跳转到别的，如：</span></span><br><span class="line">  <span class="keyword">if</span> (!isLogin) &#123;</span><br><span class="line">    <span class="title function_">next</span>(<span class="string">&#x27;/login&#x27;</span>); <span class="comment">// 重定向到登录页</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">next</span>(); <span class="comment">// 继续路由跳转</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">afterEach</span>(<span class="function">(<span class="params">to,<span class="keyword">from</span></span>)=&gt;</span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230824223803757.png" alt="image-20230824223803757"></p>
<ul>
<li>全局状态管理</li>
</ul>
<p>这里用了VueX，回顾一下怎么使用。</p>
<p>单独每个需要全局管理的变量最好都单独作为一个文件，或者是同一类型的，存放在同一个文件下管理。定义一个需要全局管理的变量，存放在state里，定义mutations用于修改全局状态变量，定义actions用于调用mutations中的函数修改管理的变量，actions是对外提供使用的。</p>
<p><img src="/../../images/image-20230825154018488.png" alt="image-20230825154018488"></p>
<p>在vuex组件的index文件中，引入：</p>
<p><img src="/../../images/image-20230825154159719.png" alt="image-20230825154159719"></p>
<ul>
<li>使用：</li>
</ul>
<p>用useStore()，获取store组件</p>
<p><img src="/../../images/image-20230825154323141.png" alt="image-20230825154323141"></p>
<h2 id="简单权限管理"><a href="#简单权限管理" class="headerlink" title="简单权限管理"></a>简单权限管理</h2><p>我们用路由绑定的菜单，我们给每个路由可以做一些鉴权操作。</p>
<ul>
<li>对需要权限的路由添加上权限设置，meta里面的属性是自己定义的：</li>
</ul>
<p><img src="/../../images/image-20230825160353174.png" alt="image-20230825160353174"></p>
<p>然后就可以在项目入口，定义上面介绍过的路由守卫函数。 to、from都可以获取所有路由参数</p>
<p><img src="/../../images/image-20230825160447249.png" alt="image-20230825160447249"></p>
<p>同样我们还可以用这种方法，实现对于有某些权限的用户才能看到某些菜单项。</p>
<p>定义一个属性</p>
<p><img src="/../../images/image-20230825164851113.png" alt="image-20230825164851113"></p>
<p>在要使用展示的地方先对这个数据进行过滤</p>
<p><img src="/../../images/image-20230825164952775.png" alt="image-20230825164952775"></p>
<p>使用</p>
<p><img src="/../../images/image-20230825165019914.png" alt="image-20230825165019914"></p>
<p>但是为了让每个组件功能更加的隔离，我们一般不会把权校验放在项目入口App.Vue 中，而是放在鉴权专用的包下，这样如果你重构这个项目，不需要鉴权就只要不引入就可以了。</p>
<p>将上面的代码转移到用于管理权限的包的index.ts下</p>
<p><img src="/../../images/image-20230828153950720.png" alt="image-20230828153950720"></p>
<p>这样我们是否使用鉴权这个功能就只要通过App.vue来管理是否引入就可以了</p>
<p><img src="/../../images/image-20230828154040368.png" alt="image-20230828154040368"></p>
<h2 id="抽象通用权限校验"><a href="#抽象通用权限校验" class="headerlink" title="抽象通用权限校验"></a>抽象通用权限校验</h2><p>上面我们会发现展示路由和路由守卫函数都可能用到鉴权，所以我们可以鉴权抽象出来。</p>
<ul>
<li>定义一个权限的枚举</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">ACCESS_ENUM</span> = &#123;</span><br><span class="line">  <span class="attr">NOT_LOGIN</span>: <span class="string">&quot;notLogin&quot;</span>,</span><br><span class="line">  <span class="attr">USER</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">  <span class="attr">ADMIN</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="variable constant_">ACCESS_ENUM</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>通用鉴权函数</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="variable constant_">ACCESS_ENUM</span> <span class="keyword">from</span> <span class="string">&quot;@/access/accessEnum&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> accessEnum <span class="keyword">from</span> <span class="string">&quot;@/access/accessEnum&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 简单权限校验的函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">loginUser</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">needAccess</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">checkAccess</span> = (<span class="params">loginUser: <span class="built_in">any</span>, needAccess = accessEnum.NOT_LOGIN</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> userRole = loginUser.<span class="property">userRole</span> ?? <span class="variable constant_">ACCESS_ENUM</span>.<span class="property">NOT_LOGIN</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(userRole);</span><br><span class="line">  <span class="keyword">if</span> (needAccess === accessEnum.<span class="property">NOT_LOGIN</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (needAccess === accessEnum.<span class="property">USER</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (userRole === <span class="variable constant_">ACCESS_ENUM</span>.<span class="property">NOT_LOGIN</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (needAccess === accessEnum.<span class="property">ADMIN</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (userRole !== accessEnum.<span class="property">ADMIN</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> checkAccess;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<ul>
<li>优化可见的路由管理</li>
</ul>
<p><img src="/../../images/image-20230825171619986.png" alt="image-20230825171619986"></p>
<p>但是这样我们在用户登录之后，无法动态的再加载一遍路由。</p>
<p>这里需要用到计算属性computed，computed会监听里面的内容是否发生发生改变就会重新执行一遍函数里的内容。登录之后我们的store里的loginUser会发生改变，所以我们要把会发生改变的东西包到computed里面。修改代码如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> canseeroutes = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> routes.<span class="title function_">filter</span>(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">checkAccess</span>(</span><br><span class="line">      store.<span class="property">state</span>?.<span class="property">userStore</span>.<span class="property">loginUser</span>,</span><br><span class="line">      item.<span class="property">meta</span>?.<span class="property">access</span> <span class="keyword">as</span> <span class="built_in">string</span></span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>store.state?.userStore.loginUser 发生改变之后 canseeroutes就会被重新加载。</p>
<h2 id="后端接口请求生成"><a href="#后端接口请求生成" class="headerlink" title="后端接口请求生成"></a>后端接口请求生成</h2><p>之前用 umi 框架自带的openapi来生成的，但是不够通用，可以用github上的一个OpenAPI 项目来完成这个功能。</p>
<ul>
<li>安装</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install openapi-typescript-codegen --save-dev</span><br></pre></td></tr></table></figure>



<ul>
<li>执行下面的命令就可以生成对应的后端接口的请求：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openapi --input swagger文件的地址或者路径 --output 生成位置 --client axios</span><br></pre></td></tr></table></figure>

<p>执行完上面的请求就可以生成后端的axios请求了。</p>
<p>生成如下：</p>
<p><img src="/../../images/image-20230827153655897.png" alt="image-20230827153655897"></p>
<h2 id="登陆页面"><a href="#登陆页面" class="headerlink" title="登陆页面"></a>登陆页面</h2><p>其实在做登录页面的时候会遇到一个问题，我们前面设置了一个全局的组件，但是我们登录页不希望用到那个页面怎么办。所以这里要支持一个多套布局。</p>
<p> 用route自带的子路由来实现。</p>
<p>新建一个路由，将不需要使用通用布局的都放到子路由里面，指定这个路由组里面需要用到的布局组件。</p>
<p><img src="/../../images/image-20230828161700403.png" alt="image-20230828161700403"></p>
<p>在App.vue里面通过前缀加以区分，router-view会使用默认的组件来渲染</p>
<p><img src="/../../images/image-20230828161838010.png" alt="image-20230828161838010"></p>
<p>然后就正常开发就可以了。</p>
<p>到这里一个项目基本的前端页面，较为通用的部分已经写好了，后续有需要只要在这个基础上增加额外的功能即可。</p>
<h1 id="后端初始化"><a href="#后端初始化" class="headerlink" title="后端初始化"></a>后端初始化</h1><p>这里使用go，还不是很熟悉。</p>
<p>首先前端要用后端的api文档，所以需要用go去整合swagger。</p>
<p>安装swaggo</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> install github.com/swaggo/swag/cmd/swag@latest</span><br></pre></td></tr></table></figure>



<p>在根目录下使用下面命令初始化api接口的文档</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swag init</span><br></pre></td></tr></table></figure>

<p>在根目录下会生成下面这样几个文件</p>
<p><img src="/../../images/image-20230825212947642.png" alt="image-20230825212947642"></p>
<p>代码中使用需要注意几点：</p>
<p>swag init 命令需要在main所在的目录下使用</p>
<p><strong>如果用到了别的包的类型，swag init需要加上以下参数</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swag init --parseDependency --parseInternal</span><br></pre></td></tr></table></figure>



<p>还需要导入一些包：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;github.com/swaggo/gin-swagger&quot;</span> <span class="comment">// gin-swagger middleware</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;github.com/swaggo/files&quot;</span> <span class="comment">// swagger embed files</span></span><br><span class="line"><span class="keyword">import</span> _ <span class="string">&quot;OJ/docs&quot;</span> 	<span class="comment">//刚刚生成的docs文件，这个必须要导入，不然无法请求到api文档！！！！！！！！！！！</span></span><br></pre></td></tr></table></figure>



<ul>
<li>配合gin使用，go中注解要用在注释里面，</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @title swaggo测试</span></span><br><span class="line"><span class="comment">// @version 1.0</span></span><br><span class="line"><span class="comment">// @description swaggo测试API文档</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// @contact.name API Support</span></span><br><span class="line"><span class="comment">// @contact.url http://www.swagger.io/support</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// @license.name Apache 2.0</span></span><br><span class="line"><span class="comment">// @license.url http://www.apache.org/licenses/LICENSE-2.0.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// @host 127.0.0.1:9009</span></span><br><span class="line"><span class="comment">// @BasePath</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    r := gin.Default()</span><br><span class="line"></span><br><span class="line">    r.Use(Cors())</span><br><span class="line">    <span class="comment">//url := ginSwagger.URL(&quot;http://localhost:8080/swagger/doc.json&quot;) // The url pointing to API definition</span></span><br><span class="line">    r.POST(<span class="string">&quot;/test/:id&quot;</span>, controller.Test)</span><br><span class="line">    r.GET(<span class="string">&quot;/swagger/*any&quot;</span>, ginSwagger.WrapHandler(swaggerFiles.Handler))	</span><br><span class="line"></span><br><span class="line">    r.Run(<span class="string">&quot;:9009&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>controller 注释编写</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @Summary 测试接口</span></span><br><span class="line"><span class="comment">// @Description 描述信息</span></span><br><span class="line"><span class="comment">// @Param			id	path		int	true	&quot;Account ID&quot;</span></span><br><span class="line"><span class="comment">// @Success 200 &#123;string&#125; string    &quot;ok&quot;</span></span><br><span class="line"><span class="comment">// @Router /test/&#123;id&#125; [get]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Test</span><span class="params">(ctx *gin.Context)</span></span> &#123;</span><br><span class="line">    ctx.JSON(<span class="number">200</span>, <span class="string">&quot;ok&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>写好后，需要重新执行swag init，将写好的注解内容，写入swagger.json 和 swagger.yaml。</p>
<p>然后就可以运行web服务器，请求<a target="_blank" rel="noopener" href="http://localhost:9009/swagger/index.html#/">http://localhost:9009/swagger/index.html#</a></p>
<p><img src="/../../images/image-20230825213841327.png" alt="image-20230825213841327"></p>
<p>初始化db、redis、log、config读取，之前都配置过了。后端的基本模板的初始化也到这里结束了。</p>
<h1 id="OJ系统数据库表设计"><a href="#OJ系统数据库表设计" class="headerlink" title="OJ系统数据库表设计"></a>OJ系统数据库表设计</h1><h2 id="题目表"><a href="#题目表" class="headerlink" title="题目表"></a>题目表</h2><ul>
<li><p>题目标题</p>
</li>
<li><p>题目内容:存放题目的介绍、输入输出提示、描述、具体的详情</p>
</li>
<li><p>题目标签(json数组字符串):栈、队列、链表、简单、中等、困难题目答案:管理员</p>
</li>
<li><p>用户设置的标准答案</p>
</li>
<li><p>提交数、通过题目的人数等:便于分析统计(可以考虑根据通过率自动给题目打难易度标签)</p>
</li>
<li><p>配置字段：</p>
<ul>
<li>时间限制</li>
<li>内存限制</li>
</ul>
</li>
<li><p>输入输出字段</p>
<ul>
<li>输入</li>
<li>输出</li>
</ul>
</li>
</ul>
<p>配置字段设计为一个JSON格式来存储，有以下好处：</p>
<ul>
<li>增加需求时候，不需要修改数据库，修改数据库算是一个比较重的操作，可能会影响整个项目</li>
<li>容拓展，以json的格式来存储，只需要修改json中的内容就可以很容易的做到增加、减少一个字段</li>
</ul>
<p>输入输出字段设置为一个JSON数组，每一组数据表示一个输入用例和输出用例对应关系。：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        input<span class="punctuation">:</span><span class="string">&quot;12&quot;</span><span class="punctuation">,</span></span><br><span class="line">        output<span class="punctuation">:</span><span class="string">&quot;12&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        input<span class="punctuation">:</span><span class="string">&quot;23&quot;</span></span><br><span class="line">        output<span class="punctuation">:</span><span class="string">&quot;23&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>





<p>一般有以下情况时候就可以考虑将数据存为一个json格式：</p>
<ul>
<li>字段易发生变动</li>
<li>不需要通过json里面的字段来查找</li>
<li>字段含义相关</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 题目表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> question</span><br><span class="line">(</span><br><span class="line">    id          <span class="type">bigint</span> auto_increment comment <span class="string">&#x27;id&#x27;</span> <span class="keyword">primary</span> key,</span><br><span class="line">    title       <span class="type">varchar</span>(<span class="number">512</span>)                       <span class="keyword">null</span> comment <span class="string">&#x27;标题&#x27;</span>,</span><br><span class="line">    content     text                               <span class="keyword">null</span> comment <span class="string">&#x27;内容&#x27;</span>,</span><br><span class="line">    tags        <span class="type">varchar</span>(<span class="number">1024</span>)                      <span class="keyword">null</span> comment <span class="string">&#x27;标签列表（json 数组）&#x27;</span>,</span><br><span class="line">    answer      text                               <span class="keyword">null</span> comment <span class="string">&#x27;题目答案&#x27;</span>,</span><br><span class="line">    submitNum   <span class="type">int</span>      <span class="keyword">default</span> <span class="number">0</span>                 <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;题目提交数&#x27;</span>,</span><br><span class="line">    acceptedNum <span class="type">int</span>      <span class="keyword">default</span> <span class="number">0</span>                 <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;题目通过数&#x27;</span>,</span><br><span class="line">    judgeCase   text                               <span class="keyword">null</span> comment <span class="string">&#x27;判题用例（json 数组）&#x27;</span>,</span><br><span class="line">    judgeConfig text                               <span class="keyword">null</span> comment <span class="string">&#x27;判题配置（json 对象）&#x27;</span>,</span><br><span class="line">    thumbNum    <span class="type">int</span>      <span class="keyword">default</span> <span class="number">0</span>                 <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;点赞数&#x27;</span>,</span><br><span class="line">    favourNum   <span class="type">int</span>      <span class="keyword">default</span> <span class="number">0</span>                 <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;收藏数&#x27;</span>,</span><br><span class="line">    userId      <span class="type">bigint</span>                             <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;创建用户 id&#x27;</span>,</span><br><span class="line">    createTime  datetime <span class="keyword">default</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    updateTime  datetime <span class="keyword">default</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">on</span> <span class="keyword">update</span> <span class="built_in">CURRENT_TIMESTAMP</span> comment <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">    isDelete    tinyint  <span class="keyword">default</span> <span class="number">0</span>                 <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;是否删除&#x27;</span>,</span><br><span class="line">    index idx_userId (userId)</span><br><span class="line">) comment <span class="string">&#x27;题目&#x27;</span> <span class="keyword">collate</span> <span class="operator">=</span> utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure>





<h2 id="题目提交表"><a href="#题目提交表" class="headerlink" title="题目提交表"></a>题目提交表</h2><p>哪个用户提交了哪道题目，存放判题结果等</p>
<ul>
<li>提交用户id: userld</li>
<li>题目id: questionld</li>
<li>语言: language</li>
<li>用户的代码:code</li>
<li>判题状态: status (0–待判题、1–判题中、2–成功、3-失败)</li>
<li>判题信息(判题过程中得到的一些信息，比如程序的失败原因、程序执行消耗的时间、空间):judgeInfo (json对象)</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    message<span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;memory&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>





<p>判题信息枚举值:</p>
<ul>
<li>Accepted成功</li>
<li>Wrong Answer答案错误. Compile Error编译错误</li>
<li>Memory Limit Exceeded 内存溢出.Time Limit Exceeded超时</li>
<li>Presentation Error展示错误.Output Limit Exceeded输出溢出. Waiting 等待中</li>
<li>Dangerous Operation危险操作</li>
<li>Runtime Error运行错误（用户程序的问题). System Error系统错误（做系统人的问题)</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 题目提交表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> question_submit</span><br><span class="line">(</span><br><span class="line">    id         <span class="type">bigint</span> auto_increment comment <span class="string">&#x27;id&#x27;</span> <span class="keyword">primary</span> key,</span><br><span class="line">    <span class="keyword">language</span>   <span class="type">varchar</span>(<span class="number">128</span>)                       <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;编程语言&#x27;</span>,</span><br><span class="line">    code       text                               <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;用户代码&#x27;</span>,</span><br><span class="line">    judgeInfo  text                               <span class="keyword">null</span> comment <span class="string">&#x27;判题信息（json 对象）&#x27;</span>,</span><br><span class="line">    status     <span class="type">int</span>      <span class="keyword">default</span> <span class="number">0</span>                 <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;判题状态（0 - 待判题、1 - 判题中、2 - 成功、3 - 失败）&#x27;</span>,</span><br><span class="line">    questionId <span class="type">bigint</span>                             <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;题目 id&#x27;</span>,</span><br><span class="line">    userId     <span class="type">bigint</span>                             <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;创建用户 id&#x27;</span>,</span><br><span class="line">    createTime datetime <span class="keyword">default</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    updateTime datetime <span class="keyword">default</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">on</span> <span class="keyword">update</span> <span class="built_in">CURRENT_TIMESTAMP</span> comment <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">    isDelete   tinyint  <span class="keyword">default</span> <span class="number">0</span>                 <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;是否删除&#x27;</span>,</span><br><span class="line">    index idx_questionId (questionId),</span><br><span class="line">    index idx_userId (userId)</span><br><span class="line">) comment <span class="string">&#x27;题目提交&#x27;</span>;</span><br></pre></td></tr></table></figure>





<h1 id="后端完成简单curd"><a href="#后端完成简单curd" class="headerlink" title="后端完成简单curd"></a>后端完成简单curd</h1><p>pass</p>
<h1 id="前端部分"><a href="#前端部分" class="headerlink" title="前端部分"></a>前端部分</h1><p>这里我们需要给管理员提供编写 问题的页面，编写问题需要提供一个富文本编辑器，并且还要有一个在线代码编辑器。这些都是第三方的组件，和后端一样，在开发前先引入会比较方便后续继续实现。 这样可以先确定找的第三方依赖是可以和我们的项目整合的。</p>
<h2 id="markdown富文本编辑器"><a href="#markdown富文本编辑器" class="headerlink" title="markdown富文本编辑器"></a>markdown富文本编辑器</h2><p>字节的一个开源的在线编辑器：<a target="_blank" rel="noopener" href="https://github.com/bytedance/bytemd">bytedance&#x2F;bytemd: Hackable Markdown Editor and Viewer (github.com)</a></p>
<ul>
<li>安装</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @bytemd/vue-next</span><br></pre></td></tr></table></figure>





<ul>
<li>导入</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &#x27;bytemd/dist/index.css&#x27;</span><br></pre></td></tr></table></figure>



<ul>
<li>样例代码</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;Editor :value=&quot;value&quot; :plugins=&quot;plugins&quot; @change=&quot;handleChange&quot; /&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import gfm from &quot;@bytemd/plugin-gfm&quot;;	//这个是一个支持的插件，出了这个之外这个md编辑器还支持其他很多插件。</span><br><span class="line">import &#123; Editor, Viewer &#125; from &quot;@bytemd/vue&quot;;</span><br><span class="line"></span><br><span class="line">const plugins = [	// 引入插件后，把要执行的插件放到一个数组里，调用初始化						插件就可以生效了</span><br><span class="line">  gfm(),</span><br><span class="line">  // Add more plugins here</span><br><span class="line">];</span><br><span class="line">//下面是 vue的基本上可以删了</span><br><span class="line">export default &#123;</span><br><span class="line">  components: &#123; Editor &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123; value: &quot;&quot;, plugins &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    handleChange(v) &#123;</span><br><span class="line">      this.value = v;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>支持的插件，有支持表情、数学符号、代码高亮等，这些也是需要安装的</li>
</ul>
<p><img src="/../../images/image-20230904143257997.png" alt="image-20230904143257997"></p>
<ul>
<li>修改样例代码</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;Editor :value=&quot;value&quot; :plugins=&quot;plugins&quot; @change=&quot;handleChange&quot; /&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import gfm from &quot;@bytemd/plugin-gfm&quot;;</span><br><span class="line">import highlight from &quot;@bytemd/plugin-highlight&quot;;	//高亮组件</span><br><span class="line">import &#123; Editor, Viewer &#125; from &quot;@bytemd/vue-next&quot;;</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;;</span><br><span class="line"></span><br><span class="line">const plugins = [</span><br><span class="line">  gfm(),</span><br><span class="line">  highlight(),</span><br><span class="line">  // Add more plugins here</span><br><span class="line">];</span><br><span class="line">const value = ref(&quot;&quot;);</span><br><span class="line">const handleChange = (v: string) =&gt; &#123;	//发生修改的钩子函数</span><br><span class="line">  value.value = v;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>





<p>随便找个页面，引入我们这个组件。</p>
<p><img src="/../../images/image-20230904144522553.png" alt="image-20230904144522553"></p>
<p>我们创建了一个组件之后，我们希望引入这个组件的父组件，可以获取到编辑器里面的内容，这样后面我们才能够提交什么的，而不是交给这个富文本编辑器的组件来完成提交。要怎么实现？</p>
<p>可以把这个组件的属性操作交给父组件控制，父组件定义:</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> value = <span class="title function_">ref</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleChange</span> = (<span class="params">v: <span class="built_in">string</span></span>) =&gt; &#123;	<span class="comment">//发生修改的钩子函数</span></span><br><span class="line">  value.<span class="property">value</span> = v;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>子组件接收并且调用父组件的传过来的函数就可以了。</p>
<ul>
<li>子组件，定义通用的接口，去接受父组件传来的值</li>
</ul>
<p><img src="/../../images/image-20230904150223821.png" alt="image-20230904150223821"></p>
<ul>
<li>父组件定义并且传递给子组件</li>
</ul>
<p><img src="/../../images/image-20230904150449266.png" alt="image-20230904150449266"></p>
<h2 id="代码编辑器"><a href="#代码编辑器" class="headerlink" title="代码编辑器"></a>代码编辑器</h2><p>微软官方的一个代码编辑器：<a target="_blank" rel="noopener" href="https://github.com/microsoft/monaco-editor">microsoft&#x2F;monaco-editor: A browser based code editor (github.com)</a></p>
<ul>
<li>安装</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install monaco-editor</span><br></pre></td></tr></table></figure>



<p>这个项目前端用的是webpack打包工具，刚好适配它的要求。</p>
<p>这里还需要安装一个它的插件，这个插件的作用就是，将webpack和这个组件进行整合</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install monaco-editor-webpack-plugin</span><br></pre></td></tr></table></figure>



<p>然后要让项目能够使用 这个组件，还需要进行一些配置，这里基本上就是百度就好了。vue-cli整合 monacoeditor。</p>
<p>我们使用的脚手架的配置文件在 vue.config.js中，我们也要在这里进行配置这个组件的使用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; defineConfig &#125; = <span class="built_in">require</span>(<span class="string">&quot;@vue/cli-service&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MonacoWebPackPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;monaco-editor-webpack-plugin&quot;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">transpileDependencies</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="title function_">chainWebpack</span>(<span class="params">config</span>) &#123;</span><br><span class="line">  	config.<span class="title function_">plugin</span>(<span class="string">&quot;monaco&quot;</span>).<span class="title function_">use</span>(<span class="keyword">new</span> <span class="title class_">MonacoWebPackPlugin</span>());</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>示例教程：<a target="_blank" rel="noopener" href="https://microsoft.github.io/monaco-editor/playground.html?source=v0.40.0#example-creating-the-editor-hello-world">Monaco Editor (microsoft.github.io)</a></p>
<ul>
<li>新建组件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=&quot;code-idetor&quot; ref=&quot;codeEditorRef&quot; style=&quot;min-height: 400px&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import * as monaco from &quot;monaco-editor&quot;;</span><br><span class="line">import &#123; onMounted, ref &#125; from &quot;vue&quot;;</span><br><span class="line"></span><br><span class="line">const codeEditorRef = ref();</span><br><span class="line">const value = ref(&quot;&quot;);</span><br><span class="line">onMounted(() =&gt; &#123;</span><br><span class="line">  //创建编辑器对象，需要挂载到到一个元素上，所以我们还要取创建这个元素</span><br><span class="line">  const myEditor = monaco.editor.create(codeEditorRef.value, &#123;</span><br><span class="line">    value: value.value,		//这里还有很多配置</span><br><span class="line">    language: &quot;java&quot;,</span><br><span class="line">    minimap: &#123;</span><br><span class="line">      enabled: true,</span><br><span class="line">    &#125;,</span><br><span class="line">    theme: &quot;vs-dark&quot;,</span><br><span class="line">    automaticLayout: true,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>





<p>放到一个页面里测试</p>
<p><img src="/../../images/image-20230904153814543.png" alt="image-20230904153814543"></p>
<p>同样，还需要监听代码编辑器里面的内容发生变化</p>
<p>我们创建的monaco实例直接提供了一个函数可以监听内容的变化：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">myEditor.<span class="title function_">onDidChangeModelContent</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;目前内容为：&quot;</span>, myEditor.<span class="title function_">getValue</span>());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>





<p>还需要和markdown编辑器一样实现父级组件控制文本的内容，方便后面提交表单，做法也是一样，由父组件去传递值和函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=&quot;code-idetor&quot; ref=&quot;codeEditorRef&quot; style=&quot;min-height: 400px&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import * as monaco from &quot;monaco-editor&quot;;</span><br><span class="line">import &#123; onMounted, ref &#125; from &quot;vue&quot;;</span><br><span class="line">import &#123; defineProps, withDefaults &#125; from &quot;vue/dist/vue&quot;;</span><br><span class="line"></span><br><span class="line">const codeEditorRef = ref();</span><br><span class="line">const value = ref(&quot;&quot;);</span><br><span class="line"></span><br><span class="line">interface Props &#123;</span><br><span class="line">  value: string;</span><br><span class="line">  handleChange: (v: string) =&gt; void;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const props = withDefaults(defineProps&lt;Props&gt;(), &#123;</span><br><span class="line">  value: () =&gt; &quot;&quot;,</span><br><span class="line">  handleChange: (v: string) =&gt; &#123;</span><br><span class="line">    console.log(v);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">onMounted(() =&gt; &#123;</span><br><span class="line">  //创建编辑器对象，需要挂载到到一个元素上，所以我们还要取创建这个元素</span><br><span class="line">  const myEditor = monaco.editor.create(codeEditorRef.value, &#123;</span><br><span class="line">    value: props.value,</span><br><span class="line">    language: &quot;java&quot;,</span><br><span class="line">    minimap: &#123;</span><br><span class="line">      enabled: true,</span><br><span class="line">    &#125;,</span><br><span class="line">    colorDecorators: true,</span><br><span class="line">    theme: &quot;vs-dark&quot;,</span><br><span class="line">    automaticLayout: true,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  myEditor.onDidChangeModelContent(() =&gt; &#123;</span><br><span class="line">    console.log(&quot;目前内容为：&quot;, myEditor.getValue());</span><br><span class="line">    props.handleChange(myEditor.getValue());</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>







<h1 id="判题系统和代码沙箱"><a href="#判题系统和代码沙箱" class="headerlink" title="判题系统和代码沙箱"></a>判题系统和代码沙箱</h1><h2 id="关系"><a href="#关系" class="headerlink" title="关系"></a>关系</h2><p>判题模块只是负责判断用户提交的代码是否有恶意行为，如果没有才会把代码交给代码沙箱执行，代码沙箱执行完成之后会把执行结果返回给判题模块，判题模块再对比执行结果和预期结果是否相同。</p>
<p>这里主要做后面一部分，判断用户结果是否正确。</p>
<p><img src="/../../images/image-20230908171655273.png" alt="image-20230908171655273"></p>
<p>这里要传的是多组的 用例输入得到多组的用例输出。因为这样可以节省很多开销。</p>
<p>首先如果是一组用例调用一次，网络请求次数就多了，速度自然就慢。</p>
<p>其次每次调用都要在沙箱编译代码，编译又很费时，所以一次传一组会很慢。</p>
<p>这是一种很常见的性能优化：降低请求次数	</p>
<h2 id="代码沙箱"><a href="#代码沙箱" class="headerlink" title="代码沙箱"></a>代码沙箱</h2><p>这个也是一个单独的服务模块，这里会用到几种设计模式。 代码沙箱主要的功能就是要执行代码，基于这个要求可以实现多种的代码沙箱。 为了方便拓展，把代码沙箱的功能定义成一个接口，有不同的实现就实现这个接口就可以了。</p>
<p>接收的参数，所有代码沙箱无非接收的都是这几个参数：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">ExecuteCodeRequest</span>&#123;</span><br><span class="line">  <span class="keyword">repeated</span> <span class="type">string</span> inputs = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> code = <span class="number">2</span>;</span><br><span class="line">  <span class="type">string</span> language = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>基本接口及参数：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">ExecuteCodeRequest</span>&#123;</span><br><span class="line">  <span class="keyword">repeated</span> <span class="type">string</span> inputs = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> code = <span class="number">2</span>;</span><br><span class="line">  <span class="type">string</span> language = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">JudgeInfo</span>&#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">  <span class="type">int64</span> memory = <span class="number">2</span>;</span><br><span class="line">  <span class="type">int64</span> time = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">message </span><span class="title class_">ExecuteCodeResponse</span>&#123;</span><br><span class="line">  <span class="keyword">repeated</span> <span class="type">string</span> outputs = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">2</span>;</span><br><span class="line">  JudgeInfo judgeInfo = <span class="number">3</span>;</span><br><span class="line">  <span class="type">string</span> status = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">CodeSandService</span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> executeCode(ExecuteCodeRequest) <span class="keyword">returns</span> (ExecuteCodeResponse)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>三种实现方式：</p>
<ul>
<li>测试使用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CodeSandService <span class="keyword">struct</span> &#123;</span><br><span class="line">    pb.UnimplementedCodeSandServiceServer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(CodeSandService)</span></span> ExecuteCode(ctx context.Context, request *pb.ExecuteCodeRequest) (*pb.ExecuteCodeResponse, <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, status.Errorf(codes.Unimplemented, <span class="string">&quot;method ExecuteCode not implemented&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>远程服务调用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RemoteCodeSandService <span class="keyword">struct</span> &#123;</span><br><span class="line">    pb.UnimplementedCodeSandServiceServer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(RemoteCodeSandService)</span></span> ExecuteCode(ctx context.Context, request *pb.ExecuteCodeRequest) (*pb.ExecuteCodeResponse, <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, status.Errorf(codes.Unimplemented, <span class="string">&quot;method ExecuteCode not implemented&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>第三方接口</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ThirdPartCodeSandService <span class="keyword">struct</span> &#123;</span><br><span class="line">    pb.UnimplementedCodeSandServiceServer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ThirdPartCodeSandService)</span></span> ExecuteCode(ctx context.Context, request *pb.ExecuteCodeRequest) (*pb.ExecuteCodeResponse, <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, status.Errorf(codes.Unimplemented, <span class="string">&quot;method ExecuteCode not implemented&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>我们创建服务的时候需要手动去切换，创建的实现类对象。这样的方式不是很灵活。</li>
</ul>
<p><img src="/../../images/image-20230911191533591.png" alt="image-20230911191533591"></p>
<p>优化方式其实也很简单，直接使用一个工厂模式就可以解决，使用的时候只需要在配置文件中修改需要使用的沙箱方式就可以了。</p>
<p>写一个工厂提供实现类</p>
<p><img src="/../../images/image-20230911200909555.png" alt="image-20230911200909555"></p>
<p>main函数在配置文件中获取要使用的实现类</p>
<p><img src="/../../images/image-20230911200938272.png" alt="image-20230911200938272"></p>
<p>配置文件</p>
<p><img src="/../../images/image-20230911200952677.png" alt="image-20230911200952677"></p>
<p>如果我们要在沙箱执行前后打上一些日志，我们应该在每个实现类上都加上log.Print吗？</p>
<p>肯定不用这么麻烦，这种需求首先就会想到AOP，但是又没有那么复杂，而AOP本身就是通过代理来实现的。所以要实现这种需求也可以用代理模式来实现，这里就是简单的使用静态代理来实现。</p>
<p>既然要代理这个接口，那这个接口本身基本的功能就必须有，所以代理类也需要实现接口，并且要能够调用具体的方法，当然还需要有一个接口作为成员变量来调用接口。</p>
<p>基本的架构如下：</p>
<p><img src="/../../images/image-20230911203513968.png" alt="image-20230911203513968"></p>
<p>注入一个接口类型，在重写的方法中调用注入对象的方法，这样就能够很容易的做到在调用前后执行一些增强操作了</p>
<p>mian函数</p>
<p><img src="/../../images/image-20230912205859984.png" alt="image-20230912205859984"></p>
<p>配置文件指定好类型之后，将代理类中代理的实现类注册到代理类，并且将代理类注册到consul。</p>
<p>这样别的服务调用的时候调用的就是代理类了。</p>
<h2 id="判题模块"><a href="#判题模块" class="headerlink" title="判题模块"></a>判题模块</h2><p>对于判题模块，实际上只要提供一个接口就可以了，功能就是调用沙箱，判断结果是否正确。</p>
<p><img src="/../../images/image-20230911211649587.png" alt="image-20230911211649587"></p>
<p>粗略实现：</p>
<ul>
<li>id查提交记录</li>
<li>id查题目</li>
<li>判断提交记录状态防止重复提交</li>
<li>跟新题目状态为执行中</li>
<li>调用沙箱服务判题</li>
<li>对比判题结果</li>
<li>对比判题信息，超时和超内存</li>
</ul>
<p>但是其实并不是所有题目都是这样判断的，并且还有可能根据用户使用的语言不同判题信息也可能有区别。</p>
<p>如果在一个函数中把所有情况考虑进去会充斥着大量的 if….else。久而久之，这样代码就会变得难以维护。</p>
<p>所以这里可以使用另一种设计模式，策略模式。</p>
<p>先定义一个接口，包含一个函数，不同的策略实现这个接口就可以了。</p>
<ul>
<li>策略接口</li>
</ul>
<p><img src="/../../images/image-20230912230355893.png" alt="image-20230912230355893"></p>
<p>有不同的策略就实现这个接口，就可以了。但是一般策略模式会配合类似工厂模型的来用，不然在代码中，一直要写if 判断不同的情况创建不同的对象。</p>
<p>我们定义一个manager对接口进行封装</p>
<p><img src="/../../images/image-20230912230409821.png" alt="image-20230912230409821"></p>
<p>这里判断要使用那种判题策略。</p>
<p>在判题服务中就可以直接使用</p>
<p><img src="/../../images/image-20230912230838050.png" alt="image-20230912230838050"></p>
<h2 id="代码沙箱实现"><a href="#代码沙箱实现" class="headerlink" title="代码沙箱实现"></a>代码沙箱实现</h2><p>先以Java为例。</p>
<p>用户肯定会传递给我们代码，所以我们要执行用户的代码自然要先将这个代码存为文件。</p>
<p>有了文件之后，我们先把我们的环境想象成记事本，而不是idea。我们要执行一个记事本中的代码，是不是要用 javac命令去编译，然后再用 java命令去执行。</p>
<p>那对于Java程序来说，程序有要求，所有方法都要在类里面，为了防止用户乱输入类，我们应该规定用户需要使用固定的类名，这里就和洛谷 一样使用 Main。</p>
<p>下面是一个简单的Java编译的例子：</p>
<ul>
<li>Main，这里不能有包名</li>
</ul>
<p><img src="/../../images/image-20230913222859740.png" alt="image-20230913222859740"></p>
<p>如果有包名会出现下面这样的错误：</p>
<p><img src="/../../images/image-20230913222931990.png" alt="image-20230913222931990"></p>
<ul>
<li>javac编译，java执行</li>
</ul>
<p><img src="/../../images/image-20230913222954891.png" alt="image-20230913222954891"></p>
<p>发现乱码了，这是因为，编译器默认使用的编码格式是utf-8，控制台默认使用的是gbc。</p>
<p>最简单的办法修改命令行的编码格式，使用以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chcp 65001</span><br></pre></td></tr></table></figure>

<p>但是这样做的缺点就在于兼容性很差，只是在自己的环境修改了，换一个环境就没用了。</p>
<p>推荐使用jvm编码参数设置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -encoding utf-8 .\Main.java</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230913223655731.png" alt="image-20230913223655731"></p>
<p>了解了上面的内容，我们现在要做的就是以下几个步骤：</p>
<p>1、要将用户输入的代码保存到一个文件中，</p>
<p>2、然后编译这个代码得到编译后的文件，</p>
<p>3、执行代码，得到输出</p>
<h3 id="将用户输入保存到文件"><a href="#将用户输入保存到文件" class="headerlink" title="将用户输入保存到文件"></a>将用户输入保存到文件</h3><p>其实这一步就是直接将用户的code读取出来，然后写入到一个文件中就可以了。</p>
<ul>
<li>写入文件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaCodeSandBoxImpl</span> <span class="keyword">implements</span> <span class="title class_">CodeSandbox</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">GLOBAL_PATH_NAME</span> <span class="operator">=</span> <span class="string">&quot;temCode&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PROGRAM_SUBFIX</span> <span class="operator">=</span> <span class="string">&quot;Main.java&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ExecuteCodeResponse <span class="title function_">executeCode</span><span class="params">(ExecuteCodeRequest executeCodeRequest)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> executeCodeRequest.getCode();</span><br><span class="line">        <span class="type">String</span> <span class="variable">language</span> <span class="operator">=</span> executeCodeRequest.getLanguage();</span><br><span class="line">        List&lt;String&gt; inputList = executeCodeRequest.getInputList();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取用户当前工作路径，user.dir是固定写法，源码可以看到</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userDir</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;user.dir&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取用户存放代码文件的目录</span></span><br><span class="line">        <span class="comment">// File.separator 就是获取当前系统的分隔符，unix下为 &#x27;\&#x27;，windows下为 &#x27;\\&#x27;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">parentPath</span> <span class="operator">=</span> userDir+ File.separator+GLOBAL_PATH_NAME;</span><br><span class="line">        <span class="keyword">if</span>(!FileUtil.exist(parentPath))&#123;</span><br><span class="line">            <span class="comment">//系统第一次使用要创建这个目录</span></span><br><span class="line">            FileUtil.mkdir(parentPath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用户的代码都是class Main，所以不可能将所有用户的代码都存放到同一个目录下</span></span><br><span class="line">        <span class="comment">// 所以要分级，这里用uuid存放不同用户的代码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userCodePath</span> <span class="operator">=</span> parentPath + File.separator + UUID.randomUUID()+ File.separator;</span><br><span class="line">        FileUtil.writeString(code,userCodePath+PROGRAM_SUBFIX, StandardCharsets.UTF_8);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>写一个类测试一下，可以看到生成了指定的目录</p>
<p><img src="/../../images/image-20230913233303544.png" alt="image-20230913233303544"></p>
<h3 id="编译代码"><a href="#编译代码" class="headerlink" title="编译代码"></a>编译代码</h3><p>上面完成了将用户代码保存到我们指定的路径，有了文件我们就可以编译这个文件得到可运行的文件了。</p>
<p>但是我们总不可能一个个去手动输入javac   java命令，这里要借助到java中的一个类：Runtime.getRuntime().exec()，这个函数得到一个进程管理类Process</p>
<p>这个类就可以帮我们执行命令行参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造用户命令</span></span><br><span class="line"><span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> String.format(<span class="string">&quot;javac -encoding utf-8 %s&quot;</span>,userCodePath);</span><br><span class="line"></span><br><span class="line"><span class="comment">//执行命令</span></span><br><span class="line"><span class="type">Process</span> <span class="variable">compileProcess</span> <span class="operator">=</span> Runtime.getRuntime().exec(command);</span><br><span class="line"><span class="comment">//等待上面的命令执行，得到一个错误码，用于判断命令是否执行正确</span></span><br><span class="line"><span class="type">int</span> <span class="variable">errValue</span> <span class="operator">=</span> compileProcess.waitFor();</span><br></pre></td></tr></table></figure>



<p>执行了命令执行成功或者失败都应该给用户返回提示，所以还需要从命令行中读取出，命令执行后的输出。 直接用上面的那个进程对象来获取就行了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (errValue==<span class="number">0</span>)&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;编译成功&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取命令执行后的控制台输出</span></span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(compileProcess.getInputStream()));</span><br><span class="line">    String line;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="keyword">while</span>((line = bufferedReader.readLine())!=<span class="literal">null</span>)&#123;</span><br><span class="line">        System.out.println(line);</span><br><span class="line">        stringBuilder.append(line);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;编译失败，错误码：&quot;</span>+errValue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取命令执行后的控制台输出</span></span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(compileProcess.getInputStream()));</span><br><span class="line">    String line;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="keyword">while</span>((line = bufferedReader.readLine())!=<span class="literal">null</span>)&#123;</span><br><span class="line">        System.out.println(line);</span><br><span class="line">        stringBuilder.append(line);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">errStringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="comment">// 获取错误的控制台输出</span></span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">errBufferedReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(compileProcess.getErrorStream()));</span><br><span class="line">    String errline;</span><br><span class="line">    <span class="keyword">while</span>((errline = errBufferedReader.readLine())!=<span class="literal">null</span>)&#123;</span><br><span class="line">        System.out.println(errline);</span><br><span class="line">        errStringBuilder.append(errline);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<ul>
<li>测试一下</li>
</ul>
<p><img src="/../../images/image-20230914155705435.png" alt="image-20230914155705435"></p>
<h3 id="执行代码"><a href="#执行代码" class="headerlink" title="执行代码"></a>执行代码</h3><p>同样还是用命令行来执行</p>
<p>上面那个代码其实每个要用终端执行的地方都要使用，所以可以抽做一个工具类 。一大段都可以放进去，调用的时候每次穿Process对象和操作类型就好了。</p>
<p><img src="/../../images/image-20230914161623007.png" alt="image-20230914161623007"></p>
<ul>
<li>测试执行</li>
</ul>
<p><img src="/../../images/image-20230914162429794.png" alt="image-20230914162429794"></p>
<p>执行又乱码了 ，修改执行命令为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dfile.encoding=UTF-8 -cp %s Main %s</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/image-20230914162556177.png" alt="image-20230914162556177"></p>
<h3 id="整理执行结果并返回"><a href="#整理执行结果并返回" class="headerlink" title="整理执行结果并返回"></a>整理执行结果并返回</h3><p>拿到执行的输出，然后判断每个结果是否有错误信息。</p>
<p><img src="/../../images/image-20230914165006918.png" alt="image-20230914165006918"></p>
<p>在构造judgeInfo的时候，发现还有程序执行时间和内存使用情况没有，所以还要去计算这两个东西，统一都放到工具类里面去计算，并且把使用情况放到工具类的返回值中。</p>
<p><img src="/../../images/image-20230914165610124.png" alt="image-20230914165610124"></p>
<p>取最大值放到返回结果中。</p>
<h3 id="文件清理异常处理"><a href="#文件清理异常处理" class="headerlink" title="文件清理异常处理"></a>文件清理异常处理</h3><p>除了上面这些操作以外，我们对于已经执行完了的代码，可以直接删掉，省的占用空间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(file.getParentFile()!=<span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">del</span> <span class="operator">=</span> FileUtil.del(file.getAbsolutePath());</span><br><span class="line">    System.out.println(<span class="string">&quot;删除&quot;</span>+ (del? <span class="string">&quot;成功&quot;</span>:<span class="string">&quot;失败&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>抛出异常的地方调用自定义的异常处理函数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ExecuteCodeResponse <span class="title function_">errProcess</span><span class="params">(Throwable e)</span>&#123;</span><br><span class="line">    <span class="type">ExecuteCodeResponse</span> <span class="variable">executeCodeResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExecuteCodeResponse</span>();</span><br><span class="line">    executeCodeResponse.setOutputList(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">    executeCodeResponse.setMessage(e.getMessage());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务器错误</span></span><br><span class="line">    executeCodeResponse.setStatus(<span class="number">2</span>);</span><br><span class="line">    executeCodeResponse.setJudgeInfo(<span class="keyword">new</span> <span class="title class_">JudgeInfo</span>());</span><br><span class="line">    <span class="keyword">return</span> executeCodeResponse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>至此简单的一个代码沙箱已经实现好了。但是是否存在安全问题？</p>
<h2 id="异常情况"><a href="#异常情况" class="headerlink" title="异常情况"></a>异常情况</h2><ul>
<li>死循环代码\无限睡眠代码</li>
</ul>
<p>如果用户提交的代码中有死循环，我们的沙箱将一直卡运行占用内存不会结束。</p>
<ul>
<li>无限创建对象，爆内存</li>
</ul>
<p>会导致沙箱服务器宕机</p>
<ul>
<li>读文件</li>
</ul>
<p>用户提交代码中，存在用相对路径读取沙箱项目的配置文件或者是源码等一些隐私数据。比如说读取到了数据库内容，导致信息泄露。</p>
<ul>
<li>写文件，将一些越权命令或木马或者病毒写入文件在执行</li>
</ul>
<p>用户提交代码可能有rm -rf &#x2F;这样的命令直接系统就奔溃了。写入运行木马就更不用说了更是一个危险操作。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>上面列举了这么多危险情况，如何解决？</p>
<ul>
<li>超时</li>
</ul>
<p>这个其实很简单，直接开一个子线程，设置一个超时时间超时就杀死对应的进程。</p>
<p><img src="/../../images/image-20230914173349347.png" alt="image-20230914173349347"></p>
<p>让超时线程sleep 超时时间之后，销毁Process线程。</p>
<ul>
<li>超内存</li>
</ul>
<p>在启动java程序的时候，限制程序最大使用的内存，有一个JVM参数可以设置</p>
<p>-Xmx256m 限制最大只能使用256M</p>
<p>还有一个 -Xms256m 这个是初始大小，这个可以初始分配一些空间，启动程序的时候有些启动加载不需要动态分配了</p>
<p>指定之后我们执行命令就变成了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xmx256m -Dfile.encoding=UTF-8 -cp %s Main %s</span><br></pre></td></tr></table></figure>





<p><img src="/../../images/image-20230914173946156.png" alt="image-20230914173946156"> </p>
<p>这里需要注意一点这个 JVM参数不等同于系统实际占用的最大资源，可能会超出。因为 JVM 本身是程序的一部分，所以可能会超出一点。</p>
<p>如果要更严格的规定，需要在系统层面进行设置，在linux上可以用  cgroup命令来限制某个进程的资源分配。</p>
<ul>
<li>读写代码</li>
</ul>
<p>可以定一个黑白名单，对用户的代码进行字符串匹配。字符串匹配的方式就有很多了，反正总体就是这样的一个思路。比如说 hutool的wordTree</p>
<p><img src="/../../images/image-20230914174903838.png" alt="image-20230914174903838"></p>
<ul>
<li>限制用户权限</li>
</ul>
<p>这种方法其实是弥补黑白名单方式的不足。</p>
<p>黑白名单的问题：</p>
<p>1、我们无法遍历所有的黑白名单</p>
<p>2、对于不同的变成语言，一些关键词又不一样</p>
<p>这里要使用到一个新的内容：Java Security Manager   Java安全管理器。这是Java提供的可以用来保护Jvm的机制。</p>
<p>但其实这里用起来还是有点麻烦的，因为要有些权限也要一个个用白名单的形式去判断。并且它粒度太细了，难以精细化的定制</p>
<ul>
<li>使用方式：</li>
</ul>
<p><img src="/../../images/image-20230918150353528.png" alt="image-20230918150353528"></p>
<p>编写一个类去继承 SecurtiyManager这个类，然后去实现里面的方法，这里是表示使用SecurityManager本身的权限校验机制。</p>
<ul>
<li>还可以指定某且特点的功能的权限，如是否允许读写文件、使用网络、删除操作等</li>
</ul>
<p><img src="/../../images/image-20230918150605017.png" alt="image-20230918150605017"></p>
<p>同样都是去重写这些方法就行了，但是可能会比较麻烦，要一点点去判断有没有权限。</p>
<ul>
<li><p>调用方法</p>
<ul>
<li><p>如果我们要在自己的代码里面检查这个权限，就只要在需要的地方将实现的SecurityManager 设置到系统中就可以了。</p>
<p><img src="/../../images/image-20230918150822674.png" alt="image-20230918150822674"></p>
</li>
<li><p>如果是要指定运行的子程序，就要在执行命令中指定securitymanger的路径和名字，一般我们会把实现的securtiymanager放在resources目录下，并且编译好</p>
<p><img src="/../../images/image-20230918151508007.png" alt="image-20230918151508007"></p>
</li>
</ul>
</li>
</ul>
<p>​		</p>
<p>​		<strong>SECURTIY_MANANGE_PATH</strong> 和 <em><strong>SECURTIY_MANAGE_NAME</strong></em> 分别就是实现的securitymanager对应的路径和编译后的执行文件名。</p>
<h2 id="环境隔离技术"><a href="#环境隔离技术" class="headerlink" title="环境隔离技术"></a>环境隔离技术</h2><p>上面我们使用原生的方式实现了一个简单的代码沙箱，但是有些问题不太好解决。而且上面那些异常情况理论上都可以使用环境隔离的方式来完成。 </p>
<p>Dokcer容器技术就能够实现环境隔离，所以我们也要使用docker来完成代码沙箱的构建。</p>
<ul>
<li>为什么要使用Docker？</li>
</ul>
<p>我们上面的代码层面的对于异常情况的控制是不够安全的，所运行的用户程序是依赖在宿主机上的，所以一但权重控制的不够完善，就可能会导致一些比较大的问题。</p>
<p>而使用docker容器技术可以做到，将执行用户的程序可以和我们的宿主机或者服务器进行隔离，提升系统的安全性。</p>
<h3 id="Docker基本概念"><a href="#Docker基本概念" class="headerlink" title="Docker基本概念"></a>Docker基本概念</h3><p>镜像：可以理解为一个简易的操作系统，里面包含了要用到的环境</p>
<p>容器：通过镜像来创建的一套运行环境，一个容器里面可以跑多个程序，可以理解为安装了操作系统的电脑，一个电脑上又可以又多个操作系统</p>
<p>Dockerfile：用来制作镜像的文件，里面定义了要用的环境、依赖程序等</p>
<p>下面是docker底层的一些实现：</p>
<p><img src="/../../images/image-20230918155642322.png" alt="image-20230918155642322"></p>
<p>首先它是基于Linux内核的</p>
<p>CGroups：实现的资源的隔离，是基于Linux的Cgroupt指令实现的。能够限制某个进程可以分配到的资源</p>
<p>NetWrok：可以实现隔离</p>
<p>NameSpaces：可以将运行的进程隔离在不同的命名空间下，每个容器可以有自己的命名空间，每个命名空间下的进程互不影响</p>
<p>Storage：容器之间的文件是相互隔离的，可以使用宿主机的文件</p>
<h3 id="Java操作Dokcer"><a href="#Java操作Dokcer" class="headerlink" title="Java操作Dokcer"></a>Java操作Dokcer</h3><p>一般来说，是不需要使用语言去操作dokcer的，使用基本的命令行就够了，但是我们这个项目需要。</p>
<p>需要引入一下依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.docker-java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.docker-java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-java-transport-httpclient5<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>官网有些概念如下：</p>
<p>DockerClientConfig:用于定义初始化 DockerClient的配置（类比 MySQL的连接、线程数配置)</p>
<p>DockerHttpClient:用于向Docker守护进程(操作Docker的接口）发送请求的客户端，低层封装（不推荐使用)，你要自己构建请求参数(简单地理解成JDBC)</p>
<p>DockerClient(推荐)︰才是真正和Docker守护进程交互的、最方便的SDK，高层封装，对DockerHttpClient再进行了一层封装（理解成 MyBatis)，提供了现成的增删改查</p>
<h3 id="Dokcer踩坑"><a href="#Dokcer踩坑" class="headerlink" title="Dokcer踩坑"></a>Dokcer踩坑</h3><p>用的是腾讯云服务器，开放好了一些端口，并且对于docker来说，需要开放默认的2375端口。</p>
<p>在云服务器上打开2375端口，在宝塔面板上也打开了2375端口。</p>
<p><img src="/../../images/image-20230919220437706.png" alt="image-20230919220437706"></p>
<p>看到这个未使用就感觉到事情不太对劲。</p>
<p>现使用java 编写简单的 ping通服务器上docker的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoDocker</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">DockerClient</span> <span class="variable">dockerClient</span> <span class="operator">=</span> DockerClientBuilder.getInstance(<span class="string">&quot;tcp://124.220.41.55:2375&quot;</span>).build();</span><br><span class="line">        <span class="type">PingCmd</span> <span class="variable">pingCmd</span> <span class="operator">=</span> dockerClient.pingCmd();</span><br><span class="line">        pingCmd.exec();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>果然出现了 拒绝连接的错误</p>
<p><img src="/../../images/image-20230919220719106.png" alt="image-20230919220719106"></p>
<p>这样的错误一般就是没开启端口，或者是没启动对应的服务。但是我到服务器上执行docker的命令又是可以使用的。找了很久，突然想到上面2375端口未使用。</p>
<p>于是看了一下服务器上的2375端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -tnlp | grep 2375</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/image-20230919220932437.png" alt="image-20230919220932437"></p>
<p>果然没有任何东西。这就说明docker服务根本没有监听2375这个端口。网上搜到了解决办法。</p>
<p>先查看使用Linux对应的docker.service存放在哪里</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status docker.service</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/image-20230919221155518.png" alt="image-20230919221155518"></p>
<p>打开这个文件，并且加上docker监听的端口</p>
<p><img src="/../../images/image-20230919221325133.png" alt="image-20230919221325133"></p>
<p>内容为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-H tcp://0.0.0.0:2375 -H unix://var/run/docker.sock</span><br></pre></td></tr></table></figure>



<p>重启docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker.service</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/image-20230919221549379.png" alt="image-20230919221549379"></p>
<p><img src="/../../images/image-20230919221606977.png" alt="image-20230919221606977"></p>
<p>这下都正常了，在运行上面的测试代码。正常运行</p>
<p><img src="/../../images/image-20230919221640183.png" alt="image-20230919221640183"></p>
<h3 id="java对docker的基本操作"><a href="#java对docker的基本操作" class="headerlink" title="java对docker的基本操作"></a>java对docker的基本操作</h3><ul>
<li>用java命令拉取一个镜像</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">DockerClient</span> <span class="variable">dockerClient</span> <span class="operator">=</span> DockerClientBuilder.getInstance(<span class="string">&quot;tcp://124.220.41.55:2375&quot;</span>).build();</span><br><span class="line">    <span class="type">String</span> <span class="variable">imagesName</span> <span class="operator">=</span> <span class="string">&quot;nginx:latest&quot;</span>;</span><br><span class="line">    <span class="type">PullImageCmd</span> <span class="variable">pullImageCmd</span> <span class="operator">=</span> dockerClient.pullImageCmd(imagesName);</span><br><span class="line">    pullImageCmd.exec(<span class="keyword">new</span> <span class="title class_">PullImageResultCallback</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(PullResponseItem item)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.onNext(item);</span><br><span class="line">            System.out.println(<span class="string">&quot;下载镜像：&quot;</span>+item.getStatus());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).awaitCompletion();</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;下载完成&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/image-20230919223134129.png" alt="image-20230919223134129"></p>
<ul>
<li>创建容器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">containerName</span> <span class="operator">=</span> <span class="string">&quot;hello-world&quot;</span>;</span><br><span class="line"><span class="type">CreateContainerCmd</span> <span class="variable">createContainerCmd</span> <span class="operator">=</span> dockerClient.createContainerCmd(containerName);</span><br><span class="line"><span class="type">CreateContainerResponse</span> <span class="variable">containerResponse</span> <span class="operator">=</span> createContainerCmd</span><br><span class="line">    .withCmd(<span class="string">&quot;echo&quot;</span>,<span class="string">&quot;hello world&quot;</span>)     <span class="comment">//运行时会执行的命令</span></span><br><span class="line">    .exec();</span><br><span class="line">System.out.println(containerResponse.getId());  <span class="comment">//创建完会得到容器的id</span></span><br></pre></td></tr></table></figure>



<ul>
<li>删除容器，withForce 强制删除</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//删除容器</span></span><br><span class="line">dockerClient.removeContainerCmd(<span class="string">&quot;eb8ac5ae7ab823ea4205c93d78d1af4d5c26c9bdd21fcc1d0bdfe31f35fe2538&quot;</span>).withForce(<span class="literal">true</span>).exec();</span><br><span class="line">	</span><br></pre></td></tr></table></figure>



<ul>
<li>启动容器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dockerClient.startContainerCmd(containerResponse.getId()).exec();</span><br></pre></td></tr></table></figure>



<ul>
<li>查看容器状态</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查看容器状态</span></span><br><span class="line"><span class="type">ListContainersCmd</span> <span class="variable">listContainersCmd</span> <span class="operator">=</span> dockerClient.listContainersCmd();</span><br><span class="line">List&lt;Container&gt; containerList = listContainersCmd.withShowAll(<span class="literal">true</span>).exec();     <span class="comment">// 查看所有的包括未运行的</span></span><br><span class="line"><span class="keyword">for</span> (Container container : containerList) &#123;</span><br><span class="line">    System.out.println(container.getStatus());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>查看日志</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查看日志</span></span><br><span class="line">dockerClient.logContainerCmd(containerResponse.getId()).exec(<span class="keyword">new</span> <span class="title class_">LogContainerResultCallback</span>()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(Frame item)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onNext(item);</span><br><span class="line">        System.out.println(<span class="string">&quot;日志：&quot;</span>+item.getPayload());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).awaitCompletion();</span><br></pre></td></tr></table></figure>





<h2 id="docker实现代码沙箱"><a href="#docker实现代码沙箱" class="headerlink" title="docker实现代码沙箱"></a>docker实现代码沙箱</h2><p>上面了解了java简单操作docker，现在要用docker来实现一个代码沙箱。</p>
<p>上面我们实现过原生的代码沙箱，他要负责保存文件、编译、运行、删除等操作。</p>
<p>但是想一下用docker来实现的代码沙箱，主要是为了隔离运行时会出现的危险操作。所以除了运行以外，其他工作没必要放到沙箱中完成。所以docker实现代码沙箱主要是要提供代码运行返回结果。</p>
<p>对比原生实现代码沙箱的流程：</p>
<ul>
<li>原生</li>
</ul>
<blockquote>
<p>1、要将用户输入的代码保存到一个文件中，</p>
<p>2、然后编译这个代码得到编译后的文件，</p>
<p>3、执行代码，得到输出</p>
<p>4、整理执行结果返回</p>
<p>5、文件清理、异常处理</p>
</blockquote>
<ul>
<li>docker</li>
</ul>
<blockquote>
<p>docker和原生不一样的地方就在于，docker中只需要运行文件，并且docker是不在项目中的，它的每个容器都是一个很干净的，所以我们编译之后的内容没办法直接在容器中获取，需要将编译的结果上传到容器中，才能执行。所以相比于原生也只是多了一步，上传可执行文件而已。</p>
<p>1、要将用户输入的代码保存到一个文件中，</p>
<p>2、然后编译这个代码得到编译后的文件，</p>
<p>3、把编译好的结果上传到容器中</p>
<p>4、执行代码。得到输出</p>
<p>5、执行结果返回</p>
<p>6、文件清理、异常处理</p>
</blockquote>
<p><strong>TODO：上面两种实现方式，基本上流程都是一样的，如果很多实现大致的流程都是一样的话，就可以考虑用 模板设计模式进行优化。</strong></p>
<p>创建容器的时候有一个问题，我们不可能每个测试用例都创建一个容器，而是创建一个可交互的容器，能够一直接收测试用例，并且得到输出。所以在创建容器的时候需要开启一些功能。</p>
<h3 id="创建可交互式的容器"><a href="#创建可交互式的容器" class="headerlink" title="创建可交互式的容器"></a>创建可交互式的容器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建容器</span></span><br><span class="line"><span class="type">CreateContainerCmd</span> <span class="variable">createContainerCmd</span> <span class="operator">=</span> dockerClient.createContainerCmd(imagesName);</span><br><span class="line"><span class="type">CreateContainerResponse</span> <span class="variable">containerResponse</span> <span class="operator">=</span> createContainerCmd</span><br><span class="line">    .withAttachStderr(<span class="literal">true</span>)     <span class="comment">// 将容器的stderr与宿主机的stderr连接起来。这意味着容器中的标准错误输出将被重定向到宿主机的标准错误输出。</span></span><br><span class="line">    .withAttachStdin(<span class="literal">true</span>)      <span class="comment">//将容器的stderr与宿主机的stderr连接起来。这意味着容器中的标准错误输出将被重定向到宿主机的标准错误输出。</span></span><br><span class="line">    .withAttachStdout(<span class="literal">true</span>)     <span class="comment">//将容器的stdout与宿主机的stdout连接起来。这意味着容器中的标准输出将被重定向到宿主机的标准输出。</span></span><br><span class="line">    .withTty(<span class="literal">true</span>)              <span class="comment">//启用TTY模式。这意味着在容器中启用了伪终端，可以与容器进行交互。</span></span><br><span class="line">    .exec();</span><br><span class="line">System.out.println(containerResponse.getId());  <span class="comment">//创建完会得到容器的id</span></span><br></pre></td></tr></table></figure>



<p>除了创建容器之后，还需要将文件复制到容器中。这个需要通过一个config进行配置，将本地文件映射到容器的文件中。</p>
<h3 id="将要编译好的文件挂载到docker容器下"><a href="#将要编译好的文件挂载到docker容器下" class="headerlink" title="将要编译好的文件挂载到docker容器下"></a>将要编译好的文件挂载到docker容器下</h3><p>建立hostConfig配置，并且将当前环境下的userParentPath的文件路径映射到docker容器中的 &#x2F;app下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HostConfig</span> <span class="variable">hostConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HostConfig</span>();</span><br><span class="line">hostConfig.setBinds(<span class="keyword">new</span> <span class="title class_">Bind</span>(userParentPath,<span class="keyword">new</span> <span class="title class_">Volume</span>(<span class="string">&quot;/app&quot;</span>)));</span><br></pre></td></tr></table></figure>





<h3 id="踩雷"><a href="#踩雷" class="headerlink" title="踩雷"></a>踩雷</h3><p>创建容器的时候指定这个配置。</p>
<p><img src="/../../images/image-20230921141950367.png" alt="image-20230921141950367"></p>
<p>这个配置对象还有很多可以设置的，比如最常见的设置内存限制，cpu设置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HostConfig</span> <span class="variable">hostConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HostConfig</span>();</span><br><span class="line">hostConfig.setBinds(<span class="keyword">new</span> <span class="title class_">Bind</span>(userParentPath,<span class="keyword">new</span> <span class="title class_">Volume</span>(<span class="string">&quot;/app&quot;</span>)));</span><br><span class="line">hostConfig.withMemory(<span class="number">10</span>*<span class="number">1000</span>*<span class="number">1000L</span>);   <span class="comment">//10M</span></span><br><span class="line">hostConfig.withCpuCount(<span class="number">1L</span>);</span><br></pre></td></tr></table></figure>





<p>这里有一个很大的坑。windows到linux文件挂载的时候路径要变化格式。</p>
<p>比如：</p>
<p>这里的userParentPath &#x3D; C:\xxx\xxx\xxx\xxx</p>
<p>要改为 &#x2F;c&#x2F;xxx&#x2F;xxx&#x2F;xxx&#x2F;  ！！！</p>
<p>否则会出现以下错误：</p>
<p><img src="/../../images/image-20230921170026346.png" alt="image-20230921170026346"></p>
<p>所以上面的代码要做如下转换</p>
<p><img src="/../../images/image-20230921165914347.png" alt="image-20230921165914347"></p>
<h3 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h3><p>上面那种方式如果是 windows的java项目，Linux的docker容器还是没用的。</p>
<p>要么把项目放到Linux里面再运行，要么就要用idea2022新出的一个远程开发方式，它会再linux下再安装一个idea，给windows提供一个同样的界面，我们可以直接再那个新的界面中编写执行代码。</p>
<p><img src="/../../images/image-20230923185331887.png" alt="image-20230923185331887"></p>
<ul>
<li>创建到服务器的连接</li>
</ul>
<p><img src="/../../images/image-20230923185442213.png" alt="image-20230923185442213"></p>
<p><img src="/../../images/image-20230923185503769.png" alt="image-20230923185503769"></p>
<p>然后 idea就会帮我们再 远程环境中安装idea，注意最低要求远程环境要有4g以上的内存。然后安装完成之后就会有一个远程idea的ui界面</p>
<p><img src="/../../images/image-20230923185647626.png" alt="image-20230923185647626"></p>
<p>配置好了就可以尝试运行远程的开发环境，当然必要的java和mvn也是要安装的。</p>
<p>运行后如出现下面这个错误：</p>
<p><img src="/../../images/image-20230923190342132.png" alt="image-20230923190342132"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java: Cannot run program &quot;/usr/lib/jvm/java-1.8.0-openjdk-amd64/bin/java&quot; (in directory &quot;/home/yimeng/.cache/JetBrains/RemoteDev-IU/_projects_java_oj-javacodesand/compile-server&quot;): error=0, Failed to exec spawn helper: pid: 8585, exit value: 1</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>需要再远程idea的ui中在setting中找到compiler，加上以下配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Djdk.lang.Process.launchMechanism=vfork</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/image-20230923190034716.png" alt="image-20230923190034716"></p>
<p>就可以运行了</p>
<h3 id="执行java命令"><a href="#执行java命令" class="headerlink" title="执行java命令"></a>执行java命令</h3><p>创建了容器，并且将文件挂载到了docker容器中，就可以进入容器，并且执行java命令了。</p>
<p>直接用docker 命令操作如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it &quot;容器id&quot; java -cp /app Main (参数)</span><br></pre></td></tr></table></figure>

<p><strong>&#x2F;app</strong> 这个就是我们上面创建的挂载目录</p>
<p>用java代码操作docker如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (String input : inputList) &#123;</span><br><span class="line">    String[] inputarg = input.split(<span class="string">&quot; &quot;</span>);   <span class="comment">// 我们的输入是  &quot;1 2&quot; 这样的，但是不能这样直接传递给docker命令，要分开当作两个参数来传递</span></span><br><span class="line">    String[] cmdArray = ArrayUtil.append(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-cp&quot;</span>,<span class="string">&quot;/app&quot;</span>,<span class="string">&quot;Main&quot;</span>&#125;,inputarg);</span><br><span class="line">    <span class="type">ExecCreateCmd</span> <span class="variable">execkedCreateCmd</span> <span class="operator">=</span> dockerClient.execCreateCmd(containerResponse.getId());</span><br><span class="line">    <span class="comment">// 进入容器相当于 docker exec -it</span></span><br><span class="line">    <span class="comment">// 上面的那个命令是接在docker exec -it 后面的</span></span><br><span class="line">    <span class="comment">// 所以一共相当于执行了  docker exec -it id java -cp /app Main (java程序的输入参数)</span></span><br><span class="line">    <span class="type">ExecCreateCmdResponse</span> <span class="variable">execCreateCmdResponse</span> <span class="operator">=</span> execkedCreateCmd</span><br><span class="line">        .withAttachStderr(<span class="literal">true</span>)     <span class="comment">// 将容器的stderr与宿主机的stderr连接起来。这意味着容器中的标准错误输出将被重定向到宿主机的标准错误输出。</span></span><br><span class="line">        .withAttachStdin(<span class="literal">true</span>)      <span class="comment">//将容器的stderr与宿主机的stderr连接起来。这意味着容器中的标准错误输出将被重定向到宿主机的标准错误输出。</span></span><br><span class="line">        .withAttachStdout(<span class="literal">true</span>)</span><br><span class="line">        .withCmd(cmdArray)</span><br><span class="line">        .exec();</span><br><span class="line">    System.out.println(<span class="string">&quot;执行的命令：&quot;</span>+execCreateCmdResponse);</span><br><span class="line">    <span class="type">String</span> <span class="variable">execCreateCmdResponseId</span> <span class="operator">=</span> execCreateCmdResponse.getId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这个回调是为了拿到命令执行的返回值</span></span><br><span class="line">    <span class="type">ExecStartResultCallback</span> <span class="variable">execStartResultCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExecStartResultCallback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.onNext(frame);</span><br><span class="line">            System.out.println(<span class="string">&quot;输出结果:&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(frame.getPayload()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 执行，这里是异步操作所以要指定回调函数</span></span><br><span class="line">    dockerClient.execStartCmd(execCreateCmdResponseId).exec(execStartResultCallback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>用java操作唯一要注意的就是要把输入的命令以 字符串数组的形式传递给容器，并且java命令的参数一个参数就要是数组中的一个项。</p>
<blockquote>
<p>例如：</p>
<p>要执行A+B</p>
<p>传递的参数是  “1 2”</p>
<p>传递给docker的命令不应该是</p>
<p>{“java”,”-cp”,”&#x2F;app”,”Main”,”1  2”}</p>
<p>而应该是</p>
<p>{“java”,”-cp”,”&#x2F;app”,”Main”,”1”,”2”}</p>
</blockquote>
<h3 id="获取结果"><a href="#获取结果" class="headerlink" title="获取结果"></a>获取结果</h3><p>其实就是从创建的回调中拿到结果。</p>
<p>对比原生方式获取执行结果</p>
<p><img src="/../../images/image-20230922181639203.png" alt="image-20230922181639203"></p>
<p>为了保持一致，docker实现中也是用一个 ExecuteMessageList来保存执行结果。</p>
<p><img src="/../../images/image-20230922181941076.png" alt="image-20230922181941076"></p>
<p>遍历输入数据的时候，创建ExecuteMessage对象，在回调函数中，设置要设置到对象中的message和errorMessage。</p>
<p>这里学到了一个之前解决内部类和lamba表达式中要求使用外部变量要么是final的，要么是相对final的，这里的解决方式就是将erormessage和message分别改为数组，作为引用对象。</p>
<h3 id="获取程序执行时间和内存"><a href="#获取程序执行时间和内存" class="headerlink" title="获取程序执行时间和内存"></a>获取程序执行时间和内存</h3><p>时间还是一样用一个stopWatch就能拿到了。</p>
<p>但是内存，之前原生实现就没有说如何拿到程序执行内存。</p>
<p>对于内存：程序执行的每个时刻所消耗的内存都是不一样的，所以不可能获取到所有时间点的内存。所以我们的做法是每秒去查询docker容器的状态，并且docker容器的状态可以看出代码运行时所占用的内存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造获取容器状态指令</span></span><br><span class="line"><span class="type">StatsCmd</span> <span class="variable">statsCmd</span> <span class="operator">=</span> dockerClient.statsCmd(containerResponse.getId());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行要接受一个回调，没找到对应指令对于这个接口的实现类</span></span><br><span class="line"><span class="comment">// 所以自己实现一个，只需要实现onNext方法就好了</span></span><br><span class="line">ResultCallback&lt;Statistics&gt; resultCallback = <span class="keyword">new</span> <span class="title class_">ResultCallback</span>&lt;Statistics&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(Closeable closeable)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// 这个参数就是对于docker容器运行状态数据的采集得到的结果</span></span><br><span class="line">    <span class="comment">// 包括网络，内存，cpu</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(Statistics statistics)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;内存占用：&quot;</span> + statistics.getMemoryStats().getUsage());</span><br><span class="line">        maxMemory[<span class="number">0</span>] = Math.max(maxMemory[<span class="number">0</span>],statistics.getMemoryStats().getUsage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//先执行获取容器状态的指令，这是一个一直在执行的命令，会一直获取容器状态</span></span><br><span class="line"><span class="comment">// 在回调函数中可以获取到当前容器的状态</span></span><br><span class="line">statsCmd.exec(resultCallback);</span><br></pre></td></tr></table></figure>



<p>其他部分都是复制原生实现的沙箱就好了。</p>
<p>执行：</p>
<p><img src="/../../images/image-20230923202730398.png" alt="image-20230923202730398"></p>
<p>至此，就实现了用docker实现代码沙箱。相比于原生实现，只有执行部分的代码不一样还有在执行前加了一步创建容器，将文件挂载到容器上以外，其他部分完全是一样的</p>
<h3 id="异常情况-1"><a href="#异常情况-1" class="headerlink" title="异常情况"></a>异常情况</h3><p>回忆原生实现中提出的异常情况在docker中是否能够解决？</p>
<ul>
<li>死循环代码\无限睡眠代码</li>
</ul>
<p>如果只是按照上面写的内容，确实不能防止这种异常，但是这个要解决起来也很方便。</p>
<p><img src="/../../images/image-20230923203349271.png" alt="image-20230923203349271"></p>
<p>在执行命令中，我们可以直接设置等待执行完成的超时时间，超时程序就会自己往下继续执行。</p>
<p>但是这样有一个问题，我们没办法知道程序是否超时。</p>
<p>有一个解决的办法，就是我们去重写，这个回调函数中的一个onComplete方法，这个方法只会在，容器执行完成之后才会执行，我们可以通过是否执行这个方法来判断程序是否超时。</p>
<p><img src="/../../images/image-20230923210645875.png" alt="image-20230923210645875"></p>
<ul>
<li>无限创建对象，爆内存</li>
</ul>
<p>这个我们在创建容器的时候就已经设置了最大内存设置</p>
<p><img src="/../../images/image-20230923210802800.png" alt="image-20230923210802800"></p>
<ul>
<li>防止代码使用网络</li>
</ul>
<p>同样可以在创建容器的时候直接指定不允许就好了。</p>
<p><img src="/../../images/image-20230923210919350.png" alt="image-20230923210919350"></p>
<ul>
<li>读文件</li>
</ul>
<p>最重要的就是限制不允许像根目录写文件。</p>
<p>同样通过一个配置就能够解决</p>
<p><img src="/../../images/image-20230923211855973.png" alt="image-20230923211855973"></p>
<ul>
<li>写文件，将一些越权命令或木马或者病毒写入文件在执行</li>
</ul>
<p>对于读写文件来说，我们已经做了容器的隔离了，最多也只会读取我们挂载到docker 内容，理论上来说是比较安全的了，但不绝对。要做更进一步权限的限制的话可以结合安全管理器使用</p>
<h2 id="优化代码沙箱"><a href="#优化代码沙箱" class="headerlink" title="优化代码沙箱"></a>优化代码沙箱</h2><p>在 一开始使用docker实现代码沙箱的时候我们说过要使用模板设计模式去优化我们的代码。</p>
<p>模板设计模式主要应用在对于不同的代码中有很多相同的操作，这些操作都是可以被复用的。就比如说我们这里的原生实现代码沙箱和docker实现代码沙箱来说，基本上只有执行部分是不一样的。</p>
<p>所以我们可以抽象出一系列流程，每个流程对应一个方法，写一个接口需要包含这些方法，实现类中对于不同的流程重写不同的方法即可。</p>
<ul>
<li>抽象出一个流程，定义一个模板类</li>
</ul>
<p><img src="/../../images/image-20230923231120579.png" alt="image-20230923231120579"></p>
<p>这里就是把原生实现的代码沙箱每一步拆分成了一个个方法来调用而已。</p>
<p>有了这个模板类之后，我们后面根据不同的流程只需要继承这个模板类，重写不同的方法，调用父类的执行方法。</p>
<p>对于docker实现代码沙箱，我们只需要重写Runfile方法就行了，其他的都是一样的</p>
<p><img src="/../../images/image-20230923233626689.png" alt="image-20230923233626689"></p>
<p>也是把docker实现的把创建容器和执行复制进去就行了。</p>
<h2 id="暴露接口"><a href="#暴露接口" class="headerlink" title="暴露接口"></a>暴露接口</h2><p>我们这里完成了整个代码沙箱的流程，只需要给判题服务提供一个能够调用的接口就行了，本来想使用grpc的，但是用起来有点麻烦，还是用http请求了。</p>
<p>用http请求就非常简单了，沙箱服务写一个controller，接收ExecuteRequest，返回ExecuteResponse就行了。</p>
<ul>
<li>代码沙箱服务，提供http接口</li>
</ul>
<p><img src="/../../images/image-20230928152240151.png" alt="image-20230928152240151"></p>
<ul>
<li>判题服务调用代码沙箱</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(RemoteCodeSandService)</span></span> ExecuteCode(ctx context.Context, request *pb.ExecuteCodeRequest) (*pb.ExecuteCodeResponse, <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">	requestBody, err := json.Marshal(request)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	req, err := http.NewRequest(http.MethodPost, <span class="string">&quot;http://localhost:8080/executeCode&quot;</span>, bytes.NewBuffer(requestBody))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	req.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">	client := &amp;http.Client&#123;&#125;</span><br><span class="line">	resp, err := client.Do(req)</span><br><span class="line">	<span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> resp.StatusCode != <span class="number">200</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;请求/localhost:8080/executeCode：异常&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 把resp的响应体从reader读为 []byte</span></span><br><span class="line">	respBody, err := io.ReadAll(resp.Body)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	executeResp := <span class="built_in">new</span>(pb.ExecuteCodeResponse)</span><br><span class="line">	err = json.Unmarshal(respBody, executeResp)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> executeResp, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="接口鉴权"><a href="#接口鉴权" class="headerlink" title="接口鉴权"></a>接口鉴权</h3><p>既然要暴露接口，那对这个接口最基本的保护是需要实现的，不然只要被捕获到接口的调用地址，就很容易被恶搞。</p>
<p>基本鉴权方式有以下几种：</p>
<ul>
<li>调用方和服务方约定一个字符串，这种方式比较适用于服务内部开发，服务不需要给外人提供使用的。</li>
</ul>
<p>请求方设置请求头</p>
<p><img src="/../../images/image-20230928155432056.png" alt="image-20230928155432056"></p>
<p>服务方判断请求头</p>
<p><img src="/../../images/image-20230928155512703.png" alt="image-20230928155512703"></p>
<p>这种方式的有点就是：简单，方便，成本低。当然上面的密钥最好是要经过加密后再进行传输。</p>
<p>缺点也比较明显：不够灵活，要变更key就要重启代码。</p>
<ul>
<li>另一种实现方式就是使用AK和SK来给用户发放签名认证。可以参考API项目</li>
</ul>
<h1 id="跑通整个流程"><a href="#跑通整个流程" class="headerlink" title="跑通整个流程"></a>跑通整个流程</h1><p>期间遇到了一个比较坑的地方，这个坑是由context引起的。在使用grpc调用的时候最好不要直接使用当前服务的context，否则在一个服务中有多个grpc调用的时候会出现以下错误</p>
<p><img src="/../../images/image-20230928175728609.png" alt="image-20230928175728609"></p>
<p>可能是因为，第一个使用了context之后那个服务就会把context取消掉，导致后面的服务无法使用。</p>
<p>其他的问题就是类型和字段名的问题，也没什么大问题。</p>
<p><img src="/../../images/image-20230928175855966.png" alt="image-20230928175855966"></p>
<p>因为我们现在的代码提交是异步的，也就是我们点提交之后看不到执行结果。所以要加一个能够查看提交情况的页面。这个界面复用以下查看题目的那个页面就可以了。</p>
<h1 id="消息队列优化解耦"><a href="#消息队列优化解耦" class="headerlink" title="消息队列优化解耦"></a>消息队列优化解耦</h1><p>因为判题服务属于比较 重的服务，所以可能要考虑到服务宕机等问题。使用消息队列后，判题服务只需要从消息队列中取提交的记录就好了，这样判题服务和题目服务不是直接相互依赖的。</p>
<ul>
<li>我们之前题目提交服务中，调用判题服务是通过异步+rpc来实现的</li>
</ul>
<p><img src="/../../images/image-20230929165332503.png" alt="image-20230929165332503"></p>
<p>引入消息队列之后，我们就必要使用异步了，直接向消息队列发送一条消息就好了，原本我们只要传递一个questionSubmitId，那我们的消息也就是一个questionSubmitId就行了。</p>
<p><img src="/../../images/image-20230929170021809.png" alt="image-20230929170021809"></p>
<p>消费者判题服务在main方法中去调用消费函数，然后一直阻塞主线程就好了。</p>
<p><img src="/../../images/image-20230930141156280.png" alt="image-20230930141156280"></p>
<p><img src="/../../images/image-20230930144721283.png" alt="image-20230930144721283"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://yimeng436.github.io">异梦</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://yimeng436.github.io/2022/08/22/Project-OJ/Project-OJ/">https://yimeng436.github.io/2022/08/22/Project-OJ/Project-OJ/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yimeng436.github.io" target="_blank">异梦的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Go/">Go</a></div><div class="post_share"><div class="social-share" data-image="/img/top.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/08/22/Project-GamerMatch/Project-GamerMatch/"><img class="prev-cover" src="/img/top.png" onerror="onerror=null;src='/img/cover.png'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Project</div></div></a></div><div class="next-post pull-right"><a href="/2022/08/21/Paper-CV_Transformer%E7%B3%BB%E5%88%97/Paper-CV_Transformer%E7%B3%BB%E5%88%97/"><img class="next-cover" src="/img/top.png" onerror="onerror=null;src='/img/cover.png'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Paper-CV_Transformer系列</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/08/19/Go/Go/" title="Go"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-19</div><div class="title">Go</div></div></a></div><div><a href="/2022/08/19/Go%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/Go%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" title="Go数据结构"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-19</div><div class="title">Go数据结构</div></div></a></div><div><a href="/2022/08/19/Go%E9%9D%A2%E8%AF%95%E9%A2%98/Go%E9%9D%A2%E8%AF%95%E9%A2%98/" title="Go面试"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-19</div><div class="title">Go面试</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="http://mms2.baidu.com/it/u=665033858,976373917&amp;fm=253&amp;app=138&amp;f=JPEG&amp;fmt=auto&amp;q=75?w=500&amp;h=500" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">异梦</div><div class="author-info__description">欢迎访问</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">62</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/yimeng436" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2441844062@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD"><span class="toc-number">1.</span> <span class="toc-text">功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.</span> <span class="toc-text">核心实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.</span> <span class="toc-text">相关概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.</span> <span class="toc-text">核心业务流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text">前端初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-number">2.1.</span> <span class="toc-text">简单权限管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E9%80%9A%E7%94%A8%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.2.</span> <span class="toc-text">抽象通用权限校验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E6%8E%A5%E5%8F%A3%E8%AF%B7%E6%B1%82%E7%94%9F%E6%88%90"><span class="toc-number">2.3.</span> <span class="toc-text">后端接口请求生成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BB%E9%99%86%E9%A1%B5%E9%9D%A2"><span class="toc-number">2.4.</span> <span class="toc-text">登陆页面</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.</span> <span class="toc-text">后端初始化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#OJ%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E8%AE%BE%E8%AE%A1"><span class="toc-number">4.</span> <span class="toc-text">OJ系统数据库表设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%A1%A8"><span class="toc-number">4.1.</span> <span class="toc-text">题目表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E6%8F%90%E4%BA%A4%E8%A1%A8"><span class="toc-number">4.2.</span> <span class="toc-text">题目提交表</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E5%AE%8C%E6%88%90%E7%AE%80%E5%8D%95curd"><span class="toc-number">5.</span> <span class="toc-text">后端完成简单curd</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E9%83%A8%E5%88%86"><span class="toc-number">6.</span> <span class="toc-text">前端部分</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#markdown%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8"><span class="toc-number">6.1.</span> <span class="toc-text">markdown富文本编辑器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%BC%96%E8%BE%91%E5%99%A8"><span class="toc-number">6.2.</span> <span class="toc-text">代码编辑器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%A4%E9%A2%98%E7%B3%BB%E7%BB%9F%E5%92%8C%E4%BB%A3%E7%A0%81%E6%B2%99%E7%AE%B1"><span class="toc-number">7.</span> <span class="toc-text">判题系统和代码沙箱</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E7%B3%BB"><span class="toc-number">7.1.</span> <span class="toc-text">关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%B2%99%E7%AE%B1"><span class="toc-number">7.2.</span> <span class="toc-text">代码沙箱</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A4%E9%A2%98%E6%A8%A1%E5%9D%97"><span class="toc-number">7.3.</span> <span class="toc-text">判题模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%B2%99%E7%AE%B1%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.4.</span> <span class="toc-text">代码沙箱实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5%E4%BF%9D%E5%AD%98%E5%88%B0%E6%96%87%E4%BB%B6"><span class="toc-number">7.4.1.</span> <span class="toc-text">将用户输入保存到文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E4%BB%A3%E7%A0%81"><span class="toc-number">7.4.2.</span> <span class="toc-text">编译代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81"><span class="toc-number">7.4.3.</span> <span class="toc-text">执行代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E7%90%86%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C%E5%B9%B6%E8%BF%94%E5%9B%9E"><span class="toc-number">7.4.4.</span> <span class="toc-text">整理执行结果并返回</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%B8%85%E7%90%86%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">7.4.5.</span> <span class="toc-text">文件清理异常处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B5"><span class="toc-number">7.5.</span> <span class="toc-text">异常情况</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3"><span class="toc-number">7.6.</span> <span class="toc-text">解决</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BB%E6%8A%80%E6%9C%AF"><span class="toc-number">7.7.</span> <span class="toc-text">环境隔离技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">7.7.1.</span> <span class="toc-text">Docker基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java%E6%93%8D%E4%BD%9CDokcer"><span class="toc-number">7.7.2.</span> <span class="toc-text">Java操作Dokcer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dokcer%E8%B8%A9%E5%9D%91"><span class="toc-number">7.7.3.</span> <span class="toc-text">Dokcer踩坑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#java%E5%AF%B9docker%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">7.7.4.</span> <span class="toc-text">java对docker的基本操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E6%B2%99%E7%AE%B1"><span class="toc-number">7.8.</span> <span class="toc-text">docker实现代码沙箱</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%8F%AF%E4%BA%A4%E4%BA%92%E5%BC%8F%E7%9A%84%E5%AE%B9%E5%99%A8"><span class="toc-number">7.8.1.</span> <span class="toc-text">创建可交互式的容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E8%A6%81%E7%BC%96%E8%AF%91%E5%A5%BD%E7%9A%84%E6%96%87%E4%BB%B6%E6%8C%82%E8%BD%BD%E5%88%B0docker%E5%AE%B9%E5%99%A8%E4%B8%8B"><span class="toc-number">7.8.2.</span> <span class="toc-text">将要编译好的文件挂载到docker容器下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B8%A9%E9%9B%B7"><span class="toc-number">7.8.3.</span> <span class="toc-text">踩雷</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3-1"><span class="toc-number">7.8.4.</span> <span class="toc-text">解决</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8Cjava%E5%91%BD%E4%BB%A4"><span class="toc-number">7.8.5.</span> <span class="toc-text">执行java命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%BB%93%E6%9E%9C"><span class="toc-number">7.8.6.</span> <span class="toc-text">获取结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%A8%8B%E5%BA%8F%E6%89%A7%E8%A1%8C%E6%97%B6%E9%97%B4%E5%92%8C%E5%86%85%E5%AD%98"><span class="toc-number">7.8.7.</span> <span class="toc-text">获取程序执行时间和内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B5-1"><span class="toc-number">7.8.8.</span> <span class="toc-text">异常情况</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E4%BB%A3%E7%A0%81%E6%B2%99%E7%AE%B1"><span class="toc-number">7.9.</span> <span class="toc-text">优化代码沙箱</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9A%B4%E9%9C%B2%E6%8E%A5%E5%8F%A3"><span class="toc-number">7.10.</span> <span class="toc-text">暴露接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E9%89%B4%E6%9D%83"><span class="toc-number">7.10.1.</span> <span class="toc-text">接口鉴权</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B7%91%E9%80%9A%E6%95%B4%E4%B8%AA%E6%B5%81%E7%A8%8B"><span class="toc-number">8.</span> <span class="toc-text">跑通整个流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%BC%98%E5%8C%96%E8%A7%A3%E8%80%A6"><span class="toc-number">9.</span> <span class="toc-text">消息队列优化解耦</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/08/19/MySQL%E5%8E%9F%E7%90%86%E9%83%A8%E5%88%86/MySQL%E5%8E%9F%E7%90%86%E9%83%A8%E5%88%86/" title="MySQL原理"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="MySQL原理"/></a><div class="content"><a class="title" href="/2023/08/19/MySQL%E5%8E%9F%E7%90%86%E9%83%A8%E5%88%86/MySQL%E5%8E%9F%E7%90%86%E9%83%A8%E5%88%86/" title="MySQL原理">MySQL原理</a><time datetime="2023-08-18T16:00:00.000Z" title="发表于 2023-08-19 00:00:00">2023-08-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/19/%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/" title="算法笔记"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="算法笔记"/></a><div class="content"><a class="title" href="/2023/08/19/%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/" title="算法笔记">算法笔记</a><time datetime="2023-08-18T16:00:00.000Z" title="发表于 2023-08-19 00:00:00">2023-08-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/06/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86/" title="前端知识"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="前端知识"/></a><div class="content"><a class="title" href="/2023/06/06/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86/" title="前端知识">前端知识</a><time datetime="2023-06-05T16:00:00.000Z" title="发表于 2023-06-06 00:00:00">2023-06-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/14/Paper-FSAF/Paper-FSAF/" title="FSAF论文"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="FSAF论文"/></a><div class="content"><a class="title" href="/2022/10/14/Paper-FSAF/Paper-FSAF/" title="FSAF论文">FSAF论文</a><time datetime="2022-10-13T16:00:00.000Z" title="发表于 2022-10-14 00:00:00">2022-10-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/25/Paper-Faster-RCNN/Paper-Faster-RCNN/" title="Faster-RCNN论文"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="Faster-RCNN论文"/></a><div class="content"><a class="title" href="/2022/08/25/Paper-Faster-RCNN/Paper-Faster-RCNN/" title="Faster-RCNN论文">Faster-RCNN论文</a><time datetime="2022-08-24T16:00:00.000Z" title="发表于 2022-08-25 00:00:00">2022-08-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 异梦</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>
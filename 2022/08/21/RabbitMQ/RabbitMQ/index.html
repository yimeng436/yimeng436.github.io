<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>SpringCloud | 异梦的博客</title><meta name="keywords" content="Java"><meta name="author" content="异梦"><meta name="copyright" content="异梦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="RabbitMQ">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud">
<meta property="og:url" content="https://yimeng436.github.io/2022/08/21/RabbitMQ/RabbitMQ/index.html">
<meta property="og:site_name" content="异梦的博客">
<meta property="og:description" content="RabbitMQ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yimeng436.github.io/img/top.png">
<meta property="article:published_time" content="2022-08-20T16:00:00.000Z">
<meta property="article:modified_time" content="2023-09-29T07:35:43.353Z">
<meta property="article:author" content="异梦">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yimeng436.github.io/img/top.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://yimeng436.github.io/2022/08/21/RabbitMQ/RabbitMQ/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SpringCloud',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-29 15:35:43'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="http://mms2.baidu.com/it/u=665033858,976373917&amp;fm=253&amp;app=138&amp;f=JPEG&amp;fmt=auto&amp;q=75?w=500&amp;h=500" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">62</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/top.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">异梦的博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SpringCloud</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-20T16:00:00.000Z" title="发表于 2022-08-21 00:00:00">2022-08-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-29T07:35:43.353Z" title="更新于 2023-09-29 15:35:43">2023-09-29</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="SpringCloud"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><strong><center><font size=5>RabbitMQ</font></center></strong></p>
<h1 id="什么是MQ"><a href="#什么是MQ" class="headerlink" title="什么是MQ"></a>什么是MQ</h1><p>​	MQ(message queue)，从字面意思上看，本质是个队列，FIFO 先入先出，只不过队列中存放的内容是 message 而已，还是一种跨进程的通信机制，用于上下游传递消息。在互联网架构中，MQ 是一种非常常 见的上下游“逻辑解耦+物理解耦”的消息通信服务。使用了 MQ 之后，消息发送上游只需要依赖 MQ，不 用依赖其他服务。</p>
<h1 id="MQ-有什么作用"><a href="#MQ-有什么作用" class="headerlink" title="MQ 有什么作用"></a>MQ 有什么作用</h1><ul>
<li><p>流量消峰</p>
<p>​	高并发下用户访问同一个服务器，如果请求次数过多，可能会导致系统崩溃宕机等问题。但是在请求到达服务器前加上一个MQ让用户排队，让服务器不是在同一时间接收到大量的请求，就能缓解服务器的压力，当然这样也会使得用户接收到的响应变慢</p>
</li>
<li><p>应用解耦</p>
<p>​	在一个应用系统中，如果一个系统依赖了其他的系统，如订单系统依赖了支付、库存、物流等系统，订单系统在执行过程中需要调用其他的系统，那么只要有其中一个系统出现问题整个系统都会崩溃。但是中间如果多一个MQ，订单系统在执行完之后给MQ发送一个消息，后续的调用由队列来完成，就不会出现这种耦合的问题。</p>
</li>
<li><p>异步处理</p>
<p>​	当有一个任务需要执行很长时间时候，以前调用系统需要一直检查任务是否完成，有点像轮询算法。这样是非常耗时的，但是现在系统通过MQ去调用任务，任务执行完成之后将返回的结果给MQ，MQ在给系统，在此期间系统可以去完成别的事情，有点像DMA。</p>
</li>
</ul>
<h1 id="常见的MQ"><a href="#常见的MQ" class="headerlink" title="常见的MQ"></a>常见的MQ</h1><p><img src="/../../images/image-20230731162107064.png" alt="image-20230731162107064"></p>
<h1 id="四大核心概念"><a href="#四大核心概念" class="headerlink" title="四大核心概念"></a>四大核心概念</h1><ul>
<li><p>生产者：产生数据发送消息的程序是生产者 交换机 </p>
</li>
<li><p>交换机：是 RabbitMQ 非常重要的一个部件，一方面它接收来自生产者的消息，另一方面它将消息 推送到队列中。交换机必须确切知道如何处理它接收到的消息，是将这些消息推送到特定队列还是推 送到多个队列，亦或者是把消息丢弃，这个得有交换机类型决定</p>
</li>
<li><p>队列： RabbitMQ 内部使用的一种数据结构，尽管消息流经 RabbitMQ 和应用程序，但它们只能存 储在队列中。队列仅受主机的内存和磁盘限制的约束，本质上是一个大的消息缓冲区。许多生产者可 以将消息发送到一个队列，许多消费者可以尝试从一个队列接收数据。这就是我们使用队列的方式</p>
</li>
<li><p>消费者：消费与接收具有相似的含义。消费者大多时候是一个等待接收消息的程序。请注意生产者，消费 者和消息中间件很多时候并不在同一机器上。同一个应用程序既可以是生产者又是可以是消费者。</p>
</li>
</ul>
<p><img src="/../../images/image-20230207100314328.png" alt="image-20230207100314328"></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>先要安装erlang、在安装RabbitMQ。</p>
<p>到安装的sbin目录下，</p>
<p>rabbitmq-server start 开启服务，</p>
<p>rabbitmq-server status查看服务状态，</p>
<p>rabbitmq-server stop关闭服务，</p>
<p>rabbitmq-plugins enable rabbitmq_management  web界面插件，默认账号密码是 guet guest</p>
<p><img src="/../../images/image-20230207104401166.png" alt="image-20230207104401166"></p>
<p>添加一个新的用户 创建账号 rabbitmqctl add_user admin 123 </p>
<p>设置用户角色 rabbitmqctl set_user_tags admin administrator </p>
<p>设置用户权限 set_permissions [-p ]     rabbitmqctl set_permissions -p “&#x2F;“ admin “.* “ “. * “ “. * “</p>
<p> 用户 user_admin 具有&#x2F;vhost1 这个 virtual host 中所有资源的配置、写、读权限 </p>
<p>当前用户和角色 rabbitmqctl list_users</p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><ul>
<li>依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--io操作的依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="简单工作模式"><a href="#简单工作模式" class="headerlink" title="简单工作模式"></a>简单工作模式</h2><p>下图是一个简易的MQ的图，MQ就是中间红色的部分，我们要完成P和C进程，P是消息生产者、C是消息消费者。P将消息发送给MQ，MQ将消息发送给C</p>
<p><img src="/../../images/image-20230207105512952.png" alt="image-20230207105512952"></p>
<ul>
<li>生产者</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MQ_NAME</span> <span class="operator">=</span> <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">//创建工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">//连接主机</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">        <span class="comment">//用户名</span></span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="comment">//密码</span></span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;zyh&quot;</span>);</span><br><span class="line">        <span class="comment">//创建 生产者和 Connection的连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">//Connection中有很多小channel</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">//本来需要建立交换机的，但是现在只是一个简单的案例，可以先不用创建交换机使用默认的</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/***</span></span><br><span class="line"><span class="comment">         * 创建一个队列</span></span><br><span class="line"><span class="comment">         * 1、队列名称</span></span><br><span class="line"><span class="comment">         * 2、消息是否需要持久化</span></span><br><span class="line"><span class="comment">         * 3、消息是否共享，true：可以被多个消费者使用，false：只能被一个消费者使用</span></span><br><span class="line"><span class="comment">         * 4、消息被一个消费者使用后是否立即删除</span></span><br><span class="line"><span class="comment">         * 5、携带的参数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.queueDeclare(MQ_NAME,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/***</span></span><br><span class="line"><span class="comment">         * 发送一个消息</span></span><br><span class="line"><span class="comment">         * 1、发送到哪台交换机</span></span><br><span class="line"><span class="comment">         * 2、路由的Key，本次连接名</span></span><br><span class="line"><span class="comment">         * 3、其他参数信息</span></span><br><span class="line"><span class="comment">         * 4、本次发送的内容，是一个二进制数组</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>,MQ_NAME,<span class="literal">null</span>,<span class="string">&quot;helloword&quot;</span>.getBytes());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;消息发送完毕&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>运行结束口可以在上面的web界面中看到我们的 Hello 队列</p>
<p><img src="/../../images/image-20230207112926996.png" alt="image-20230207112926996"></p>
<p><img src="/../../images/image-20230207113033839.png" alt="image-20230207113033839"></p>
<ul>
<li>消费者</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Conusmer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MQ_NAME</span> <span class="operator">=</span> <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;zyh&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/***</span></span><br><span class="line"><span class="comment">         * 消息消费</span></span><br><span class="line"><span class="comment">         * 1、队列名称</span></span><br><span class="line"><span class="comment">         * 2、消费之后是否自动应答，true 自动，false手动</span></span><br><span class="line"><span class="comment">         * 3、当一个消息发送过来后的回调接口,就是接收消息的时候调用的就是匿名内部类的重写方法</span></span><br><span class="line"><span class="comment">         * 4、消息被中断或者取消</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 3、4都是接口要么用匿名内部类的形式 要么就是labdma表达式</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.basicConsume(MQ_NAME, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;DeliverCallback第一个参数:&quot;</span>+s);</span><br><span class="line">                <span class="comment">//要通过getbody才能获得消息的值，并且需要指定编码格式不然会乱码</span></span><br><span class="line">                System.out.println(<span class="string">&quot;DeliverCallback第二个参数&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(),<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;CancelCallback第一个参数&quot;</span>+s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230207124415481.png" alt="image-20230207124415481"></p>
<h2 id="Work-queues工作模式"><a href="#Work-queues工作模式" class="headerlink" title="Work queues工作模式"></a>Work queues工作模式</h2><p>​	主要思想是避免立即执行资源密集型任务，而不得不等待它完成。 相反我们安排任务在之后执行。我们把任务封装为消息并将其发送到队列。在后台运行的工作进 程将弹出任务并最终执行作业。当有多个工作线程时，这些工作线程将一起处理这些任务。也就是多个消费者，轮询处理MQ队列里的消息。需要注意的是，MQ里的消息必须只允许处理一次。 </p>
<p><img src="/../../images/image-20230207125414847.png" alt="image-20230207125414847"></p>
<ul>
<li><p>消费者（同一个类，只改变输出的语句，开启两个线程）</p>
<ul>
<li><p>线程1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Worker1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MQ_NAME</span> <span class="operator">=</span> <span class="string">&quot;work_queues&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> RabbitMQUtills.setpropertis(RabbitMQUtills.getConnectionFactory(),<span class="string">&quot;localhost&quot;</span>,<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;zyh&quot;</span>);</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel(RabbitMQUtills.getconnection(connectionFactory));</span><br><span class="line">        channel.queueDeclare(MQ_NAME,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;当前是线程1&quot;</span>);</span><br><span class="line">        channel.basicConsume(MQ_NAME, <span class="literal">true</span>,</span><br><span class="line">                (s, delivery) -&gt; System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(),<span class="string">&quot;UTF-8&quot;</span>)),</span><br><span class="line">                s -&gt; System.out.println(<span class="string">&quot;消息被中断&quot;</span>+s));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><ul>
<li><p>线程2：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Worker1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MQ_NAME</span> <span class="operator">=</span> <span class="string">&quot;work_queues&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> RabbitMQUtills.setpropertis(RabbitMQUtills.getConnectionFactory(),<span class="string">&quot;localhost&quot;</span>,<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;zyh&quot;</span>);</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel(RabbitMQUtills.getconnection(connectionFactory));</span><br><span class="line">        channel.queueDeclare(MQ_NAME,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;当前是线程2&quot;</span>);</span><br><span class="line">        channel.basicConsume(MQ_NAME, <span class="literal">true</span>,</span><br><span class="line">                (s, delivery) -&gt; System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(),<span class="string">&quot;UTF-8&quot;</span>)),</span><br><span class="line">                s -&gt; System.out.println(<span class="string">&quot;消息被中断&quot;</span>+s));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>生产者</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MQ_NAME</span> <span class="operator">=</span> <span class="string">&quot;work_queues&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel(RabbitMQUtills.getconnection(RabbitMQUtills.setpropertis(RabbitMQUtills.getConnectionFactory(),</span><br><span class="line">                <span class="string">&quot;localhost&quot;</span>, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;zyh&quot;</span>)));</span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(MQ_NAME,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span>(scanner.hasNext())&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            System.out.println(<span class="string">&quot;发送完成:&quot;</span>+message);</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>,MQ_NAME,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>生产者发送</li>
</ul>
<p><img src="/../../images/image-20230207135403251.png" alt="image-20230207135403251"></p>
<ul>
<li>线程1</li>
</ul>
<p><img src="/../../images/image-20230207135413332.png" alt="image-20230207135413332"></p>
<ul>
<li>线程2</li>
</ul>
<p><img src="/../../images/image-20230207135421066.png" alt="image-20230207135421066"></p>
<p>可以发现是轮询接收的。</p>
<h2 id="消息应答机制"><a href="#消息应答机制" class="headerlink" title="消息应答机制"></a>消息应答机制</h2><pre><code>  消费者完成一个任务可能需要一段时间，如果其中一个消费者处理一个长的任务并仅只完成 了部分突然它挂掉了，会发生什么情况。RabbitMQ 一旦向消费者传递了一条消息，便立即将该消 息标记为删除。在这种情况下，突然有个消费者挂掉了，我们将丢失正在处理的消息。以及后续 发送给该消费这的消息，因为它无法接收到。 
</code></pre>
<p>​		为了保证消息在发送过程中不丢失，rabbitmq 引入消息应答机制，消息应答就是:消费者在接收 到消息并且处理该消息之后，告诉 rabbitmq 它已经处理了，rabbitmq 可以把该消息删除了。 </p>
<h3 id="应答方法"><a href="#应答方法" class="headerlink" title="应答方法"></a>应答方法</h3><ul>
<li>自动应答</li>
</ul>
<p>自动应答不是特别可靠，他要在并发度不是特别高，或者传输安全性要求不是特别高的情况下才建议使用，这种方式不是特别的安全。</p>
<ul>
<li>手动应答</li>
</ul>
<p>A.Channel.basicAck(用于肯定确认)  RabbitMQ 已知道该消息并且成功的处理消息，可以将其丢弃了</p>
<p>B.Channel.basicNack(用于否定确认)  </p>
<p>C.Channel.basicReject(用于否定确认)  与 Channel.basicNack 相比少一个参数，标识用于批量应答 不处理该消息了直接拒绝，可以将其丢弃了</p>
<p>批量应答和计网的累计确认有点类似。为true 则会对所有处理完的都进行应答，false则只会对最新的编号最大的那个进行应答。</p>
<h3 id="消息丢失处理"><a href="#消息丢失处理" class="headerlink" title="消息丢失处理"></a>消息丢失处理</h3><p>如果消息发生丢失（未接受到 ack）那么这个消息会被重新入队，并且是放入对头不是队尾。让下次要被消费的消息就是这个未收到ack的消息。</p>
<ul>
<li><p>消费者</p>
<ul>
<li><p>线程1，sleep 1s 模拟快业务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Work2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MQ_NAME</span> <span class="operator">=</span> <span class="string">&quot;work_queues&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> RabbitMQUtills.setpropertis(RabbitMQUtills.getConnectionFactory(),<span class="string">&quot;localhost&quot;</span>,<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;zyh&quot;</span>);</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel(RabbitMQUtills.getconnection(connectionFactory));</span><br><span class="line">        channel.queueDeclare(MQ_NAME,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;当前是线程1，执行时间是1s&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">auto_ack</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        channel.basicConsume(MQ_NAME, auto_ack, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> delivery.getEnvelope().getDeliveryTag(); <span class="comment">//对那个消息进行应答</span></span><br><span class="line">                System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(),<span class="string">&quot;utf8&quot;</span>));</span><br><span class="line"></span><br><span class="line">                ThreadUtil.safeSleep(<span class="number">1000</span>); <span class="comment">//模拟业务处理速度</span></span><br><span class="line">                channel.basicAck(deliveryTag,<span class="literal">false</span>);    <span class="comment">//不开启批量应答</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;连接中断&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>线程2，sleep 30s 模拟慢业务</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Work2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MQ_NAME</span> <span class="operator">=</span> <span class="string">&quot;work_queues&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> RabbitMQUtills.setpropertis(RabbitMQUtills.getConnectionFactory(),<span class="string">&quot;localhost&quot;</span>,<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;zyh&quot;</span>);</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel(RabbitMQUtills.getconnection(connectionFactory));</span><br><span class="line">        channel.queueDeclare(MQ_NAME,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;当前是线程2，执行时间是30s&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">auto_ack</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        channel.basicConsume(MQ_NAME, auto_ack, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> delivery.getEnvelope().getDeliveryTag(); <span class="comment">//对那个消息进行应答</span></span><br><span class="line">                System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(),<span class="string">&quot;utf8&quot;</span>));</span><br><span class="line"></span><br><span class="line">                ThreadUtil.safeSleep(<span class="number">30000</span>); <span class="comment">//模拟业务处理速度</span></span><br><span class="line">                channel.basicAck(deliveryTag,<span class="literal">false</span>);    <span class="comment">//不开启批量应答</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;连接中断&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>生产者</li>
</ul>
<p><img src="/../../images/image-20230207153602156.png" alt="image-20230207153602156"></p>
<ul>
<li>线程2，发送DD的时候终止</li>
</ul>
<p><img src="/../../images/image-20230207153622149.png" alt="image-20230207153622149"></p>
<ul>
<li>线程1</li>
</ul>
<p><img src="/../../images/image-20230207153645936.png" alt="image-20230207153645936"></p>
<p>BB会被接收是因为 sleep 30s才应答ack，但是30s内我又发了DD 并且发DD的同时中断了线程2，使得BB的ack没有返回所以会回到队头，重新分配给另一个线程执行。</p>
<h3 id="队列持久化"><a href="#队列持久化" class="headerlink" title="队列持久化"></a>队列持久化</h3><p>为了防止队列丢失，可以在创建队列的时候，将队列设置为需要持久化的，注意已经创建的队列如果是不允许持久化，不允许修改成允许持久化的，否则将报错，信息如下</p>
<p><img src="/../../images/image-20230207154235795.png" alt="image-20230207154235795"></p>
<p>需要创建一个新的</p>
<p><img src="/../../images/image-20230207154327991.png" alt="image-20230207154327991"></p>
<p>这样就表示这个队列需要进行持久化，这时候即使重启RabbitMQ这个队列也存在，但是这并不能保证消息不会丢失。</p>
<p>不持久化的队列也被称为临时队列。</p>
<h3 id="消息持久化"><a href="#消息持久化" class="headerlink" title="消息持久化"></a>消息持久化</h3><p>在消息发布的时候，可以通过一个参数对消息是否持久化进行设置</p>
<p><img src="/../../images/image-20230207155250475.png" alt="image-20230207155250475"></p>
<p> 表示对文本进行持久化，但是这也不能一定保证消息不会丢失，因为可能消息在持久化的时候出现了故障，那么消息还是会丢失的。</p>
<h3 id="不公平分发"><a href="#不公平分发" class="headerlink" title="不公平分发"></a>不公平分发</h3><p>默认情况下，RabbitMQ采用的是轮询分发策略，但是实际上这样并不是很合理，就比如上面消息丢失处理的例子一样，一个业务30s另一个1s，那么1s的那个线程就会变得空闲时间过长，分配不是很合理。</p>
<p>需要设置方式也很简单，只需要对所有消费者设置成不公平分发就行了。</p>
<p><img src="/../../images/image-20230207161117940.png" alt="image-20230207161117940"></p>
<h3 id="预取值"><a href="#预取值" class="headerlink" title="预取值"></a>预取值</h3><p>​	在消费者在完成业务的时候，并不是让他一定不会被分配到消息，而是能够让他最多能够在处理业务的期间内获取一定个数的待处理的消息。</p>
<p><img src="/../../images/image-20230207213102506.png" alt="image-20230207213102506"></p>
<ul>
<li>生产者</li>
</ul>
<p><img src="/../../images/image-20230207213934081.png" alt="image-20230207213934081"></p>
<ul>
<li><p>线程1</p>
<p><img src="/../../images/image-20230207213951841.png" alt="image-20230207213951841"></p>
</li>
<li><p>线程2</p>
<p><img src="/../../images/image-20230207214000626.png" alt="image-20230207214000626"></p>
</li>
</ul>
<p>可以发现 连续发送a-k，处理时间长的线程，在处理的过程中也可以获取一些消息。</p>
<h3 id="发布确认"><a href="#发布确认" class="headerlink" title="发布确认"></a>发布确认</h3><p>这是可以保证消息不丢失的一个机制。上面我们讲到过 队列持久化和消息持久化，能够解决部分消息丢失的情况，但是还是存在消息在持久化到磁盘的过程中可能出现异常，宕机等情况，那么这些消息还是丢失了。</p>
<p>而发布确认就是来解决这一情况的，这是当队列将消息持久化到磁盘上了，再向生产者发送一个确认信息，这样才能够确保消息不会丢失。</p>
<p>我们只需要再生产者创建信道的时候，使用channel.confirmSelect()， 就能够开启发布确认。</p>
<p><img src="/../../images/image-20230207215006854.png" alt="image-20230207215006854"></p>
<p>发布确认有三种方式：单个确认发布、批量确认发布、异步确认发布。</p>
<p>下面对比三种方式的时间开销</p>
<ul>
<li>单个确认发布：类似于计网中的停止等待协议，发送一个只有等到接收到确认信息之后才返回。这样的好处是你可以准确的知道到底是哪一条消息发送出错了，但是相应的执行效率就慢了。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">One_step_Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MQ_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, TimeoutException, IOException &#123;</span><br><span class="line">        one_step_publish();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">one_step_publish</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException, InterruptedException &#123;</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> RabbitMQUtills.getConnectionFactory();</span><br><span class="line">        connectionFactory = RabbitMQUtills.setpropertis(connectionFactory, <span class="string">&quot;localhost&quot;</span>, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;zyh&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">getconnection</span> <span class="operator">=</span> RabbitMQUtills.getconnection(connectionFactory);</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel(getconnection);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启发布确认</span></span><br><span class="line">        channel.confirmSelect();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">dureable</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        channel.queueDeclare(MQ_NAME,dureable,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> i+<span class="string">&quot;&quot;</span>;</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>,MQ_NAME,<span class="literal">true</span>,<span class="literal">null</span>,message.getBytes());</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> channel.waitForConfirms();</span><br><span class="line">            <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;消息发送成功&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;1000条消息花费&quot;</span>+(end-begin)+<span class="string">&quot;ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/image-20230207222415547.png" alt="image-20230207222415547"></p>
<p>可以看到 单步确认1000条消息花费了337 ms。</p>
<ul>
<li>批量确认，可以自定义选择在某个时间段或者是发送多少条后再等待确认，这样做的好处就在于执行速度上快了，但是相应的具体那条消息出现问题无从而知。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, TimeoutException, IOException &#123;</span><br><span class="line">    mulit_step_publish();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">mulit_step_publish</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException, InterruptedException &#123;</span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> RabbitMQUtills.getConnectionFactory();</span><br><span class="line">    connectionFactory = RabbitMQUtills.setpropertis(connectionFactory, <span class="string">&quot;localhost&quot;</span>, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;zyh&quot;</span>);</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">getconnection</span> <span class="operator">=</span> RabbitMQUtills.getconnection(connectionFactory);</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel(getconnection);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开启发布确认</span></span><br><span class="line">    channel.confirmSelect();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">dureable</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    channel.queueDeclare(MQ_NAME,dureable,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">batch_size</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> i+<span class="string">&quot;&quot;</span>;</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>,MQ_NAME,<span class="literal">true</span>,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">        <span class="keyword">if</span>(i%batch_size==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> channel.waitForConfirms();</span><br><span class="line">            <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;前100条消息发送成功&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;1000条消息花费&quot;</span>+(end-begin)+<span class="string">&quot;ms&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230207223043642.png" alt="image-20230207223043642"></p>
<p>可以很明显看到速度快了很多。</p>
<ul>
<li>异步发布确认</li>
</ul>
<p>他是利用回调函数来达到消息可靠性传递的，这个中间件也是通过函数回调来保证是否投递成功。 生产者将消息发送到channel中，需要对消息进行编号，然后回传给一个MQ，MQ就会对消息每一个成功和不成功都会发送一个应答信号，并且会附带上编号，通知生产者，生产者只需要一直发送，不需要关心哪个消息是否发送成功，对发送来的未确认信号的编号对应的消息再重发即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, TimeoutException, IOException &#123;</span><br><span class="line">    Ansc_publish();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Ansc_publish</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> RabbitMQUtills.getConnectionFactory();</span><br><span class="line">    connectionFactory = RabbitMQUtills.setpropertis(connectionFactory, <span class="string">&quot;localhost&quot;</span>, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;zyh&quot;</span>);</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">getconnection</span> <span class="operator">=</span> RabbitMQUtills.getconnection(connectionFactory);</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel(getconnection);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开启发布确认</span></span><br><span class="line">    channel.confirmSelect();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">dureable</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    channel.queueDeclare(MQ_NAME,dureable,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//需要开启一个监听器，来监听哪些消息发送成功哪些发送失败</span></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 1、成功信号的回调函数</span></span><br><span class="line"><span class="comment">     * 2、失败信号的回调函数</span></span><br><span class="line"><span class="comment">     * 另一个重载形式就是可以只要一个参数只监听成功了的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    channel.addConfirmListener(<span class="keyword">new</span> <span class="title class_">ConfirmCallback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(<span class="type">long</span> deliveryTag, <span class="type">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            System.out.println(deliveryTag+<span class="string">&quot;成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="keyword">new</span> <span class="title class_">ConfirmCallback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(<span class="type">long</span> deliveryTag, <span class="type">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            System.out.println(deliveryTag+<span class="string">&quot;失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> i+<span class="string">&quot;&quot;</span>;</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>,MQ_NAME,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;1000条消息花费&quot;</span>+(end-begin)+<span class="string">&quot;ms&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230208103626448.png" alt="image-20230208103626448"></p>
<p>由于是异步发送，所以生产者只管发送完1000条数据，速度最快。</p>
<p>但是现在有一个问题，成功的消息可以不做处理，但是我们上面的代码并没有对失败的消息进行处理，如何对失败的消息进行处理。 </p>
<p>1000条数据在中间的时候就已经发送完成，后续都是监听器线程对于应答消息的处理。所以很明显这是两个线程交替执行的一个过程，这两个线程对于未确认消息需要进行通信，最好的办法就是用一个基于内存的能被发布消息的线程访问的一个容器来存储未确认的消息，所以肯定需要的是Concurrentxxxx的容器</p>
<ul>
<li>思路：我们再发送的时候将所有的已发送的消息记录在Concurrentxxxx容器中，对于正确接收的消息将其从Concurrentxxxx容器中删除，剩下的就是未确认的消息。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, TimeoutException, IOException &#123;</span><br><span class="line">    Ansc_publish();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Ansc_publish</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> RabbitMQUtills.getConnectionFactory();</span><br><span class="line">    connectionFactory = RabbitMQUtills.setpropertis(connectionFactory, <span class="string">&quot;localhost&quot;</span>, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;zyh&quot;</span>);</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">getconnection</span> <span class="operator">=</span> RabbitMQUtills.getconnection(connectionFactory);</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel(getconnection);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开启发布确认</span></span><br><span class="line">    channel.confirmSelect();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">dureable</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    channel.queueDeclare(MQ_NAME,dureable,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ConcurrentHashMap&lt;Long,String&gt; map = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//需要开启一个监听器，来监听哪些消息发送成功哪些发送失败</span></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 1、成功信号的回调函数</span></span><br><span class="line"><span class="comment">     * 2、失败信号的回调函数</span></span><br><span class="line"><span class="comment">     * 另一个重载形式就是可以只要一个参数只监听成功了的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    channel.addConfirmListener(<span class="keyword">new</span> <span class="title class_">ConfirmCallback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(<span class="type">long</span> deliveryTag, <span class="type">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">            map.remove(deliveryTag);</span><br><span class="line">            System.out.println(deliveryTag+<span class="string">&quot;成功&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;map.size() = &quot;</span>+map.size());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="keyword">new</span> <span class="title class_">ConfirmCallback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(<span class="type">long</span> deliveryTag, <span class="type">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            System.out.println(deliveryTag+<span class="string">&quot;失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> i+<span class="string">&quot;&quot;</span>;</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>,MQ_NAME,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">        map.put(channel.getNextPublishSeqNo(),message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;1000条消息花费&quot;</span>+(end-begin)+<span class="string">&quot;ms&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="交换机"><a href="#交换机" class="headerlink" title="交换机"></a>交换机</h2><p>上面我们使用的一直都是默认的交换机，但是最开始我们也知道 MQ实际上是有 交换机 + 队列组成的。我们上面所有消息都只能被消费一次它的流程图大概是这样的：</p>
<p><img src="/../../images/image-20230208111406980.png" alt="image-20230208111406980"></p>
<p>但是如果我一定要消息被消费两次怎么办，那么就要使用到交换机，交换机会帮我们去路由当前这条消息要发给哪个队列，因此我们只需要将消息发给两个不同的交换机，交换机再绑定两个不同队列，这样同一条消息就能够发给两个队列被不同的消费者消费，但是同一个队列中的消息还是只能被消费一次的。</p>
<p><img src="/../../images/image-20230208111637123.png" alt="image-20230208111637123"></p>
<h3 id="交换机类型"><a href="#交换机类型" class="headerlink" title="交换机类型"></a>交换机类型</h3><p>​	RabbitMQ 消息传递模型的核心思想是: 生产者生产的消息从不会直接发送到队列。实际上，通常生产 者甚至都不知道这些消息传递传递到了哪些队列中。</p>
<p>​	相反，生产者只能将消息发送到交换机(exchange)，交换机工作的内容非常简单，一方面它接收来 自生产者的消息，另一方面将它们推入队列。交换机必须确切知道如何处理收到的消息。是应该把这些消 息放到特定队列还是说把他们到许多队列中还是说应该丢弃它们。这就的由交换机的类型来决定。</p>
<p>交换机类型包括：直接(direct，也叫里也有类型), 主题(topic) ,标题(headers，不常用) , 扇出(fanout，就是发布订阅类型)。也可以不指定交换机类型，RabbitMQ会使用默认的类型 用  “ “ 传递参数。</p>
<h3 id="绑定"><a href="#绑定" class="headerlink" title="绑定"></a>绑定</h3><p>交换机和队列可以通过一个 Routing key进行绑定，这个Routing key就是让交换机只去找某个或某些特定的队列，将消息发送给这个队列。</p>
<h2 id="fanout模式"><a href="#fanout模式" class="headerlink" title="fanout模式"></a>fanout模式</h2><p>Fanout 这种类型非常简单。正如从名称中猜到的那样，它是将接收到的所有消息广播到它知道的 所有队列中。</p>
<p><img src="/../../images/image-20230208125744027.png" alt="image-20230208125744027"></p>
<p>交换机和信道绑定同样的  Routing key，生产者将消息发送给 交换机，并且指定同样的 Routing key，那么所有消费者都可以接收到消息</p>
<ul>
<li>生产者</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel();</span><br><span class="line"></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME,<span class="string">&quot;fanout&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span>(scanner.hasNext())&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            channel.basicPublish(EXCHANGE_NAME,<span class="string">&quot;&quot;</span>,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;消息发送完成：&quot;</span>+message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>消费者（两个消费者代码完全一样）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consummer_1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/***</span></span><br><span class="line"><span class="comment">         *  创建一个交换机</span></span><br><span class="line"><span class="comment">         *  1、交换机名字</span></span><br><span class="line"><span class="comment">         *  2、交换机类型</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME,<span class="string">&quot;fanout&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//channel.queueDeclare()生成一个临时队列，名字是随机的，连接关闭就删除</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//交换机与队列绑定</span></span><br><span class="line">        channel.queueBind(queue,EXCHANGE_NAME,<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;消费者1，等待消息进行接收.......&quot;</span>);</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(queue, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String consumerTag, Delivery message)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;utf8&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String consumerTag)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;连接中断&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>生产者 测试</li>
</ul>
<p><img src="/../../images/image-20230208125956215.png" alt="image-20230208125956215"></p>
<ul>
<li>消费者1  测试</li>
</ul>
<p><img src="/../../images/image-20230208130015349.png" alt="image-20230208130015349"></p>
<ul>
<li>消费者2 测试</li>
</ul>
<p><img src="/../../images/image-20230208130025892.png" alt="image-20230208130025892"></p>
<ul>
<li>web界面、</li>
</ul>
<p><img src="/../../images/image-20230208130119493.png" alt="image-20230208130119493"></p>
<h2 id="direct-模式"><a href="#direct-模式" class="headerlink" title="direct 模式"></a>direct 模式</h2><p>fanout模式类似于是广播的一个形式，而direct则是通过 Routing key通过和某个队列进行绑定，生产者只会将消息发送给指定的 Routing key 队列。</p>
<p>还可以通过一下方式指定交换机的类型</p>
<p><img src="/../../images/image-20230209202109375.png" alt="image-20230209202109375"></p>
<ul>
<li>生产者，只需要改变交换机类型</li>
</ul>
<p><img src="/../../images/image-20230209202520834.png" alt="image-20230209202520834"></p>
<ul>
<li>消费者，也只需要改变交换机类型</li>
</ul>
<p><img src="/../../images/image-20230209202537371.png" alt="image-20230209202537371"></p>
<p><img src="/../../images/image-20230209202543829.png" alt="image-20230209202543829"></p>
<p>注：一个交换机可以绑定多个信道，调用多次  channel.queueBind(queue,EXCHANGE_NAME,”consumer1”);</p>
<h2 id="Topic-模式"><a href="#Topic-模式" class="headerlink" title="Topic 模式"></a>Topic 模式</h2><p>​	direct 交换机增加了消息发送和接收的自定义性，但是还不是特别的完美，就比如说我们希望有写消息可以被两个队列同时收到，又有些只希望被一个队列收到，我们没法指定一些筛选条件。 这也是Topic交换机的优势所在。</p>
<p>  发送到类型是 topic 交换机的消息的 routing_key 不能随意写，必须满足一定的要求，它必须是一个单 词列表，以点号分隔开。这些单词可以是任意单词，比如说：”stock.usd.nyse”, “nyse.vmw”, “quick.orange.rabbit”.这种类型的。当然这个单词列表最多不能超过 255 个字节。</p>
<p>可以用通配符进行占位：</p>
<p>*(星号)可以代替一个单词</p>
<p> #(井号)可以替代零个或多个单词</p>
<p>下图绑定关系如下 </p>
<p>Q1–&gt;绑定的是 中间带 orange 带 3 个单词的字符串( * .orange. * ) </p>
<p>Q2–&gt;绑定的是 最后一个单词是 rabbit 的 3 个单词( * . * .rabbit) 第一个单词是 lazy 的多个单词(lazy.#)</p>
<p><img src="/../../images/image-20230210120132531.png" alt="image-20230210120132531"></p>
<p>当一个队列绑定键是#,那么这个队列将接收所有数据，就有点像 fanout 了 </p>
<p>如果队列绑定键当中没有#和*出现，那么该队列绑定类型就是 direct 了</p>
<p>所以Topic 可以替换前两个交换机。</p>
<ul>
<li>生产者</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;topic_logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel();</span><br><span class="line"></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;生产者准备发送消息.....&quot;</span>);</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span>(scanner.hasNext())&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            <span class="type">String</span> <span class="variable">routing_key</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            channel.basicPublish(EXCHANGE_NAME,routing_key,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;发送给&quot;</span>+routing_key+<span class="string">&quot;的队列的内容为&quot;</span>+message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230210122335825.png" alt="image-20230210122335825"></p>
<ul>
<li>消费者1</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">consumer_1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;topic_logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel();</span><br><span class="line"></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line"></span><br><span class="line">        channel.queueBind(queue,EXCHANGE_NAME,<span class="string">&quot;*.orange.*&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;消费者1，绑定的routing key为：*.orange.*&quot;</span>);</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(queue, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String consumerTag, Delivery message)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;接收的消息是&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;utf8&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String consumerTag)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230210122347123.png" alt="image-20230210122347123"></p>
<ul>
<li>消费者2</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">consumer_2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;topic_logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel();</span><br><span class="line"></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line"></span><br><span class="line">        channel.queueBind(queue,EXCHANGE_NAME,<span class="string">&quot;*.*.rabbit&quot;</span>);</span><br><span class="line">        channel.queueBind(queue,EXCHANGE_NAME,<span class="string">&quot;lazy.#&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;消费者2，绑定的routing key为：*.*.rabbit和lazy.#&quot;</span>);</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(queue, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String consumerTag, Delivery message)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;接收的消息是&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;utf8&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String consumerTag)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230210122354610.png" alt="image-20230210122354610"></p>
<h2 id="死信队列"><a href="#死信队列" class="headerlink" title="死信队列"></a>死信队列</h2><p>死信：无法被消费的消息。consumer 从 queue 取出消息 进行消费，但某些时候由于特定的原因导致 queue 中的某些消息无法被消费，这样的消息如果没有 后续的处理，就变成了死信，有死信自然就有了死信队列。</p>
<p>应用场景:为了保证订单业务的消息数据不丢失，需要使用到 RabbitMQ 的死信队列机制，当消息 消费发生异常时，将消息投入死信队列中.还有比如说: 用户在商城下单成功并点击去支付后在指定时 间未支付时自动失效。</p>
<p>死信来源：</p>
<ul>
<li>消息TTL 过期 </li>
<li>队列达到最大长度(队列满了，无法再添加数据到 mq 中) </li>
<li>消息被拒绝(basic.reject 或 basic.nack)并且 requeue&#x3D;false（不放回队列中）</li>
</ul>
<h3 id="消息TTL-过期"><a href="#消息TTL-过期" class="headerlink" title="消息TTL 过期"></a>消息TTL 过期</h3><ul>
<li>生产者：将消息发送给  普通交换机，普通交换机和普通队列的routing key是 zhangsan，设置消息过期时间。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;dead_logs&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置消息过期时间，成为死信</span></span><br><span class="line">        AMQP.<span class="type">BasicProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties().builder().expiration(<span class="string">&quot;10000&quot;</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(scanner.hasNext())&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            channel.basicPublish(EXCHANGE_NAME,<span class="string">&quot;zhangsan&quot;</span>,properties,message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;发送了消息&quot;</span>+message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>消费者1：消费来自普通 队列的消息，给普通队列绑定一个死信队列，让死信可以转发给死信队列。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">consumer_1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;dead_logs&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;normal_queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;dead_exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;dead_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//声明普通和死信交换机</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">        channel.exchangeDeclare(DEAD_EXCHANGE,BuiltinExchangeType.DIRECT);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//死信队列</span></span><br><span class="line">        channel.queueDeclare(DEAD_QUEUE,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//死信队列和死信交换机进行绑定</span></span><br><span class="line">        channel.queueBind(DEAD_QUEUE,DEAD_EXCHANGE,<span class="string">&quot;lisi&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//声明普通队列</span></span><br><span class="line">        <span class="comment">/***</span></span><br><span class="line"><span class="comment">         * 这里的普通队列和之前的不一样</span></span><br><span class="line"><span class="comment">         * 因为这里的队列需要在某些特殊情况将消息发送给死信交换机</span></span><br><span class="line"><span class="comment">         * 所以我们需要让这个队列知道自己绑定了哪个死信交换机</span></span><br><span class="line"><span class="comment">         * 要用到的就是最后一个 map参数，并且map的 key是固定的</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//绑定死信交换机</span></span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>,DEAD_EXCHANGE);</span><br><span class="line">        <span class="comment">//死信交换机将消息转发给哪个队列</span></span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>,<span class="string">&quot;lisi&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//可以指定成为死信的条件 如：过期时间,一般在生产者方指定</span></span><br><span class="line">        <span class="comment">//map.put(&quot;x-message-ttl&quot;,10000);</span></span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,map);</span><br><span class="line">        <span class="comment">//普通交换机绑定routing key</span></span><br><span class="line">        channel.queueBind(QUEUE_NAME,EXCHANGE_NAME,<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;等待接收消息........&quot;</span>);</span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String consumerTag, Delivery message)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;接收到了&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;utf8&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String consumerTag)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>消费者2：消费来自死信队列的信息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">consumer_2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;dead_exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;dead_queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> RabbitMQUtills.getChannel();</span><br><span class="line">        channel.basicConsume(DEAD_QUEUE, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String consumerTag, Delivery message)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;接收来自死信交换机的消息：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;utf8&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String consumerTag)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>生产者发送：</li>
</ul>
<p><img src="/../../images/image-20230210172305402.png" alt="image-20230210172305402"></p>
<ul>
<li>消费者1，启动后关闭</li>
</ul>
<p><img src="/../../images/image-20230210172324668.png" alt="image-20230210172324668"></p>
<ul>
<li>消费者2：接收死信消息</li>
</ul>
<p><img src="/../../images/image-20230210172339662.png" alt="image-20230210172339662"></p>
<ul>
<li>web控制界面</li>
</ul>
<p><img src="/../../images/image-20230210172509525.png" alt="image-20230210172509525"></p>
<h3 id="队列达到最大长度"><a href="#队列达到最大长度" class="headerlink" title="队列达到最大长度"></a>队列达到最大长度</h3><p>我们只需要在创建 普通队列时候指定，队列的最大长度</p>
<p><img src="/../../images/image-20230210190341615.png" alt="image-20230210190341615"></p>
<p>同样启动的时候会报错，因为我们之前已经声明好了这个队列，我们不能够改变他的设置，只能够将原来的删除，重新声明。</p>
<ul>
<li>生产者</li>
</ul>
<p><img src="/../../images/image-20230210191357918.png" alt="image-20230210191357918"></p>
<ul>
<li>消费者1： 为什么不是 先进先出？ 说明这里积压的消息会根据先进先出交给死信队列，而不是后面来的消息进入死信队列。</li>
</ul>
<p><img src="/../../images/image-20230210191424360.png" alt="image-20230210191424360"></p>
<ul>
<li>消费者2：</li>
</ul>
<p><img src="/../../images/image-20230210191440252.png" alt="image-20230210191440252"></p>
<h3 id="消息被拒"><a href="#消息被拒" class="headerlink" title="消息被拒"></a>消息被拒</h3><ul>
<li>消费者1</li>
</ul>
<p><img src="/../../images/image-20230210193047974.png" alt="image-20230210193047974"></p>
<ul>
<li>生产者</li>
</ul>
<p><img src="/../../images/image-20230210193105509.png" alt="image-20230210193105509"></p>
<ul>
<li>消费者1</li>
</ul>
<p><img src="/../../images/image-20230210193116963.png" alt="image-20230210193116963"></p>
<ul>
<li>消费者2</li>
</ul>
<p><img src="/../../images/image-20230210193126207.png" alt="image-20230210193126207"></p>
<h1 id="整合SpringBoot"><a href="#整合SpringBoot" class="headerlink" title="整合SpringBoot"></a>整合SpringBoot</h1><h2 id="延迟队列"><a href="#延迟队列" class="headerlink" title="延迟队列"></a>延迟队列</h2><p>上面消息TTL过期的例子，如果消费者1，一直不存在或者宕机，那么生产者的消息对于死信队列的消费者来说就是一个延迟的队列，里面的消息也按照顺序的在一定时间后被执行，这实际上在实际中也是很有利用场景的。先整合SpringBoot之后在对其进行演示。</p>
<p><img src="/../../images/image-20230210193551697.png" alt="image-20230210193551697"></p>
<ul>
<li>依赖：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>yml 配置</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br></pre></td></tr></table></figure>





<p>我们上面好多交换机 队列配置都是会放在消费者和生产者的代码中的，难免看起来有些笨重。整合SpringBoot之后，生产者 只负责发，消费者只负责消费，一些交换机和队列的配置都放在配置类里面完成。</p>
<p><img src="/../../images/image-20230210230236183.png" alt="image-20230210230236183"></p>
<p>这个是一个延迟队列的一个架构图，下面是对这个架构图完成的配置。</p>
<ul>
<li>配置类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;X&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_ECHANGE</span> <span class="operator">=</span> <span class="string">&quot;Y&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUENE_1</span> <span class="operator">=</span> <span class="string">&quot;A&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUENE_2</span> <span class="operator">=</span> <span class="string">&quot;B&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;QD&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_X_A</span> <span class="operator">=</span> <span class="string">&quot;XA&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_X_B</span> <span class="operator">=</span> <span class="string">&quot;XB&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_A_B_DEAD</span> <span class="operator">=</span> <span class="string">&quot;YD&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_DEAD_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;YD&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 声明直接交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;xexchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">xExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(EXCHANGE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;yexchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">yExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(DEAD_ECHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 声明队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;queueA&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueA</span><span class="params">()</span>&#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>,DEAD_ECHANGE);</span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>,KEY_A_B_DEAD);</span><br><span class="line">        <span class="comment">//声明队列的 TTL</span></span><br><span class="line">        map.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUENE_1).withArguments(map).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;queueB&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueB</span><span class="params">()</span>&#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>,DEAD_ECHANGE);</span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>,KEY_A_B_DEAD);</span><br><span class="line">        <span class="comment">//声明队列的 TTL</span></span><br><span class="line">        map.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">40000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUENE_2).withArguments(map).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;queueQD&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueQD</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(DEAD_QUEUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 队列和交换绑定</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queueAbingdingX</span><span class="params">(<span class="meta">@Qualifier(&quot;queueA&quot;)</span> Queue queueA,<span class="meta">@Qualifier(&quot;xexchange&quot;)</span> DirectExchange xexchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queueA).to(xexchange).with(KEY_X_A);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queueBbindingx</span><span class="params">(<span class="meta">@Qualifier(&quot;queueB&quot;)</span> Queue queueB,<span class="meta">@Qualifier(&quot;xexchange&quot;)</span> DirectExchange xexchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queueB).to(xexchange).with(KEY_X_B);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">queueQDbindingY</span><span class="params">(<span class="meta">@Qualifier(&quot;queueQD&quot;)</span> Queue queueQD,<span class="meta">@Qualifier(&quot;yexchange&quot;)</span> DirectExchange yexchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queueQD).to(yexchange).with(KEY_DEAD_QUEUE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>生产者，其实就是一个Controller去传递要发送的消息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SendMessageController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/send/&#123;message&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@PathVariable</span> String message)</span>&#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;当前时间&#123;&#125;,发送了&#123;&#125;&quot;</span>,<span class="keyword">new</span> <span class="title class_">Date</span>().toString(),message);</span><br><span class="line">        <span class="comment">/***</span></span><br><span class="line"><span class="comment">         * 1、exchange</span></span><br><span class="line"><span class="comment">         * 2、Routing key</span></span><br><span class="line"><span class="comment">         * 3、message object</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;X&quot;</span>,<span class="string">&quot;XA&quot;</span>,<span class="string">&quot;来自10s的队列的消息&quot;</span>+message);</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;X&quot;</span>,<span class="string">&quot;XB&quot;</span>,<span class="string">&quot;来自40s的队列的消息&quot;</span>+message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>消费者，是一个监听器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dead_Letter_Listener</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//监听哪个 队列</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;QD&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveD</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> UnsupportedEncodingException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;当前时间&#123;&#125;,收到了&#123;&#125;&quot;</span>,<span class="keyword">new</span> <span class="title class_">Date</span>().toString(),<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;utf8&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>h ttp:&#x2F;&#x2F;localhost:8080&#x2F;ttl&#x2F;send&#x2F;helloworld<br><img src="/../../images/image-20230211085656289.png" alt="image-20230211085656289"></li>
</ul>
<p>​	上面我们实现了一个延迟队列的案例，但是好像还是有一些问题，如果我现在要增加一个延时时间为30s的队列，我是不是又要自己去增加？ 那每次新增一个新的延迟就要重新增加一个队列岂不是很麻烦。</p>
<pre><code> 我们之前也说到过过期时间一般会由生产者来指定，所以我们一般会建立一个没有时间限制的队列，让生产者在传递参数的时候，将TTL传递给后端。下面是新的延迟队列的一个架构图
</code></pre>
<p><img src="/../../images/image-20230211090305305.png" alt="image-20230211090305305"></p>
<ul>
<li>新增QC的配置</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(&quot;queueC&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">queueC</span><span class="params">()</span>&#123;</span><br><span class="line">    HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>,DEAD_ECHANGE);</span><br><span class="line">    map.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>,KEY_DEAD_QUEUE);</span><br><span class="line">    <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;QC&quot;</span>).withArguments(map).build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">queueQCbingdingX</span><span class="params">(<span class="meta">@Qualifier(&quot;queueC&quot;)</span> Queue queue,<span class="meta">@Qualifier(&quot;xexchange&quot;)</span> DirectExchange xexchange)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(queue).to(xexchange).with(<span class="string">&quot;XC&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>生产者</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/send/&#123;ttl&#125;/&#123;message&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsgWithTtl</span><span class="params">(<span class="meta">@PathVariable(&quot;ttl&quot;)</span> <span class="keyword">final</span> String ttl, <span class="meta">@PathVariable(&quot;message&quot;)</span> String message)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;当前时间&#123;&#125;,设置的ttl为:&#123;&#125;,发送了:&#123;&#125;&quot;</span>,<span class="keyword">new</span> <span class="title class_">Date</span>().toString(),ttl,message);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 另一种重载形式</span></span><br><span class="line"><span class="comment">     * 第四个参数 是可以对消息的某些属性进行设置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;X&quot;</span>, <span class="string">&quot;XC&quot;</span>, message, <span class="keyword">new</span> <span class="title class_">MessagePostProcessor</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> Message <span class="title function_">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException &#123;</span><br><span class="line">            message.getMessageProperties().setExpiration(ttl);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>h ttp:&#x2F;&#x2F;localhost:8080&#x2F;ttl&#x2F;send&#x2F;2000&#x2F;延迟2s</li>
</ul>
<p><img src="/../../images/image-20230211092354499.png" alt="image-20230211092354499"></p>
<p>上面的测试看起来似乎是非常合理的，并且也达到了我们的目的，但是我们连续发送两个请求，先发送10s的延迟，在发送2s的延迟</p>
<p><img src="/../../images/image-20230211092733199.png" alt="image-20230211092733199"></p>
<p>​	会发现，明明应该先到的2s的延迟居然等第一条发送完成后才会到来，说明延迟队列也是按照FIFO的。也就是说RabbitMQ会一次检查到来的消息是否过期，这也导致有很多消息可能不会按时 “死亡” 进入死信队列。这也是基于死信队列来做延迟队列最大的问题。</p>
<h2 id="延迟插件"><a href="#延迟插件" class="headerlink" title="延迟插件"></a>延迟插件</h2><p>以上问题可以通过一个 RabbitMQ 的插件来解决，在官网上下载 <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/community-plugins.html%EF%BC%8C%E4%B8%8B%E8%BD%BD">https://www.rabbitmq.com/community-plugins.html，下载</a> rabbitmq_delayed_message_exchange 插件，然后解压放置到 RabbitMQ 的插件目录。</p>
<p><img src="/../../images/image-20230211095311331.png" alt="image-20230211095311331"></p>
<p>windows下安装要回到  sbin目录下，执行 rabbitmq-plugins enable rabbitmq_delayed_message_exchange</p>
<p>命令。</p>
<p>重启后可以在新建交换机界面看到 一个新的交换机的类型。</p>
<p><img src="/../../images/image-20230211095409290.png" alt="image-20230211095409290"></p>
<p>使用这个插件后，我们从上面的延迟队列变成了延迟交换机，也就是说延迟不再有队列来管理，而是由交换机来管理。</p>
<ul>
<li>基于死信队列的工作流程</li>
</ul>
<p><img src="/../../images/image-20230211095542422.png" alt="image-20230211095542422"></p>
<ul>
<li>基于插件的延迟队列工作流程</li>
</ul>
<p><img src="/../../images/image-20230211095608892.png" alt="image-20230211095608892"></p>
<h3 id="基于插件的绑定关系"><a href="#基于插件的绑定关系" class="headerlink" title="基于插件的绑定关系"></a>基于插件的绑定关系</h3><p><img src="/../../images/image-20230211102430822.png" alt="image-20230211102430822"></p>
<ul>
<li>配置类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;delayed.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;delayed.routingkey&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;delayed.queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(QUEUE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomExchange <span class="title function_">exchange</span><span class="params">()</span>&#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;x-delayed-type&quot;</span>,<span class="string">&quot;direct&quot;</span>); <span class="comment">//  延迟类型</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/***</span></span><br><span class="line"><span class="comment">         * 1、交换机名字</span></span><br><span class="line"><span class="comment">         * 2、交换机的类型</span></span><br><span class="line"><span class="comment">         * 3、是否持久化</span></span><br><span class="line"><span class="comment">         * 4、是否自动删除</span></span><br><span class="line"><span class="comment">         * 5、额外参数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(EXCHANGE_NAME,<span class="string">&quot;x-delayed-message&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding</span><span class="params">(<span class="meta">@Autowired</span> Queue queue,<span class="meta">@Autowired</span> CustomExchange exchange)</span>&#123;</span><br><span class="line">        <span class="comment">//自定义交换机 绑定时需要调用 noargs 进行创建。</span></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(ROUTING_KEY).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SendMessageController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/send/&#123;message&#125;/&#123;delay&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@PathVariable</span> String message,<span class="meta">@PathVariable</span> <span class="keyword">final</span> Integer delay)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;当前时间&#123;&#125;,发送了&#123;&#125;,延迟时间为&#123;&#125;&quot;</span>,<span class="keyword">new</span> <span class="title class_">Date</span>().toString(),message,delay);</span><br><span class="line"></span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE_NAME, RabbitMQConfig.ROUTING_KEY, message, <span class="keyword">new</span> <span class="title class_">MessagePostProcessor</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> Message <span class="title function_">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException &#123;</span><br><span class="line">                <span class="comment">//设置延迟时间和上面基于死信队列的有所不同</span></span><br><span class="line">                message.getMessageProperties().setDelay(delay);</span><br><span class="line">                <span class="keyword">return</span> message;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<p><img src="/../../images/image-20230211103926366.png" alt="image-20230211103926366"></p>
<p>可以看到先发送延迟10s，也不会出现短延迟的慢执行了。</p>
<h2 id="MQ出现异常"><a href="#MQ出现异常" class="headerlink" title="MQ出现异常"></a>MQ出现异常</h2><p>​	前面我们在讨论持久化的时候，讨论过了消息丢失的各种情况，但是这些都是在消费者方会出现的问题，但是如果我在生产者部分就已经出现消息丢失，那后续的持久化方式和操作都变得没用了。</p>
<p>​	发送消息可能出错的阶段包括两个：	</p>
<ul>
<li>交换机无法从生产者那得到消息</li>
<li>队列无法从交换机那得到消息</li>
</ul>
<h3 id="交换机无法从生产者那得到消息"><a href="#交换机无法从生产者那得到消息" class="headerlink" title="交换机无法从生产者那得到消息"></a>交换机无法从生产者那得到消息</h3><p>简单搭建一下下面案例的环境</p>
<p><img src="/../../images/image-20230211123734570.png" alt="image-20230211123734570"></p>
<ul>
<li>配置类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;confirm.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;key1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_NAME).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">directExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(EXCHANGE_NAME,<span class="literal">true</span>,<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding</span><span class="params">(<span class="meta">@Autowired</span> Queue queue,<span class="meta">@Autowired</span> DirectExchange directExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(directExchange).with(ROUTING_KEY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>controller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;message&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">(<span class="meta">@PathVariable</span> String message)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;发送了&#123;&#125;&quot;</span>,message);</span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE_NAME,RabbitMQConfig.ROUTING_KEY,message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>consumer</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.QUEUE_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getmsg</span><span class="params">(Message message)</span> <span class="keyword">throws</span> UnsupportedEncodingException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;接收到&#123;&#125;&quot;</span>,<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;utf8&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230211124110871.png" alt="image-20230211124110871"></p>
<p>上面是正常的情况，但是我们上面也说过交换机可能会接受不到消息，所以为了避免这种情况我们希望，交换机无论有没有接收到消息最好都能够通知生产者。这就要用到RabbitTemplate中的一个内部的接口：</p>
<p><img src="/../../images/image-20230211124454736.png" alt="image-20230211124454736"></p>
<p>我们只要实现了这个接口交换机就可以对生产者的消息进行处理，无论失败或者成功都会调用这个方法。要是这个方法能够生效还需要在yml文件中进行配置，</p>
<p>spring.rabbitmq.publisher-confirm-type&#x3D;correlated </p>
<ul>
<li><p>NONE 禁用发布确认模式，是默认值 </p>
</li>
<li><p>CORRELATED 发布消息成功到交换器后会触发回调方法</p>
</li>
<li><p>SIMPLE  经测试有两种效果，其一效果和 CORRELATED 值一样会触发回调方法， 其二在发布消息成功后使用 rabbitTemplate 调用 waitForConfirms 或 waitForConfirmsOrDie 方法 等待 broker 节点返回发送结果，根据返回结果来判定下一步的逻辑，要注意的点是 waitForConfirmsOrDie 方法如果返回 false 则会关闭 channel，则接下来无法发送消息到 MQ</p>
</li>
<li><p>yml</p>
</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span></span><br></pre></td></tr></table></figure>



<ul>
<li>实现ConfirmCallback接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfirmCallback</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//correlationData 包含了id和内容等相关信息</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> flag, String reason)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(!flag)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.info(<span class="string">&quot;第&quot;</span>+correlationData.getId()+<span class="string">&quot;条消息&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(correlationData.getReturnedMessage().getBody(),<span class="string">&quot;utf8&quot;</span>)+<span class="string">&quot;交换机接收失败，原因&#123;&#125;&quot;</span>,reason);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            log.info(<span class="string">&quot;第&quot;</span>+correlationData.getId()+<span class="string">&quot;条消息&quot;</span>+<span class="string">&quot;消息交换机接收成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>测试</li>
</ul>
<p><img src="/../../images/image-20230211131622587.png" alt="image-20230211131622587"></p>
<p>发现并没有生效，why？</p>
<p>因为我们的确认回调方法是RabbitTemplate里的一个内部的接口，我们在外面实现了这个接口，并不会被调用，还需要将我们的实现类注入到RabbitTemplate的内部接口中。</p>
<p><img src="/../../images/image-20230211131853940.png" alt="image-20230211131853940"></p>
<p>我们需要把RabbitTmplate 注入，并设置回调函数的值，并且为了保证 init 方法会被执行，需要加上@PostConstruct 注解，表示类创建完之后会调用这个方法，也为了避免 RabbitTemplate 还没被注入就调用init方法。</p>
<p>再测试</p>
<p><img src="/../../images/image-20230211132710222.png" alt="image-20230211132710222"></p>
<p>报了空指针异常 ，CorrelationData correlationData 对象为空。 这又是为什么？</p>
<p>因为这个参数是需要我们自己进行封装的，并且在生产者发送消息的时候将这个对象一起发送过来，我们看到rabbitTemplate.convertAndSend 方法有以下的重载形式：</p>
<p><img src="/../../images/image-20230211132923302.png" alt="image-20230211132923302"></p>
<p>这个就是我们实现类中需要接收的对象，</p>
<p><img src="/../../images/image-20230211133030268.png" alt="image-20230211133030268"></p>
<p>我们可以将 id并且只能将id封装成CorrelationData 类型，再进行发送。</p>
<p><img src="/../../images/image-20230211133313842.png" alt="image-20230211133313842"></p>
<p>再进行测试</p>
<p><img src="/../../images/image-20230211133337294.png" alt="image-20230211133337294"></p>
<p>这样成功接收的消息交换机会进行调用，</p>
<p>我们将交换机名字故意输错，在进行测试</p>
<p><img src="/../../images/image-20230211133722513.png" alt="image-20230211133722513"></p>
<p>他会提示出错误的原因。</p>
<h3 id="队列无法从交换机那得到消息"><a href="#队列无法从交换机那得到消息" class="headerlink" title="队列无法从交换机那得到消息"></a>队列无法从交换机那得到消息</h3><p>解决方法和上面的其实类似，都是通过RabbiTemplate中的内部接口。</p>
<ul>
<li>yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span>		<span class="comment">#表示队列没有接收到消息要将消息回退到交换机</span></span><br></pre></td></tr></table></figure>





<ul>
<li>实现内部接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfirmCallback</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback,RabbitTemplate.ReturnCallback &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span>  RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">    rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">    rabbitTemplate.setReturnCallback(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(Message message, <span class="type">int</span> replyCode, String replyText, String exchange, String routingKey)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;消息&#123;&#125;,被交换机&#123;&#125;退回，原因：&#123;&#125;，路由key：&#123;&#125;&quot;</span>,<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;utf8&quot;</span>),exchange,replyText,routingKey);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h2 id="幂等性"><a href="#幂等性" class="headerlink" title="幂等性"></a>幂等性</h2><p>​	幂等性实际上就是消息的重复消费，消费者再消费完了MQ中的某条消息之后，返回ack时，由于网络等问题，ack丢失，导致MQ认为消息未被消费，于是再发送了一次消息给消费者，但是实际上消费者已经消费过这条消息，从而导致消息的重复消费。</p>
<ul>
<li>解决思路：使用一个全局唯一的id，消费者可以通过id来判断这个id是否被消费过。也可以使用redis，redis中的setnx 天然具备幂等性，一定不会出现重复消费。</li>
</ul>
<h2 id="惰性队列"><a href="#惰性队列" class="headerlink" title="惰性队列"></a>惰性队列</h2><p>惰性队列指的是，MQ将数据先写到磁盘上，然后消费者要使用的时候MQ从磁盘中将消息读入内存，再被消费者消费。这样的速度当然很慢，但是也有一定的应用场景，那就是当消费者宕机了之后，MQ中的消息大量积压就可以使用惰性队列，将数据先存入磁盘要的时候再取。这时候MQ中只会存放到内存中消息保存的索引，从而减小MQ内存的消耗。</p>
<h2 id="注解实现绑定"><a href="#注解实现绑定" class="headerlink" title="注解实现绑定"></a>注解实现绑定</h2><p>上面的一些例子都是通过配置文件来实现的，下面介绍通过注解来实现队列、交换机的绑定。</p>
<ul>
<li>contrller</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/send&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendmess</span><span class="params">()</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> Result.ok(mqService.sendMessage(<span class="string">&quot;exchange.confirm&quot;</span>,<span class="string">&quot;routingkey.confirm&quot;</span>,<span class="string">&quot;哈哈哈哈哈&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>listenner</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(value = &quot;exchange.confirm&quot;,autoDelete = &quot;false&quot;),</span></span><br><span class="line"><span class="meta">        value = @Queue(value = &quot;queue.confirm&quot;,durable = &quot;true&quot;,autoDelete = &quot;false&quot;),</span></span><br><span class="line"><span class="meta">        key = &#123;&quot;routingkey.confirm&quot;&#125;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getmessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;收到来自队列的消息：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(),<span class="string">&quot;UTF8&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//手动响应，指定对那个消息，和是否开启批量确认</span></span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@QueueBinding注解去绑定交换机、队列和routingkey。</p>
<h1 id="Go操作RabbitMQ"><a href="#Go操作RabbitMQ" class="headerlink" title="Go操作RabbitMQ"></a>Go操作RabbitMQ</h1><ul>
<li>导包</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;github.com/streadway/amqp&quot;</span></span><br></pre></td></tr></table></figure>



<p>每个模式的例子我们都写一个封装RabbitMQ的文件，和其他生产者、消费者。</p>
<p>和Java有些许不同，Go的MQ客户端指定Url的方式是下面这样的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 连接信息&quot;amqp://guest:guest@127.0.0.1:5672/&quot;这个信息是固定不变的amqp://事固定参数后面两个是用户名密码ip地址端口号Virtual Host</span></span><br><span class="line"><span class="keyword">const</span> MQURL = <span class="string">&quot;amqp://guest:guest@127.0.0.1:5672/&quot;</span></span><br></pre></td></tr></table></figure>



<p>封装MQ包含的内容的结构体</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rabbitMQ结构体</span></span><br><span class="line"><span class="keyword">type</span> RabbitMQ <span class="keyword">struct</span> &#123;</span><br><span class="line">    conn    *amqp.Connection</span><br><span class="line">    channel *amqp.Channel</span><br><span class="line">    <span class="comment">//队列名称</span></span><br><span class="line">    QueueName <span class="type">string</span></span><br><span class="line">    <span class="comment">//交换机名称</span></span><br><span class="line">    Exchange <span class="type">string</span></span><br><span class="line">    <span class="comment">//bind Key 名称</span></span><br><span class="line">    Key <span class="type">string</span></span><br><span class="line">    <span class="comment">//连接信息</span></span><br><span class="line">    Mqurl <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>根据队列名、交换机名、路由key创建出MQ对象</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建结构体实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRabbitMQ</span><span class="params">(queueName <span class="type">string</span>, exchange <span class="type">string</span>, key <span class="type">string</span>)</span></span> *RabbitMQ &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;RabbitMQ&#123;QueueName: queueName, Exchange: exchange, Key: key, Mqurl: MQURL&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>销毁和错误处理函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 断开channel 和 connection</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RabbitMQ)</span></span> Destory() &#123;</span><br><span class="line">    r.channel.Close()</span><br><span class="line">    r.conn.Close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RabbitMQ)</span></span> failOnErr(err <span class="type">error</span>, message <span class="type">string</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       log.Fatalf(<span class="string">&quot;%s:%s&quot;</span>, message, err)</span><br><span class="line">       <span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;%s:%s&quot;</span>, message, err))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Simple模式"><a href="#Simple模式" class="headerlink" title="Simple模式"></a>Simple模式</h2><ul>
<li>Simple模式下创建MQ对象</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建简单模式下RabbitMQ实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRabbitMQSimple</span><span class="params">(queueName <span class="type">string</span>)</span></span> *RabbitMQ &#123;</span><br><span class="line">    <span class="comment">//创建RabbitMQ实例,Simple模式下没有交换机和key</span></span><br><span class="line">    rabbitmq := NewRabbitMQ(queueName, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">    <span class="comment">//获取connection</span></span><br><span class="line">    rabbitmq.conn, err = amqp.Dial(rabbitmq.Mqurl)</span><br><span class="line">    rabbitmq.failOnErr(err, <span class="string">&quot;failed to connect rabb&quot;</span>+</span><br><span class="line">       <span class="string">&quot;itmq!&quot;</span>)</span><br><span class="line">    <span class="comment">//获取channel</span></span><br><span class="line">    rabbitmq.channel, err = rabbitmq.conn.Channel()</span><br><span class="line">    rabbitmq.failOnErr(err, <span class="string">&quot;failed to open a channel&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> rabbitmq</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>Simple模式下的生产函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接模式队列生产</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RabbitMQ)</span></span> PublishSimple(message <span class="type">string</span>) &#123;</span><br><span class="line">    <span class="comment">//1.申请队列，如果队列不存在会自动创建，存在则跳过创建</span></span><br><span class="line">    _, err := r.channel.QueueDeclare(</span><br><span class="line">        r.QueueName,</span><br><span class="line">        <span class="comment">//是否持久化</span></span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="comment">//是否自动删除</span></span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="comment">//是否具有排他性</span></span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="comment">//是否阻塞处理</span></span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="comment">//额外的属性</span></span><br><span class="line">        <span class="literal">nil</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//调用channel 发送消息到队列中</span></span><br><span class="line">    r.channel.Publish(</span><br><span class="line">        r.Exchange,</span><br><span class="line">        r.QueueName,</span><br><span class="line">        <span class="comment">//如果为true，根据自身exchange类型和routekey规则无法找到符合条件的队列会把消息返还给发送者</span></span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="comment">//如果为true，当exchange发送消息到队列后发现队列上没有消费者，则会把消息返还给发送者</span></span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="comment">// 纯文本形式发送</span></span><br><span class="line">        amqp.Publishing&#123;</span><br><span class="line">            ContentType: <span class="string">&quot;text/plain&quot;</span>,</span><br><span class="line">            Body:        []<span class="type">byte</span>(message),</span><br><span class="line">        &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<ul>
<li>Simple下消费函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// simple 模式下消费者</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RabbitMQ)</span></span> ConsumeSimple() &#123;</span><br><span class="line">    <span class="comment">//1.申请队列，如果队列不存在会自动创建，存在则跳过创建</span></span><br><span class="line">    q, err := r.channel.QueueDeclare(</span><br><span class="line">       r.QueueName,</span><br><span class="line">       <span class="comment">//是否持久化</span></span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="comment">//是否自动删除</span></span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="comment">//是否具有排他性</span></span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="comment">//是否阻塞处理</span></span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="comment">//额外的属性</span></span><br><span class="line">       <span class="literal">nil</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接收消息</span></span><br><span class="line">    msgs, err := r.channel.Consume(</span><br><span class="line">       q.Name, <span class="comment">// queue</span></span><br><span class="line">       <span class="comment">//用来区分多个消费者</span></span><br><span class="line">       <span class="string">&quot;&quot;</span>, <span class="comment">// consumer</span></span><br><span class="line">       <span class="comment">//是否自动应答</span></span><br><span class="line">       <span class="literal">true</span>, <span class="comment">// auto-ack</span></span><br><span class="line">       <span class="comment">//是否独有</span></span><br><span class="line">       <span class="literal">false</span>, <span class="comment">// exclusive</span></span><br><span class="line">       <span class="comment">//设置为true，表示 不能将同一个Conenction中生产者发送的消息传递给这个Connection中 的消费者</span></span><br><span class="line">       <span class="literal">false</span>, <span class="comment">// no-local</span></span><br><span class="line">       <span class="comment">//列是否阻塞</span></span><br><span class="line">       <span class="literal">false</span>, <span class="comment">// no-wait</span></span><br><span class="line">       <span class="literal">nil</span>,   <span class="comment">// args</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    forever := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line">    <span class="comment">//启用协程处理消息</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">       <span class="keyword">for</span> d := <span class="keyword">range</span> msgs &#123;</span><br><span class="line">          <span class="comment">//消息逻辑处理，可以自行设计逻辑</span></span><br><span class="line">          log.Printf(<span class="string">&quot;Received a message: %s&quot;</span>, d.Body)</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    log.Printf(<span class="string">&quot; [*] Waiting for messages. To exit press CTRL+C&quot;</span>)</span><br><span class="line">    &lt;-forever</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><img src="/../../images/image-20230928232924828.png" alt="image-20230928232924828"></p>
<h2 id="Work模式"><a href="#Work模式" class="headerlink" title="Work模式"></a>Work模式</h2><p>Work模式和Simple几乎一样，只是消费者从一个变成了多个</p>
<ul>
<li>Send函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Send</span><span class="params">()</span></span> &#123;</span><br><span class="line">    rabbitmq := NewRabbitMQSimple(<span class="string">&quot;go_test&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">       rabbitmq.PublishSimple(<span class="string">&quot;Hello go-rabbitmq!&quot;</span> + strconv.Itoa(i))</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;发送成功！&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>Accept函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Accept</span><span class="params">()</span></span> &#123;</span><br><span class="line">    rabbitmq := NewRabbitMQSimple(<span class="string">&quot;go_test&quot;</span>)</span><br><span class="line">    rabbitmq.ConsumeSimple()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230928234113979.png" alt="image-20230928234113979"></p>
<p>和Java中测试的结果一样，是轮询接收的。</p>
<h2 id="Fanout模式-发布订阅模式"><a href="#Fanout模式-发布订阅模式" class="headerlink" title="Fanout模式(发布订阅模式)"></a>Fanout模式(发布订阅模式)</h2><ul>
<li>Fanout模式下创建MQ对象，fanout模式下设不设置routing key都可以</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订阅模式创建RabbitMQ实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRabbitMQPubSub</span><span class="params">(exchangeName <span class="type">string</span>)</span></span> *RabbitMQ &#123;</span><br><span class="line">    <span class="comment">//创建RabbitMQ实例</span></span><br><span class="line">    rabbitmq := NewRabbitMQ(<span class="string">&quot;&quot;</span>, exchangeName, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">    <span class="comment">//获取connection</span></span><br><span class="line">    rabbitmq.conn, err = amqp.Dial(rabbitmq.Mqurl)</span><br><span class="line">    rabbitmq.failOnErr(err, <span class="string">&quot;failed to connect rabbitmq!&quot;</span>)</span><br><span class="line">    <span class="comment">//获取channel</span></span><br><span class="line">    rabbitmq.channel, err = rabbitmq.conn.Channel()</span><br><span class="line">    rabbitmq.failOnErr(err, <span class="string">&quot;failed to open a channel&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> rabbitmq</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>扇出模式下需要使用交换机，所以创建的时候要指定交换机的名字	</p>
<ul>
<li>Fanout生产函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订阅模式生产</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RabbitMQ)</span></span> PublishPub(message <span class="type">string</span>) &#123;</span><br><span class="line">    <span class="comment">//1.尝试创建交换机，指定交换机类型为fanout</span></span><br><span class="line">    err := r.channel.ExchangeDeclare(</span><br><span class="line">       r.Exchange,</span><br><span class="line">       <span class="string">&quot;fanout&quot;</span>,</span><br><span class="line">       <span class="literal">true</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="comment">//true表示这个exchange不可以被client用来推送消息，仅用来进行exchange和exchange之间的绑定</span></span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">nil</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    r.failOnErr(err, <span class="string">&quot;Failed to declare an excha&quot;</span>+</span><br><span class="line">       <span class="string">&quot;nge&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.发送消息</span></span><br><span class="line">    err = r.channel.Publish(</span><br><span class="line">       r.Exchange,</span><br><span class="line">       <span class="string">&quot;&quot;</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       amqp.Publishing&#123;</span><br><span class="line">          ContentType: <span class="string">&quot;text/plain&quot;</span>,</span><br><span class="line">          Body:        []<span class="type">byte</span>(message),</span><br><span class="line">       &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>fanout模型消费函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订阅模式消费端代码</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RabbitMQ)</span></span> RecieveSub() &#123;</span><br><span class="line">    <span class="comment">//1.试探性创建交换机</span></span><br><span class="line">    err := r.channel.ExchangeDeclare(</span><br><span class="line">       r.Exchange,</span><br><span class="line">       <span class="comment">//交换机类型</span></span><br><span class="line">       <span class="string">&quot;fanout&quot;</span>,</span><br><span class="line">       <span class="literal">true</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="comment">//YES表示这个exchange不可以被client用来推送消息，仅用来进行exchange和exchange之间的绑定</span></span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">nil</span>,</span><br><span class="line">    )</span><br><span class="line">    r.failOnErr(err, <span class="string">&quot;Failed to declare an exch&quot;</span>+</span><br><span class="line">       <span class="string">&quot;ange&quot;</span>)</span><br><span class="line">    <span class="comment">//2.试探性创建队列，这里注意队列名称不要写</span></span><br><span class="line">    q, err := r.channel.QueueDeclare(</span><br><span class="line">       <span class="string">&quot;&quot;</span>, <span class="comment">//随机生产队列名称</span></span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">true</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">nil</span>,</span><br><span class="line">    )</span><br><span class="line">    r.failOnErr(err, <span class="string">&quot;Failed to declare a queue&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定队列到 exchange 中</span></span><br><span class="line">    err = r.channel.QueueBind(</span><br><span class="line">       q.Name,</span><br><span class="line">       <span class="comment">//在pub/sub模式下，这里的key要为空</span></span><br><span class="line">       <span class="string">&quot;&quot;</span>,</span><br><span class="line">       r.Exchange,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//消费消息</span></span><br><span class="line">    messges, err := r.channel.Consume(</span><br><span class="line">       q.Name,</span><br><span class="line">       <span class="string">&quot;&quot;</span>,</span><br><span class="line">       <span class="literal">true</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">nil</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    forever := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">       <span class="keyword">for</span> d := <span class="keyword">range</span> messges &#123;</span><br><span class="line">          log.Printf(<span class="string">&quot;Received a message: %s&quot;</span>, d.Body)</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    fmt.Println(<span class="string">&quot;退出请按 CTRL+C\n&quot;</span>)</span><br><span class="line">    &lt;-forever</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>Send函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Send</span><span class="params">()</span></span> &#123;</span><br><span class="line">    rabbitmq := NewRabbitMQPubSub(<span class="string">&quot;&quot;</span> +</span><br><span class="line">       <span class="string">&quot;go_test_fanout&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">       rabbitmq.PublishPub(<span class="string">&quot;订阅模式生产第&quot;</span> +</span><br><span class="line">          strconv.Itoa(i) + <span class="string">&quot;条&quot;</span> + <span class="string">&quot;数据&quot;</span>)</span><br><span class="line">       fmt.Println(<span class="string">&quot;订阅模式生产第&quot;</span> +</span><br><span class="line">          strconv.Itoa(i) + <span class="string">&quot;条&quot;</span> + <span class="string">&quot;数据&quot;</span>)</span><br><span class="line">       time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>Accept函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Accept</span><span class="params">()</span></span> &#123;</span><br><span class="line">    rabbitmq := NewRabbitMQPubSub(<span class="string">&quot;&quot;</span> +</span><br><span class="line">       <span class="string">&quot;go_test_fanout&quot;</span>)</span><br><span class="line">    rabbitmq.RecieveSub()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/../../images/image-20230929115342931.png" alt="image-20230929115342931"></p>
<h2 id="Routing-模式-direct"><a href="#Routing-模式-direct" class="headerlink" title="Routing 模式(direct)"></a>Routing 模式(direct)</h2><ul>
<li>Routing模式下创建MQ对象，需要指定routing key</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由模式</span></span><br><span class="line"><span class="comment">// 创建RabbitMQ实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRabbitMQRouting</span><span class="params">(exchangeName <span class="type">string</span>, routingKey <span class="type">string</span>)</span></span> *RabbitMQ &#123;</span><br><span class="line">    <span class="comment">//创建RabbitMQ实例</span></span><br><span class="line">    rabbitmq := NewRabbitMQ(<span class="string">&quot;&quot;</span>, exchangeName, routingKey)</span><br><span class="line">    <span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">    <span class="comment">//获取connection</span></span><br><span class="line">    rabbitmq.conn, err = amqp.Dial(rabbitmq.Mqurl)</span><br><span class="line">    rabbitmq.failOnErr(err, <span class="string">&quot;failed to connect rabbitmq!&quot;</span>)</span><br><span class="line">    <span class="comment">//获取channel</span></span><br><span class="line">    rabbitmq.channel, err = rabbitmq.conn.Channel()</span><br><span class="line">    rabbitmq.failOnErr(err, <span class="string">&quot;failed to open a channel&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> rabbitmq</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>Routing 下生产者，创建交换机的类型要改为direct，用channel发布消息时候要指定routingkey</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由模式发送消息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RabbitMQ)</span></span> PublishRouting(message <span class="type">string</span>) &#123;</span><br><span class="line">    <span class="comment">//1.尝试创建交换机</span></span><br><span class="line">    err := r.channel.ExchangeDeclare(</span><br><span class="line">       r.Exchange,</span><br><span class="line">       <span class="comment">//要改成direct</span></span><br><span class="line">       <span class="string">&quot;direct&quot;</span>,</span><br><span class="line">       <span class="literal">true</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">nil</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    r.failOnErr(err, <span class="string">&quot;Failed to declare an excha&quot;</span>+</span><br><span class="line">       <span class="string">&quot;nge&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.发送消息</span></span><br><span class="line">    err = r.channel.Publish(</span><br><span class="line">       r.Exchange,</span><br><span class="line">       <span class="comment">//要设置</span></span><br><span class="line">       r.Key,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       amqp.Publishing&#123;</span><br><span class="line">          ContentType: <span class="string">&quot;text/plain&quot;</span>,</span><br><span class="line">          Body:        []<span class="type">byte</span>(message),</span><br><span class="line">       &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>Routing 模式下的消费者，指定交换机类型 direct，消费者要绑定的routing key</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由模式接受消息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RabbitMQ)</span></span> RecieveRouting() &#123;</span><br><span class="line">    <span class="comment">//1.试探性创建交换机</span></span><br><span class="line">    err := r.channel.ExchangeDeclare(</span><br><span class="line">       r.Exchange,</span><br><span class="line">       <span class="comment">//交换机类型</span></span><br><span class="line">       <span class="string">&quot;direct&quot;</span>,</span><br><span class="line">       <span class="literal">true</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">nil</span>,</span><br><span class="line">    )</span><br><span class="line">    r.failOnErr(err, <span class="string">&quot;Failed to declare an exch&quot;</span>+</span><br><span class="line">       <span class="string">&quot;ange&quot;</span>)</span><br><span class="line">    <span class="comment">//2.试探性创建队列，这里注意队列名称不要写</span></span><br><span class="line">    q, err := r.channel.QueueDeclare(</span><br><span class="line">       <span class="string">&quot;&quot;</span>, <span class="comment">//随机生产队列名称</span></span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">true</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">nil</span>,</span><br><span class="line">    )</span><br><span class="line">    r.failOnErr(err, <span class="string">&quot;Failed to declare a queue&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定队列到 exchange 中</span></span><br><span class="line">    err = r.channel.QueueBind(</span><br><span class="line">       q.Name,</span><br><span class="line">       <span class="comment">//需要绑定key</span></span><br><span class="line">       r.Key,</span><br><span class="line">       r.Exchange,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//消费消息</span></span><br><span class="line">    messges, err := r.channel.Consume(</span><br><span class="line">       q.Name,</span><br><span class="line">       <span class="string">&quot;&quot;</span>,</span><br><span class="line">       <span class="literal">true</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">nil</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    forever := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">       <span class="keyword">for</span> d := <span class="keyword">range</span> messges &#123;</span><br><span class="line">          log.Printf(<span class="string">&quot;Received a message: %s&quot;</span>, d.Body)</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;退出请按 CTRL+C&quot;</span>)</span><br><span class="line">    &lt;-forever</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>Routing 生产者</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Send</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//一个交换机，绑定了两个channel</span></span><br><span class="line">    test1 := NewRabbitMQRouting(<span class="string">&quot;go_routing_exchange&quot;</span>, <span class="string">&quot;go_routing_key1&quot;</span>)</span><br><span class="line">    test2 := NewRabbitMQRouting(<span class="string">&quot;go_routing_exchange&quot;</span>, <span class="string">&quot;go_routing_key2&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt;= <span class="number">100</span>; i++ &#123;</span><br><span class="line">       test1.PublishRouting(<span class="string">&quot;Hello kuteng one!&quot;</span> + strconv.Itoa(i))</span><br><span class="line">       test2.PublishRouting(<span class="string">&quot;Hello kuteng Two!&quot;</span> + strconv.Itoa(i))</span><br><span class="line">       time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">       fmt.Println(i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>Routing消费者</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Accept1</span><span class="params">()</span></span> &#123;</span><br><span class="line">    one := NewRabbitMQRouting(<span class="string">&quot;go_routing_exchange&quot;</span>, <span class="string">&quot;go_routing_key1&quot;</span>)</span><br><span class="line">    one.RecieveRouting()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Accept2</span><span class="params">()</span></span> &#123;</span><br><span class="line">	two := NewRabbitMQRouting(<span class="string">&quot;go_routing_exchange&quot;</span>, <span class="string">&quot;go_routing_key2&quot;</span>)</span><br><span class="line">	two.RecieveRouting()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p><img src="/../../images/image-20230929135906376.png" alt="image-20230929135906376"></p>
<h2 id="Topic模式"><a href="#Topic模式" class="headerlink" title="Topic模式"></a>Topic模式</h2><p>和Routing模式几乎一样，只不过支持通配符指定，交换机可以把消息发给多个队列。</p>
<ul>
<li>Topic创建MQ对象</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//话题模式</span></span><br><span class="line"><span class="comment">//创建RabbitMQ实例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRabbitMQTopic</span><span class="params">(exchangeName <span class="type">string</span>, routingKey <span class="type">string</span>)</span></span> *RabbitMQ &#123;</span><br><span class="line">    <span class="comment">//创建RabbitMQ实例</span></span><br><span class="line">    rabbitmq := NewRabbitMQ(<span class="string">&quot;&quot;</span>, exchangeName, routingKey)</span><br><span class="line">    <span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">    <span class="comment">//获取connection</span></span><br><span class="line">    rabbitmq.conn, err = amqp.Dial(rabbitmq.Mqurl)</span><br><span class="line">    rabbitmq.failOnErr(err, <span class="string">&quot;failed to connect rabbitmq!&quot;</span>)</span><br><span class="line">    <span class="comment">//获取channel</span></span><br><span class="line">    rabbitmq.channel, err = rabbitmq.conn.Channel()</span><br><span class="line">    rabbitmq.failOnErr(err, <span class="string">&quot;failed to open a channel&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> rabbitmq</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>Topic生产消息</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 话题模式发送消息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RabbitMQ)</span></span> PublishTopic(message <span class="type">string</span>) &#123;</span><br><span class="line">    <span class="comment">//1.尝试创建交换机</span></span><br><span class="line">    err := r.channel.ExchangeDeclare(</span><br><span class="line">       r.Exchange,</span><br><span class="line">       <span class="comment">//要改成topic</span></span><br><span class="line">       <span class="string">&quot;topic&quot;</span>,</span><br><span class="line">       <span class="literal">true</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">nil</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    r.failOnErr(err, <span class="string">&quot;Failed to declare an excha&quot;</span>+</span><br><span class="line">       <span class="string">&quot;nge&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.发送消息</span></span><br><span class="line">    err = r.channel.Publish(</span><br><span class="line">       r.Exchange,</span><br><span class="line">       <span class="comment">//要设置</span></span><br><span class="line">       r.Key,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       amqp.Publishing&#123;</span><br><span class="line">          ContentType: <span class="string">&quot;text/plain&quot;</span>,</span><br><span class="line">          Body:        []<span class="type">byte</span>(message),</span><br><span class="line">       &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>Topic消费者</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 话题模式接受消息</span></span><br><span class="line"><span class="comment">// 要注意key,规则</span></span><br><span class="line"><span class="comment">// 其中“*”用于匹配一个单词，“#”用于匹配多个单词（可以是零个）</span></span><br><span class="line"><span class="comment">// 匹配 kuteng.* 表示匹配 kuteng.hello, kuteng.hello.one需要用kuteng.#才能匹配到</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RabbitMQ)</span></span> RecieveTopic() &#123;</span><br><span class="line">    <span class="comment">//1.试探性创建交换机</span></span><br><span class="line">    err := r.channel.ExchangeDeclare(</span><br><span class="line">       r.Exchange,</span><br><span class="line">       <span class="comment">//交换机类型</span></span><br><span class="line">       <span class="string">&quot;topic&quot;</span>,</span><br><span class="line">       <span class="literal">true</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">nil</span>,</span><br><span class="line">    )</span><br><span class="line">    r.failOnErr(err, <span class="string">&quot;Failed to declare an exch&quot;</span>+</span><br><span class="line">       <span class="string">&quot;ange&quot;</span>)</span><br><span class="line">    <span class="comment">//2.试探性创建队列，这里注意队列名称不要写</span></span><br><span class="line">    q, err := r.channel.QueueDeclare(</span><br><span class="line">       <span class="string">&quot;&quot;</span>, <span class="comment">//随机生产队列名称</span></span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">true</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">nil</span>,</span><br><span class="line">    )</span><br><span class="line">    r.failOnErr(err, <span class="string">&quot;Failed to declare a queue&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定队列到 exchange 中</span></span><br><span class="line">    err = r.channel.QueueBind(</span><br><span class="line">       q.Name,</span><br><span class="line">       <span class="comment">//在pub/sub模式下，这里的key要为空</span></span><br><span class="line">       r.Key,</span><br><span class="line">       r.Exchange,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//消费消息</span></span><br><span class="line">    messges, err := r.channel.Consume(</span><br><span class="line">       q.Name,</span><br><span class="line">       <span class="string">&quot;&quot;</span>,</span><br><span class="line">       <span class="literal">true</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">false</span>,</span><br><span class="line">       <span class="literal">nil</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    forever := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">       <span class="keyword">for</span> d := <span class="keyword">range</span> messges &#123;</span><br><span class="line">          log.Printf(<span class="string">&quot;Received a message: %s&quot;</span>, d.Body)</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;退出请按 CTRL+C&quot;</span>)</span><br><span class="line">    &lt;-forever</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>Topic生产者</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Send</span><span class="params">()</span></span> &#123;</span><br><span class="line">    kutengOne := NewRabbitMQTopic(<span class="string">&quot;go_test_topic&quot;</span>, <span class="string">&quot;gotest.topic.one&quot;</span>)</span><br><span class="line">    kutengTwo := NewRabbitMQTopic(<span class="string">&quot;go_test_topic&quot;</span>, <span class="string">&quot;gotest.topic.two&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt;= <span class="number">100</span>; i++ &#123;</span><br><span class="line">       kutengOne.PublishTopic(<span class="string">&quot;Hello gotest topic one!&quot;</span> + strconv.Itoa(i))</span><br><span class="line">       kutengTwo.PublishTopic(<span class="string">&quot;Hello gotest topic Two!&quot;</span> + strconv.Itoa(i))</span><br><span class="line">       time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">       fmt.Println(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>Topic消费者</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Accept1</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 会接收go_test_topic所有的channel</span></span><br><span class="line">    kutengOne := NewRabbitMQTopic(<span class="string">&quot;go_test_topic&quot;</span>, <span class="string">&quot;#&quot;</span>)</span><br><span class="line">    kutengOne.RecieveTopic()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Accept2</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 只会接收gotest + 任意单词 + two的channel的消息</span></span><br><span class="line">	kutengOne := NewRabbitMQTopic(<span class="string">&quot;go_test_topic&quot;</span>, <span class="string">&quot;gotest.*.two&quot;</span>)</span><br><span class="line">	kutengOne.RecieveTopic()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/../../images/image-20230929153538839.png" alt="image-20230929153538839"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://yimeng436.github.io">异梦</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://yimeng436.github.io/2022/08/21/RabbitMQ/RabbitMQ/">https://yimeng436.github.io/2022/08/21/RabbitMQ/RabbitMQ/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yimeng436.github.io" target="_blank">异梦的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a></div><div class="post_share"><div class="social-share" data-image="/img/top.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/08/21/NewCod_Java/NewCod_Java/"><img class="prev-cover" src="/img/top.png" onerror="onerror=null;src='/img/cover.png'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">NewCode_Java</div></div></a></div><div class="next-post pull-right"><a href="/2022/08/21/SpringSecurity/SpringSecurity/"><img class="next-cover" src="/img/top.png" onerror="onerror=null;src='/img/cover.png'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SpringSecurity</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/01/04/%E5%A4%9A%E6%80%81%E4%BE%8B%E9%A2%98/%E5%A4%9A%E6%80%81%E4%BE%8B%E9%A2%98/" title="多态例题"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-04</div><div class="title">多态例题</div></div></a></div><div><a href="/2022/06/06/%E8%87%AA%E5%8A%A8%E6%8B%86%E8%A3%85%E7%AE%B1/%E8%87%AA%E5%8A%A8%E6%8B%86%E8%A3%85%E7%AE%B1/" title="自动拆装箱"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-06</div><div class="title">自动拆装箱</div></div></a></div><div><a href="/2022/06/15/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="多线程"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-15</div><div class="title">多线程</div></div></a></div><div><a href="/2022/06/30/JavaWeb/JavaWeb/" title="JavaWeb"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-30</div><div class="title">JavaWeb</div></div></a></div><div><a href="/2022/07/25/Mybatis/Mybatis/" title="Mybatis"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-25</div><div class="title">Mybatis</div></div></a></div><div><a href="/2022/07/26/%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%8F%8D%E5%B0%84/%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%8F%8D%E5%B0%84/" title="注解和反射"><img class="cover" src="/img/top.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-26</div><div class="title">注解和反射</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="http://mms2.baidu.com/it/u=665033858,976373917&amp;fm=253&amp;app=138&amp;f=JPEG&amp;fmt=auto&amp;q=75?w=500&amp;h=500" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">异梦</div><div class="author-info__description">欢迎访问</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">62</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/yimeng436" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2441844062@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFMQ"><span class="toc-number">1.</span> <span class="toc-text">什么是MQ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MQ-%E6%9C%89%E4%BB%80%E4%B9%88%E4%BD%9C%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">MQ 有什么作用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84MQ"><span class="toc-number">3.</span> <span class="toc-text">常见的MQ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E5%A4%A7%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">4.</span> <span class="toc-text">四大核心概念</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">5.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.1.</span> <span class="toc-text">简单工作模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Work-queues%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.2.</span> <span class="toc-text">Work queues工作模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%BA%94%E7%AD%94%E6%9C%BA%E5%88%B6"><span class="toc-number">6.3.</span> <span class="toc-text">消息应答机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%AD%94%E6%96%B9%E6%B3%95"><span class="toc-number">6.3.1.</span> <span class="toc-text">应答方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1%E5%A4%84%E7%90%86"><span class="toc-number">6.3.2.</span> <span class="toc-text">消息丢失处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%9F%E5%88%97%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">6.3.3.</span> <span class="toc-text">队列持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">6.3.4.</span> <span class="toc-text">消息持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%85%AC%E5%B9%B3%E5%88%86%E5%8F%91"><span class="toc-number">6.3.5.</span> <span class="toc-text">不公平分发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%84%E5%8F%96%E5%80%BC"><span class="toc-number">6.3.6.</span> <span class="toc-text">预取值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4"><span class="toc-number">6.3.7.</span> <span class="toc-text">发布确认</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">6.4.</span> <span class="toc-text">交换机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.4.1.</span> <span class="toc-text">交换机类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A"><span class="toc-number">6.4.2.</span> <span class="toc-text">绑定</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fanout%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.5.</span> <span class="toc-text">fanout模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#direct-%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.6.</span> <span class="toc-text">direct 模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Topic-%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.7.</span> <span class="toc-text">Topic 模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-number">6.8.</span> <span class="toc-text">死信队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AFTTL-%E8%BF%87%E6%9C%9F"><span class="toc-number">6.8.1.</span> <span class="toc-text">消息TTL 过期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%9F%E5%88%97%E8%BE%BE%E5%88%B0%E6%9C%80%E5%A4%A7%E9%95%BF%E5%BA%A6"><span class="toc-number">6.8.2.</span> <span class="toc-text">队列达到最大长度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%A2%AB%E6%8B%92"><span class="toc-number">6.8.3.</span> <span class="toc-text">消息被拒</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B4%E5%90%88SpringBoot"><span class="toc-number">7.</span> <span class="toc-text">整合SpringBoot</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97"><span class="toc-number">7.1.</span> <span class="toc-text">延迟队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E6%8F%92%E4%BB%B6"><span class="toc-number">7.2.</span> <span class="toc-text">延迟插件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%8F%92%E4%BB%B6%E7%9A%84%E7%BB%91%E5%AE%9A%E5%85%B3%E7%B3%BB"><span class="toc-number">7.2.1.</span> <span class="toc-text">基于插件的绑定关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MQ%E5%87%BA%E7%8E%B0%E5%BC%82%E5%B8%B8"><span class="toc-number">7.3.</span> <span class="toc-text">MQ出现异常</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A4%E6%8D%A2%E6%9C%BA%E6%97%A0%E6%B3%95%E4%BB%8E%E7%94%9F%E4%BA%A7%E8%80%85%E9%82%A3%E5%BE%97%E5%88%B0%E6%B6%88%E6%81%AF"><span class="toc-number">7.3.1.</span> <span class="toc-text">交换机无法从生产者那得到消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%9F%E5%88%97%E6%97%A0%E6%B3%95%E4%BB%8E%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%82%A3%E5%BE%97%E5%88%B0%E6%B6%88%E6%81%AF"><span class="toc-number">7.3.2.</span> <span class="toc-text">队列无法从交换机那得到消息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc-number">7.4.</span> <span class="toc-text">幂等性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%83%B0%E6%80%A7%E9%98%9F%E5%88%97"><span class="toc-number">7.5.</span> <span class="toc-text">惰性队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3%E5%AE%9E%E7%8E%B0%E7%BB%91%E5%AE%9A"><span class="toc-number">7.6.</span> <span class="toc-text">注解实现绑定</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Go%E6%93%8D%E4%BD%9CRabbitMQ"><span class="toc-number">8.</span> <span class="toc-text">Go操作RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Simple%E6%A8%A1%E5%BC%8F"><span class="toc-number">8.1.</span> <span class="toc-text">Simple模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Work%E6%A8%A1%E5%BC%8F"><span class="toc-number">8.2.</span> <span class="toc-text">Work模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fanout%E6%A8%A1%E5%BC%8F-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">8.3.</span> <span class="toc-text">Fanout模式(发布订阅模式)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Routing-%E6%A8%A1%E5%BC%8F-direct"><span class="toc-number">8.4.</span> <span class="toc-text">Routing 模式(direct)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Topic%E6%A8%A1%E5%BC%8F"><span class="toc-number">8.5.</span> <span class="toc-text">Topic模式</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/08/19/MySQL%E5%8E%9F%E7%90%86%E9%83%A8%E5%88%86/MySQL%E5%8E%9F%E7%90%86%E9%83%A8%E5%88%86/" title="MySQL原理"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="MySQL原理"/></a><div class="content"><a class="title" href="/2023/08/19/MySQL%E5%8E%9F%E7%90%86%E9%83%A8%E5%88%86/MySQL%E5%8E%9F%E7%90%86%E9%83%A8%E5%88%86/" title="MySQL原理">MySQL原理</a><time datetime="2023-08-18T16:00:00.000Z" title="发表于 2023-08-19 00:00:00">2023-08-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/19/%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/" title="算法笔记"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="算法笔记"/></a><div class="content"><a class="title" href="/2023/08/19/%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/" title="算法笔记">算法笔记</a><time datetime="2023-08-18T16:00:00.000Z" title="发表于 2023-08-19 00:00:00">2023-08-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/06/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86/" title="前端知识"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="前端知识"/></a><div class="content"><a class="title" href="/2023/06/06/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86/" title="前端知识">前端知识</a><time datetime="2023-06-05T16:00:00.000Z" title="发表于 2023-06-06 00:00:00">2023-06-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/14/Paper-FSAF/Paper-FSAF/" title="FSAF论文"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="FSAF论文"/></a><div class="content"><a class="title" href="/2022/10/14/Paper-FSAF/Paper-FSAF/" title="FSAF论文">FSAF论文</a><time datetime="2022-10-13T16:00:00.000Z" title="发表于 2022-10-14 00:00:00">2022-10-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/25/Paper-Faster-RCNN/Paper-Faster-RCNN/" title="Faster-RCNN论文"><img src="/img/top.png" onerror="this.onerror=null;this.src='/img/cover.png'" alt="Faster-RCNN论文"/></a><div class="content"><a class="title" href="/2022/08/25/Paper-Faster-RCNN/Paper-Faster-RCNN/" title="Faster-RCNN论文">Faster-RCNN论文</a><time datetime="2022-08-24T16:00:00.000Z" title="发表于 2022-08-25 00:00:00">2022-08-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 异梦</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>